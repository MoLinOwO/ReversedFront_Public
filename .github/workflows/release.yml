name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    env:
      VERSION: ${{ github.ref_name }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install mold linker (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get install -y mold
          echo "RUSTFLAGS=-C link-arg=-fuse-ld=mold" >> $GITHUB_ENV

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.1-dev libjavascriptcoregtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev libsoup-3.0-dev

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"

      # 跳過 Webpack - bundle 檔案已預先打包在 repo 中
      # - name: Build Frontend (Webpack)
      #   working-directory: assets/mod
      #   run: |
      #     npm install
      #     npx webpack

      - name: Build Tauri App
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          cd src-tauri
          cargo tauri build ${{ matrix.args }}

      - name: Rename Artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          set -e
          echo "Version: ${VERSION}"

          deb_file=$(ls src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n 1 || true)
          if [ -n "$deb_file" ]; then
            mv "$deb_file" "src-tauri/target/release/bundle/deb/ReversedFront_${VERSION}.deb"
          fi

          appimage_file=$(ls src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null | head -n 1 || true)
          if [ -n "$appimage_file" ]; then
            mv "$appimage_file" "src-tauri/target/release/bundle/appimage/ReversedFront_${VERSION}.AppImage"
          fi

      - name: Rename Artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $version = "$env:VERSION"
          Write-Host "Version: $version"

          $nsisDir = "src-tauri/target/release/bundle/nsis"
          $msiDir = "src-tauri/target/release/bundle/msi"

          if (Test-Path $nsisDir) {
            $nsis = Get-ChildItem $nsisDir -Filter *.exe -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($nsis) {
              $target = Join-Path $nsisDir "ReversedFront_$version.exe"
              Move-Item $nsis.FullName $target -Force
            }
          }

          if (Test-Path $msiDir) {
            $msi = Get-ChildItem $msiDir -Filter *.msi -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($msi) {
              $target = Join-Path $msiDir "ReversedFront_$version.msi"
              Move-Item $msi.FullName $target -Force
            }
          }

      - name: Rename Artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          set -e
          echo "Version: ${VERSION}"

          dmg_file=$(find src-tauri/target -path "*bundle/dmg/*.dmg" | head -n 1 || true)
          if [ -n "$dmg_file" ]; then
            dmg_dir=$(dirname "$dmg_file")
            mv "$dmg_file" "$dmg_dir/ReversedFront_${VERSION}.dmg"
          fi

          app_file=$(find src-tauri/target -path "*bundle/macos/*.app.tar.gz" | head -n 1 || true)
          if [ -n "$app_file" ]; then
            app_dir=$(dirname "$app_file")
            mv "$app_file" "$app_dir/ReversedFront_${VERSION}.app.tar.gz"
          fi

      - name: List build artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          echo "Checking target directories..."
          ls -R src-tauri/target/ || true
          echo "Looking for DMG files..."
          find src-tauri/target -name "*.dmg" || true
          find src-tauri/target -name "*.app" || true

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/**/bundle/dmg/*.dmg
            src-tauri/target/**/bundle/macos/*.app.tar.gz
