name: 跨平台編譯 (Nuitka)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允許手動觸發

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # 一個平台失敗不影響其他平台
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ['3.13']  # Python 3.14 在 GitHub Actions 可能還不穩定
    
    steps:
    - name: Checkout 代碼
      uses: actions/checkout@v4
    
    - name: 設置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: 設置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # ==================== 安裝依賴 ====================
    - name: 安裝 Python 依賴
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 安裝前端依賴並打包
      run: |
        cd mod
        npm install
        npx webpack --mode production
        cd ..
    
    # ==================== Windows 特定設置 ====================
    - name: (Windows) 安裝 MSVC
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    
    # ==================== macOS 特定設置 ====================
    - name: (macOS) 準備圖標
      if: runner.os == 'macOS'
      run: |
        echo "macOS 將使用 build.py 自動從 logo.ico 轉換圖標"
    
    # ==================== Linux 特定設置 ====================
    - name: (Linux) 安裝系統依賴
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y patchelf ccache
    
    # ==================== Nuitka 編譯 ====================
    - name: 使用 Nuitka 編譯
      run: python build.py
      continue-on-error: false
    
    # ==================== 平台特定後處理 ====================
    - name: (Windows) 創建安裝程序
      if: runner.os == 'Windows'
      run: |
        # 安裝 Inno Setup
        choco install innosetup -y
        
        # 創建安裝腳本
        $issContent = @"
[Setup]
AppName=ReversedFront
AppVersion=2.8.0
DefaultDirName={autopf}\ReversedFront
DefaultGroupName=ReversedFront
OutputDir=.
OutputBaseFilename=ReversedFront-Setup
Compression=lzma2
SolidCompression=yes
ArchitecturesInstallIn64BitMode=x64
PrivilegesRequired=admin
DisableProgramGroupPage=yes
LicenseFile=
UninstallDisplayIcon={app}\ReversedFront.exe

[Files]
Source: "dist\main.dist\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

[Icons]
Name: "{autoprograms}\ReversedFront"; Filename: "{app}\ReversedFront.exe"
Name: "{autodesktop}\ReversedFront"; Filename: "{app}\ReversedFront.exe"

[Run]
Filename: "{app}\ReversedFront.exe"; Description: "啟動 ReversedFront"; Flags: postinstall nowait skipifsilent
"@
        
        $issContent | Out-File -FilePath "installer.iss" -Encoding UTF8
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
    
    - name: (macOS) 創建 DMG
      if: runner.os == 'macOS'
      run: |
        # 創建臨時目錄
        mkdir -p dmg_temp
        cp -r dist/main.dist/ReversedFront.app dmg_temp/
        
        # 創建 DMG
        hdiutil create -volname "ReversedFront" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          ReversedFront-macOS.dmg
        
        rm -rf dmg_temp
    
    - name: (Linux) 創建 AppImage
      if: runner.os == 'Linux'
      run: |
        # 安裝 AppImage 工具
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        # 創建 AppDir
        mkdir -p AppDir/usr/bin
        cp -r dist/main.dist/* AppDir/usr/bin/
        
        # 創建 desktop 文件
        mkdir -p AppDir/usr/share/applications
        cat > AppDir/usr/share/applications/ReversedFront.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=ReversedFront
        Exec=ReversedFront
        Icon=logo
        Categories=Game;Utility;
        EOF
        
        # 複製圖標
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp logo192.png AppDir/usr/share/icons/hicolor/256x256/apps/logo.png
        
        # 創建 AppImage
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
        mv ReversedFront*.AppImage ReversedFront-Linux.AppImage
    
    # ==================== 上傳編譯產物 ====================
    - name: 上傳 Windows 安裝程序
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Windows-Setup
        path: ReversedFront-Setup.exe
    
    - name: 上傳 macOS DMG
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-macOS
        path: ReversedFront-macOS.dmg
    
    - name: 上傳 Linux AppImage
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Linux
        path: ReversedFront-Linux.AppImage

  # ==================== 創建 Release ====================
  release:
    name: 創建 Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: 下載所有產物
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: 創建 Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/ReversedFront-Windows-Setup/ReversedFront-Setup.exe
          artifacts/ReversedFront-macOS/ReversedFront-macOS.dmg
          artifacts/ReversedFront-Linux/ReversedFront-Linux.AppImage
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
