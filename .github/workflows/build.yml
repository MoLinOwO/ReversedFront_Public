name: è·¨å¹³å°ç·¨è­¯ (Nuitka)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # ä¸€å€‹å¹³å°å¤±æ•—ä¸å½±éŸ¿å…¶ä»–å¹³å°
      matrix:
        os: [windows-latest, ubuntu-latest]  # æš«æ™‚ç§»é™¤ macOS (PyQt6 ä¸æ”¯æŒ)
        python-version: ['3.13']  # Python 3.14 åœ¨ GitHub Actions å¯èƒ½é‚„ä¸ç©©å®š
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # ==================== å®‰è£ä¾è³´ ====================
    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: å®‰è£å‰ç«¯ä¾è³´ä¸¦æ‰“åŒ…
      run: |
        cd mod
        npm install
        npx webpack --mode production
        cd ..
    
    # ==================== Windows ç‰¹å®šè¨­ç½® ====================
    - name: (Windows) å®‰è£ MSVC
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    
    # ==================== macOS ç‰¹å®šè¨­ç½® ====================
    # æš«æ™‚ç¦ç”¨ï¼šNuitka ä¸æ”¯æŒ PyQt6 on macOS
    # å°‡ä¾†å¯æ”¹ç”¨ PySide6 æˆ–æ‰‹å‹•ç·¨è­¯
    # - name: (macOS) æº–å‚™åœ–æ¨™
    #   if: runner.os == 'macOS'
    #   run: |
    #     echo "macOS å°‡ä½¿ç”¨ build.py è‡ªå‹•å¾ž logo.ico è½‰æ›åœ–æ¨™"
    
    # ==================== Linux ç‰¹å®šè¨­ç½® ====================
    - name: (Linux) å®‰è£ç³»çµ±ä¾è³´
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y patchelf ccache
    
    # ==================== Nuitka ç·¨è­¯ ====================
    - name: ä½¿ç”¨ Nuitka ç·¨è­¯
      run: python build.py
      continue-on-error: false
    
    # ==================== å¹³å°ç‰¹å®šå¾Œè™•ç† ====================
    - name: (Windows) å‰µå»ºå®‰è£ç¨‹åº
      if: runner.os == 'Windows'
      run: |
        # å®‰è£ Inno Setup
        choco install innosetup -y
        
        # å‰µå»ºå®‰è£è…³æœ¬
        $issContent = @"
[Setup]
AppName=ReversedFront
AppVersion=2.8.0
DefaultDirName={autopf}\ReversedFront
DefaultGroupName=ReversedFront
OutputDir=.
OutputBaseFilename=ReversedFront-Setup
Compression=lzma2
SolidCompression=yes
ArchitecturesInstallIn64BitMode=x64
PrivilegesRequired=admin
DisableProgramGroupPage=yes
LicenseFile=
UninstallDisplayIcon={app}\ReversedFront.exe

[Files]
Source: "dist\main.dist\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

[Icons]
Name: "{autoprograms}\ReversedFront"; Filename: "{app}\ReversedFront.exe"
Name: "{autodesktop}\ReversedFront"; Filename: "{app}\ReversedFront.exe"

[Run]
Filename: "{app}\ReversedFront.exe"; Description: "å•Ÿå‹• ReversedFront"; Flags: postinstall nowait skipifsilent
"@
        
        $issContent | Out-File -FilePath "installer.iss" -Encoding UTF8
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
    
    - name: (macOS) å‰µå»º DMG
      if: runner.os == 'macOS'
      run: |
        # å‰µå»ºè‡¨æ™‚ç›®éŒ„
        mkdir -p dmg_temp
        cp -r dist/main.dist/ReversedFront.app dmg_temp/
        
        # å‰µå»º DMG
        hdiutil create -volname "ReversedFront" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          ReversedFront-macOS.dmg
        
        rm -rf dmg_temp
    
    - name: (Linux) å‰µå»º AppImage
      if: runner.os == 'Linux'
      run: |
        # å®‰è£ AppImage å·¥å…·
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        # å‰µå»º AppDir
        mkdir -p AppDir/usr/bin
        cp -r dist/main.dist/* AppDir/usr/bin/
        
        # å‰µå»º desktop æ–‡ä»¶
        mkdir -p AppDir/usr/share/applications
        cat > AppDir/usr/share/applications/ReversedFront.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=ReversedFront
        Exec=ReversedFront
        Icon=logo
        Categories=Game;Utility;
        EOF
        
        # è¤‡è£½åœ–æ¨™
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp logo192.png AppDir/usr/share/icons/hicolor/256x256/apps/logo.png
        
        # å‰µå»º AppImage
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
        mv ReversedFront*.AppImage ReversedFront-Linux.AppImage
    
    # ==================== ä¸Šå‚³ç·¨è­¯ç”¢ç‰© ====================
    - name: ä¸Šå‚³ Windows å®‰è£ç¨‹åº
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Windows-Setup
        path: ReversedFront-Setup.exe
    
    - name: ä¸Šå‚³ macOS DMG
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-macOS
        path: ReversedFront-macOS.dmg
    
    - name: ä¸Šå‚³ Linux AppImage
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Linux
        path: ReversedFront-Linux.AppImage

  # ==================== å‰µå»º Release ====================
  release:
    name: å‰µå»º Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ä¸‹è¼‰æ‰€æœ‰ç”¢ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: å‰µå»º Release
      uses: softprops/action-gh-release@v1
      with:
        files: |Linux/ReversedFront-Linux.AppImage
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ðŸŽ‰ ReversedFront v2.8.0
          
          ### ðŸ“¦ ä¸‹è¼‰
          - **Windows**: ReversedFront-Setup.exe (å®‰è£ç¨‹åº)
          - **Linux**: ReversedFront-Linux.AppImage (å–®æ–‡ä»¶å¯åŸ·è¡Œ)
          - **macOS**: æš«ä¸æä¾›è‡ªå‹•ç·¨è­¯ï¼ˆPyQt6 é™åˆ¶ï¼‰ï¼Œè«‹ä½¿ç”¨ Windows/Linux ç‰ˆæœ¬æˆ–ç­‰å¾… PySide6 ç‰ˆæœ¬
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - è·¨å¹³å°æ”¯æŒï¼ˆWindows, Linuxï¼‰
          - Nuitka åŽŸç”Ÿç·¨è­¯ï¼Œæ€§èƒ½å„ªç•°
          - GPU ç¡¬ä»¶åŠ é€Ÿ
          - å®Œæ•´çš„éŠæˆ²è¼”åŠ©åŠŸèƒ½
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
