name: è·¨å¹³å°ç·¨è­¯ (Nuitka)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write  # å…è¨±å‰µå»º Release å’Œä¸Šå‚³è³‡ç”¢

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # ä¸€å€‹å¹³å°å¤±æ•—ä¸å½±éŸ¿å…¶ä»–å¹³å°
      matrix:
        os: [windows-latest, ubuntu-22.04]  # ä½¿ç”¨ 22.04 ä»¥ç²å¾—æ›´å¥½çš„å¥—ä»¶ç›¸å®¹æ€§
        python-version: ['3.13']  # Python 3.14 åœ¨ GitHub Actions å¯èƒ½é‚„ä¸ç©©å®š
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # ==================== å®‰è£ä¾è³´ ====================
    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: å®‰è£å‰ç«¯ä¾è³´ä¸¦æ‰“åŒ…
      run: |
        cd mod
        npm install
        npx webpack --mode production
        cd ..
    
    # ==================== Windows ç‰¹å®šè¨­ç½® ====================
    - name: (Windows) å®‰è£ MSVC
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
    
    # ==================== macOS ç‰¹å®šè¨­ç½® ====================
    # æš«æ™‚ç¦ç”¨ï¼šNuitka ä¸æ”¯æŒ PyQt6 on macOS
    # å°‡ä¾†å¯æ”¹ç”¨ PySide6 æˆ–æ‰‹å‹•ç·¨è­¯
    # - name: (macOS) æº–å‚™åœ–æ¨™
    #   if: runner.os == 'macOS'
    #   run: |
    #     echo "macOS å°‡ä½¿ç”¨ build.py è‡ªå‹•å¾ logo.ico è½‰æ›åœ–æ¨™"
    
    # ==================== Linux ç‰¹å®šè¨­ç½® ====================
    - name: (Linux) å®‰è£ç³»çµ±ä¾è³´
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y patchelf ccache fuse libfuse2 \
          libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
          libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
          libxcb-xfixes0 libxkbcommon-x11-0 \
          libgl1 libegl1 libxkbcommon0 libdbus-1-3 libglx-mesa0
    
    # ==================== Nuitka ç·¨è­¯ ====================
    - name: ä½¿ç”¨ Nuitka ç·¨è­¯
      run: python build.py
      continue-on-error: false
    
    # ==================== å¹³å°ç‰¹å®šå¾Œè™•ç† ====================
    - name: (Windows) å‰µå»ºå®‰è£ç¨‹åº
      if: runner.os == 'Windows'
      run: |
        choco install innosetup -y
        
        @'
        [Setup]
        AppName=ReversedFront
        AppVersion=2.9
        DefaultDirName={autopf}\ReversedFront
        DefaultGroupName=ReversedFront
        OutputDir=.
        OutputBaseFilename=ReversedFront-Setup
        Compression=lzma2
        SolidCompression=yes
        ArchitecturesInstallIn64BitMode=x64
        PrivilegesRequired=admin
        DisableProgramGroupPage=yes
        ; SignTool=signtool
        ; å¦‚éœ€æ•¸ä½ç°½ç« ï¼Œè«‹åœ¨ GitHub Secrets ä¸­æ·»åŠ è­‰æ›¸
        
        [Files]
        Source: "dist\main.dist\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{autoprograms}\ReversedFront"; Filename: "{app}\ReversedFront.exe"
        Name: "{autodesktop}\ReversedFront"; Filename: "{app}\ReversedFront.exe"
        
        [Run]
        Filename: "{app}\ReversedFront.exe"; Description: "å•Ÿå‹• ReversedFront"; Flags: postinstall nowait skipifsilent
        '@ | Out-File -FilePath "installer.iss" -Encoding UTF8
        
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
    
    # Windows æ•¸ä½ç°½ç« 
    - name: (Windows) æ•¸ä½ç°½ç« 
      if: runner.os == 'Windows'
      env:
        CERTIFICATE_BASE64: ${{ secrets.REVERSEDFRONT }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        if ([string]::IsNullOrEmpty($env:CERTIFICATE_BASE64)) {
            Write-Host "æœªé…ç½®è­‰æ›¸ï¼Œè·³éç°½ç« " -ForegroundColor Yellow
            exit 0
        }
        
        # å¾ Base64 è§£ç¢¼è­‰æ›¸
        $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
        [IO.File]::WriteAllBytes("temp-cert.pfx", $certBytes)
        
        # ç°½ç« å®‰è£ç¨‹åº
        & signtool sign /f "temp-cert.pfx" /p $env:CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com /td sha256 /fd sha256 `
          ReversedFront-Setup.exe
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "ç°½ç« å¤±æ•—!" -ForegroundColor Red
            exit 1
        }
        
        # åˆªé™¤è‡¨æ™‚è­‰æ›¸
        Remove-Item temp-cert.pfx
        
        Write-Host "æ•¸ä½ç°½ç« å·²å¥—ç”¨" -ForegroundColor Green
    
    - name: (macOS) å‰µå»º DMG
      if: runner.os == 'macOS'
      run: |
        # å‰µå»ºè‡¨æ™‚ç›®éŒ„
        mkdir -p dmg_temp
        cp -r dist/main.dist/ReversedFront.app dmg_temp/
        
        # å‰µå»º DMG
        hdiutil create -volname "ReversedFront" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          ReversedFront-macOS.dmg
        
        rm -rf dmg_temp
    
    - name: (Linux) å‰µå»º DEB å®‰è£åŒ…
      if: runner.os == 'Linux'
      run: |
        # å‰µå»º DEB åŒ…çµæ§‹
        mkdir -p ReversedFront_2.8.0/DEBIAN
        mkdir -p ReversedFront_2.8.0/opt/reversedfront
        mkdir -p ReversedFront_2.8.0/usr/share/applications
        mkdir -p ReversedFront_2.8.0/usr/share/icons/hicolor/256x256/apps
        
        # è¤‡è£½ç¨‹åºæ–‡ä»¶
        cp -r dist/main.dist/* ReversedFront_2.8.0/opt/reversedfront/
        
        # å‰µå»ºå•Ÿå‹•è…³æœ¬
        cat > ReversedFront_2.8.0/opt/reversedfront/reversedfront.sh << 'EOF'
        #!/bin/bash
        cd "$(dirname "$0")"
        ./ReversedFront "$@"
        EOF
        chmod +x ReversedFront_2.8.0/opt/reversedfront/reversedfront.sh
        
        # å‰µå»º desktop æ–‡ä»¶
        cat > ReversedFront_2.8.0/usr/share/applications/reversedfront.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=ReversedFront
        Comment=é€†çµ±æˆ°ï¼šçƒ½ç«è¼”åŠ©å·¥å…·
        Exec=/opt/reversedfront/reversedfront.sh
        Icon=reversedfront
        Terminal=false
        Categories=Game;Utility;
        EOF
        
        # è¤‡è£½åœ–æ¨™
        cp logo192.png ReversedFront_2.8.0/usr/share/icons/hicolor/256x256/apps/reversedfront.png
        
        # å‰µå»º control æ–‡ä»¶
        cat > ReversedFront_2.8.0/DEBIAN/control << 'EOF'
        Package: reversedfront
        Version: 2.9
        Section: games
        Priority: optional
        Architecture: amd64
        Maintainer: ESC <support@example.com>
        Description: é€†çµ±æˆ°ï¼šçƒ½ç«è¼”åŠ©å·¥å…·
         ReversedFront æ˜¯ä¸€å€‹è·¨å¹³å°çš„éŠæˆ²è¼”åŠ©å·¥å…·ã€‚
         ä½¿ç”¨ Nuitka åŸç”Ÿç·¨è­¯ï¼Œæ€§èƒ½å„ªç•°ã€‚
        EOF
        
        # æ§‹å»º DEB åŒ…
        dpkg-deb --build ReversedFront_2.8.0
        mv ReversedFront_2.8.0.deb ReversedFront-Linux.deb
    
    - name: ä¸Šå‚³ Linux DEB å®‰è£åŒ…
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Linux
        path: ReversedFront-Linux.deb
    
    - name: ä¸Šå‚³ Windows å®‰è£ç¨‹åº
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-Windows-Setup
        path: ReversedFront-Setup.exe
    
    - name: ä¸Šå‚³ macOS DMG
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: ReversedFront-macOS
        path: ReversedFront-macOS.dmg

  # ==================== å‰µå»º Release ====================
  release:
    name: å‰µå»º Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ä¸‹è¼‰æ‰€æœ‰ç”¢ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: åˆ—å‡ºä¸‹è¼‰çš„æ–‡ä»¶
      run: |
        echo "=== ä¸‹è¼‰çš„ artifacts çµæ§‹ ==="
        ls -R artifacts/
        echo "================================"
    
    - name: å‰µå»º Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/ReversedFront-Windows-Setup/ReversedFront-Setup.exe
          artifacts/ReversedFront-Linux/ReversedFront-Linux.deb
        draft: false
        prerelease: false
        generate_release_notes: true
        fail_on_unmatched_files: false
        body: |
          ## ğŸ‰ ReversedFront v2.9
          
          ### ğŸ“¦ ä¸‹è¼‰
          - **Windows**: ReversedFront-Setup.exe (å®‰è£ç¨‹åºï¼Œå·²æ•¸ä½ç°½ç« )
          - **Linux**: ReversedFront-Linux.deb (Debian å®‰è£åŒ…)
          - **macOS**: æš«ä¸æä¾›ï¼ˆPyQt6 é™åˆ¶ï¼‰
          
          ### ğŸ’¡ ä½¿ç”¨èªªæ˜
          **Windows**:
          - åŸ·è¡Œ ReversedFront-Setup.exe å®‰è£
          - å·²é€šéæ•¸ä½ç°½ç« é©—è­‰
          
          **Linux**:
          - å®‰è£: `sudo dpkg -i ReversedFront-Linux.deb`
          - å¦‚æœ‰ä¾è³´å•é¡Œ: `sudo apt-get install -f`
          - å•Ÿå‹•: å¾æ‡‰ç”¨ç¨‹åºé¸å–®æˆ–åŸ·è¡Œ `reversedfront`
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - Nuitka åŸç”Ÿç·¨è­¯ï¼Œæ€§èƒ½å„ªç•°
          - GPU ç¡¬ä»¶åŠ é€Ÿ
          - å®Œæ•´éŠæˆ²è³‡æºæ‰“åŒ…
          - è·¨å¹³å°æ”¯æŒï¼ˆWindows, Linuxï¼‰
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
