(()=>{"use strict";var __webpack_modules__={"./js/account/accountManager.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   autofillActiveAccount: () => (/* binding */ autofillActiveAccount),\n/* harmony export */   renderAccountManager: () => (/* binding */ renderAccountManager),\n/* harmony export */   setupLoginInterceptor: () => (/* binding */ setupLoginInterceptor)\n/* harmony export */ });\n/* harmony import */ var _core_api_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../core/api.js */ \"./js/core/api.js\");\n/* harmony import */ var _core_utils_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../core/utils.js */ \"./js/core/utils.js\");\n\r\n\r\n\r\n// 帳號管理模組\r\n\r\n// 用 window.currentSelectedAccountIdx 儲存目前選取的帳號 index\r\n// 第一次啟動時會優先依照後端的 active_account_index 對齊，\r\nif (typeof window.currentSelectedAccountIdx !== 'number') {\r\n    const savedIdx = sessionStorage.getItem('currentSelectedAccountIdx');\r\n    window.currentSelectedAccountIdx = savedIdx !== null ? parseInt(savedIdx) : 0;\r\n    window.accountIndexInitializedFromBackend = false;\r\n}\r\n// 之後才使用 sessionStorage 當作本次啟動過程中的快取。\r\n\r\nasync function renderAccountManager(accountSection, autofillActiveAccount) {\r\n    let accounts = [];\r\n    try {\r\n        accounts = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getAccounts();\r\n    } catch(e) {}\r\n\r\n    // 第一次啟動時：優先依照後端 active_account_index（getActiveAccount）\r\n    // 決定預設選取的帳號，之後就只依照目前記憶的 index。\r\n    if (!window.accountIndexInitializedFromBackend) {\r\n        try {\r\n            const activeAccount = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getActiveAccount();\r\n            if (activeAccount && activeAccount.account && Array.isArray(accounts) && accounts.length > 0) {\r\n                const idx = accounts.findIndex(a => a.account === activeAccount.account);\r\n                if (idx >= 0 && idx < accounts.length) {\r\n                    window.currentSelectedAccountIdx = idx;\r\n                }\r\n            }\r\n        } catch (e) {}\r\n\r\n        // 若後端沒有給或超出範圍，仍然用原本的 sessionStorage 值（在頂部已初始化）\r\n        if (!Number.isInteger(window.currentSelectedAccountIdx) || window.currentSelectedAccountIdx < 0 || window.currentSelectedAccountIdx >= accounts.length) {\r\n            window.currentSelectedAccountIdx = 0;\r\n        }\r\n\r\n        sessionStorage.setItem('currentSelectedAccountIdx', window.currentSelectedAccountIdx);\r\n        window.accountIndexInitializedFromBackend = true;\r\n    }\r\n\r\n    // 首次渲染時，嘗試依照後端的 active_account_index 對齊預設選取帳號\r\n    if (window.__TAURI__?.core && !window.accountIndexInitializedFromBackend) {\r\n        try {\r\n            const activeAccount = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getActiveAccount();\r\n            if (activeAccount && activeAccount.account) {\r\n                const idx = accounts.findIndex(a => a.account === activeAccount.account);\r\n                if (idx !== -1) {\r\n                    window.currentSelectedAccountIdx = idx;\r\n                    sessionStorage.setItem('currentSelectedAccountIdx', idx);\r\n                }\r\n            }\r\n        } catch (e) {\r\n            // 忽略錯誤，後續會用預設 0 處理\r\n        } finally {\r\n            window.accountIndexInitializedFromBackend = true;\r\n        }\r\n    }\r\n\r\n    // 若目前選取 index 超出範圍，自動歸零\r\n    if (window.currentSelectedAccountIdx >= accounts.length) {\r\n        window.currentSelectedAccountIdx = 0;\r\n        sessionStorage.setItem('currentSelectedAccountIdx', 0);\r\n    }\r\n    let html = '';\r\n    html += '<div style=\"margin-bottom:8px;font-size:1em;\">帳號管理</div>';\r\n    html += '<div id=\"account-list\" style=\"min-height:60px;max-height:120px;overflow-y:auto;margin-bottom:8px;\">';\r\n    accounts.forEach((acc, i) => {\r\n        html += `<div style=\"display:flex;align-items:center;margin-bottom:2px;\">\r\n            <input type=\"radio\" name=\"account-radio\" value=\"${i}\" ${i===window.currentSelectedAccountIdx?'checked':''} style=\"margin-right:6px;\">\r\n            <span style=\"flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${acc.account}</span>\r\n            <button type=\"button\" class=\"del-account-btn\" data-idx=\"${i}\" style=\"margin-left:6px;background:#333;color:#fff;border:none;border-radius:3px;padding:2px 7px;cursor:pointer;\">刪除</button>\r\n        </div>`;\r\n    });\r\n    html += '</div>';\r\n    html += `<button id=\"show-add-account\" style=\"background:#444;color:#fff;border:none;padding:6px 0;border-radius:6px;cursor:pointer;width:100%;margin-bottom:4px;\">新增帳號</button>`;\r\n    html += `<form id=\"add-account-form\" style=\"display:none;flex-direction:column;gap:4px;margin-bottom:4px;\">\r\n        <input id=\"add-account-input\" type=\"text\" placeholder=\"帳號\" style=\"padding:5px;border-radius:4px;border:1px solid #444;background:#222;color:#fff;\">\r\n        <input id=\"add-password-input\" type=\"password\" placeholder=\"密碼\" style=\"padding:5px;border-radius:4px;border:1px solid #444;background:#222;color:#fff;\">\r\n        <button type=\"submit\" style=\"background:#444;color:#fff;border:none;padding:6px 0;border-radius:6px;cursor:pointer;\">儲存</button>\r\n    </form>`;\r\n    accountSection.innerHTML = html;\r\n    (0,_core_utils_js__WEBPACK_IMPORTED_MODULE_1__.$)(\"#show-add-account\").onclick = function() {\r\n        (0,_core_utils_js__WEBPACK_IMPORTED_MODULE_1__.$)(\"#add-account-form\").style.display = 'flex';\r\n        this.style.display = 'none';\r\n    };\r\n    document.querySelectorAll('input[name=\"account-radio\"]').forEach(radio => {\r\n        radio.onchange = async function() {\r\n            window.currentSelectedAccountIdx = parseInt(this.value);\r\n            sessionStorage.setItem('currentSelectedAccountIdx', window.currentSelectedAccountIdx);\r\n\r\n            // 同步後端的 active_account_index，確保重啟後仍維持同一個帳號\r\n            try {\r\n                await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.setActiveAccount(window.currentSelectedAccountIdx);\r\n            } catch (e) {}\r\n\r\n            renderAccountManager(accountSection, autofillActiveAccount);\r\n            autofillActiveAccount();\r\n            // 切換帳號時自動同步音量UI（含se147_muted）\r\n            if (window.syncAudioControlsWithConfig && window.__TAURI__?.core) {\r\n                try {\r\n                    const accounts = await window.__TAURI__.core.invoke('get_accounts');\r\n                    const accountIdx = parseInt(this.value);\r\n                    if (accounts && accountIdx < accounts.length) {\r\n                        const targetAccount = accounts[accountIdx];\r\n                        window.syncAudioControlsWithConfig(targetAccount);\r\n                    } else {\r\n                        window.syncAudioControlsWithConfig();\r\n                    }\r\n                } catch (e) {\r\n                    window.syncAudioControlsWithConfig();\r\n                }\r\n            }\r\n            // 切換帳號時同步戰報通知過濾 select\r\n            if (window.syncFactionFilterFromConfig) {\r\n                setTimeout(window.syncFactionFilterFromConfig, 300);\r\n            }\r\n            // 新增：同步控制面板帳號 select 狀態\r\n            const accountSelect = document.getElementById('account-select');\r\n            if (accountSelect) {\r\n                accountSelect.selectedIndex = window.currentSelectedAccountIdx;\r\n                accountSelect.dispatchEvent(new Event('change', { bubbles: true }));\r\n            }\r\n        };\r\n    });\r\n    document.querySelectorAll('.del-account-btn').forEach(btn => {\r\n        btn.onclick = async function() {\r\n            await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.deleteAccount(parseInt(this.dataset.idx));\r\n            // 若刪除的是目前選取的帳號，index 歸零\r\n            if (window.currentSelectedAccountIdx >= accounts.length - 1) window.currentSelectedAccountIdx = 0;\r\n            sessionStorage.setItem('currentSelectedAccountIdx', window.currentSelectedAccountIdx);\r\n            renderAccountManager(accountSection, autofillActiveAccount);\r\n        };\r\n    });\r\n    (0,_core_utils_js__WEBPACK_IMPORTED_MODULE_1__.$)(\"#add-account-form\").onsubmit = async function(e) {\r\n        e.preventDefault();\r\n        const account = (0,_core_utils_js__WEBPACK_IMPORTED_MODULE_1__.$)(\"#add-account-input\").value;\r\n        const password = (0,_core_utils_js__WEBPACK_IMPORTED_MODULE_1__.$)(\"#add-password-input\").value;\r\n        if(account && password) {\r\n            await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.addAccount({account,password});\r\n            // 新增帳號後自動選到最後一個\r\n            window.currentSelectedAccountIdx = accounts.length;\r\n            sessionStorage.setItem('currentSelectedAccountIdx', window.currentSelectedAccountIdx);\r\n            renderAccountManager(accountSection, autofillActiveAccount);\r\n            autofillActiveAccount();\r\n        }\r\n    };\r\n}\r\n\r\n// 自動攔截登入並保存帳號\r\nfunction setupLoginInterceptor(accountSection, autofillActiveAccount) {\r\n    const checkAndAttachInterceptor = () => {\r\n        // 嘗試更通用的選擇器策略\r\n        let formBox = document.querySelector('.Login_loginFormBox__LKcQJ');\r\n        \r\n        // 如果找不到特定 class，嘗試尋找包含密碼輸入框的容器\r\n        if (!formBox) {\r\n            const pwdInput = document.querySelector('input[type=\"password\"]');\r\n            if (pwdInput) {\r\n                // 往上找直到找到看起來像表單容器的元素 (通常有 button)\r\n                let parent = pwdInput.parentElement;\r\n                let depth = 0;\r\n                while (parent && parent !== document.body && depth < 5) {\r\n                    if (parent.querySelector('button') || parent.querySelector('[class*=\"Btn\"]')) {\r\n                        formBox = parent;\r\n                        break;\r\n                    }\r\n                    parent = parent.parentElement;\r\n                    depth++;\r\n                }\r\n            }\r\n        }\r\n\r\n        // 確保只綁定一次\r\n        if (formBox && !formBox.dataset.interceptorAttached) {\r\n            // 尋找按鈕：多種策略\r\n            let loginBtn = formBox.querySelector('.Login_formBtn__L1ZuE');\r\n            if (!loginBtn) loginBtn = formBox.querySelector('button');\r\n            if (!loginBtn) loginBtn = formBox.querySelector('input[type=\"submit\"]');\r\n            if (!loginBtn) loginBtn = formBox.querySelector('[class*=\"Btn\"]'); // 包含 Btn 的 class\r\n            if (!loginBtn) loginBtn = formBox.querySelector('[class*=\"btn\"]'); // 包含 btn 的 class\r\n            if (!loginBtn) loginBtn = formBox.querySelector('[role=\"button\"]'); // role=\"button\"\r\n            \r\n            const accountInput = formBox.querySelector('input[type=\"text\"]');\r\n            const passwordInput = formBox.querySelector('input[type=\"password\"]');\r\n\r\n            if (accountInput && passwordInput) {\r\n                formBox.dataset.interceptorAttached = 'true';\r\n                \r\n                const saveAccount = async () => {\r\n                    const account = accountInput.value;\r\n                    const password = passwordInput.value;\r\n                    \r\n                    if (account && password) {\r\n                        try {\r\n                            // 新增或更新帳號 (後端會處理重複並更新密碼)\r\n                            await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.addAccount({account, password});\r\n\r\n                            // 獲取最新帳號列表以找到索引\r\n                            const accounts = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getAccounts();\r\n                            const idx = accounts.findIndex(a => a.account === account);\r\n                            \r\n                            if (idx !== -1) {\r\n                                // 更新當前選擇\r\n                                window.currentSelectedAccountIdx = idx;\r\n                                sessionStorage.setItem('currentSelectedAccountIdx', idx);\r\n                                \r\n                                // 更新 UI\r\n                                if (accountSection) {\r\n                                    renderAccountManager(accountSection, autofillActiveAccount);\r\n                                }\r\n                                \r\n                                // 同步音量等設定\r\n                                if (window.syncAudioControlsWithConfig) {\r\n                                    window.syncAudioControlsWithConfig(accounts[idx]);\r\n                                }\r\n                                \r\n                                // 同步戰報過濾\r\n                                if (window.syncFactionFilterFromConfig) {\r\n                                    setTimeout(window.syncFactionFilterFromConfig, 300);\r\n                                }\r\n                                \r\n                                // 同步控制面板 select\r\n                                const accountSelect = document.getElementById('account-select');\r\n                                if (accountSelect) {\r\n                                    accountSelect.selectedIndex = idx;\r\n                                    accountSelect.dispatchEvent(new Event('change', { bubbles: true }));\r\n                                }\r\n\r\n                                // 同步後端 active_account_index\r\n                                try {\r\n                                    await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.setActiveAccount(idx);\r\n                                } catch (e) {}\r\n                            }\r\n                        } catch (e) {\r\n                            console.error('Failed to save account on login:', e);\r\n                        }\r\n                    }\r\n                };\r\n\r\n                if (loginBtn) {\r\n                    // 監聽點擊事件 (使用 mousedown 確保在頁面跳轉前觸發)\r\n                    loginBtn.addEventListener('mousedown', saveAccount);\r\n                    // 備用：click\r\n                    loginBtn.addEventListener('click', (e) => {\r\n                        // 這裡不做事，依賴 mousedown，或者如果 mousedown 沒觸發(例如鍵盤操作)\r\n                    });\r\n                }\r\n                \r\n                // 監聽 Enter 鍵\r\n                const handleEnter = (e) => {\r\n                    if (e.key === 'Enter') {\r\n                        saveAccount();\r\n                    }\r\n                };\r\n                passwordInput.addEventListener('keydown', handleEnter);\r\n                accountInput.addEventListener('keydown', handleEnter);\r\n            }\r\n        }\r\n    };\r\n\r\n    // 使用 MutationObserver 監控登入表單的出現\r\n    const observer = new MutationObserver((mutations) => {\r\n        checkAndAttachInterceptor();\r\n    });\r\n\r\n    observer.observe(document.body, { childList: true, subtree: true });\r\n    \r\n    // 立即檢查一次\r\n    checkAndAttachInterceptor();\r\n}\r\n\r\n// 自動登入功能\r\nwindow.autoLogin = function(account, password) {\r\n    if (!location.hash.startsWith('#/users/log_in')) return;\r\n    let tryCount = 0;\r\n    let fillTimer = setInterval(function() {\r\n        // 若已經跳轉到 home，直接結束輪詢\r\n        if (location.hash.startsWith('#/home')) {\r\n            clearInterval(fillTimer);\r\n            return;\r\n        }\r\n        var loginBtn = document.querySelector('.Login_loginRow1__idwSI .Login_formBtn__L1ZuE');\r\n        if (loginBtn) {\r\n            ['mousedown','mouseup','click'].forEach(ev => {\r\n                loginBtn.dispatchEvent(new MouseEvent(ev, { bubbles: true }));\r\n            });\r\n        }\r\n        var formBox = document.querySelector('.Login_loginFormBox__LKcQJ');\r\n        if (formBox) {\r\n            var accountInput = formBox.querySelector('input[type=\"text\"]');\r\n            var passwordInput = formBox.querySelector('input[type=\"password\"]');\r\n            if (accountInput && passwordInput) {\r\n                var nativeSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;\r\n                nativeSetter.call(accountInput, account);\r\n                nativeSetter.call(passwordInput, password);\r\n                ['input','change','blur'].forEach(ev => {\r\n                    accountInput.dispatchEvent(new Event(ev, { bubbles: true }));\r\n                    passwordInput.dispatchEvent(new Event(ev, { bubbles: true }));\r\n                });\r\n                clearInterval(fillTimer);\r\n                // 輪詢等待確定按鈕出現再點擊（模擬滑鼠點擊）\r\n                let submitTry = 0;\r\n                let submitTimer = setInterval(function() {\r\n                    if (location.hash.startsWith('#/home')) {\r\n                        clearInterval(submitTimer);\r\n                        return;\r\n                    }\r\n                    var submitBtn = formBox.querySelector('.Login_formBtn__L1ZuE.ClickEffect');\r\n                    if (submitBtn) {\r\n                        ['mousedown','mouseup','click'].forEach(ev => {\r\n                            submitBtn.dispatchEvent(new MouseEvent(ev, { bubbles: true }));\r\n                        });\r\n                        clearInterval(submitTimer);\r\n                    }\r\n                    if (++submitTry > 30) clearInterval(submitTimer);\r\n                }, 200);\r\n            }\r\n        }\r\n        if (++tryCount > 30) {\r\n            clearInterval(fillTimer);\r\n        }\r\n    }, 200);\r\n};\r\n\r\nasync function autofillActiveAccount() {\r\n    let savedAccount = null;\r\n    try {\r\n        savedAccount = await getCurrentSelectedAccountForLogin();\r\n    } catch(e) {}\r\n    if(savedAccount) {\r\n        console.log(`自動填入將使用選擇的帳號: ${savedAccount.account}`);\r\n        let tryCount = 0;\r\n        let autofillTimer = setInterval(function() {\r\n            let accountInput = Array.from(document.querySelectorAll('input'))\r\n                .filter(el => !el.closest('#custom-controls'))\r\n                .find(el => el.placeholder && el.placeholder.includes('帳號'));\r\n            let passwordInput = Array.from(document.querySelectorAll('input'))\r\n                .filter(el => !el.closest('#custom-controls'))\r\n                .find(el => el.type === 'password');\r\n            if (!accountInput || !passwordInput) {\r\n                const inputs = Array.from(document.querySelectorAll('input'))\r\n                    .filter(el => !el.closest('#custom-controls'));\r\n                if (inputs.length >= 2) {\r\n                    accountInput = inputs[0];\r\n                    passwordInput = inputs[1];\r\n                }\r\n            }\r\n            if (accountInput && passwordInput) {\r\n                const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;\r\n                nativeInputValueSetter.call(accountInput, savedAccount.account);\r\n                nativeInputValueSetter.call(passwordInput, savedAccount.password);\r\n                ['input','change','blur'].forEach(ev=>{\r\n                    accountInput.dispatchEvent(new Event(ev, { bubbles: true }));\r\n                    passwordInput.dispatchEvent(new Event(ev, { bubbles: true }));\r\n                });\r\n                const loginBtn = Array.from(document.querySelectorAll('div[class*=\"Login_text__SoiB+\"]')).find(div => {\r\n                    return Array.from(div.querySelectorAll('*')).some(\r\n                        el => el.textContent && el.textContent.includes('帳號登入')\r\n                    );\r\n                });\r\n                if(loginBtn) {\r\n                    ['mousedown','mouseup','click'].forEach(ev=>{\r\n                        loginBtn.dispatchEvent(new MouseEvent(ev, { bubbles: true }));\r\n                    });\r\n                } else {\r\n                    const btn = Array.from(document.querySelectorAll('button,input[type=\"button\"],input[type=\"submit\"]')).find(\r\n                        el => el.textContent.includes('登入') || el.value === '登入'\r\n                    );\r\n                    if(btn) {\r\n                        ['mousedown','mouseup','click'].forEach(ev=>{\r\n                            btn.dispatchEvent(new MouseEvent(ev, { bubbles: true }));\r\n                        });\r\n                    }\r\n                }\r\n                clearInterval(autofillTimer);\r\n            }\r\n            if(++tryCount > 20) clearInterval(autofillTimer);\r\n        }, 800);\r\n    }\r\n}\r\n\r\n// 獲取當前應該用來自動登入的帳號\r\n// 這裡統一依照後端的 active_account_index 決定，\r\n// 而功能選單在切換帳號時會呼叫 setActiveAccount 保持同步。\r\nasync function getCurrentSelectedAccountForLogin() {\r\n    try {\r\n        // 優先使用後端記錄的 active account（與功能選單同步）\r\n        const activeAccount = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getActiveAccount();\r\n        if (activeAccount && activeAccount.account && activeAccount.password) {\r\n            console.log(`自動登入將使用後端活動帳號: ${activeAccount.account}`);\r\n            return activeAccount;\r\n        }\r\n\r\n        // 如果尚未設定 active，退回到帳號列表中的第一個\r\n        const accounts = await _core_api_js__WEBPACK_IMPORTED_MODULE_0__.getAccounts();\r\n        if (accounts && accounts.length > 0) {\r\n            const first = accounts[0];\r\n            console.log(`自動登入找不到活動帳號，改用第一個帳號: ${first.account}`);\r\n            return first;\r\n        }\r\n\r\n        return null;\r\n    } catch (e) {\r\n        console.error('獲取當前選擇帳號失敗:', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// 進入 /#/users/log_in 頁面自動觸發 autoLogin\r\nwindow.addEventListener('hashchange', async function() {\r\n    if (location.hash.startsWith('#/users/log_in')) {\r\n        try {\r\n            const savedAccount = await getCurrentSelectedAccountForLogin();\r\n            if (savedAccount && savedAccount.account && savedAccount.password) {\r\n                setTimeout(() => {\r\n                    window.autoLogin(savedAccount.account, savedAccount.password);\r\n                }, 300); // 延遲以確保畫面渲染完成\r\n            }\r\n        } catch(e) {}\r\n    }\r\n});\r\n// 若一開始就位於登入頁，也要觸發\r\nif (location.hash.startsWith('#/users/log_in')) {\r\n    (async () => {\r\n        try {\r\n            const savedAccount = await getCurrentSelectedAccountForLogin();\r\n            if (savedAccount && savedAccount.account && savedAccount.password) {\r\n                setTimeout(() => {\r\n                    window.autoLogin(savedAccount.account, savedAccount.password);\r\n                }, 300);\r\n            }\r\n        } catch(e) {}\r\n    })();\r\n}\r\n\r\n// 監控 hash 變化，方便 SPA/React 路由偵測\r\nwindow.addEventListener('hashchange', function() {});\r\n\r\n// 輪詢 hash 變化，防止 React Router 沒有觸發 hashchange\r\nlet lastHash = location.hash;\r\nlet hashPollTimer = setInterval(() => {\r\n    if (location.hash !== lastHash) {\r\n        if (location.hash.startsWith('#/users/log_in')) {\r\n            (async () => {\r\n                try {\r\n                    const savedAccount = await getCurrentSelectedAccountForLogin();\r\n                    if (savedAccount && savedAccount.account && savedAccount.password) {\r\n                        setTimeout(() => {\r\n                            window.autoLogin(savedAccount.account, savedAccount.password);\r\n                        }, 300);\r\n                    }\r\n                } catch(e) {}\r\n            })();\r\n        }\r\n        // 若已經跳轉到 home，直接結束 hash 輪詢\r\n        if (location.hash.startsWith('#/home')) {\r\n            clearInterval(hashPollTimer);\r\n        }\r\n        lastHash = location.hash;\r\n    }\r\n}, 300);\n\n//# sourceURL=webpack://reversedfront-mod/./js/account/accountManager.js?\n}")},"./js/audio/audioControls.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupAudioControls: () => (/* binding */ setupAudioControls)\n/* harmony export */ });\n// 音量與通知控制\r\nfunction setupAudioControls(controlsPanel) {\r\n    // 獲取前端當前選中的帳號資訊\r\n    function getCurrentSelectedAccount() {\r\n        const selectedRadio = document.querySelector('input[name=\"account-radio\"]:checked');\r\n        if (selectedRadio) {\r\n            const accountIdx = parseInt(selectedRadio.value);\r\n            const accountSpan = selectedRadio.parentElement.querySelector('span');\r\n            if (accountSpan) {\r\n                const accountName = accountSpan.textContent.trim();\r\n                // 這裡我們只能取得帳號名稱，密碼需要從 API 獲取\r\n                return { accountName, accountIdx };\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // 獲取完整的帳號資訊（包含密碼）\r\n    async function getCurrentAccountData() {\r\n        const selected = getCurrentSelectedAccount();\r\n        if (!selected) return null;\r\n        \r\n        try {\r\n            if (!window.__TAURI__?.core) return null;\r\n            const accounts = await window.__TAURI__.core.invoke('get_accounts');\r\n            if (accounts && selected.accountIdx < accounts.length) {\r\n                return accounts[selected.accountIdx];\r\n            }\r\n        } catch (e) {\r\n            console.error('獲取帳號列表失敗:', e);\r\n        }\r\n        return null;\r\n    }\r\n\r\n    if (!document.getElementById('rf-audio-controls')) {\r\n        const audioContainer = document.createElement('div');\r\n        audioContainer.id = 'rf-audio-controls';\r\n        audioContainer.innerHTML = `\r\n            <div style=\"border-top: 1px solid #555; margin: 16px 0 12px 0;\"></div>\r\n            <div style=\"margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; font-size: 0.95em;\">\r\n                <label for=\"bgm-volume-slider\" style=\"margin-right: 10px;\">BGM音量</label>\r\n                <input type=\"range\" id=\"bgm-volume-slider\" min=\"0\" max=\"1\" step=\"0.01\" value=\"0\" style=\"flex-grow: 1; margin: 0 8px; accent-color:#2a7cff;\">\r\n                <span class=\"volume-value\" style=\"width: 30px; text-align: right; font-variant-numeric: tabular-nums;\">0</span>\r\n            </div>\r\n            <div style=\"margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; font-size: 0.95em;\">\r\n                <label for=\"se-volume-slider\" style=\"margin-right: 10px;\">音效音量</label>\r\n                <input type=\"range\" id=\"se-volume-slider\" min=\"0\" max=\"1\" step=\"0.01\" value=\"0\" style=\"flex-grow: 1; margin: 0 8px; accent-color:#1dbf60;\">\r\n                <span class=\"volume-value\" style=\"width: 30px; text-align: right; font-variant-numeric: tabular-nums;\">0</span>\r\n            </div>\r\n            <div style=\"margin-bottom: 4px;\">\r\n                <button id=\"se147-toggle-button\" style=\"width:100%; background:#d9534f; color:#fff; border:none; padding:8px 0; border-radius:6px; cursor:pointer; font-size: 0.95em; transition: background-color 0.2s;\">戰報通知：關</button>\r\n                <input type=\"checkbox\" id=\"se147-toggle\" style=\"display: none;\">\r\n            </div>\r\n        `;\r\n        controlsPanel.appendChild(audioContainer);\r\n        // 在 DOM 元素創建後立即嘗試同步設定（移除同步音量按鈕）\r\n        setTimeout(() => {\r\n            if (!hasSynced) {\r\n                initialSync();\r\n            }\r\n        }, 50);\r\n    }\r\n    window.updateCustomControlsUI = function(cfg) {\r\n        if (!cfg) {\r\n            console.warn('updateCustomControlsUI: 沒有提供配置數據');\r\n            return;\r\n        }\r\n        \r\n        console.log('updateCustomControlsUI: 更新音量控制 UI，配置:', cfg);\r\n        \r\n        const bgmSlider = document.getElementById('bgm-volume-slider');\r\n        const bgmValueSpan = bgmSlider ? bgmSlider.parentElement.querySelector('.volume-value') : null;\r\n        if (bgmSlider && typeof cfg.bgm === 'number') {\r\n            console.log(`更新 BGM 滑塊: ${cfg.bgm}`);\r\n            bgmSlider.value = cfg.bgm;\r\n            if (bgmValueSpan) bgmValueSpan.textContent = Math.round(cfg.bgm * 100);\r\n            \r\n            // 實際應用 BGM 音量到音頻系統\r\n            window._rf_bgm_volume = cfg.bgm;\r\n            if (window._rf_bgmGainNodes && Array.isArray(window._rf_bgmGainNodes)) {\r\n                window._rf_bgmGainNodes.forEach(node => {\r\n                    if (node && node.gain) node.gain.value = cfg.bgm;\r\n                });\r\n            }\r\n            if (window.setMediaVolume) window.setMediaVolume();\r\n        } else {\r\n            console.warn('updateCustomControlsUI: BGM 滑塊不存在或 BGM 值無效');\r\n        }\r\n        \r\n        const seSlider = document.getElementById('se-volume-slider');\r\n        const seValueSpan = seSlider ? seSlider.parentElement.querySelector('.volume-value') : null;\r\n        if (seSlider && typeof cfg.se === 'number') {\r\n            console.log(`更新 SE 滑塊: ${cfg.se}`);\r\n            seSlider.value = cfg.se;\r\n            if (seValueSpan) seValueSpan.textContent = Math.round(cfg.se * 100);\r\n            \r\n            // 實際應用 SE 音量到音頻系統\r\n            window._rf_se_volume = cfg.se;\r\n            if (window._rf_seGainNodes && Array.isArray(window._rf_seGainNodes)) {\r\n                window._rf_seGainNodes.forEach(node => {\r\n                    if (node && node.gain) node.gain.value = cfg.se;\r\n                });\r\n            }\r\n            if (window.setMediaVolume) window.setMediaVolume();\r\n            if (window.updateSe147Volume) window.updateSe147Volume();\r\n        } else {\r\n            console.warn('updateCustomControlsUI: SE 滑塊不存在或 SE 值無效');\r\n        }\r\n        \r\n        // 強制以 window._rf_se147Muted 為唯一依據刷新 UI\r\n        const se147Toggle = document.getElementById('se147-toggle');\r\n        const se147Button = document.getElementById('se147-toggle-button');\r\n        if (se147Toggle && se147Button) {\r\n            const muted = (typeof cfg.se147Muted === 'boolean') ? cfg.se147Muted : !!window._rf_se147Muted;\r\n            console.log(`更新 SE147 切換按鈕: ${muted}`);\r\n            se147Toggle.checked = muted;\r\n            se147Button.textContent = `戰報通知：${!muted ? '開' : '關'}`;\r\n            se147Button.style.backgroundColor = !muted ? '#5cb85c' : '#d9534f';\r\n            window._rf_se147Muted = muted;\r\n            // 實際應用 SE147 靜音狀態\r\n            if (window.updateSe147Volume) window.updateSe147Volume();\r\n        } else {\r\n            console.warn('updateCustomControlsUI: SE147 切換按鈕不存在');\r\n        }\r\n        \r\n        console.log('updateCustomControlsUI: UI 更新完成');\r\n    };\r\n    const bgmSlider = document.getElementById('bgm-volume-slider');\r\n    if (bgmSlider) {\r\n        // 防止連續多次觸發保存\r\n        let bgmSaveTimeout = null;\r\n        let isBgmSliding = false;  // 追蹤是否正在滑動\r\n        \r\n        // 滑動開始時 - 滑鼠和觸控支援\r\n        bgmSlider.addEventListener('mousedown', function() {\r\n            isBgmSliding = true;\r\n            clearTimeout(bgmSaveTimeout);  // 清除先前的保存計時器\r\n        });\r\n        \r\n        bgmSlider.addEventListener('touchstart', function() {\r\n            isBgmSliding = true;\r\n            clearTimeout(bgmSaveTimeout);  // 清除先前的保存計時器\r\n        });\r\n        \r\n        // 滑動過程中更新，但不保存\r\n        bgmSlider.addEventListener('input', function() {\r\n            const value = Number(this.value);\r\n            \r\n            // 立即更新 UI 和播放\r\n            this.parentElement.querySelector('.volume-value').textContent = Math.round(value * 100);\r\n            if (window.setBGMVolume) {\r\n                // 只設置內存中的值，不觸發保存\r\n                window._rf_bgm_volume = value;\r\n                // 確保 _rf_bgmGainNodes 存在且是陣列\r\n                if (window._rf_bgmGainNodes && Array.isArray(window._rf_bgmGainNodes)) {\r\n                    window._rf_bgmGainNodes.forEach(node => {\r\n                        if (node && node.gain) node.gain.value = value;\r\n                    });\r\n                }\r\n                if (window.setMediaVolume) window.setMediaVolume();\r\n            }\r\n            \r\n            // 滑動過程中不保存，只在滑動結束時保存\r\n            clearTimeout(bgmSaveTimeout);\r\n        });\r\n        \r\n        // 滑動結束時 - 滑鼠和觸控支援\r\n        document.addEventListener('mouseup', function() {\r\n            if (isBgmSliding) {\r\n                isBgmSliding = false;\r\n                \r\n                // 滑動結束後執行一次保存\r\n                const value = Number(bgmSlider.value);\r\n                if (window.__TAURI__?.core) {\r\n                    getCurrentAccountData().then(targetAccount => {\r\n                        const saveData = {\r\n                            bgm: value,\r\n                            se: null,  // 不傳入則不更新\r\n                            se147Muted: null  // 不傳入則不更新\r\n                        };\r\n                        if (targetAccount) {\r\n                            saveData.target_account = targetAccount;\r\n                        }\r\n                        window.__TAURI__.core.invoke('save_config_volume', { data: JSON.stringify(saveData) }).catch(e => { \r\n                            console.error('音量設定保存失敗', e); \r\n                        });\r\n                    });\r\n                }\r\n            }\r\n        });\r\n        \r\n        // 觸控結束支援\r\n        document.addEventListener('touchend', function() {\r\n            if (isBgmSliding) {\r\n                isBgmSliding = false;\r\n                \r\n                // 滑動結束後執行一次保存\r\n                const value = Number(bgmSlider.value);\r\n                if (window.__TAURI__?.core) {\r\n                    getCurrentAccountData().then(targetAccount => {\r\n                        const saveData = {\r\n                            bgm: value,\r\n                            se: null,  // 不傳入則不更新\r\n                            se147Muted: null  // 不傳入則不更新\r\n                        };\r\n                        if (targetAccount) {\r\n                            saveData.target_account = targetAccount;\r\n                        }\r\n                        window.__TAURI__.core.invoke('save_config_volume', { data: JSON.stringify(saveData) }).catch(e => { \r\n                            console.error('音量設定保存失敗', e); \r\n                        });\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    const seSlider = document.getElementById('se-volume-slider');\r\n    if (seSlider) {\r\n        // 防止連續多次觸發保存\r\n        let seSaveTimeout = null;\r\n        let isSeSliding = false;   // 追蹤是否正在滑動\r\n        \r\n        // 滑動開始時 - 滑鼠和觸控支援\r\n        seSlider.addEventListener('mousedown', function() {\r\n            isSeSliding = true;\r\n            clearTimeout(seSaveTimeout);  // 清除先前的保存計時器\r\n        });\r\n        \r\n        seSlider.addEventListener('touchstart', function() {\r\n            isSeSliding = true;\r\n            clearTimeout(seSaveTimeout);  // 清除先前的保存計時器\r\n        });\r\n        \r\n        // 滑動過程中更新，但不保存\r\n        seSlider.addEventListener('input', function() {\r\n            const value = Number(this.value);\r\n            \r\n            // 立即更新 UI 和播放\r\n            this.parentElement.querySelector('.volume-value').textContent = Math.round(value * 100);\r\n            if (window.setSEVolume) {\r\n                // 只設置內存中的值，不觸發保存\r\n                window._rf_se_volume = value;\r\n                // 確保 _rf_seGainNodes 存在且是陣列\r\n                if (window._rf_seGainNodes && Array.isArray(window._rf_seGainNodes)) {\r\n                    window._rf_seGainNodes.forEach(node => {\r\n                        if (node && node.gain) node.gain.value = value;\r\n                    });\r\n                }\r\n                if (window.setMediaVolume) window.setMediaVolume();\r\n                if (window.updateSe147Volume) window.updateSe147Volume();\r\n            }\r\n            \r\n            // 滑動過程中不保存，只在滑動結束時保存\r\n            clearTimeout(seSaveTimeout);\r\n        });\r\n        \r\n        // 滑動結束時 - 滑鼠和觸控支援\r\n        document.addEventListener('mouseup', function() {\r\n            if (isSeSliding) {\r\n                isSeSliding = false;\r\n                \r\n                // 滑動結束後執行一次保存\r\n                const value = Number(seSlider.value);\r\n                if (window.__TAURI__?.core) {\r\n                    getCurrentAccountData().then(targetAccount => {\r\n                        const saveData = {\r\n                            bgm: null,  // 不傳入則不更新\r\n                            se: value,\r\n                            se147Muted: null  // 不傳入則不更新\r\n                        };\r\n                        if (targetAccount) {\r\n                            saveData.target_account = targetAccount;\r\n                        }\r\n                        window.__TAURI__.core.invoke('save_config_volume', { data: JSON.stringify(saveData) }).catch(e => { \r\n                            console.error('音量設定保存失敗', e); \r\n                        });\r\n                    });\r\n                }\r\n            }\r\n        });\r\n        \r\n        // 觸控結束支援\r\n        document.addEventListener('touchend', function() {\r\n            if (isSeSliding) {\r\n                isSeSliding = false;\r\n                \r\n                // 滑動結束後執行一次保存\r\n                const value = Number(seSlider.value);\r\n                if (window.__TAURI__?.core) {\r\n                    getCurrentAccountData().then(targetAccount => {\r\n                        const saveData = {\r\n                            bgm: null,  // 不傳入則不更新\r\n                            se: value,\r\n                            se147Muted: null  // 不傳入則不更新\r\n                        };\r\n                        if (targetAccount) {\r\n                            saveData.target_account = targetAccount;\r\n                        }\r\n                        window.__TAURI__.core.invoke('save_config_volume', { data: JSON.stringify(saveData) }).catch(e => { \r\n                            console.error('音量設定保存失敗', e); \r\n                        });\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n    const se147Button = document.getElementById('se147-toggle-button');\r\n    const se147Toggle = document.getElementById('se147-toggle');\r\n    // 檢查是否已經綁定過事件監聽器，避免重複綁定\r\n    if (se147Button && se147Toggle && !se147Button.dataset.listenerAttached) {\r\n        // 標記已綁定\r\n        se147Button.dataset.listenerAttached = 'true';\r\n        \r\n        // 使用一個變量跟踪操作狀態，避免重複操作\r\n        let isWriting = false;\r\n        let lastClickTime = 0;\r\n        \r\n        // 更新按鈕UI的輔助函數，確保視覺呈現與狀態一致\r\n        const updateSe147ButtonUI = (muted) => {\r\n            se147Toggle.checked = muted;\r\n            se147Button.textContent = `戰報通知：${!muted ? '開' : '關'}`;\r\n            se147Button.style.backgroundColor = !muted ? '#5cb85c' : '#d9534f';\r\n        };\r\n        \r\n        se147Button.addEventListener('click', async function() {\r\n            // 防止快速雙擊（300ms內的第二次點擊會被忽略）\r\n            const now = Date.now();\r\n            if (now - lastClickTime < 300) {\r\n                console.log('點擊過快，忽略');\r\n                return;\r\n            }\r\n            lastClickTime = now;\r\n            if (isWriting) return;\r\n            isWriting = true;\r\n            se147Button.disabled = true;\r\n            try {\r\n                // 取反當前 window._rf_se147Muted 狀態\r\n                const newMuted = !window._rf_se147Muted;\r\n                // 先更新全局狀態\r\n                window._rf_se147Muted = newMuted;\r\n                // 立即更新 UI，提供即時反饋\r\n                updateSe147ButtonUI(newMuted);\r\n                if (window.setMediaVolume) window.setMediaVolume();\r\n                if (window.updateSe147Volume) window.updateSe147Volume();\r\n                // 保存設置\r\n                if (window.__TAURI__?.core) {\r\n                    const targetAccount = await getCurrentAccountData();\r\n                    const saveData = {\r\n                        bgm: null,\r\n                        se: null,\r\n                        se147Muted: newMuted\r\n                    };\r\n                    if (targetAccount) {\r\n                        saveData.target_account = targetAccount;\r\n                    }\r\n                    await window.__TAURI__.core.invoke('save_config_volume', { data: JSON.stringify(saveData) });\r\n                    console.log('戰報通知設定已保存:', newMuted);\r\n                }\r\n            } catch (e) {\r\n                console.error('戰報通知設定失敗', e);\r\n                // 發生錯誤時恢復原狀態\r\n                const originalMuted = !window._rf_se147Muted;\r\n                window._rf_se147Muted = originalMuted;\r\n                updateSe147ButtonUI(originalMuted);\r\n            } finally {\r\n                se147Button.disabled = false;\r\n                isWriting = false;\r\n            }\r\n        });\r\n    }\r\n    let hasSynced = false;\r\n    \r\n    // 創建一個全局可調用的音量同步函數\r\n    window.syncAudioControlsWithConfig = async function(targetAccount = null) {\r\n        if (!window.__TAURI__?.core) {\r\n            console.log('API 尚未準備好，跳過音量同步');\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            console.log('開始音量同步...');\r\n            \r\n            // 如果沒有提供目標帳號，則獲取當前帳號\r\n            if (!targetAccount) {\r\n                targetAccount = await getCurrentAccountData();\r\n            }\r\n            \r\n            console.log('使用帳號資料:', targetAccount);\r\n            const cfg = await window.__TAURI__.core.invoke('get_config_volume', { targetAccount });\r\n            console.log('獲取音量設定:', cfg);\r\n            \r\n            // 使用 globalAudioControl.js 提供的統一音頻配置應用函數\r\n            if (window.applyAudioConfig) {\r\n                window.applyAudioConfig(cfg);\r\n            } else {\r\n                // 備用方案：手動設置\r\n                if (typeof cfg.bgm === 'number') {\r\n                    window._rf_bgm_volume = cfg.bgm;\r\n                    if (window._rf_bgmGainNodes && Array.isArray(window._rf_bgmGainNodes)) {\r\n                        window._rf_bgmGainNodes.forEach(node => {\r\n                            if (node && node.gain) node.gain.value = cfg.bgm;\r\n                        });\r\n                    }\r\n                }\r\n                \r\n                if (typeof cfg.se === 'number') {\r\n                    window._rf_se_volume = cfg.se;\r\n                    if (window._rf_seGainNodes && Array.isArray(window._rf_seGainNodes)) {\r\n                        window._rf_seGainNodes.forEach(node => {\r\n                            if (node && node.gain) node.gain.value = cfg.se;\r\n                        });\r\n                    }\r\n                }\r\n                \r\n                if (typeof cfg.se147Muted === 'boolean') {\r\n                    window._rf_se147Muted = cfg.se147Muted;\r\n                }\r\n                \r\n                // 應用音量設定到音頻系統\r\n                if (window.setMediaVolume) window.setMediaVolume();\r\n                if (window.updateSe147Volume) window.updateSe147Volume();\r\n            }\r\n            \r\n            // 更新UI顯示\r\n            if (window.updateCustomControlsUI) {\r\n                window.updateCustomControlsUI(cfg);\r\n            }\r\n            \r\n            console.log('音量同步完成');\r\n        } catch (e) {\r\n            console.error('音量同步失敗:', e);\r\n        }\r\n    };\r\n    \r\n    const initialSync = () => {\r\n        if (hasSynced) return;\r\n        \r\n        // 檢查必要的元素和 API 是否就緒\r\n        const bgmSlider = document.getElementById('bgm-volume-slider');\r\n        const seSlider = document.getElementById('se-volume-slider');\r\n        \r\n        if (!bgmSlider || !seSlider) {\r\n            setTimeout(initialSync, 100);\r\n            return;\r\n        }\r\n        \r\n        if (window.__TAURI__?.core) {\r\n            hasSynced = true;\r\n            \r\n            // 使用新的全局同步函數\r\n            window.syncAudioControlsWithConfig();\r\n        } else {\r\n            setTimeout(initialSync, 250);\r\n        }\r\n    };\r\n    \r\n    // 監聽多個事件以確保初始化\r\n    window.addEventListener('pywebviewready', initialSync);\r\n    document.addEventListener('DOMContentLoaded', initialSync);\r\n    \r\n    // 額外的延遲初始化，確保在帳號管理器載入後也能同步\r\n    setTimeout(() => {\r\n        if (!hasSynced) {\r\n            initialSync();\r\n        }\r\n    }, 1000);\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/audio/audioControls.js?\n}")},"./js/audio/globalAudioControl.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n// 全域音訊控制模組\r\n// 提供音量控制、passionfruit 資源後台下載檢測功能\r\n\r\n(function() {\r\n    // 辨識音訊類型\r\n    function getAudioTypeFromUrl(url) {\r\n        if (typeof url !== 'string') return null;\r\n        const normalizedUrl = url.toLowerCase().replace(/\\\\/g, '/');\r\n        if (!normalizedUrl.endsWith('.mp3')) return null;\r\n\r\n        if (normalizedUrl.includes('se147.mp3')) return 'SE147';\r\n        if (normalizedUrl.includes('audio/music/') || normalizedUrl.includes('passionfruit/audio/music/')) return 'BGM';\r\n        if (normalizedUrl.includes('passionfruit/audio/')) return 'SE';\r\n        \r\n        return 'SE';\r\n    }\r\n\r\n    // 保存原始描述符\r\n    const origSrcDescriptor = Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype, 'src');\r\n    const origVolumeDescriptor = Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype, 'volume');\r\n\r\n    // 攔截媒體錯誤避免干擾\r\n    document.addEventListener('error', function(e) {\r\n        if (e.target.tagName === 'AUDIO' || e.target.tagName === 'VIDEO') {\r\n            e.stopImmediatePropagation();\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n        }\r\n    }, true);\r\n\r\n    // 監聽 HTMLMediaElement src（檢測 passionfruit 資源並觸發後台下載）\r\n    Object.defineProperty(HTMLMediaElement.prototype, 'src', {\r\n        ...origSrcDescriptor,\r\n        set: function(url) {\r\n            if (typeof url !== 'string') {\r\n                return origSrcDescriptor.set.call(this, url);\r\n            }\r\n\r\n            // 修正錯誤路徑\r\n            let correctedUrl = url.startsWith('undefined/') ? url.substring(10) : url;\r\n            \r\n            const type = getAudioTypeFromUrl(correctedUrl);\r\n            this._rf_type = type;\r\n            \r\n            // 只處理音訊，非音訊直接放行\r\n            if (!type) {\r\n                return origSrcDescriptor.set.call(this, correctedUrl);\r\n            }\r\n            \r\n            // 檢測 passionfruit 音訊資源並觸發後台下載（不攔截原始請求）\r\n            if (window.__TAURI__?.invoke && !correctedUrl.startsWith('http://') && !correctedUrl.startsWith('https://')) {\r\n                const passionfruitMatch = correctedUrl.match(/(?:assets\\/)?passionfruit\\/(.+)$/);\r\n                \r\n                if (passionfruitMatch) {\r\n                    let cleanUrl = `passionfruit/${passionfruitMatch[1]}`;\r\n                    // 異步觸發後台下載\r\n                    window.__TAURI__.invoke('check_resource_exists', { resourcePath: cleanUrl })\r\n                        .catch(() => {}); // 靜默失敗\r\n                } else {\r\n                    // 假設 audio/ 開頭的路徑是 passionfruit 資源\r\n                    let clean = correctedUrl.replace(/^\\.\\//, '');\r\n                    if (clean.startsWith('audio/')) {\r\n                        let cleanUrl = `passionfruit/${clean}`;\r\n                        window.__TAURI__.invoke('check_resource_exists', { resourcePath: cleanUrl })\r\n                            .catch(() => {});\r\n                    }\r\n                }\r\n            }\r\n\r\n            // 設置音量（不攔截原始請求）\r\n            this.volume = (type === 'BGM') ? (window._rf_bgm_volume ?? 1.0) : (window._rf_se_volume ?? 1.0);\r\n            return origSrcDescriptor.set.call(this, correctedUrl);\r\n        }\r\n    });\r\n\r\n    // 攔截 play 方法以套用音量\r\n    const origPlay = HTMLMediaElement.prototype.play;\r\n    HTMLMediaElement.prototype.play = function() {\r\n        const type = this._rf_type || getAudioTypeFromUrl(this.currentSrc || this.src || '');\r\n        if (type) {\r\n            const targetVolume = (type === 'BGM') ? (window._rf_bgm_volume ?? 1.0) : (window._rf_se_volume ?? 1.0);\r\n            if (this.volume !== targetVolume) {\r\n                this.volume = targetVolume;\r\n            }\r\n            if (type === 'SE147' && window._rf_se147Muted) {\r\n                this.muted = true;\r\n            }\r\n        }\r\n        return origPlay.apply(this, arguments);\r\n    };\r\n\r\n    // 攔截 volume setter 以應用全域音量\r\n    if (origVolumeDescriptor && origVolumeDescriptor.set) {\r\n        Object.defineProperty(HTMLMediaElement.prototype, 'volume', {\r\n            get: origVolumeDescriptor.get,\r\n            set: function(value) {\r\n                const type = this._rf_type || getAudioTypeFromUrl(this.currentSrc || this.src);\r\n                if (!type) return origVolumeDescriptor.set.call(this, value);\r\n                \r\n                this._rf_intended_volume = value;\r\n                const newVolume = (type === 'BGM') ? (window._rf_bgm_volume ?? 1.0) : (window._rf_se_volume ?? 1.0);\r\n                \r\n                if (origVolumeDescriptor.get.call(this) !== newVolume) {\r\n                    origVolumeDescriptor.set.call(this, newVolume);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    // 批量設置所有媒體元素音量\r\n    function setMediaVolume() {\r\n        document.querySelectorAll('audio,video').forEach(el => {\r\n            const type = el._rf_type || getAudioTypeFromUrl(el.currentSrc || el.src || '');\r\n            if (type === 'BGM') {\r\n                el.volume = window._rf_bgm_volume ?? 1.0;\r\n            } else if (type === 'SE147') {\r\n                el.volume = window._rf_se_volume ?? 1.0;\r\n                el.muted = window._rf_se147Muted;\r\n            } else if (type) {\r\n                el.volume = window._rf_se_volume ?? 1.0;\r\n            }\r\n        });\r\n    }\r\n\r\n    // 全域音量變數初始化\r\n    window._rf_bgm_volume = 1.0;\r\n    window._rf_se_volume = 1.0;\r\n    window._rf_se147Muted = false;\r\n    window._rf_bgmGainNodes = [];\r\n    window._rf_seGainNodes = [];\r\n\r\n    // SE147 專用 AudioContext\r\n    let rf_se147_context = null;\r\n    let rf_se147_gainNode = null;\r\n    let rf_se147_buffer = null;\r\n\r\n    // SE147 播放器初始化\r\n    function initSE147Player() {\r\n        if (rf_se147_context) return;\r\n        \r\n        const AudioContext = window.AudioContext || window.webkitAudioContext;\r\n        if (!AudioContext) return;\r\n\r\n        rf_se147_context = new AudioContext();\r\n        rf_se147_gainNode = rf_se147_context.createGain();\r\n        rf_se147_gainNode.connect(rf_se147_context.destination);\r\n        rf_se147_gainNode.gain.value = window._rf_se_volume ?? 1.0;\r\n\r\n        // 載入 SE147 音訊檔案\r\n        const se147Url = './passionfruit/audio/SE147.mp3';\r\n        fetch(se147Url)\r\n            .then(response => response.arrayBuffer())\r\n            .then(buffer => rf_se147_context.decodeAudioData(buffer))\r\n            .then(audioBuffer => {\r\n                rf_se147_buffer = audioBuffer;\r\n            })\r\n            .catch(() => {});\r\n    }\r\n\r\n    // 播放 SE147\r\n    window.playSE147 = function() {\r\n        if (window._rf_se147Muted) return;\r\n        \r\n        initSE147Player();\r\n        if (!rf_se147_buffer || !rf_se147_context) return;\r\n\r\n        const source = rf_se147_context.createBufferSource();\r\n        source.buffer = rf_se147_buffer;\r\n        source.connect(rf_se147_gainNode);\r\n        source.start(0);\r\n    };\r\n\r\n    // BGM 音量控制\r\n    window.setBGMVolume = function(volume, skipSave) {\r\n        window._rf_bgm_volume = Math.max(0, Math.min(1, volume));\r\n        setMediaVolume();\r\n        \r\n        window._rf_bgmGainNodes.forEach(node => {\r\n            if (node && node.gain) {\r\n                node.gain.setValueAtTime(window._rf_bgm_volume, node.context.currentTime);\r\n            }\r\n        });\r\n\r\n        if (!skipSave && window.__TAURI__?.invoke) {\r\n            window.__TAURI__.invoke('save_config_volume', {\r\n                data: JSON.stringify({\r\n                    bgm: window._rf_bgm_volume,\r\n                    se: window._rf_se_volume,\r\n                    se147Muted: window._rf_se147Muted\r\n                })\r\n            }).catch(() => {});\r\n        }\r\n    };\r\n\r\n    // SE 音量控制\r\n    window.setSEVolume = function(volume, skipSave) {\r\n        window._rf_se_volume = Math.max(0, Math.min(1, volume));\r\n        setMediaVolume();\r\n\r\n        if (rf_se147_gainNode && rf_se147_gainNode.gain) {\r\n            rf_se147_gainNode.gain.setValueAtTime(window._rf_se_volume, rf_se147_gainNode.context.currentTime);\r\n        }\r\n        \r\n        window._rf_seGainNodes.forEach(node => {\r\n            if (node && node.gain) {\r\n                node.gain.setValueAtTime(window._rf_se_volume, node.context.currentTime);\r\n            }\r\n        });\r\n\r\n        if (!skipSave && window.__TAURI__?.invoke) {\r\n            window.__TAURI__.invoke('save_config_volume', {\r\n                data: JSON.stringify({\r\n                    bgm: window._rf_bgm_volume,\r\n                    se: window._rf_se_volume,\r\n                    se147Muted: window._rf_se147Muted\r\n                })\r\n            }).catch(() => {});\r\n        }\r\n    };\r\n\r\n    // SE147 靜音控制\r\n    window.setSE147Muted = function(muted, skipSave) {\r\n        window._rf_se147Muted = !!muted;\r\n        setMediaVolume();\r\n\r\n        if (!skipSave && window.__TAURI__?.invoke) {\r\n            window.__TAURI__.invoke('save_config_volume', {\r\n                data: JSON.stringify({\r\n                    bgm: window._rf_bgm_volume,\r\n                    se: window._rf_se_volume,\r\n                    se147Muted: muted\r\n                })\r\n            }).catch(() => {});\r\n        }\r\n    };\r\n\r\n    // 強制更新 SE147 按鈕狀態\r\n    window.forceUpdateSE147Button = function() {\r\n        const se147Button = document.getElementById('se147-toggle-button');\r\n        const se147Toggle = document.getElementById('se147-toggle');\r\n        if (se147Button && se147Toggle) {\r\n            const currentState = !window._rf_se147Muted;\r\n            se147Toggle.checked = currentState;\r\n            se147Button.textContent = `戰報通知：${currentState ? '開' : '關'}`;\r\n            se147Button.style.backgroundColor = currentState ? '#5cb85c' : '#d9534f';\r\n        }\r\n    };\r\n\r\n    // Web Audio API 攔截（用於追蹤 AudioBuffer 類型並套用音量）\r\n    (function initWebAudioInterception() {\r\n        const OrigAudioContext = window.AudioContext || window.webkitAudioContext;\r\n        if (!OrigAudioContext) return;\r\n\r\n        const audioBufferTypes = new WeakMap();\r\n\r\n        // 攔截 fetch（標記音訊類型）\r\n        const origFetch = window.fetch;\r\n        window.fetch = function(resource, options) {\r\n            const url = resource instanceof Request ? resource.url : resource;\r\n            const type = getAudioTypeFromUrl(url);\r\n\r\n            const promise = origFetch.apply(this, arguments);\r\n            \r\n            if (type) {\r\n                promise.then(response => {\r\n                    const clone = response.clone();\r\n                    clone.arrayBuffer().then(buffer => {\r\n                        audioBufferTypes.set(buffer, type);\r\n                    }).catch(() => {});\r\n                    return response;\r\n                }).catch(() => {});\r\n            }\r\n\r\n            return promise;\r\n        };\r\n\r\n        // 攔截 XMLHttpRequest（標記音訊類型）\r\n        const OrigXHR = XMLHttpRequest;\r\n        const origXhrOpen = OrigXHR.prototype.open;\r\n        OrigXHR.prototype.open = function(method, url, ...args) {\r\n            this._rf_url = url;\r\n            return origXhrOpen.call(this, method, url, ...args);\r\n        };\r\n\r\n        const origXhrSend = OrigXHR.prototype.send;\r\n        OrigXHR.prototype.send = function(...args) {\r\n            const url = this._rf_url;\r\n            if (url) {\r\n                const type = getAudioTypeFromUrl(url);\r\n                if (type) {\r\n                    this.addEventListener('load', function() {\r\n                        if (this.response instanceof ArrayBuffer) {\r\n                            audioBufferTypes.set(this.response, type);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n            return origXhrSend.apply(this, args);\r\n        };\r\n\r\n        // 攔截 decodeAudioData（獲取類型並標記 AudioBuffer）\r\n        const origDecodeAudioData = OrigAudioContext.prototype.decodeAudioData;\r\n        OrigAudioContext.prototype.decodeAudioData = function(audioData, successCallback, errorCallback) {\r\n            const type = audioBufferTypes.get(audioData);\r\n            \r\n            const wrappedSuccess = function(decodedBuffer) {\r\n                if (type) {\r\n                    audioBufferTypes.set(decodedBuffer, type);\r\n                }\r\n                if (successCallback) {\r\n                    return successCallback(decodedBuffer);\r\n                }\r\n            };\r\n\r\n            if (successCallback) {\r\n                return origDecodeAudioData.call(this, audioData, wrappedSuccess, errorCallback);\r\n            } else {\r\n                return origDecodeAudioData.call(this, audioData).then(decodedBuffer => {\r\n                    if (type) {\r\n                        audioBufferTypes.set(decodedBuffer, type);\r\n                    }\r\n                    return decodedBuffer;\r\n                });\r\n            }\r\n        };\r\n\r\n        // 攔截 createBufferSource（套用音量）\r\n        const origCreateBufferSource = OrigAudioContext.prototype.createBufferSource;\r\n        OrigAudioContext.prototype.createBufferSource = function() {\r\n            const source = origCreateBufferSource.call(this);\r\n            const origSourceConnect = source.connect;\r\n\r\n            source.connect = function(destination, ...args) {\r\n                const buffer = this.buffer;\r\n                if (buffer) {\r\n                    const type = audioBufferTypes.get(buffer);\r\n                    \r\n                    if (type) {\r\n                        const gainNode = source.context.createGain();\r\n                        \r\n                        if (type === 'BGM') {\r\n                            gainNode.gain.value = window._rf_bgm_volume ?? 1.0;\r\n                            window._rf_bgmGainNodes.push(gainNode);\r\n                        } else {\r\n                            gainNode.gain.value = window._rf_se_volume ?? 1.0;\r\n                            window._rf_seGainNodes.push(gainNode);\r\n                        }\r\n                        \r\n                        origSourceConnect.call(this, gainNode);\r\n                        gainNode.connect(destination, ...args);\r\n                        return gainNode;\r\n                    }\r\n                }\r\n                \r\n                return origSourceConnect.call(this, destination, ...args);\r\n            };\r\n\r\n            return source;\r\n        };\r\n    })();\r\n\r\n    // 載入儲存的音量設定\r\n    window.loadAudioConfig = function() {\r\n        if (!window.__TAURI__?.invoke) return;\r\n\r\n        window.__TAURI__.invoke('get_config_volume', {})\r\n            .then(cfg => {\r\n                if (typeof cfg.bgm === 'number') {\r\n                    window.setBGMVolume(cfg.bgm, true);\r\n                }\r\n                \r\n                if (typeof cfg.se === 'number') {\r\n                    window.setSEVolume(cfg.se, true);\r\n                }\r\n                \r\n                if (typeof cfg.se147Muted === 'boolean') {\r\n                    window.setSE147Muted(cfg.se147Muted, true);\r\n                }\r\n            })\r\n            .catch(() => {});\r\n    };\r\n})();\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/audio/globalAudioControl.js?\n}")},"./js/core/api.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   addAccount: () => (/* binding */ addAccount),\n/* harmony export */   deleteAccount: () => (/* binding */ deleteAccount),\n/* harmony export */   exitApp: () => (/* binding */ exitApp),\n/* harmony export */   getAccounts: () => (/* binding */ getAccounts),\n/* harmony export */   getActiveAccount: () => (/* binding */ getActiveAccount),\n/* harmony export */   loadYaml: () => (/* binding */ loadYaml),\n/* harmony export */   saveYaml: () => (/* binding */ saveYaml),\n/* harmony export */   setActiveAccount: () => (/* binding */ setActiveAccount)\n/* harmony export */ });\n// Tauri API 封裝\r\n\r\nfunction isTauri() {\r\n    return window.__TAURI__ && window.__TAURI__.core;\r\n}\r\n\r\nasync function getAccounts() {\r\n    if (!isTauri()) return [];\r\n    return await window.__TAURI__.core.invoke('get_accounts');\r\n}\r\n\r\nasync function getActiveAccount() {\r\n    if (!isTauri()) return null;\r\n    return await window.__TAURI__.core.invoke('get_active_account');\r\n}\r\n\r\nasync function addAccount(accountObj) {\r\n    if (!isTauri()) return false;\r\n    return await window.__TAURI__.core.invoke('add_account', { data: JSON.stringify(accountObj) });\r\n}\r\n\r\nasync function deleteAccount(idx) {\r\n    if (!isTauri()) return false;\r\n    return await window.__TAURI__.core.invoke('delete_account', { idx });\r\n}\r\n\r\nasync function setActiveAccount(idx) {\r\n    if (!isTauri()) return false;\r\n    return await window.__TAURI__.core.invoke('set_active_account', { idx });\r\n}\r\n\r\nasync function saveYaml(filename, content) {\r\n    if (!isTauri()) return false;\r\n    return await window.__TAURI__.core.invoke('save_yaml', { filename, content });\r\n}\r\n\r\nasync function loadYaml(filename) {\r\n    if (!isTauri()) return '';\r\n    return await window.__TAURI__.core.invoke('load_yaml', { filename });\r\n}\r\n\r\nasync function exitApp() {\r\n    if (!isTauri()) {\r\n        window.close();\r\n        return;\r\n    }\r\n    return await window.__TAURI__.core.invoke('exit_app');\r\n}\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/core/api.js?\n}")},"./js/core/entrypoint.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _ui_keyboardInit_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../ui/keyboardInit.js */ \"./js/ui/keyboardInit.js\");\n/* harmony import */ var _ui_windowManager_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../ui/windowManager.js */ \"./js/ui/windowManager.js\");\n/* harmony import */ var _account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../account/accountManager.js */ \"./js/account/accountManager.js\");\n/* harmony import */ var _ui_customControls_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../ui/customControls.js */ \"./js/ui/customControls.js\");\n/* harmony import */ var _ui_rankingModal_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../ui/rankingModal.js */ \"./js/ui/rankingModal.js\");\n/* harmony import */ var _audio_globalAudioControl_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../audio/globalAudioControl.js */ \"./js/audio/globalAudioControl.js\");\n/* harmony import */ var _map_markerInteraction_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../map/markerInteraction.js */ \"./js/map/markerInteraction.js\");\n/* harmony import */ var _ui_notificationBox_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../ui/notificationBox.js */ \"./js/ui/notificationBox.js\");\n/* harmony import */ var _map_markerData_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ../map/markerData.js */ \"./js/map/markerData.js\");\n/* harmony import */ var _ui_updatePrompt_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ../ui/updatePrompt.js */ \"./js/ui/updatePrompt.js\");\n// 入口腳本\r\n// Tauri API 工具函數\r\nconst invoke = () => window.__TAURI__?.core?.invoke;\r\nconst toggleControlPanel = () => {\r\n    const panel = document.getElementById('custom-controls');\r\n    const toggle = document.getElementById('custom-controls-toggle');\r\n    if (panel && toggle) {\r\n        if (panel.style.display === 'none' || !panel.style.display) {\r\n            panel.style.display = 'block';\r\n            toggle.style.display = 'none';\r\n        } else {\r\n            panel.style.display = 'none';\r\n            toggle.style.display = 'flex';\r\n        }\r\n    }\r\n};\r\n// 導入鍵盤初始化腳本與視窗管理器\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// 立即初始化視窗管理器（優先於其他模塊）\r\nif (typeof _ui_windowManager_js__WEBPACK_IMPORTED_MODULE_1__.initWindowManager === 'function') {\r\n    console.log('entrypoint.js: 立即初始化視窗管理器');\r\n    try {\r\n        (0,_ui_windowManager_js__WEBPACK_IMPORTED_MODULE_1__.initWindowManager)();\r\n        console.log('entrypoint.js: 視窗管理器初始化成功');\r\n    } catch (e) {\r\n        console.error('entrypoint.js: 視窗管理器初始化失敗', e);\r\n    }\r\n}\r\n\r\n// 確保鍵盤控制被初始化 (延遲執行，確保優先級較低)\r\nsetTimeout(() => {\r\n    if (typeof _ui_keyboardInit_js__WEBPACK_IMPORTED_MODULE_0__.initKeyboardControls === 'function') {\r\n        console.log('entrypoint.js: 延遲初始化鍵盤控制');\r\n        (0,_ui_keyboardInit_js__WEBPACK_IMPORTED_MODULE_0__.initKeyboardControls)();\r\n    }\r\n    // 初始化更新提示\r\n    if (typeof _ui_updatePrompt_js__WEBPACK_IMPORTED_MODULE_9__.initUpdatePrompt === 'function') {\r\n        (0,_ui_updatePrompt_js__WEBPACK_IMPORTED_MODULE_9__.initUpdatePrompt)();\r\n    }\r\n}, 500);\r\n\r\n// 動態插入功能選單相關 DOM 結構\r\nfunction insertCustomControlsDOM() {\r\n    if (document.getElementById('custom-controls-toggle')) return; // 已插入則跳過\r\n    const main = document.querySelector('main') || document.body;\r\n    // 判斷是否 pywebview 或 Tauri（延遲檢查以確保 Qt WebChannel 已注入）\r\n    const isDesktop = !!window.__TAURI__ || (window.__TAURI__ && !!window.__TAURI__.core);\r\n    console.log('insertCustomControlsDOM: isDesktop =', isDesktop, 'window.__TAURI__ =', !!window.__TAURI__, 'Tauri =', !!(window.__TAURI__ && window.__TAURI__.core));\r\n    // 懸浮按鈕位置：桌面版中央，網頁版左上\r\n    const toggleBtnStyle = isDesktop\r\n        ? 'position:fixed;top:20%;left:50%;' // 不加 transform\r\n        : 'position:fixed;top:16px;left:16px;';\r\n    main.insertAdjacentHTML('beforeend', `\r\n    <div id=\"custom-controls-toggle\" aria-label=\"展開功能選單\" style=\"${toggleBtnStyle}z-index:10000;background:#222c;backdrop-filter:blur(2px);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 12px #000a;\">\r\n        <img src=\"./static/media/logo_monthlycard.fc4baca34b9e97ab8974.png\" alt=\"功能選單\" style=\"width:32px;height:32px;object-fit:contain;\"/>\r\n    </div>\r\n    <div id=\"custom-controls\" style=\"position:fixed;z-index:9999;background:rgba(34,34,34,0.82);backdrop-filter:blur(4px);border-radius:10px;padding:20px 18px 16px 18px;box-shadow:0 2px 12px #000a;color:#fff;min-width:220px;max-width:420px;font-family:sans-serif;display:none;transition:transform 0.2s cubic-bezier(.4,2,.6,1);max-height:88vh;overflow:auto;\">\r\n        <div style=\"margin-bottom:12px;font-size:1.1em;font-weight:bold;letter-spacing:1px;\">功能選單</div>\r\n        <button id=\"show-portalmap-ranking\" aria-label=\"顯示陣營據點排行榜\" style=\"width:100%;margin-bottom:10px;background:#2a7cff;color:#fff;border:none;padding:8px 0;border-radius:6px;cursor:pointer;\">陣營據點排行榜</button>\r\n        <button id=\"toggle-faction-map\" aria-label=\"顯示勢力分布圖\" style=\"width:100%;margin-bottom:10px;background:#1dbf60;color:#fff;border:none;padding:8px 0;border-radius:6px;cursor:pointer;\">顯示勢力分布圖</button>\r\n        <div id=\"account-section\"></div>\r\n        <div id=\"account-status\" style=\"margin-top:6px;font-size:0.92em;color:#7fffd4;\"></div>\r\n        \x3c!-- 音量控制、戰報過濾、下載狀態將由 setupCustomControls 動態添加 --\x3e\r\n        \x3c!-- ESC 提示將由 setupCustomControls 動態添加 --\x3e\r\n        \x3c!-- 桌面專屬按鈕（退出、全螢幕）容器將由 setupCustomControls 創建並在最後添加 --\x3e\r\n    </div>\r\n    <div id=\"ranking-modal\" style=\"display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:12000;background:none;align-items:center;justify-content:center;pointer-events:auto;overflow:hidden;\">\r\n      <div id=\"ranking-panel\" style=\"background:rgba(30,34,44,0.92);padding:3vw 2vw 2vw 2vw;border-radius:22px;min-width:320px;max-width:96vw;width:min(540px,92vw);max-height:88vh;overflow:auto;box-shadow:0 4px 32px #0008;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;backdrop-filter:blur(6px);pointer-events:auto;cursor:move;\">\r\n        <button id=\"close-ranking-modal\" aria-label=\"關閉排行榜\" style=\"position:absolute;top:14px;right:18px;background:rgba(60,60,60,0.7);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:1.3em;cursor:pointer;z-index:1;box-shadow:0 2px 8px #000a;\">×</button>\r\n        <div id=\"ranking-content\" style=\"margin-top:8px;width:100%;max-height:70vh;overflow:auto;\"></div>\r\n      </div>\r\n    </div>\r\n    <div id=\"faction-map-canvas-container\" style=\"position:absolute;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:1000;display:none;\">\r\n        <canvas id=\"faction-map-canvas\" width=\"1920\" height=\"1080\" style=\"width:100vw;height:100vh;\"></canvas>\r\n    </div>\r\n    `);\r\n\r\n    // 展開 custom-controls 時自動定位在 toggleBtn 旁邊\r\n    const controls = document.getElementById('custom-controls');\r\n    const toggleBtn = document.getElementById('custom-controls-toggle');\r\n    function showCustomControls() {\r\n        if (!controls || !toggleBtn) return;\r\n        // 先顯示，等內容渲染後再定位（兩次 rAF 保證內容載入）\r\n        controls.style.display = '';\r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(() => {\r\n                const btnRect = toggleBtn.getBoundingClientRect();\r\n                // 固定 panelWidth，桌面 320px，手機 96vw\r\n                let panelWidth = window.innerWidth <= 600 ? Math.floor(window.innerWidth * 0.96) : 320;\r\n                panelWidth = Math.max(220, Math.min(420, panelWidth));\r\n                controls.style.width = panelWidth + 'px';\r\n                controls.style.maxWidth = '420px';\r\n                controls.style.minWidth = '220px';\r\n                // 動態定位：預設在圓點右側，若超出則往左，但panelWidth不變\r\n                let left = btnRect.left + btnRect.width + 12;\r\n                if (left + panelWidth > window.innerWidth) {\r\n                    left = btnRect.left - panelWidth - 12;\r\n                }\r\n                // 若還是超出，直接貼齊螢幕邊緣\r\n                left = Math.max(0, Math.min(window.innerWidth - panelWidth, left));\r\n                let top = btnRect.top;\r\n                // 若下方空間不足，往上移\r\n                const panelHeight = Math.min(controls.offsetHeight || 480, window.innerHeight * 0.88);\r\n                if (top + panelHeight > window.innerHeight) {\r\n                    top = window.innerHeight - panelHeight - 12;\r\n                }\r\n                top = Math.max(0, top);\r\n                controls.style.left = left + 'px';\r\n                controls.style.top = top + 'px';\r\n                controls.style.right = '';\r\n                controls.style.borderRadius = window.innerWidth <= 600 ? '12px' : '10px';\r\n            });\r\n        });\r\n    }\r\n    function hideCustomControls() {\r\n        if (controls) controls.style.display = 'none';\r\n    }\r\n    if (toggleBtn && controls) {\r\n        toggleBtn.addEventListener('click', function() {\r\n            if (controls.style.display === '' || controls.style.display === 'block') {\r\n                hideCustomControls();\r\n            } else {\r\n                showCustomControls();\r\n            }\r\n        });\r\n    }\r\n    // 點擊外部自動關閉\r\n    document.addEventListener('mousedown', function(e) {\r\n        if (controls && controls.style.display !== 'none' && !controls.contains(e.target) && e.target !== toggleBtn) {\r\n            hideCustomControls();\r\n        }\r\n    });\r\n\r\n    // 重構：功能選單縮放與定位，桌面固定寬度，手機自適應\r\n    function scaleCustomControls() {\r\n        const controls = document.getElementById('custom-controls');\r\n        if (!controls) return;\r\n        if (window.innerWidth <= 600) {\r\n            // 手機：寬度自適應，左右 2vw，圓角大\r\n            controls.style.width = '96vw';\r\n            controls.style.maxWidth = '96vw';\r\n            controls.style.minWidth = '0';\r\n            controls.style.left = '2vw';\r\n            controls.style.right = '2vw';\r\n            controls.style.top = '12vw';\r\n            controls.style.borderRadius = '12px';\r\n            controls.style.transform = 'none';\r\n        } else {\r\n            // 桌面：固定寬度，右上角，圓角小\r\n            controls.style.width = '320px';\r\n            controls.style.maxWidth = '420px';\r\n            controls.style.minWidth = '220px';\r\n            controls.style.left = '';\r\n            controls.style.right = '20px';\r\n            controls.style.top = '20px';\r\n            controls.style.borderRadius = '10px';\r\n            controls.style.transform = 'none';\r\n        }\r\n    }\r\n    window.addEventListener('resize', scaleCustomControls);\r\n    scaleCustomControls();\r\n}\r\n\r\n// 延遲調用 insertCustomControlsDOM，等待 Qt WebChannel 初始化\r\n// 但要足夠早，讓後續代碼能找到這些 DOM 元素\r\nlet customControlsInserted = false;\r\n\r\n// DOMContentLoaded 時插入 DOM\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    if (!customControlsInserted) {\r\n        console.log('DOMContentLoaded: 調用 insertCustomControlsDOM');\r\n        insertCustomControlsDOM();\r\n        customControlsInserted = true;\r\n    }\r\n});\r\n\r\n// 如果 DOMContentLoaded 已經觸發，立即執行\r\nif (document.readyState === 'loading') {\r\n    // 還在加載中，上面的事件監聽會處理\r\n} else {\r\n    // 已經加載完成，立即執行\r\n    console.log('Document already loaded: 調用 insertCustomControlsDOM');\r\n    insertCustomControlsDOM();\r\n    customControlsInserted = true;\r\n}\r\n\r\n// GPU 驗證：啟動時印出 WebGL 渲染器資訊\r\nconsole.log((() => {\r\n  try {\r\n    const canvas = document.createElement('canvas');\r\n    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');\r\n    if (!gl) return 'WebGL not supported';\r\n    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');\r\n    return debugInfo\r\n      ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)\r\n      : 'No debug info';\r\n  } catch (e) {\r\n    return 'Error: ' + e;\r\n  }\r\n})());\r\n\r\n// 防止重複初始化\r\nlet markerInteractionInitialized = false;\r\n\r\n// 封裝 pywebview 相關的初始化邏輯\r\nlet pywebviewFeaturesInitialized = false;\r\nasync function initPywebviewFeatures() {\r\n    if (pywebviewFeaturesInitialized) return;\r\n    pywebviewFeaturesInitialized = true;\r\n\r\n    // 確保基礎 DOM 已插入\r\n    if (!document.getElementById('custom-controls')) {\r\n        insertCustomControlsDOM();\r\n    }\r\n\r\n    // 帳號管理（僅桌面版顯示）\r\n    const accountSection = document.getElementById('account-section');\r\n    if (accountSection) {\r\n        await (0,_account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__.renderAccountManager)(accountSection, _account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__.autofillActiveAccount);\r\n        (0,_account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__.autofillActiveAccount)();\r\n        \r\n        // 啟動登入攔截器\r\n        (0,_account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__.setupLoginInterceptor)(accountSection, _account_accountManager_js__WEBPACK_IMPORTED_MODULE_2__.autofillActiveAccount);\r\n        \r\n        // 在帳號管理器渲染完成後，觸發音量控制同步\r\n        setTimeout(() => {\r\n            if (window.syncAudioControlsWithConfig) {\r\n                window.syncAudioControlsWithConfig();\r\n            }\r\n        }, 500);\r\n    }\r\n\r\n    // 添加桌面專屬按鈕到最後的容器中\r\n    // 確保 setupCustomControls 已經執行過，容器應該已存在\r\n    // 如果不存在，嘗試手動創建或等待\r\n    let desktopBtnsContainer = document.getElementById('desktop-buttons-container');\r\n    if (!desktopBtnsContainer) {\r\n        // 嘗試再次執行 setupCustomControls\r\n        (0,_ui_customControls_js__WEBPACK_IMPORTED_MODULE_3__.setupCustomControls)();\r\n        desktopBtnsContainer = document.getElementById('desktop-buttons-container');\r\n    }\r\n\r\n    if (desktopBtnsContainer && !document.getElementById('exit-app')) {\r\n        desktopBtnsContainer.innerHTML = `\r\n            <button id=\"exit-app\" aria-label=\"退出遊戲\" style=\"width:100%;margin-bottom:10px;background:#d9534f;color:#fff;border:none;padding:8px 0;border-radius:6px;cursor:pointer;margin-top:10px;\">退出遊戲</button>\r\n            <button id=\"toggle-fullscreen\" aria-label=\"切換全螢幕/視窗\" style=\"width:100%;margin-bottom:0;background:#333c;color:#fff;border:none;padding:8px 0;border-radius:6px;cursor:pointer;\">切換全螢幕/視窗</button>\r\n        `;\r\n        \r\n        // 綁定事件\r\n        const exitBtn = document.getElementById('exit-app');\r\n        if (exitBtn) {\r\n            exitBtn.onclick = function() {\r\n                if (!window.__TAURI__.core.exit_app) {\r\n                    window.__TAURI__.core.invoke('exit_app');\r\n                }\r\n            };\r\n        }\r\n        const fsBtn = document.getElementById('toggle-fullscreen');\r\n        if (fsBtn) {\r\n            fsBtn.onclick = function() {\r\n                if (!window.__TAURI__.core.toggle_fullscreen) {\r\n                    window.__TAURI__.core.invoke('toggle_fullscreen');\r\n                }\r\n            };\r\n        }\r\n    }\r\n}\r\n\r\n// Tauri 環境下直接初始化\r\nif (window.__TAURI__) {\r\n    document.addEventListener('DOMContentLoaded', async () => {\r\n        await initPywebviewFeatures();\r\n    });\r\n}\r\n\r\n// Tauri 環境檢查\r\nif (window.__TAURI__ && document.readyState !== 'loading') {\r\n    initPywebviewFeatures();\r\n}\r\n\r\n// 通用初始化（不依賴 pywebview）\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n    // ... existing code ...\r\n    if (!customControlsInserted) {\r\n        insertCustomControlsDOM();\r\n        customControlsInserted = true;\r\n    }\r\n    \r\n    (0,_ui_rankingModal_js__WEBPACK_IMPORTED_MODULE_4__.setupRankingModalEvents)();\r\n    (0,_ui_customControls_js__WEBPACK_IMPORTED_MODULE_3__.setupCustomControls)();\r\n    (0,_ui_customControls_js__WEBPACK_IMPORTED_MODULE_3__.setupRankingPanelDrag)();\r\n    \r\n    try {\r\n        await (0,_ui_notificationBox_js__WEBPACK_IMPORTED_MODULE_7__.initializeMessageObserver)(); // 初始化訊息觀察者\r\n        if (!markerInteractionInitialized) {\r\n            (0,_map_markerInteraction_js__WEBPACK_IMPORTED_MODULE_6__.setupMarkerInteractionOptimized)();\r\n            markerInteractionInitialized = true;\r\n        }\r\n        \r\n        // 初始化鍵盤事件處理 - 只處理 F11 鍵，讓 ESC 由 keyboard_handler 處理\r\n        document.addEventListener('keydown', function(event) {\r\n            // 僅處理 F11 鍵 - 切換全屏\r\n            if (event.key === 'F11' || event.keyCode === 122) {\r\n                console.log('entrypoint.js 捕獲F11按鍵，觸發全屏切換');\r\n                if (!window.__TAURI__ && window.__TAURI__?.core) {\r\n                    window.__TAURI__.core.invoke('toggle_fullscreen');\r\n                    event.preventDefault();\r\n                    return false;\r\n                }\r\n            }\r\n            \r\n            // 注意：不再在此處理 ESC 鍵，避免重複觸發\r\n        }, true);\r\n        \r\n        // 額外的音量控制同步檢查\r\n        // 延遲執行以確保所有模組都已載入\r\n        setTimeout(() => {\r\n            if (!window.__TAURI__ && window.syncAudioControlsWithConfig) {\r\n                console.log('DOMContentLoaded: 觸發額外的音量控制同步檢查');\r\n                window.syncAudioControlsWithConfig();\r\n            }\r\n        }, 2000);\r\n    } catch(e) {}\r\n});\r\n// 只偵測地圖 DOM 是否有變化，必要時才重新綁定 marker 互動\r\nlet lastMarkerCount = 0;\r\nsetInterval(() => {\r\n    try {\r\n        const markers = document.querySelectorAll('[class^=\"PortalMap_marker\"], [class^=\"PortalMap_markerCapital\"]');\r\n        if (markers.length !== lastMarkerCount) {\r\n            (0,_map_markerInteraction_js__WEBPACK_IMPORTED_MODULE_6__.setupMarkerInteractionOptimized)();\r\n            lastMarkerCount = markers.length;\r\n        }\r\n    } catch(e) {}\r\n}, 1000);\r\n\r\nwindow.saveMarkerDataToYaml = _map_markerData_js__WEBPACK_IMPORTED_MODULE_8__.saveMarkerDataToYaml;\r\n\r\n// 修正拖移時滑鼠即為中心點\r\nconst toggleBtn = document.getElementById('custom-controls-toggle');\r\nlet isDragging = false;\r\nlet dragOffsetX = 0;\r\nlet dragOffsetY = 0;\r\ntoggleBtn.addEventListener('mousedown', function(e) {\r\n    isDragging = true;\r\n    // 以滑鼠點擊位置為左上角\r\n    dragOffsetX = e.offsetX;\r\n    dragOffsetY = e.offsetY;\r\n    document.body.style.userSelect = 'none';\r\n});\r\nwindow.addEventListener('mousemove', function(e) {\r\n    if (!isDragging) return;\r\n    const btnW = toggleBtn.offsetWidth;\r\n    const btnH = toggleBtn.offsetHeight;\r\n    let newLeft = e.clientX - dragOffsetX;\r\n    let newTop = e.clientY - dragOffsetY;\r\n    // 確保整個按鈕都在畫面內\r\n    newLeft = Math.max(0, Math.min(window.innerWidth - btnW, newLeft));\r\n    newTop = Math.max(0, Math.min(window.innerHeight - btnH, newTop));\r\n    toggleBtn.style.left = `${newLeft}px`;\r\n    toggleBtn.style.top = `${newTop}px`;\r\n});\r\nwindow.addEventListener('mouseup', function() {\r\n    isDragging = false;\r\n    document.body.style.userSelect = '';\r\n});\r\n\r\n// 禁止網頁版雙擊據點編輯\r\nif (window.setupMarkerInteractionOptimized) {\r\n    const origSetupMarkerInteractionOptimized = window.setupMarkerInteractionOptimized;\r\n    window.setupMarkerInteractionOptimized = function(...args) {\r\n        origSetupMarkerInteractionOptimized.apply(this, args);\r\n        if (!window.__TAURI__) {\r\n            // 移除所有 marker 的 dblclick 事件\r\n            setTimeout(() => {\r\n                document.querySelectorAll('[class^=\"PortalMap_marker\"], [class^=\"PortalMap_markerCapital\"]').forEach(marker => {\r\n                    marker.replaceWith(marker.cloneNode(true));\r\n                });\r\n            }, 500);\r\n        }\r\n    };\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/core/entrypoint.js?\n}")},"./js/core/index.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval('{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   loadExitPromptsAndShow: () => (/* reexport safe */ _ui_exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__.loadExitPromptsAndShow),\n/* harmony export */   setupAudioControls: () => (/* reexport safe */ _audio_audioControls_js__WEBPACK_IMPORTED_MODULE_3__.setupAudioControls),\n/* harmony export */   setupFactionMapControl: () => (/* reexport safe */ _map_factionMapControl_js__WEBPACK_IMPORTED_MODULE_2__.setupFactionMapControl),\n/* harmony export */   setupPanelDrag: () => (/* reexport safe */ _ui_panelDrag_js__WEBPACK_IMPORTED_MODULE_0__.setupPanelDrag),\n/* harmony export */   setupRankingPanelDrag: () => (/* reexport safe */ _ui_rankingPanelDrag_js__WEBPACK_IMPORTED_MODULE_4__.setupRankingPanelDrag),\n/* harmony export */   showExitConfirm: () => (/* reexport safe */ _ui_exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__.showExitConfirm)\n/* harmony export */ });\n/* harmony import */ var _ui_panelDrag_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../ui/panelDrag.js */ "./js/ui/panelDrag.js");\n/* harmony import */ var _ui_exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../ui/exitConfirm.js */ "./js/ui/exitConfirm.js");\n/* harmony import */ var _map_factionMapControl_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../map/factionMapControl.js */ "./js/map/factionMapControl.js");\n/* harmony import */ var _audio_audioControls_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../audio/audioControls.js */ "./js/audio/audioControls.js");\n/* harmony import */ var _ui_rankingPanelDrag_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../ui/rankingPanelDrag.js */ "./js/ui/rankingPanelDrag.js");\n// 統一 export\r\n\r\n\r\n\r\n\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/core/index.js?\n}')},"./js/core/resource_interceptor.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n(function() {\r\n    const originalFetch = window.fetch;\r\n    const originalXhrOpen = XMLHttpRequest.prototype.open;\r\n    const originalImageSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');\r\n    \r\n    // 檢測是否為 passionfruit 資源\r\n    function isPassionfruitResource(url) {\r\n        if (!url) return false;\r\n        if (url.match(/^(http|https|data|blob):/i)) return false;\r\n        \r\n        let cleanUrl = url.replace(/^[\\.\\/]+/, '').replace(/^assets\\//, '');\r\n        return cleanUrl.startsWith('passionfruit/');\r\n    }\r\n    \r\n    // 觸發後台下載（不阻塞原始請求）\r\n    function triggerBackgroundDownload(url) {\r\n        if (!window.__TAURI__?.invoke) return;\r\n        \r\n        let cleanUrl = url.replace(/^[\\.\\/]+/, '').replace(/^assets\\//, '');\r\n        \r\n        // 異步調用 Rust 命令檢查並下載\r\n        window.__TAURI__.invoke('check_resource_exists', { resourcePath: cleanUrl })\r\n            .catch(() => {}); // 靜默失敗，不影響原始請求\r\n    }\r\n    \r\n    // 監聽 fetch（不攔截）\r\n    window.fetch = async function(resource, init) {\r\n        let url = resource instanceof Request ? resource.url : resource;\r\n        \r\n        if (isPassionfruitResource(url)) {\r\n            triggerBackgroundDownload(url);\r\n        }\r\n        \r\n        return originalFetch.apply(this, arguments);\r\n    };\r\n    \r\n    // 監聽 XMLHttpRequest（不攔截）\r\n    XMLHttpRequest.prototype.open = function(method, url, async, user, password) {\r\n        if (isPassionfruitResource(url)) {\r\n            triggerBackgroundDownload(url);\r\n        }\r\n        \r\n        return originalXhrOpen.apply(this, arguments);\r\n    };\r\n    \r\n    // 監聽圖片加載（不攔截）\r\n    Object.defineProperty(HTMLImageElement.prototype, 'src', {\r\n        get: function() {\r\n            return originalImageSrc.get.call(this);\r\n        },\r\n        set: function(url) {\r\n            const urlStr = String(url);\r\n            \r\n            if (isPassionfruitResource(urlStr)) {\r\n                triggerBackgroundDownload(urlStr);\r\n            }\r\n            \r\n            originalImageSrc.set.call(this, url);\r\n        },\r\n        configurable: true\r\n    });\r\n})();\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/core/resource_interceptor.js?\n}")},"./js/core/utils.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   $: () => (/* binding */ $),\n/* harmony export */   $all: () => (/* binding */ $all),\n/* harmony export */   debounce: () => (/* binding */ debounce)\n/* harmony export */ });\n// 共用工具函式\r\nfunction debounce(fn, delay) {\r\n    let timer = null;\r\n    return function(...args) {\r\n        clearTimeout(timer);\r\n        timer = setTimeout(() => fn.apply(this, args), delay);\r\n    };\r\n}\r\n\r\nfunction $(selector, parent = document) {\r\n    return parent.querySelector(selector);\r\n}\r\n\r\nfunction $all(selector, parent = document) {\r\n    return Array.from(parent.querySelectorAll(selector));\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/core/utils.js?\n}")},"./js/index.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _account_accountManager_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./account/accountManager.js */ \"./js/account/accountManager.js\");\n/* harmony import */ var _audio_audioControls_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./audio/audioControls.js */ \"./js/audio/audioControls.js\");\n/* harmony import */ var _audio_globalAudioControl_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./audio/globalAudioControl.js */ \"./js/audio/globalAudioControl.js\");\n/* harmony import */ var _core_api_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./core/api.js */ \"./js/core/api.js\");\n/* harmony import */ var _core_entrypoint_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./core/entrypoint.js */ \"./js/core/entrypoint.js\");\n/* harmony import */ var _core_index_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./core/index.js */ \"./js/core/index.js\");\n/* harmony import */ var _core_resource_interceptor_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./core/resource_interceptor.js */ \"./js/core/resource_interceptor.js\");\n/* harmony import */ var _core_utils_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./core/utils.js */ \"./js/core/utils.js\");\n/* harmony import */ var _map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./map/factionColorMap.js */ \"./js/map/factionColorMap.js\");\n/* harmony import */ var _map_factionMap_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./map/factionMap.js */ \"./js/map/factionMap.js\");\n/* harmony import */ var _map_factionMapControl_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./map/factionMapControl.js */ \"./js/map/factionMapControl.js\");\n/* harmony import */ var _map_markerConnections_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./map/markerConnections.js */ \"./js/map/markerConnections.js\");\n/* harmony import */ var _map_markerData_js__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./map/markerData.js */ \"./js/map/markerData.js\");\n/* harmony import */ var _map_markerDialogs_js__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./map/markerDialogs.js */ \"./js/map/markerDialogs.js\");\n/* harmony import */ var _map_markerInteraction_js__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./map/markerInteraction.js */ \"./js/map/markerInteraction.js\");\n/* harmony import */ var _map_markerUtils_js__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./map/markerUtils.js */ \"./js/map/markerUtils.js\");\n/* harmony import */ var _map_rankingModal_js__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./map/rankingModal.js */ \"./js/map/rankingModal.js\");\n/* harmony import */ var _ui_customControls_js__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ./ui/customControls.js */ \"./js/ui/customControls.js\");\n/* harmony import */ var _ui_exitConfirm_js__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./ui/exitConfirm.js */ \"./js/ui/exitConfirm.js\");\n/* harmony import */ var _ui_keyboardInit_js__WEBPACK_IMPORTED_MODULE_19__ = __webpack_require__(/*! ./ui/keyboardInit.js */ \"./js/ui/keyboardInit.js\");\n/* harmony import */ var _ui_notificationBox_js__WEBPACK_IMPORTED_MODULE_20__ = __webpack_require__(/*! ./ui/notificationBox.js */ \"./js/ui/notificationBox.js\");\n/* harmony import */ var _ui_panelDrag_js__WEBPACK_IMPORTED_MODULE_21__ = __webpack_require__(/*! ./ui/panelDrag.js */ \"./js/ui/panelDrag.js\");\n/* harmony import */ var _ui_rankingModal_js__WEBPACK_IMPORTED_MODULE_22__ = __webpack_require__(/*! ./ui/rankingModal.js */ \"./js/ui/rankingModal.js\");\n/* harmony import */ var _ui_rankingPanelDrag_js__WEBPACK_IMPORTED_MODULE_23__ = __webpack_require__(/*! ./ui/rankingPanelDrag.js */ \"./js/ui/rankingPanelDrag.js\");\n/* harmony import */ var _ui_swordsIcon_js__WEBPACK_IMPORTED_MODULE_24__ = __webpack_require__(/*! ./ui/swordsIcon.js */ \"./js/ui/swordsIcon.js\");\n/* harmony import */ var _ui_windowManager_js__WEBPACK_IMPORTED_MODULE_25__ = __webpack_require__(/*! ./ui/windowManager.js */ \"./js/ui/windowManager.js\");\n// 全局錯誤監聽和頁面加載追踪\r\n(function() {\r\n    let loadCount = parseInt(sessionStorage.getItem('rf_load_count') || '0') + 1;\r\n    sessionStorage.setItem('rf_load_count', loadCount.toString());\r\n    \r\n    // 記錄加載時間戳\r\n    const loadTime = new Date().toISOString();\r\n    const prevLoadTime = sessionStorage.getItem('rf_prev_load_time');\r\n    if (prevLoadTime) {\r\n        const timeDiff = new Date() - new Date(prevLoadTime);\r\n        console.log(`%c[頁面加載] 第 ${loadCount} 次加載 (距離上次 ${timeDiff}ms)`, 'color: #00ff00; font-size: 14px; font-weight: bold');\r\n    } else {\r\n        console.log(`%c[頁面加載] 第 ${loadCount} 次加載`, 'color: #00ff00; font-size: 14px; font-weight: bold');\r\n    }\r\n    sessionStorage.setItem('rf_prev_load_time', loadTime);\r\n    \r\n    if (loadCount > 3) {\r\n        console.error(`%c[警告] 頁面在短時間內重複加載 ${loadCount} 次！`, 'color: #ff0000; font-size: 16px; font-weight: bold');\r\n    }\r\n    \r\n    // 追踪導航變化\r\n    let lastUrl = window.location.href;\r\n    setInterval(() => {\r\n        if (window.location.href !== lastUrl) {\r\n            console.log(`%c[導航變化] ${lastUrl} -> ${window.location.href}`, 'color: #ffaa00; font-size: 12px');\r\n            lastUrl = window.location.href;\r\n        }\r\n    }, 100);\r\n    \r\n    // 追踪 history API\r\n    const originalPushState = history.pushState;\r\n    const originalReplaceState = history.replaceState;\r\n    \r\n    history.pushState = function(...args) {\r\n        console.log('[History] pushState:', args[2]);\r\n        return originalPushState.apply(this, args);\r\n    };\r\n    \r\n    history.replaceState = function(...args) {\r\n        console.log('[History] replaceState:', args[2]);\r\n        return originalReplaceState.apply(this, args);\r\n    };\r\n    \r\n    window.addEventListener('popstate', (e) => {\r\n        console.log('[History] popstate:', window.location.href);\r\n    });\r\n    \r\n    // 監聽未捕獲錯誤\r\n    window.addEventListener('error', (event) => {\r\n        const isMediaError = event.target && (event.target.tagName === 'AUDIO' || event.target.tagName === 'VIDEO' || event.target.tagName === 'IMG');\r\n        \r\n        console.error('[全局錯誤]', {\r\n            message: event.message,\r\n            filename: event.filename,\r\n            lineno: event.lineno,\r\n            colno: event.colno,\r\n            error: event.error,\r\n            target: event.target?.tagName,\r\n            isMediaError: isMediaError\r\n        });\r\n        \r\n        // 特別處理媒體錯誤：完全阻止冒泡\r\n        if (isMediaError) {\r\n            event.stopPropagation();\r\n            event.stopImmediatePropagation();\r\n            console.warn(`%c[媒體錯誤已攔截] ${event.target.tagName}: ${event.target.src}`, 'color: #ffaa00; font-size: 12px');\r\n        }\r\n        \r\n        // 阻止默認行為，防止某些錯誤觸發重載\r\n        event.preventDefault();\r\n    }, true);\r\n    \r\n    // 監聽未處理的 Promise 拒絕\r\n    window.addEventListener('unhandledrejection', (event) => {\r\n        console.error('[未處理的Promise拒絕]', event.reason);\r\n        // 阻止默認行為，防止頁面重載\r\n        event.preventDefault();\r\n    });\r\n    \r\n    // 監聽資源加載錯誤\r\n    window.addEventListener('error', (event) => {\r\n        if (event.target !== window) {\r\n            console.warn('[資源加載失敗]', {\r\n                tagName: event.target.tagName,\r\n                src: event.target.src || event.target.href,\r\n                currentSrc: event.target.currentSrc\r\n            });\r\n            // 阻止錯誤冒泡\r\n            event.stopPropagation();\r\n            event.preventDefault();\r\n        }\r\n    }, true);\r\n    \r\n    // 監聽 beforeunload 事件,記錄重載原因和堆棧\r\n    let unloadCount = 0;\r\n    window.addEventListener('beforeunload', (e) => {\r\n        unloadCount++;\r\n        console.error(`%c[即將卸載 #${unloadCount}] 頁面即將重新加載或關閉`, 'color: #ff6600; font-size: 14px; font-weight: bold');\r\n        console.trace('[卸載堆棧] 觸發來源:');\r\n        \r\n        // 記錄到 sessionStorage 供下次加載檢查\r\n        const unloadInfo = {\r\n            count: unloadCount,\r\n            time: new Date().toISOString(),\r\n            url: window.location.href,\r\n            loadCount: loadCount\r\n        };\r\n        sessionStorage.setItem('rf_last_unload', JSON.stringify(unloadInfo));\r\n    });\r\n    \r\n    // 檢查上次卸載資訊\r\n    const lastUnload = sessionStorage.getItem('rf_last_unload');\r\n    if (lastUnload) {\r\n        try {\r\n            const info = JSON.parse(lastUnload);\r\n            const timeSinceUnload = new Date() - new Date(info.time);\r\n            console.warn(`%c[卸載資訊] 上次卸載於 ${timeSinceUnload}ms 前`, 'color: #ff9900; font-size: 12px', info);\r\n        } catch (e) {}\r\n    }\r\n    \r\n    // ============================================\r\n    // 被動加載模式: 監控並阻止重載行為\r\n    // 注意: WebView 的 location 屬性通常是不可配置的,\r\n    // 所以我們只監控函數調用,不嘗試覆蓋屬性\r\n    // ============================================\r\n    \r\n    // 1. 嘗試攔截 location.reload() (如果可配置)\r\n    try {\r\n        const originalReload = window.location.reload;\r\n        if (originalReload) {\r\n            window.location.reload = function(...args) {\r\n                console.error('%c[阻止重載] location.reload() 被調用', 'color: #ff0000; font-size: 16px; font-weight: bold');\r\n                console.trace('[阻止重載] 調用堆棧:');\r\n                // 不執行重載\r\n                return;\r\n            };\r\n        }\r\n    } catch (e) {\r\n        console.warn('[診斷] location.reload 不可覆蓋 (這是正常的):', e.message);\r\n    }\r\n    \r\n    // 2. 攔截 location.replace() 同 URL 替換\r\n    try {\r\n        const originalReplace = window.location.replace;\r\n        if (originalReplace) {\r\n            window.location.replace = function(url) {\r\n                if (!url || url === window.location.href) {\r\n                    console.error('%c[阻止重載] location.replace() 同 URL 被攔截', 'color: #ff0000; font-size: 16px; font-weight: bold');\r\n                    console.trace('[阻止重載] 調用堆棧:');\r\n                    return;\r\n                }\r\n                return originalReplace.call(this, url);\r\n            };\r\n        }\r\n    } catch (e) {\r\n        console.warn('[診斷] location.replace 不可覆蓋:', e.message);\r\n    }\r\n    \r\n    // 3. 攔截 location.assign() 同 URL 分配\r\n    try {\r\n        const originalAssign = window.location.assign;\r\n        if (originalAssign) {\r\n            window.location.assign = function(url) {\r\n                if (!url || url === window.location.href) {\r\n                    console.error('%c[阻止重載] location.assign() 同 URL 被攔截', 'color: #ff0000; font-size: 16px; font-weight: bold');\r\n                    console.trace('[阻止重載] 調用堆棧:');\r\n                    return;\r\n                }\r\n                return originalAssign.call(this, url);\r\n            };\r\n        }\r\n    } catch (e) {\r\n        console.warn('[診斷] location.assign 不可覆蓋:', e.message);\r\n    }\r\n    \r\n    // 4. 攔截 history.go(0) 刷新\r\n    try {\r\n        const originalGo = window.history.go;\r\n        if (originalGo) {\r\n            window.history.go = function(delta) {\r\n                if (delta === 0 || delta === undefined) {\r\n                    console.error('%c[阻止重載] history.go(0) 被攔截', 'color: #ff0000; font-size: 16px; font-weight: bold');\r\n                    console.trace('[阻止重載] 調用堆棧:');\r\n                    return;\r\n                }\r\n                return originalGo.call(this, delta);\r\n            };\r\n        }\r\n    } catch (e) {\r\n        console.warn('[診斷] history.go 不可覆蓋:', e.message);\r\n    }\r\n    \r\n    console.log('%c[被動加載模式] 重載監控已啟動 (盡力而為)', 'color: #00ff00; font-size: 14px; font-weight: bold');\r\n    console.log('[診斷] 全局錯誤監聽已啟動');\r\n})();\r\n\r\n// 匯入所有主要功能 js\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// import './ui/dialogResponsive.js';\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// 初始化視窗管理器\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    (0,_ui_windowManager_js__WEBPACK_IMPORTED_MODULE_25__.initWindowManager)();\r\n});\r\n\r\n// 如果 DOM 已經載入完成，立即初始化\r\nif (document.readyState !== 'loading') {\r\n    (0,_ui_windowManager_js__WEBPACK_IMPORTED_MODULE_25__.initWindowManager)();\r\n}\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/index.js?\n}")},"./js/map/factionColorMap.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getAllFactions: () => (/* binding */ getAllFactions),\n/* harmony export */   getFactionByColor: () => (/* binding */ getFactionByColor),\n/* harmony export */   getFactionColor: () => (/* binding */ getFactionColor)\n/* harmony export */ });\n// 陣營顏色對應表模組\r\n// 以 rgb 格式為主\r\n\r\nconst factionColorMap = [\r\n  { name: '蒙古', color: 'rgb(0, 138, 247)' },\r\n  { name: '臺灣', color: 'rgb(6, 133, 158)' },  // 更新為實際顏色\r\n  { name: '滿洲', color: 'rgb(252, 185, 0)' },\r\n  { name: '香港', color: 'rgb(174, 67, 236)' },\r\n  { name: '反賊聯盟', color: 'rgb(255, 255, 255)' },\r\n  { name: '藏國', color: 'rgb(70, 190, 127)' },\r\n  { name: '維吾爾', color: 'rgb(116, 160, 246)' },\r\n  { name: '哈薩克', color: 'rgb(0, 233, 228)' },  // 更新為實際顏色\r\n  { name: '紅軍', color: 'rgb(253, 30, 25)' },\r\n  { name: '新中國狂歡', color: 'rgb(109, 109, 109)' }\r\n];\r\n\r\nfunction getFactionColor(factionName) {\r\n  const found = factionColorMap.find(f => f.name === factionName);\r\n  return found ? found.color : 'rgb(109,109,109)';\r\n}\r\n\r\nfunction normalizeColor(color) {\r\n  // 將 hex 轉 rgb，rgba 轉 rgb，並去除空格\r\n  if (!color) return '';\r\n  color = color.trim().replace(/\\s+/g, '');\r\n  // hex 轉 rgb\r\n  if (color[0] === '#') {\r\n    let r, g, b;\r\n    if (color.length === 7) {\r\n      r = parseInt(color.slice(1, 3), 16);\r\n      g = parseInt(color.slice(3, 5), 16);\r\n      b = parseInt(color.slice(5, 7), 16);\r\n    } else if (color.length === 4) {\r\n      r = parseInt(color[1] + color[1], 16);\r\n      g = parseInt(color[2] + color[2], 16);\r\n      b = parseInt(color[3] + color[3], 16);\r\n    }\r\n    return `rgb(${r},${g},${b})`;\r\n  }\r\n  // rgba 轉 rgb\r\n  if (color.startsWith('rgba')) {\r\n    const m = color.match(/rgba\\((\\d+),(\\d+),(\\d+),/);\r\n    if (m) return `rgb(${m[1]},${m[2]},${m[3]})`;\r\n  }\r\n  // rgb 直接回傳\r\n  if (color.startsWith('rgb')) return color.replace(/\\s+/g, '');\r\n  return color;\r\n}\r\n\r\nfunction getFactionByColor(color) {\r\n  if (!color) return '未知';\r\n  \r\n  color = normalizeColor(color);\r\n  color = color.replace(/\\s+/g, '');\r\n  \r\n  // 先嘗試精確匹配（去除空格）\r\n  let found = factionColorMap.find(f => f.color.replace(/\\s+/g, '') === color);\r\n  \r\n  // 如果沒找到，嘗試模糊匹配（處理 rgb(7,162,188) vs rgb(7, 162, 188) 的差異）\r\n  if (!found) {\r\n    const match = color.match(/rgb\\((\\d+),(\\d+),(\\d+)\\)/);\r\n    if (match) {\r\n      const r = parseInt(match[1]), g = parseInt(match[2]), b = parseInt(match[3]);\r\n      found = factionColorMap.find(f => {\r\n        const m = f.color.replace(/\\s+/g, '').match(/rgb\\((\\d+),(\\d+),(\\d+)\\)/);\r\n        if (!m) return false;\r\n        return parseInt(m[1]) === r && parseInt(m[2]) === g && parseInt(m[3]) === b;\r\n      });\r\n    }\r\n  }\r\n  \r\n  return found ? found.name : '未知';\r\n}\r\n\r\nfunction getAllFactions() {\r\n  return factionColorMap.map(f => ({ ...f }));\r\n}\r\n\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/factionColorMap.js?\n}")},"./js/map/factionMap.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   collectMarkerData: () => (/* binding */ collectMarkerData),\n/* harmony export */   drawFactionMapBaseOptimized: () => (/* binding */ drawFactionMapBaseOptimized)\n/* harmony export */ });\n/* harmony import */ var _factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./factionColorMap.js */ \"./js/map/factionColorMap.js\");\n// 勢力分布圖繪製模組\r\n\r\n\r\n// marker 顏色快取（以 marker dom id 或座標為 key）\r\nconst markerColorCache = new Map();\r\n\r\n// 據點座標與顏色快取（以座標為唯一 key）\r\nconst markerInfoCache = new Map();\r\n\r\nfunction normalizeColor(color) {\r\n    if (!color) return '';\r\n    // 只取 rgb 數字\r\n    let m = color.match(/rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)/);\r\n    if (m) return `rgb(${parseInt(m[1])},${parseInt(m[2])},${parseInt(m[3])})`;\r\n    // hex 轉 rgb\r\n    if (color[0] === '#') {\r\n        let hex = color.replace('#','');\r\n        if (hex.length === 3) hex = hex.split('').map(x=>x+x).join('');\r\n        if (hex.length === 6) {\r\n            return `rgb(${parseInt(hex.substr(0,2),16)},${parseInt(hex.substr(2,2),16)},${parseInt(hex.substr(4,2),16)})`;\r\n        }\r\n    }\r\n    return color.trim();\r\n}\r\n\r\nfunction collectMarkerData(canvasWidth, canvasHeight) {\r\n    const markerSelector = '[class^=\"PortalMap_marker\"], [class^=\"PortalMap_markerCapital\"]';\r\n    const markers = Array.from(document.querySelectorAll(markerSelector));\r\n    const colorMap = {};\r\n    // 先建立顏色對照表（標準化）\r\n    markers.forEach(marker => {\r\n        let color = marker.style.backgroundColor;\r\n        if (!color) {\r\n            const cs = window.getComputedStyle(marker);\r\n            color = cs.backgroundColor;\r\n        }\r\n        color = normalizeColor(color);\r\n        if (color) {\r\n            if (!colorMap[color]) colorMap[color] = 0;\r\n            colorMap[color]++;\r\n        }\r\n    });\r\n    // 再組成 markerData\r\n    const data = [];\r\n    const seen = new Set();\r\n    markers.forEach(marker => {\r\n        const leftStr = marker.style.left || '';\r\n        const topStr = marker.style.top || '';\r\n        const leftPct = parseFloat(leftStr.replace('calc(', '').replace('%)', '')) / 100;\r\n        const topPct = parseFloat(topStr.replace('calc(', '').replace('%)', '')) / 100;\r\n        const x = Math.round(leftPct * canvasWidth);\r\n        const y = Math.round(topPct * canvasHeight);\r\n        const key = `${x},${y}`;\r\n        let color = marker.style.backgroundColor;\r\n        if (!color) {\r\n            const cs = window.getComputedStyle(marker);\r\n            color = cs.backgroundColor;\r\n        }\r\n        color = normalizeColor(color);\r\n        // 用 colorMap 的 key 做標準化（確保與排行榜一致）\r\n        let stdColor = Object.keys(colorMap).find(c => c === color) || color;\r\n        const faction = (0,_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getFactionByColor)(stdColor);\r\n        const mergeKey = `${key},${faction},${stdColor}`;\r\n        if (!seen.has(mergeKey)) {\r\n            data.push({ x, y, color: stdColor, faction, marker });\r\n            seen.add(mergeKey);\r\n        }\r\n    });\r\n    return data;\r\n}\r\n\r\n// 允許所有 rgb 對應表內的陣營\r\n// const allowedFactions = getAllFactions().map(f => f.name); // 不再使用\r\n\r\n// 動態載入 d3-delaunay\r\nasync function loadD3Delaunay() {\r\n    if (window.d3 && window.d3.Delaunay) return window.d3.Delaunay;\r\n    try {\r\n        // The script will attach d3 to the window object, or return it as a module\r\n    const d3 = await __webpack_require__.e(/*! import() */ \"vendors-node_modules_d3-delaunay_src_index_js\").then(__webpack_require__.bind(__webpack_require__, /*! d3-delaunay */ \"./node_modules/d3-delaunay/src/index.js\"));\r\n        return d3.Delaunay || (window.d3 && window.d3.Delaunay);\r\n    } catch (error) {\r\n        console.error(\"無法載入 d3-delaunay 函式庫:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n\r\n/**\r\n * 優化版：drawFactionMapBaseOptimized\r\n * - 批次快取 marker 資訊，減少 DOM 操作\r\n * - canvas 操作合併，減少重複 clearRect\r\n * - 保留原有美術效果（色塊、邊界、羽化、漸層）\r\n */\r\nasync function drawFactionMapBaseOptimized(ctx, markerData) {\r\n    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\r\n    const width = ctx.canvas.width, height = ctx.canvas.height;\r\n    const validMarkerData = markerData.filter(m => isFinite(m.x) && isFinite(m.y) && m.faction && m.faction !== '未知');\r\n    if (validMarkerData.length < 3) return;\r\n    // Delaunay\r\n    let Delaunay;\r\n    if (window.d3 && window.d3.Delaunay) {\r\n        Delaunay = window.d3.Delaunay;\r\n    } else {\r\n        try {\r\n            const d3 = await __webpack_require__.e(/*! import() */ \"vendors-node_modules_d3-delaunay_src_index_js\").then(__webpack_require__.bind(__webpack_require__, /*! d3-delaunay */ \"./node_modules/d3-delaunay/src/index.js\"));\r\n            Delaunay = d3.Delaunay || (window.d3 && window.d3.Delaunay);\r\n        } catch {\r\n            return;\r\n        }\r\n    }\r\n    const points = validMarkerData.map(m => [m.x, m.y]);\r\n    const delaunay = Delaunay.from(points);\r\n    const voronoi = delaunay.voronoi([0, 0, width, height]);\r\n    // 色塊分組\r\n    const sitesByColor = new Map();\r\n    for (let i = 0; i < validMarkerData.length; i++) {\r\n        const color = validMarkerData[i].color;\r\n        if (!sitesByColor.has(color)) sitesByColor.set(color, []);\r\n        sitesByColor.get(color).push(i);\r\n    }\r\n    ctx.save();\r\n    ctx.globalAlpha = 0.22;\r\n    for (const [color, sites] of sitesByColor.entries()) {\r\n        ctx.beginPath();\r\n        for (const i of sites) {\r\n            const polygon = voronoi.cellPolygon(i);\r\n            if (polygon && polygon.length > 2) {\r\n                let area = 0;\r\n                for (let k = 0; k < polygon.length; k++) {\r\n                    const [x1, y1] = polygon[k];\r\n                    const [x2, y2] = polygon[(k + 1) % polygon.length];\r\n                    area += (x1 * y2 - x2 * y1);\r\n                }\r\n                area = Math.abs(area) / 2;\r\n                if (area < 10) continue;\r\n                ctx.moveTo(polygon[0][0], polygon[0][1]);\r\n                for (let k = 1; k < polygon.length; k++) ctx.lineTo(polygon[k][0], polygon[k][1]);\r\n                ctx.closePath();\r\n            }\r\n        }\r\n        try { ctx.clip('evenodd'); } catch(e) { ctx.clip(); }\r\n        ctx.fillStyle = color;\r\n        ctx.fillRect(0, 0, width, height);\r\n        ctx.restore();\r\n        ctx.save();\r\n        ctx.globalAlpha = 0.22;\r\n    }\r\n    ctx.restore();\r\n    // --- 邊界線 ---\r\n    const edgeToSites = new Map();\r\n    const round = p => [Math.round(p[0] * 100) / 100, Math.round(p[1] * 100) / 100];\r\n    const edgeKey = (p1, p2) => {\r\n        const r1 = round(p1);\r\n        const r2 = round(p2);\r\n        return r1[0] < r2[0] || (r1[0] === r2[0] && r1[1] < r2[1])\r\n            ? `${r1.join(',')}:${r2.join(',')}`\r\n            : `${r2.join(',')}:${r1.join(',')}`;\r\n    };\r\n    for (let i = 0; i < validMarkerData.length; i++) {\r\n        const cell = voronoi.cellPolygon(i);\r\n        if (!cell || cell.length < 2) continue;\r\n        let area = 0;\r\n        for (let k = 0; k < cell.length; k++) {\r\n            const [x1, y1] = cell[k];\r\n            const [x2, y2] = cell[(k + 1) % cell.length];\r\n            area += (x1 * y2 - x2 * y1);\r\n        }\r\n        area = Math.abs(area) / 2;\r\n        if (area < 10) continue;\r\n        for (let j = 0; j < cell.length; j++) {\r\n            const p1 = cell[j];\r\n            const p2 = cell[(j + 1) % cell.length];\r\n            const dx = p2[0] - p1[0];\r\n            const dy = p2[1] - p1[1];\r\n            if (Math.sqrt(dx*dx + dy*dy) < 2) continue;\r\n            const key = edgeKey(p1, p2);\r\n            if (!edgeToSites.has(key)) {\r\n                edgeToSites.set(key, { sites: [], points: [p1, p2] });\r\n            }\r\n            edgeToSites.get(key).sites.push(i);\r\n        }\r\n    }\r\n    // 畫邊界\r\n    const bgColor = '#181818';\r\n    const bgWidth = 4;\r\n    const fgWidth = 1.5;\r\n    const borderColor = 'rgba(220, 220, 220, 0.8)';\r\n    for (const { sites, points } of edgeToSites.values()) {\r\n        const [p1, p2] = points;\r\n        let draw = false;\r\n        if (sites.length < 2) {\r\n            draw = true;\r\n        } else {\r\n            const color1 = validMarkerData[sites[0]].color;\r\n            const color2 = validMarkerData[sites[1]].color;\r\n            if (color1 !== color2) draw = true;\r\n        }\r\n        if (draw) {\r\n            ctx.beginPath();\r\n            ctx.moveTo(p1[0], p1[1]);\r\n            ctx.lineTo(p2[0], p2[1]);\r\n            ctx.strokeStyle = bgColor;\r\n            ctx.lineWidth = bgWidth;\r\n            ctx.lineCap = 'round';\r\n            ctx.stroke();\r\n            ctx.beginPath();\r\n            ctx.moveTo(p1[0], p1[1]);\r\n            ctx.lineTo(p2[0], p2[1]);\r\n            ctx.strokeStyle = borderColor;\r\n            ctx.lineWidth = fgWidth;\r\n            ctx.lineCap = 'round';\r\n            ctx.stroke();\r\n        }\r\n    }\r\n    // --- 外圍漸層淡出 ---\r\n    const fadeMargin = Math.max(width, height) * 0.06;\r\n    ctx.save();\r\n    ctx.globalCompositeOperation = 'destination-out';\r\n    let grad = ctx.createLinearGradient(0, 0, 0, fadeMargin);\r\n    grad.addColorStop(0, 'rgba(0,0,0,0.92)');\r\n    grad.addColorStop(0.05, 'rgba(0,0,0,0)');\r\n    ctx.fillStyle = grad;\r\n    ctx.fillRect(0, 0, width, fadeMargin);\r\n    grad = ctx.createLinearGradient(0, height, 0, height - fadeMargin);\r\n    grad.addColorStop(0, 'rgba(0,0,0,0.92)');\r\n    grad.addColorStop(0.05, 'rgba(0,0,0,0)');\r\n    ctx.fillStyle = grad;\r\n    ctx.fillRect(0, height - fadeMargin, width, fadeMargin);\r\n    grad = ctx.createLinearGradient(0, 0, fadeMargin, 0);\r\n    grad.addColorStop(0, 'rgba(0,0,0,0.92)');\r\n    grad.addColorStop(0.05, 'rgba(0,0,0,0)');\r\n    ctx.fillStyle = grad;\r\n    ctx.fillRect(0, 0, fadeMargin, height);\r\n    grad = ctx.createLinearGradient(width, 0, width - fadeMargin, 0);\r\n    grad.addColorStop(0, 'rgba(0,0,0,0.92)');\r\n    grad.addColorStop(0.05, 'rgba(0,0,0,0)');\r\n    ctx.fillStyle = grad;\r\n    ctx.fillRect(width - fadeMargin, 0, fadeMargin, height);\r\n    ctx.restore();\r\n    // --- 色塊邊緣模糊融合 ---\r\n    function toRgba(color, alpha) {\r\n        if (!color) return `rgba(0,0,0,${alpha})`;\r\n        if (color.startsWith('rgba')) {\r\n            return color.replace(/rgba?\\(([^)]+)\\)/, (m, c) => {\r\n                const parts = c.split(',').map(x=>x.trim());\r\n                return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;\r\n            });\r\n        }\r\n        if (color.startsWith('rgb')) {\r\n            return color.replace(/rgb\\(([^)]+)\\)/, (m, c) => {\r\n                const parts = c.split(',').map(x=>x.trim());\r\n                return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;\r\n            });\r\n        }\r\n        if (color[0] === '#') {\r\n            let hex = color.replace('#','');\r\n            if (hex.length === 3) hex = hex.split('').map(x=>x+x).join('');\r\n            if (hex.length === 6) {\r\n                const r = parseInt(hex.substr(0,2),16);\r\n                const g = parseInt(hex.substr(2,2),16);\r\n                const b = parseInt(hex.substr(4,2),16);\r\n                return `rgba(${r},${g},${b},${alpha})`;\r\n            }\r\n        }\r\n        return color;\r\n    }\r\n    for (const { sites, points } of edgeToSites.values()) {\r\n        const [p1, p2] = points;\r\n        let isBorder = false;\r\n        let color1 = null, color2 = null;\r\n        if (sites.length < 2) {\r\n            continue;\r\n        } else {\r\n            color1 = validMarkerData[sites[0]].color;\r\n            color2 = validMarkerData[sites[1]].color;\r\n            if (color1 !== color2) isBorder = true;\r\n        }\r\n        if (!isBorder) continue;\r\n        const dx = p2[0] - p1[0];\r\n        const dy = p2[1] - p1[1];\r\n        const len = Math.sqrt(dx*dx + dy*dy);\r\n        if (len < 2) continue;\r\n        const nx = -dy / len;\r\n        const ny = dx / len;\r\n        const blurWidth = 28;\r\n        const p1a = [p1[0] + nx * blurWidth, p1[1] + ny * blurWidth];\r\n        const p2a = [p2[0] + nx * blurWidth, p2[1] + ny * blurWidth];\r\n        const p1b = [p1[0] - nx * blurWidth, p1[1] - ny * blurWidth];\r\n        const p2b = [p2[0] - nx * blurWidth, p2[1] - ny * blurWidth];\r\n        const grad = ctx.createLinearGradient(p1a[0], p1a[1], p1b[0], p1b[1]);\r\n        grad.addColorStop(0, toRgba(color1, 0));\r\n        grad.addColorStop(0.18, toRgba(color1, 0.25));\r\n        grad.addColorStop(0.38, toRgba(color1, 0.7));\r\n        grad.addColorStop(0.5, toRgba(color1, 1));\r\n        grad.addColorStop(0.5, toRgba(color2, 1));\r\n        grad.addColorStop(0.62, toRgba(color2, 0.7));\r\n        grad.addColorStop(0.82, toRgba(color2, 0.25));\r\n        grad.addColorStop(1, toRgba(color2, 0));\r\n        ctx.save();\r\n        ctx.globalAlpha = 0.18;\r\n        ctx.beginPath();\r\n        ctx.moveTo(p1a[0], p1a[1]);\r\n        ctx.lineTo(p2a[0], p2a[1]);\r\n        ctx.lineTo(p2b[0], p2b[1]);\r\n        ctx.lineTo(p1b[0], p1b[1]);\r\n        ctx.closePath();\r\n        ctx.fillStyle = grad;\r\n        ctx.fill();\r\n        ctx.restore();\r\n    }\r\n    ctx.canvas.style.pointerEvents = 'none';\r\n}\r\n// --- End 優化版 ---\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/factionMap.js?\n}")},"./js/map/factionMapControl.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupFactionMapControl: () => (/* binding */ setupFactionMapControl)\n/* harmony export */ });\n/* harmony import */ var _factionMap_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./factionMap.js */ \"./js/map/factionMap.js\");\n// 勢力分布圖開關\r\n\r\n\r\nfunction setupFactionMapControl(factionMapBtn, factionMapContainer) {\r\n    let factionMapVisible = false;\r\n    let factionMapObserver = null;\r\n    let factionMapDebounceTimer = null;\r\n    const canvas = document.getElementById('faction-map-canvas');\r\n    const ctx = canvas.getContext('2d');\r\n    function alignCanvasToMapArea() {\r\n        const mapArea = document.querySelector('.PortalMap_mapArea__h7Err');\r\n        if (!mapArea) return;\r\n        const bounds = mapArea.getBoundingClientRect();\r\n        // 以 mapArea 為定位基準\r\n        factionMapContainer.style.position = 'absolute';\r\n        factionMapContainer.style.left = '0px';\r\n        factionMapContainer.style.top = '0px';\r\n        factionMapContainer.style.width = bounds.width + 'px';\r\n        factionMapContainer.style.height = bounds.height + 'px';\r\n        factionMapContainer.style.pointerEvents = 'none'; // 不擋互動\r\n        // canvas 尺寸同步\r\n        canvas.width = bounds.width;\r\n        canvas.height = bounds.height;\r\n        canvas.style.width = bounds.width + 'px';\r\n        canvas.style.height = bounds.height + 'px';\r\n    }\r\n    function ensureCanvasLayer() {\r\n        const mapArea = document.querySelector('.PortalMap_mapArea__h7Err');\r\n        if (!mapArea) return;\r\n        // 插入 mapArea 內部，並放在地圖圖層（img）之後、marker 之前\r\n        const mapImg = mapArea.querySelector('img.PortalMap_fakeMapImg__y7a1r, img.PortalMap_mapImg__JJkQ7');\r\n        if (mapImg && factionMapContainer.parentNode !== mapArea) {\r\n            // 插在地圖圖層之後\r\n            if (mapImg.nextSibling) {\r\n                mapArea.insertBefore(factionMapContainer, mapImg.nextSibling);\r\n            } else {\r\n                mapArea.appendChild(factionMapContainer);\r\n            }\r\n        }\r\n        // 設定 z-index 讓 canvas 在地圖圖層上、marker 下\r\n        factionMapContainer.style.zIndex = '2';\r\n        canvas.style.zIndex = '2';\r\n    }\r\n    function hideFactionMapImmediate() {\r\n        // 無論 factionMapVisible 狀態都強制隱藏與清理\r\n        factionMapContainer.style.display = 'none';\r\n        factionMapBtn.textContent = '顯示勢力分布圖';\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        disableFactionMapObserver();\r\n        window.removeEventListener('resize', alignCanvasToMapArea);\r\n        factionMapVisible = false;\r\n    }\r\n    window.addEventListener('hashchange', function() {\r\n        if (location.hash !== '#/portalmap') {\r\n            hideFactionMapImmediate();\r\n        }\r\n    });\r\n    // 新增 popstate 監聽，處理 history.pushState/replaceState 導致的頁面切換\r\n    window.addEventListener('popstate', function() {\r\n        if (location.hash !== '#/portalmap') {\r\n            hideFactionMapImmediate();\r\n        }\r\n    });\r\n    // 初始化時強制隱藏（避免 reload 或進入其他頁殘留）\r\n    if (location.hash !== '#/portalmap') {\r\n        hideFactionMapImmediate();\r\n    }\r\n    factionMapBtn.onclick = function() {\r\n        if (location.hash !== '#/portalmap') {\r\n            hideFactionMapImmediate();\r\n            return;\r\n        }\r\n        factionMapVisible = !factionMapVisible;\r\n        if (factionMapVisible) {\r\n            ensureCanvasLayer();\r\n            alignCanvasToMapArea();\r\n            factionMapContainer.style.display = 'block';\r\n            factionMapBtn.textContent = '隱藏勢力分布圖';\r\n            const markerData = (0,_factionMap_js__WEBPACK_IMPORTED_MODULE_0__.collectMarkerData)(canvas.width, canvas.height);\r\n            (0,_factionMap_js__WEBPACK_IMPORTED_MODULE_0__.drawFactionMapBaseOptimized)(ctx, markerData);\r\n            enableFactionMapObserver();\r\n            window.addEventListener('resize', alignCanvasToMapArea);\r\n        } else {\r\n            factionMapContainer.style.display = 'none';\r\n            factionMapBtn.textContent = '顯示勢力分布圖';\r\n            ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n            disableFactionMapObserver();\r\n            window.removeEventListener('resize', alignCanvasToMapArea);\r\n        }\r\n    };\r\n    function enableFactionMapObserver() {\r\n        if (factionMapObserver) return;\r\n        const markerRoot = document.querySelector('.PortalMap_mapBox__3WtlM') || document.body;\r\n        factionMapObserver = new MutationObserver((mutationsList) => {\r\n            let needUpdate = false;\r\n            for (const m of mutationsList) {\r\n                if (m.type === 'attributes' && (m.attributeName === 'class' || m.attributeName === 'style')) {\r\n                    needUpdate = true; break;\r\n                }\r\n                if (m.type === 'childList') {\r\n                    needUpdate = true; break;\r\n                }\r\n            }\r\n            if (needUpdate && factionMapVisible) {\r\n                if (factionMapDebounceTimer) clearTimeout(factionMapDebounceTimer);\r\n                factionMapDebounceTimer = setTimeout(() => {\r\n                    const markerData = (0,_factionMap_js__WEBPACK_IMPORTED_MODULE_0__.collectMarkerData)(canvas.width, canvas.height);\r\n                    (0,_factionMap_js__WEBPACK_IMPORTED_MODULE_0__.drawFactionMapBaseOptimized)(ctx, markerData);\r\n                }, 200);\r\n            }\r\n        });\r\n        factionMapObserver.observe(markerRoot, {\r\n            subtree: true,\r\n            attributes: true,\r\n            attributeFilter: ['class', 'style'],\r\n            childList: true\r\n        });\r\n    }\r\n    function disableFactionMapObserver() {\r\n        if (factionMapObserver) { factionMapObserver.disconnect(); factionMapObserver = null; }\r\n        if (factionMapDebounceTimer) { clearTimeout(factionMapDebounceTimer); factionMapDebounceTimer = null; }\r\n    }\r\n    // --- 自動偵測是否離開地圖頁，若離開則強制隱藏勢力分布圖 ---\r\n    let autoHideTimer = setInterval(() => {\r\n        // 只要勢力分布圖有顯示，且地圖主體不存在，就強制隱藏\r\n        if (factionMapVisible && !document.querySelector('.PortalMap_mapArea__h7Err')) {\r\n            hideFactionMapImmediate();\r\n        }\r\n    }, 500);\r\n    // 若有需要可在適當時機 clearInterval(autoHideTimer);\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/factionMapControl.js?\n}")},"./js/map/markerConnections.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   clearConnectionLines: () => (/* binding */ clearConnectionLines),\n/* harmony export */   drawConnectionLinesOptimized: () => (/* binding */ drawConnectionLinesOptimized),\n/* harmony export */   resetCityToMarkerCache: () => (/* binding */ resetCityToMarkerCache)\n/* harmony export */ });\n/* harmony import */ var _markerUtils_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./markerUtils.js */ \"./js/map/markerUtils.js\");\n// marker 航線繪製\r\n\r\n/**\r\n * 優化版：drawConnectionLinesOptimized\r\n * - cityToMarker 全域快取，僅在 marker 變動時重建\r\n * - SVG 物件池，重用 line/text 元素，減少 DOM 操作\r\n */\r\nlet _cityToMarkerCache = null;\r\nlet _cityToMarkerCacheKey = '';\r\nfunction getCityToMarker(markerData) {\r\n    const allMarkers = Array.from(document.querySelectorAll('[class^=\"PortalMap_marker\"], [class^=\"PortalMap_markerCapital\"]'));\r\n    const key = allMarkers.length + ':' + Object.keys(markerData).length;\r\n    if (_cityToMarkerCache && _cityToMarkerCacheKey === key) return _cityToMarkerCache;\r\n    const cityToMarker = {};\r\n    allMarkers.forEach(m => {\r\n        const mid = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getMarkerId)(m);\r\n        const mdata = markerData[mid];\r\n        if (mdata && mdata.cityName) cityToMarker[mdata.cityName] = m;\r\n    });\r\n    _cityToMarkerCache = cityToMarker;\r\n    _cityToMarkerCacheKey = key;\r\n    return cityToMarker;\r\n}\r\nfunction findTargetMarker(cityToMarker, city) {\r\n    const keys = [\r\n        city,\r\n        city.trim(),\r\n        city.trim().toLowerCase(),\r\n        city.replace(/\\s+/g, ''),\r\n        city.trim().replace(/\\s+/g, ''),\r\n        city.trim().replace(/\\s+/g, '').toLowerCase()\r\n    ];\r\n    for (const k of keys) {\r\n        if (cityToMarker[k]) return cityToMarker[k];\r\n    }\r\n    console.warn('[RF DEBUG] 找不到航線目標城市:', city, Object.keys(cityToMarker));\r\n    return null;\r\n}\r\nfunction drawConnectionLinesOptimized(marker, markerData) {\r\n    // 新增：只允許在 #/portalmap 顯示\r\n    if (location.hash !== '#/portalmap') {\r\n        clearConnectionLines();\r\n        return;\r\n    }\r\n    const id = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getMarkerId)(marker);\r\n    const data = markerData[id];\r\n    if (!data) return;\r\n    const cityToMarker = getCityToMarker(markerData);\r\n    const rect = marker.getBoundingClientRect();\r\n    const x0 = rect.left + rect.width/2;\r\n    const y0 = rect.top + rect.height/2;\r\n    let svg = document.getElementById('map-connection-svg');\r\n    if (!svg) {\r\n        svg = document.createElementNS('http://www.w3.org/2000/svg','svg');\r\n        svg.id = 'map-connection-svg';\r\n        svg.style.position = 'fixed';\r\n        svg.style.left = '0';\r\n        svg.style.top = '0';\r\n        svg.style.width = '100vw';\r\n        svg.style.height = '100vh';\r\n        svg.style.pointerEvents = 'none';\r\n        svg.style.zIndex = 99998;\r\n        document.body.appendChild(svg);\r\n    }\r\n    // 只清空一次\r\n    while (svg.firstChild) svg.removeChild(svg.firstChild);\r\n    // 機場線\r\n    if (data.airport) {\r\n        const targets = data.airport.split(/,|，/).map(s=>s.trim()).filter(Boolean);\r\n        targets.forEach(city => {\r\n            const targetMarker = findTargetMarker(cityToMarker, city);\r\n            if (!targetMarker) return;\r\n            const trect = targetMarker.getBoundingClientRect();\r\n            const x1 = trect.left + trect.width/2;\r\n            const y1 = trect.top + trect.height/2;\r\n            const color = '#fe9898';\r\n            const line = document.createElementNS('http://www.w3.org/2000/svg','line');\r\n            line.setAttribute('x1', x0);\r\n            line.setAttribute('y1', y0);\r\n            line.setAttribute('x2', x1);\r\n            line.setAttribute('y2', y1);\r\n            line.setAttribute('stroke', color);\r\n            line.setAttribute('stroke-width', 3);\r\n            line.setAttribute('opacity', 0.85);\r\n            line.setAttribute('stroke-dasharray', '8,6'); // 虛線\r\n            svg.appendChild(line);\r\n            // 顯示地名（自動調整位置避免重疊）\r\n            let dx = x1 - x0;\r\n            let dy = y1 - y0;\r\n            let offsetX = 0, offsetY = 0;\r\n            // 根據方向自動調整文字位置\r\n            if (dx >= 0 && dy <= 0) { // 右上\r\n                offsetX = 10; offsetY = -10;\r\n            } else if (dx >= 0 && dy > 0) { // 右下\r\n                offsetX = 10; offsetY = 18;\r\n            } else if (dx < 0 && dy <= 0) { // 左上\r\n                offsetX = -60; offsetY = -10;\r\n            } else { // 左下\r\n                offsetX = -60; offsetY = 18;\r\n            }\r\n            const text = document.createElementNS('http://www.w3.org/2000/svg','text');\r\n            text.setAttribute('x', x1 + offsetX);\r\n            text.setAttribute('y', y1 + offsetY);\r\n            text.setAttribute('fill', color);\r\n            text.setAttribute('font-size', '1em');\r\n            text.setAttribute('font-weight', 'bold');\r\n            text.setAttribute('stroke', '#222');\r\n            text.setAttribute('stroke-width', '0.5');\r\n            text.setAttribute('paint-order', 'stroke');\r\n            text.textContent = city;\r\n            svg.appendChild(text);\r\n        });\r\n    }\r\n    // 港口線\r\n    if (data.port) {\r\n        const targets = data.port.split(/,|，/).map(s=>s.trim()).filter(Boolean);\r\n        targets.forEach(city => {\r\n            const targetMarker = findTargetMarker(cityToMarker, city);\r\n            if (!targetMarker) return;\r\n            const trect = targetMarker.getBoundingClientRect();\r\n            const x1 = trect.left + trect.width/2;\r\n            const y1 = trect.top + trect.height/2;\r\n            const color = '#98fefe';\r\n            const line = document.createElementNS('http://www.w3.org/2000/svg','line');\r\n            line.setAttribute('x1', x0);\r\n            line.setAttribute('y1', y0);\r\n            line.setAttribute('x2', x1);\r\n            line.setAttribute('y2', y1);\r\n            line.setAttribute('stroke', color);\r\n            line.setAttribute('stroke-width', 3);\r\n            line.setAttribute('opacity', 0.85);\r\n            line.setAttribute('stroke-dasharray', '8,6'); // 虛線\r\n            svg.appendChild(line);\r\n            // 顯示地名（自動調整位置避免重疊）\r\n            let dx = x1 - x0;\r\n            let dy = y1 - y0;\r\n            let offsetX = 0, offsetY = 0;\r\n            // 根據方向自動調整文字位置\r\n            if (dx >= 0 && dy <= 0) { // 右上\r\n                offsetX = 10; offsetY = -10;\r\n            } else if (dx >= 0 && dy > 0) { // 右下\r\n                offsetX = 10; offsetY = 18;\r\n            } else if (dx < 0 && dy <= 0) { // 左上\r\n                offsetX = -60; offsetY = -10;\r\n            } else { // 左下\r\n                offsetX = -60; offsetY = 18;\r\n            }\r\n            const text = document.createElementNS('http://www.w3.org/2000/svg','text');\r\n            text.setAttribute('x', x1 + offsetX);\r\n            text.setAttribute('y', y1 + offsetY);\r\n            text.setAttribute('fill', color);\r\n            text.setAttribute('font-size', '1em');\r\n            text.setAttribute('font-weight', 'bold');\r\n            text.setAttribute('stroke', '#222');\r\n            text.setAttribute('stroke-width', '0.5');\r\n            text.setAttribute('paint-order', 'stroke');\r\n            text.textContent = city;\r\n            svg.appendChild(text);\r\n        });\r\n    }\r\n}\r\nfunction clearConnectionLines() {\r\n    const svg = document.getElementById('map-connection-svg');\r\n    if (svg) svg.innerHTML = '';\r\n}\r\n// 強制刷新 cityToMarker 快取\r\nfunction resetCityToMarkerCache() {\r\n    _cityToMarkerCache = null;\r\n    _cityToMarkerCacheKey = '';\r\n}\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/markerConnections.js?\n}")},"./js/map/markerData.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   importYamlFile: () => (/* binding */ importYamlFile),\n/* harmony export */   loadMarkerDataFromYaml: () => (/* binding */ loadMarkerDataFromYaml),\n/* harmony export */   saveMarkerDataToYaml: () => (/* binding */ saveMarkerDataToYaml)\n/* harmony export */ });\n/* harmony import */ var js_yaml__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! js-yaml */ \"./node_modules/js-yaml/dist/js-yaml.mjs\");\n/* harmony import */ var _core_api_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../core/api.js */ \"./js/core/api.js\");\n// 用於管理地圖據點資料的模組\r\n\r\n\r\n\r\nconst YAML_FILE = 'RFcity.yaml';\r\n\r\nasync function saveMarkerDataToYaml(markerData) {\r\n    const yamlStr = js_yaml__WEBPACK_IMPORTED_MODULE_0__[\"default\"].dump(markerData);\r\n    // 儲存到本地 RFcity.yaml\r\n    await _core_api_js__WEBPACK_IMPORTED_MODULE_1__.saveYaml(YAML_FILE, yamlStr);\r\n}\r\n\r\nasync function loadMarkerDataFromYaml() {\r\n    // 桌面版（pywebview）\r\n    if (!window.__TAURI__) {\r\n        try {\r\n            const yamlStr = await _core_api_js__WEBPACK_IMPORTED_MODULE_1__.loadYaml(YAML_FILE);\r\n            return js_yaml__WEBPACK_IMPORTED_MODULE_0__[\"default\"].load(yamlStr) || {};\r\n        } catch (e) {\r\n            console.warn('[markerData] 桌面版讀取 RFcity.yaml 失敗:', e);\r\n            return {};\r\n        }\r\n    } else {\r\n        // 網頁版：直接 fetch yaml 檔\r\n        try {\r\n            // 用相對路徑，避免靜態主機根目錄問題\r\n            const res = await fetch('./mod/data/RFcity.yaml');\r\n            if (!res.ok) {\r\n                console.warn('[markerData] fetch RFcity.yaml 失敗，HTTP 狀態:', res.status);\r\n                return {};\r\n            }\r\n            const yamlStr = await res.text();\r\n            const data = js_yaml__WEBPACK_IMPORTED_MODULE_0__[\"default\"].load(yamlStr) || {};\r\n            if (Object.keys(data).length === 0) {\r\n                console.warn('[markerData] RFcity.yaml 內容為空或格式錯誤');\r\n            }\r\n            return data;\r\n        } catch (e) {\r\n            console.warn('[markerData] 網頁版讀取 RFcity.yaml 失敗:', e);\r\n            return {};\r\n        }\r\n    }\r\n}\r\n\r\nfunction importYamlFile(file, callback) {\r\n    const reader = new FileReader();\r\n    reader.onload = function(e) {\r\n        try {\r\n            const data = js_yaml__WEBPACK_IMPORTED_MODULE_0__[\"default\"].load(e.target.result);\r\n            if (data) {\r\n                callback(data);\r\n            }\r\n        } catch {}\r\n    };\r\n    reader.readAsText(file);\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/markerData.js?\n}")},"./js/map/markerDialogs.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   showDetailDialog: () => (/* binding */ showDetailDialog),\n/* harmony export */   showEditDialog: () => (/* binding */ showEditDialog)\n/* harmony export */ });\n/* harmony import */ var _markerUtils_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./markerUtils.js */ \"./js/map/markerUtils.js\");\n// marker 彈窗相關\r\n\r\n\r\nfunction parseMaterialType(bracket) {\r\n    if (!bracket) return '';\r\n    const colorMap = { '紅': '游擊隊', '黃': '資助家', '綠': '間諜', '藍': '宣傳家' };\r\n    const color = bracket[0];\r\n    const level = bracket[1];\r\n    const type = colorMap[color] || '';\r\n    if (!type || !level) return '';\r\n    return `${type}${level}級素材`;\r\n}\r\n\r\nfunction getFactionColorStyle(faction) {\r\n    // 對應顏色\r\n    const map = {\r\n        '蒙古': 'rgb(0, 138, 247)',\r\n        '臺灣': 'rgb(6, 133, 158)',  // 更新為實際顏色\r\n        '滿洲': 'rgb(252, 185, 0)',\r\n        '香港': 'rgb(174, 67, 236)',\r\n        '反賊聯盟': 'rgb(255, 255, 255)',\r\n        '藏國': 'rgb(70, 190, 127)',\r\n        '維吾爾': 'rgb(116, 160, 246)',\r\n        '哈薩克': 'rgb(0, 233, 228)',  // 更新為實際顏色\r\n        '紅軍': 'rgb(253, 30, 25)',\r\n        '新中國狂歡': 'rgb(109, 109, 109)'\r\n    };\r\n    return map[faction] || 'rgb(109,109,109)';\r\n}\r\n\r\nfunction showEditDialog(marker, markerData) {\r\n    const id = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getMarkerId)(marker);\r\n    const color = marker.style.backgroundColor;\r\n    const faction = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getFactionByColor)(color);\r\n    const data = markerData[id] || { cityName: '', id: '', npc: [], reward: [], sovereignty: '', airport: '', port: '' };\r\n    // 快速選單資料（去重）\r\n    const npcOptions = Array.from(new Set((0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getAllUniqueValues)(markerData, 'npc')));\r\n    const rewardComboOptions = Array.from(new Set((0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getAllRewardCombos)(markerData)));\r\n    const sovereigntyOptions = Array.from(new Set((0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getAllUniqueValues)(markerData, 'sovereignty')));\r\n    const airportOptions = Array.from(new Set((0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getAllUniqueValues)(markerData, 'airport')));\r\n    const portOptions = Array.from(new Set((0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getAllUniqueValues)(markerData, 'port')));\r\n    let html = `<div style=\\\"font-size:1.3em;font-weight:bold;margin-bottom:18px;letter-spacing:1px;\\\">編輯據點資訊</div>`;\r\n    html += `<div style=\\\"display:flex;flex-direction:column;gap:14px;\\\">`;\r\n    html += `<label style=\\\"font-size:1em;\\\">城市名稱：<input id=\\\"edit-cityName\\\" value=\\\"${data.cityName||''}\\\" placeholder=\\\"可留空\\\" style=\\\"width:100%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\"></label>`;\r\n    html += `<label style=\\\"font-size:1em;\\\">ID：<input id=\\\"edit-id\\\" value=\\\"${data.id||''}\\\" placeholder=\\\"可留空\\\" style=\\\"width:100%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\"></label>`;\r\n    // NPC支援\r\n    html += `<label style=\\\"font-size:1em;\\\">NPC支援（多項以,分隔）：<input id=\\\"edit-npc\\\" value=\\\"${(data.npc||[]).join(',')}\\\" style=\\\"width:70%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\">`;\r\n    if (npcOptions.length) {\r\n        html += `<select id=\\\"npc-select\\\" style=\\\"margin-left:8px;padding:7px 10px;border-radius:6px;background:#222;color:#fff;\\\">`;\r\n        html += `<option value=\\\"\\\">快速選擇</option>`;\r\n        npcOptions.forEach(opt => {\r\n            html += `<option value=\\\"${opt}\\\">${opt}</option>`;\r\n        });\r\n        html += `</select>`;\r\n    }\r\n    html += `</label>`;\r\n    // 佔領獎勵\r\n    html += `<label style=\\\"font-size:1em;\\\">佔領獎勵（多項以,分隔）：<input id=\\\"edit-reward\\\" value=\\\"${(data.reward||[]).join(',')}\\\" style=\\\"width:70%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\">`;\r\n    if (rewardComboOptions.length) {\r\n        html += `<select id=\\\"reward-select\\\" style=\\\"margin-left:8px;padding:7px 10px;border-radius:6px;background:#222;color:#fff;\\\">`;\r\n        html += `<option value=\\\"\\\">快速選擇組合</option>`;\r\n        rewardComboOptions.forEach(opt => {\r\n            html += `<option value=\\\"${opt}\\\">${opt}</option>`;\r\n        });\r\n        html += `</select>`;\r\n    }\r\n    html += `</label>`;\r\n    // 主權\r\n    html += `<label style=\\\"font-size:1em;\\\">主權：<input id=\\\"edit-sovereignty\\\" value=\\\"${data.sovereignty||''}\\\" style=\\\"width:70%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\">`;\r\n    if (sovereigntyOptions.length) {\r\n        html += `<select id=\\\"sovereignty-select\\\" style=\\\"margin-left:8px;padding:7px 10px;border-radius:6px;background:#222;color:#fff;\\\">`;\r\n        html += `<option value=\\\"\\\">快速選擇</option>`;\r\n        sovereigntyOptions.forEach(opt => {\r\n            html += `<option value=\\\"${opt}\\\">${opt}</option>`;\r\n        });\r\n        html += `</select>`;\r\n    }\r\n    html += `</label>`;\r\n    // 機場\r\n    html += `<label style=\\\"font-size:1em;\\\">機場前往：<input id=\\\"edit-airport\\\" value=\\\"${data.airport||''}\\\" style=\\\"width:70%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\">`;\r\n    if (airportOptions.length) {\r\n        html += `<select id=\\\"airport-select\\\" style=\\\"margin-left:8px;padding:7px 10px;border-radius:6px;background:#222;color:#fff;\\\">`;\r\n        html += `<option value=\\\"\\\">快速選擇</option>`;\r\n        airportOptions.forEach(opt => {\r\n            html += `<option value=\\\"${opt}\\\">${opt}</option>`;\r\n        });\r\n        html += `</select>`;\r\n    }\r\n    html += `</label>`;\r\n    // 港口\r\n    html += `<label style=\\\"font-size:1em;\\\">港口前往：<input id=\\\"edit-port\\\" value=\\\"${data.port||''}\\\" style=\\\"width:70%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#222;color:#fff;font-size:1em;\\\">`;\r\n    if (portOptions.length) {\r\n        html += `<select id=\\\"port-select\\\" style=\\\"margin-left:8px;padding:7px 10px;border-radius:6px;background:#222;color:#fff;\\\">`;\r\n        html += `<option value=\\\"\\\">快速選擇</option>`;\r\n        portOptions.forEach(opt => {\r\n            html += `<option value=\\\"${opt}\\\">${opt}</option>`;\r\n        });\r\n        html += `</select>`;\r\n    }\r\n    html += `</label>`;\r\n    html += `<label style=\\\"font-size:1em;\\\">控制：<input value=\\\"${faction}\\\" disabled style=\\\"width:100%;padding:7px 10px;border-radius:6px;border:1.5px solid #888;background:#333;color:#fff;font-size:1em;\\\"></label>`;\r\n    html += `</div>`;\r\n    html += `<div style=\\\"display:flex;gap:18px;justify-content:center;margin-top:28px;\\\">`\r\n        + `<button id=\\\"save-marker-data\\\" style=\\\"background:#2a7cff;color:#fff;border:none;padding:10px 32px;border-radius:8px;font-size:1.1em;cursor:pointer;font-weight:bold;letter-spacing:2px;\\\">儲存</button>`\r\n        + `<button id=\\\"close-marker-dialog\\\" style=\\\"background:#444;color:#fff;border:none;padding:10px 32px;border-radius:8px;font-size:1.1em;cursor:pointer;font-weight:bold;letter-spacing:2px;\\\">關閉</button>`\r\n        + `</div>`;\r\n    let dialog = document.getElementById('marker-edit-dialog');\r\n    if (!dialog) {\r\n        dialog = document.createElement('div');\r\n        dialog.id = 'marker-edit-dialog';\r\n        dialog.tabIndex = 0;\r\n        dialog.style.position = 'fixed';\r\n        dialog.style.left = '50%';\r\n        dialog.style.top = '50%';\r\n        dialog.style.transform = 'translate(-50%,-50%)';\r\n        dialog.style.background = 'rgba(30,30,30,0.98)';\r\n        dialog.style.color = '#fff';\r\n        // 編輯據點彈窗自適應橫向螢幕（更窄，65vw）\r\n        dialog.style.width = 'min(420px, 65vw)';\r\n        dialog.style.maxWidth = '65vw';\r\n        dialog.style.minWidth = '220px';\r\n        dialog.style.maxHeight = '88vh';\r\n        dialog.style.overflow = 'auto';\r\n        dialog.style.padding = '32px 20px 20px 20px';\r\n        dialog.style.borderRadius = '18px';\r\n        dialog.style.zIndex = 100000;\r\n        dialog.style.boxShadow = '0 8px 48px #000c';\r\n        dialog.style.outline = 'none';\r\n        document.body.appendChild(dialog);\r\n    }\r\n    dialog.innerHTML = html;\r\n    dialog.style.display = 'block';\r\n    dialog.focus();\r\n    document.getElementById('close-marker-dialog').onclick = () => dialog.style.display = 'none';\r\n    setTimeout(()=>{\r\n        function outsideClick(e) {\r\n            if (dialog.style.display !== 'block') return;\r\n            if (!dialog.contains(e.target)) {\r\n                dialog.style.display = 'none';\r\n                document.removeEventListener('mousedown', outsideClick);\r\n            }\r\n        }\r\n        document.addEventListener('mousedown', outsideClick);\r\n    }, 0);\r\n    // 快速選單事件\r\n    if (npcOptions.length) {\r\n        const npcSelect = document.getElementById('npc-select');\r\n        if (npcSelect) {\r\n            npcSelect.onchange = function() {\r\n                if (this.value) {\r\n                    let v = document.getElementById('edit-npc').value;\r\n                    if (v && !v.endsWith(',')) v += ',';\r\n                    document.getElementById('edit-npc').value = v + this.value;\r\n                    this.value = '';\r\n                }\r\n            };\r\n        }\r\n    }\r\n    if (rewardComboOptions.length) {\r\n        const rewardSelect = document.getElementById('reward-select');\r\n        if (rewardSelect) {\r\n            rewardSelect.onchange = function() {\r\n                if (this.value) {\r\n                    document.getElementById('edit-reward').value = this.value;\r\n                    this.value = '';\r\n                }\r\n            };\r\n        }\r\n    }\r\n    if (sovereigntyOptions.length) {\r\n        const sovereigntySelect = document.getElementById('sovereignty-select');\r\n        if (sovereigntySelect) {\r\n            sovereigntySelect.onchange = function() {\r\n                if (this.value) {\r\n                    document.getElementById('edit-sovereignty').value = this.value;\r\n                    this.value = '';\r\n                }\r\n            };\r\n        }\r\n    }\r\n    if (airportOptions.length) {\r\n        const airportSelect = document.getElementById('airport-select');\r\n        if (airportSelect) {\r\n            airportSelect.onchange = function() {\r\n                if (this.value) {\r\n                    document.getElementById('edit-airport').value = this.value;\r\n                    this.value = '';\r\n                }\r\n            };\r\n        }\r\n    }\r\n    if (portOptions.length) {\r\n        const portSelect = document.getElementById('port-select');\r\n        if (portSelect) {\r\n            portSelect.onchange = function() {\r\n                if (this.value) {\r\n                    document.getElementById('edit-port').value = this.value;\r\n                    this.value = '';\r\n                }\r\n            };\r\n        }\r\n    }\r\n    document.getElementById('save-marker-data').onclick = async () => {\r\n        markerData[id] = {\r\n            cityName: document.getElementById('edit-cityName').value,\r\n            id: document.getElementById('edit-id').value,\r\n            npc: document.getElementById('edit-npc').value.split(',').map(s=>s.trim()).filter(Boolean),\r\n            reward: document.getElementById('edit-reward').value.split(',').map(s=>s.trim()).filter(Boolean),\r\n            sovereignty: document.getElementById('edit-sovereignty').value,\r\n            airport: document.getElementById('edit-airport').value,\r\n            port: document.getElementById('edit-port').value\r\n        };\r\n        if (window.saveMarkerDataToYaml) {\r\n            await window.saveMarkerDataToYaml(markerData);\r\n        }\r\n        dialog.style.display = 'none';\r\n    };\r\n}\r\n\r\nfunction showDetailDialog(marker, markerData) {\r\n    // 僅在 #/portalmap 顯示\r\n    if (!location.hash.startsWith('#/portalmap')) return;\r\n    const id = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getMarkerId)(marker);\r\n    const color = marker.style.backgroundColor;\r\n    const data = markerData[id] || { cityName: (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getCityName)(marker), id, npc: [], reward: [], sovereignty: '', airport: '', port: '' };\r\n    const faction = (0,_markerUtils_js__WEBPACK_IMPORTED_MODULE_0__.getFactionByColor)(color);\r\n    const factionColor = getFactionColorStyle(faction);\r\n    const isWhiteFaction = faction === '反賊聯盟';\r\n    let html = `<div style='font-size:1.45em;font-weight:700;margin-bottom:16px;letter-spacing:1px;text-align:center;'>${data.cityName||''} <span style='font-size:0.9em;font-weight:normal;color:#eee;'>(ID: ${data.id||''})</span></div>`;\r\n    html += `<hr style='border:none;border-top:2px solid #fff5;margin:0 0 18px 0;'>`;\r\n    html += `<div style='display:flex;gap:18px;margin-bottom:10px;align-items:center;'><span style='font-weight:bold;font-size:1.15em;'>主權</span><span style='background:#333;padding:4px 18px;border-radius:8px;font-size:1.1em;'>${data.sovereignty||''}</span></div>`;\r\n    html += `<div style='display:flex;gap:18px;align-items:center;'><span style='font-weight:bold;font-size:1.15em;'>控制</span><span style='background:${factionColor};color:${isWhiteFaction?'#222':'#fff'};padding:4px 18px;border-radius:8px;font-size:1.1em;font-weight:bold;box-shadow:0 1px 6px #0003;'>${faction}</span></div>`;\r\n    // 新增分隔線\r\n    html += `<hr style='border:none;border-top:2px solid #fff5;margin:18px 0 10px 0;'>`;\r\n    // 新增顯示機場與港口\r\n    if (data.airport) {\r\n        html += `<div style='display:flex;gap:18px;margin-bottom:10px;align-items:center;'><span style='font-weight:bold;font-size:1.15em;'>機場前往</span><span style='background:#1dbf60;padding:4px 18px;border-radius:8px;font-size:1.1em;'>${data.airport}</span></div>`;\r\n    }\r\n    if (data.port) {\r\n        html += `<div style='display:flex;gap:18px;margin-bottom:10px;align-items:center;'><span style='font-weight:bold;font-size:1.15em;'>港口前往</span><span style='background:#1dbf60;padding:4px 18px;border-radius:8px;font-size:1.1em;'>${data.port}</span></div>`;\r\n    }\r\n    html += `<hr style='border:none;border-top:2px solid #fff5;margin:18px 0 10px 0;'>`;\r\n    if (data.npc && data.npc.length) {\r\n        html += `<div style='font-weight:bold;font-size:1.15em;margin-bottom:8px;'>NPC 支援</div>`;\r\n        html += `<div style='display:flex;gap:12px;margin-bottom:10px;'>`;\r\n        data.npc.forEach(n=>{\r\n            const npcColor = getFactionColorStyle(n);\r\n            const isWhite = n === '反賊聯盟';\r\n            html += `<span style='background:${npcColor};color:${isWhite?'#222':'#fff'};padding:4px 16px;border-radius:8px;font-size:1.1em;font-weight:bold;'>${n}</span>`;\r\n        });\r\n        html += `</div>`;\r\n        html += `<hr style='border:none;border-top:2px solid #fff5;margin:18px 0 10px 0;'>`;\r\n    }\r\n    if (data.reward && data.reward.length) {\r\n        html += `<div style='font-weight:bold;font-size:1.15em;margin-bottom:8px;'>佔領獎勵</div>`;\r\n        data.reward.forEach(rw=>{\r\n            let match = rw.match(/^(.*?)(\\((.*?)\\))?:(\\d+)/);\r\n            if (match) {\r\n                const name = match[1].trim();\r\n                const bracket = match[3] || '';\r\n                const value = match[4];\r\n                const material = parseMaterialType(bracket);\r\n                html += `<div style='display:flex;align-items:center;gap:10px;padding:4px 0 4px 0;font-size:1.1em;'>`;\r\n                html += `<span style='min-width:70px;'>${name}</span>`;\r\n                html += `<span style='font-weight:bold;color:#ffd700;min-width:36px;text-align:right;'>${value}</span>`;\r\n                html += material ? `<span style='font-size:0.98em;color:#fff;opacity:0.85;'>丨${material}</span>` : '';\r\n                html += `</div>`;\r\n            } else {\r\n                html += `<div style='padding:4px 0;font-size:1.1em;'>${rw}</div>`;\r\n            }\r\n        });\r\n    }\r\n    html += `<div style='display:flex;gap:18px;justify-content:center;margin-top:18px;'>`;\r\n    // 不加入關閉按鈕\r\n    html += `</div>`;\r\n    let dialog = document.getElementById('marker-detail-dialog');\r\n    if (!dialog) {\r\n        dialog = document.createElement('div');\r\n        dialog.id = 'marker-detail-dialog';\r\n        dialog.tabIndex = 0;\r\n        dialog.style.position = 'fixed';\r\n        dialog.style.left = '50%';\r\n        dialog.style.top = '50%';\r\n        dialog.style.transform = 'translate(-50%,-50%)';\r\n        dialog.style.background = `${factionColor}CC`;\r\n        dialog.style.backdropFilter = 'blur(18px)';\r\n        dialog.style.webkitBackdropFilter = 'blur(18px)';\r\n        dialog.style.color = '#fff';\r\n        dialog.style.padding = '0';\r\n        dialog.style.borderRadius = '22px';\r\n        dialog.style.zIndex = 100000;\r\n        dialog.style.boxShadow = '0 8px 48px #000c';\r\n        // 詳細資訊彈窗自適應橫向螢幕（更窄，65vw）\r\n        dialog.style.width = 'min(420px, 65vw)';\r\n        dialog.style.maxWidth = '65vw';\r\n        dialog.style.minWidth = '220px';\r\n        dialog.style.maxHeight = '88vh';\r\n        dialog.style.overflow = 'auto';\r\n        dialog.style.outline = 'none';\r\n        document.body.appendChild(dialog);\r\n    } else {\r\n        dialog.style.background = `${factionColor}CC`;\r\n        dialog.style.backdropFilter = 'blur(18px)';\r\n        dialog.style.webkitBackdropFilter = 'blur(18px)';\r\n        dialog.style.width = 'min(420px, 65vw)';\r\n        dialog.style.maxWidth = '65vw';\r\n        dialog.style.minWidth = '220px';\r\n        dialog.style.maxHeight = '88vh';\r\n        dialog.style.overflow = 'auto';\r\n    }\r\n    dialog.innerHTML = `<div style='padding:20px 16px 14px 16px;'>${html}</div>`;\r\n    dialog.style.display = 'block';\r\n    dialog.focus();\r\n    // 不掛 close-marker-detail-dialog 事件\r\n    // 點擊視窗外自動關閉\r\n    setTimeout(()=>{\r\n        function outsideClick(e) {\r\n            if (dialog.style.display !== 'block') return;\r\n            if (!dialog.contains(e.target)) {\r\n                dialog.style.display = 'none';\r\n                document.removeEventListener('mousedown', outsideClick);\r\n            }\r\n        }\r\n        document.addEventListener('mousedown', outsideClick);\r\n    }, 0);\r\n    // hash 變動自動關閉\r\n    function hashClose() {\r\n        if (!location.hash.startsWith('#/portalmap')) {\r\n            dialog.style.display = 'none';\r\n            window.removeEventListener('hashchange', hashClose);\r\n        }\r\n    }\r\n    window.addEventListener('hashchange', hashClose);\r\n    // 拖拉功能\r\n    let isDragging = false, startX = 0, startY = 0, origX = 0, origY = 0;\r\n    dialog.onmousedown = function(e) {\r\n        if (e.target.tagName === 'BUTTON') return;\r\n        isDragging = true;\r\n        startX = e.clientX;\r\n        startY = e.clientY;\r\n        const rect = dialog.getBoundingClientRect();\r\n        origX = rect.left;\r\n        origY = rect.top;\r\n        dialog.style.transition = 'none';\r\n        document.body.style.userSelect = 'none';\r\n    };\r\n    window.onmousemove = function(e) {\r\n        if (!isDragging) return;\r\n        let dx = e.clientX - startX;\r\n        let dy = e.clientY - startY;\r\n        let newLeft = origX + dx;\r\n        let newTop = origY + dy;\r\n        // 邊界修正\r\n        const rect = dialog.getBoundingClientRect();\r\n        const vw = window.innerWidth;\r\n        const vh = window.innerHeight;\r\n        const minX = 8, minY = 8;\r\n        const maxX = vw - rect.width - 8;\r\n        const maxY = vh - rect.height - 8;\r\n        if (newLeft < minX) newLeft = minX;\r\n        if (newTop < minY) newTop = minY;\r\n        if (newLeft > maxX) newLeft = maxX;\r\n        if (newTop > maxY) newTop = maxY;\r\n        dialog.style.left = newLeft + 'px';\r\n        dialog.style.top = newTop + 'px';\r\n        dialog.style.transform = 'none';\r\n    };\r\n    window.onmouseup = function() {\r\n        isDragging = false;\r\n        document.body.style.userSelect = '';\r\n    };\r\n}\r\n\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/markerDialogs.js?\n}")},"./js/map/markerInteraction.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupMarkerInteractionOptimized: () => (/* binding */ setupMarkerInteractionOptimized)\n/* harmony export */ });\n/* harmony import */ var _markerData_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./markerData.js */ \"./js/map/markerData.js\");\n/* harmony import */ var _markerUtils_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./markerUtils.js */ \"./js/map/markerUtils.js\");\n/* harmony import */ var _markerDialogs_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./markerDialogs.js */ \"./js/map/markerDialogs.js\");\n/* harmony import */ var _markerConnections_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./markerConnections.js */ \"./js/map/markerConnections.js\");\n\r\n\r\n\r\n\r\n\r\n// --- End 修正版 ---\r\n\r\n// 儲存 observer 以便重複呼叫時清理\r\nlet _rf_marker_map_observer = null;\r\n\r\nfunction setupMarkerInteractionOptimized({ useCanvas = false } = {}) {\r\n    let markerData = {};\r\n    let tooltip = document.getElementById('map-tooltip-optimized');\r\n    if (!tooltip) {\r\n        tooltip = document.createElement('div');\r\n        tooltip.id = 'map-tooltip-optimized';\r\n        tooltip.style.position = 'fixed';\r\n        tooltip.style.background = 'rgba(30,30,30,0.92)';\r\n        tooltip.style.color = '#fff';\r\n        tooltip.style.padding = '6px 12px';\r\n        tooltip.style.borderRadius = '8px';\r\n        tooltip.style.pointerEvents = 'none';\r\n        tooltip.style.zIndex = 99999;\r\n        tooltip.style.fontSize = '1em';\r\n        tooltip.style.display = 'none';\r\n        document.body.appendChild(tooltip);\r\n    }\r\n    function showTooltip(e, text) {\r\n        tooltip.textContent = text;\r\n        tooltip.style.display = 'block';\r\n        let left = e.clientX + 12;\r\n        let top = e.clientY + 8;\r\n        setTimeout(() => {\r\n            const rect = tooltip.getBoundingClientRect();\r\n            const vw = window.innerWidth;\r\n            const vh = window.innerHeight;\r\n            if (rect.right > vw - 8) left = vw - rect.width - 8;\r\n            if (rect.bottom > vh - 8) top = vh - rect.height - 8;\r\n            if (left < 8) left = 8;\r\n            if (top < 8) top = 8;\r\n            tooltip.style.left = left + 'px';\r\n            tooltip.style.top = top + 'px';\r\n        }, 0);\r\n    }\r\n    function hideTooltip() {\r\n        tooltip.style.display = 'none';\r\n    }\r\n    async function bindMarkers() {\r\n        const { loadMarkerDataFromYaml } = await Promise.resolve(/*! import() */).then(__webpack_require__.bind(__webpack_require__, /*! ./markerData.js */ \"./js/map/markerData.js\"));\r\n        const { getCityName, getMarkerId } = await Promise.resolve(/*! import() */).then(__webpack_require__.bind(__webpack_require__, /*! ./markerUtils.js */ \"./js/map/markerUtils.js\"));\r\n        const { showEditDialog, showDetailDialog } = await Promise.resolve(/*! import() */).then(__webpack_require__.bind(__webpack_require__, /*! ./markerDialogs.js */ \"./js/map/markerDialogs.js\"));\r\n        const { drawConnectionLinesOptimized, clearConnectionLines, resetCityToMarkerCache } = await Promise.resolve(/*! import() */).then(__webpack_require__.bind(__webpack_require__, /*! ./markerConnections.js */ \"./js/map/markerConnections.js\"));\r\n        markerData = await loadMarkerDataFromYaml();\r\n        // 每次綁定都強制刷新 cityToMarker 快取\r\n        resetCityToMarkerCache();\r\n        const markers = Array.from(document.querySelectorAll('[class^=\"PortalMap_marker\"], [class^=\"PortalMap_markerCapital\"]'));\r\n        markers.forEach(marker => {\r\n            // 先移除舊事件\r\n            if (marker._rf_marker_handlers) {\r\n                marker.removeEventListener('mouseenter', marker._rf_marker_handlers.mouseenter);\r\n                marker.removeEventListener('mousemove', marker._rf_marker_handlers.mousemove);\r\n                marker.removeEventListener('mouseleave', marker._rf_marker_handlers.mouseleave);\r\n                marker.removeEventListener('click', marker._rf_marker_handlers.click);\r\n                marker.removeEventListener('dblclick', marker._rf_marker_handlers.dblclick);\r\n            }\r\n            // 處理士兵SVG與光輝\r\n            const swords = marker.querySelector('.PortalMap_marker2swords__1V7ah');\r\n            if (swords && swords.tagName === 'IMG') {\r\n                const leftStr = marker.style.left || '';\r\n                const topStr = marker.style.top || '';\r\n                const leftPct = parseFloat(leftStr.replace('calc(', '').replace('%)', '')) / 100;\r\n                const topPct = parseFloat(topStr.replace('calc(', '').replace('%)', '')) / 100;\r\n                const canvas = document.getElementById('faction-map-canvas');\r\n                let x = leftPct, y = topPct;\r\n                if (canvas) {\r\n                    x = Math.round(leftPct * canvas.width);\r\n                    y = Math.round(topPct * canvas.height);\r\n                }\r\n                let color = marker.style.backgroundColor;\r\n                if (!color) {\r\n                    const cs = window.getComputedStyle(marker);\r\n                    color = cs.backgroundColor;\r\n                }\r\n                swords.dataset.x = x;\r\n                swords.dataset.y = y;\r\n                swords.dataset.color = color;\r\n                const id = getMarkerId(marker);\r\n                const data = markerData[id] || {};\r\n                let factionColor = marker.style.backgroundColor || '#888';\r\n                if (data.faction && window.getFactionColor) {\r\n                    try {\r\n                        factionColor = window.getFactionColor(data.faction) || factionColor;\r\n                    } catch {}\r\n                }\r\n                if (!window._soldierSvgCache) window._soldierSvgCache = {};\r\n                let svgUrl = window._soldierSvgCache[factionColor];\r\n                if (!svgUrl) {\r\n                    const soldierPath = \"M148.204,202.609l1.379,23.581c0.237,4.028,2.331,7.717,5.669,9.982c3.32,2.252,7.519,2.856,11.369,1.58l12.621-4.183L148.204,202.609z M511.983,153.352c-0.304-5.214-4.628-9.238-9.784-9.238c-0.193,0-0.387,0.006-0.582,0.017l-14.706,0.86l-0.501-8.569c-0.306-5.214-4.628-9.238-9.784-9.238c-0.193,0-0.387,0.006-0.582,0.017c-5.409,0.317-9.536,4.957-9.221,10.366l0.501,8.569l-79.533,4.652l-19.782-35.024c-1.920-3.335-5.518-5.35-9.365-5.218l-79.706,2.543c-4.735,0.151-8.772,3.476-9.829,8.094l-5.615,24.55l21.907-1.093l2.237-10.971l65.423-2.087l11.491,20.567l-14.716,0.861c13.8,20.885,5.559,48.911-16.953,59.171l-6.104,2.782l10.304,30.286c3.954,11.623,16.581,17.832,28.194,13.879c11.618-3.953,17.832-16.575,13.879-28.194c-11.117-32.675-8.724-25.643-13.659-40.147l37.381-2.186c5.409-0.317,9.536-4.957,9.221-10.366c-0.247-4.218-3.128-7.647-6.949-8.806l97.611-5.708C508.172,163.402,512.299,158.762,511.983,153.352z M206.773,53.045c-26.768-4.088-51.798,14.296-55.888,41.077c-4.526,29.623,18.376,56.458,48.543,56.458c23.815,0,44.716-17.381,48.423-41.647C251.941,82.157,233.549,57.134,206.773,53.045z M336.32,166.143c-5.09-11.167-18.271-16.092-29.436-11.004l-81.045,36.939c-8.178-4.584-66.046-37.059-74.61-41.822c-11.75-6.535-16.266-19.697-16.266-19.697c-9.933-0.071-19.482,3.832-26.521,10.839c-7.039,7.008-10.984,16.54-10.957,26.472c0.528,61.581,0.432,111.869,0.351,133.039c-0.027,6.905,1.002,13.896,3.043,20.491c4.407,14.247,13.026,43.684,22.571,84.787H26.665C11.938,406.19,0,418.128,0,432.855c0,14.727,11.938,26.665,26.665,26.665h130.432c8.143,0,15.84-3.721,20.898-10.103c5.058-6.382,6.922-14.726,5.063-22.652l-22.422-95.568l73.378-7.277l-16.648,104.75c-2.567,16.15,9.895,30.854,26.367,30.854c12.883,0,24.216-9.358,26.302-22.483l22.072-138.882c1.298-8.162-1.263-16.465-6.933-22.479c-5.67-6.014-13.805-9.059-22.032-8.242l-57.92,5.744l0.148-13.942c-2.717-2.2-2.532-2.137-15.431-15.003l-19.073,6.32c-7.552,2.502-16.143,1.556-23.185-3.223c-6.761-4.588-11.083-12.198-11.56-20.356c-1.913-32.717-2.021-31.378-1.465-35.068c14.386,8.063-4.26-2.388,79.287,44.443c6.176,3.464,13.635,3.775,20.079,0.838l91.297-41.612C336.484,190.488,341.41,177.31,336.32,166.143z\";\r\n                    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='56' height='48' viewBox='0 0 512 512'>\r\n                    <defs>\r\n                        <filter id='glow' x='-30%' y='-30%' width='160%' height='160%'>\r\n                            <feGaussianBlur stdDeviation='8' result='coloredBlur'/>\r\n                            <feMerge>\r\n                                <feMergeNode in='coloredBlur'/>\r\n                                <feMergeNode in='SourceGraphic'/>\r\n                            </feMerge>\r\n                        </filter>\r\n                    </defs>\r\n                    <path d='${soldierPath}' fill='${factionColor}' filter='url(#glow)'/>\r\n                    </svg>`;\r\n                    svgUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);\r\n                    window._soldierSvgCache[factionColor] = svgUrl;\r\n                }\r\n                if (swords.src !== svgUrl) swords.src = svgUrl;\r\n                swords.onerror = function() { this.style.display = 'none'; };\r\n                swords.onload = function() { this.style.display = ''; };\r\n                const left = marker.style.left;\r\n                const top = marker.style.top;\r\n                if (left) swords.style.left = left;\r\n                if (top) swords.style.top = top;\r\n                swords.style.transform = 'translate(-50%, -50%) scale(0.65)';\r\n                swords.style.backgroundColor = '';\r\n                swords.style.borderRadius = '';\r\n                swords.style.filter = '';\r\n                swords.style.mixBlendMode = '';\r\n                swords.style.boxShadow = 'none';\r\n                swords.style.background = 'none';\r\n                swords.style.border = 'none';\r\n            }\r\n            marker.style.cursor = 'pointer';\r\n            marker.style.boxShadow = `0 0 8px 2px ${marker.style.backgroundColor}, 0 0 18px 6px ${marker.style.backgroundColor.replace(')',',0.35)')}`;\r\n            marker.style.transition = 'box-shadow 0.2s';\r\n            const has2Swords = marker.querySelector('.PortalMap_marker2swords__1V7ah') !== null;\r\n            // 新事件處理\r\n            const mouseenter = function(e) {\r\n                const id = getMarkerId(marker);\r\n                const data = markerData[id];\r\n                const cityName = (data && data.cityName) ? data.cityName : getCityName(marker);\r\n                showTooltip(e, cityName);\r\n                clearConnectionLines();\r\n                if (data && data.airport) drawConnectionLinesOptimized(marker, markerData, 'airport');\r\n                if (data && data.port) drawConnectionLinesOptimized(marker, markerData, 'port');\r\n            };\r\n            const mousemove = function(e) {\r\n                tooltip.style.left = (e.clientX + 12) + 'px';\r\n                tooltip.style.top = (e.clientY + 8) + 'px';\r\n            };\r\n            const mouseleave = function() {\r\n                hideTooltip();\r\n                clearConnectionLines();\r\n                // 強制重設 tooltip 狀態，避免殘留\r\n                tooltip.textContent = '';\r\n            };\r\n            const click = function(e) {\r\n                if (e.detail === 1) {\r\n                    setTimeout(() => {\r\n                        if (!marker._dblClicked) {\r\n                            if (has2Swords) {\r\n                                if (marker.dataset && marker.dataset.url) {\r\n                                    window.open(marker.dataset.url, '_blank');\r\n                                }\r\n                            } else {\r\n                                showDetailDialog(marker, markerData);\r\n                            }\r\n                        }\r\n                        marker._dblClicked = false;\r\n                        // 點擊後也強制清除 tooltip 與航線\r\n                        hideTooltip();\r\n                        clearConnectionLines();\r\n                        tooltip.textContent = '';\r\n                    }, 200);\r\n                }\r\n            };\r\n            const dblclick = function(e) {\r\n                marker._dblClicked = true;\r\n                if (has2Swords) {\r\n                    showDetailDialog(marker, markerData);\r\n                } else {\r\n                    showEditDialog(marker, markerData);\r\n                }\r\n                // 雙擊後也強制清除 tooltip 與航線\r\n                hideTooltip();\r\n                clearConnectionLines();\r\n                tooltip.textContent = '';\r\n            };\r\n            marker.addEventListener('mouseenter', mouseenter);\r\n            marker.addEventListener('mousemove', mousemove);\r\n            marker.addEventListener('mouseleave', mouseleave);\r\n            marker.addEventListener('click', click);\r\n            marker.addEventListener('dblclick', dblclick);\r\n            marker._rf_marker_handlers = { mouseenter, mousemove, mouseleave, click, dblclick };\r\n        });\r\n    }\r\n    bindMarkers();\r\n    // 動態監聽地圖刷新\r\n    const mapBox = document.querySelector('.PortalMap_mapBox__3WtlM');\r\n    if (mapBox) {\r\n        // 清理舊 observer\r\n        if (_rf_marker_map_observer) {\r\n            _rf_marker_map_observer.disconnect();\r\n        }\r\n        _rf_marker_map_observer = new MutationObserver(() => {\r\n            bindMarkers();\r\n        });\r\n        _rf_marker_map_observer.observe(mapBox, { childList: true, subtree: true });\r\n    }\r\n}\r\n// --- End ---\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/markerInteraction.js?\n}")},"./js/map/markerUtils.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getAllRewardCombos: () => (/* binding */ getAllRewardCombos),\n/* harmony export */   getAllUniqueValues: () => (/* binding */ getAllUniqueValues),\n/* harmony export */   getCityName: () => (/* binding */ getCityName),\n/* harmony export */   getFactionByColor: () => (/* binding */ getFactionByColor),\n/* harmony export */   getMarkerId: () => (/* binding */ getMarkerId)\n/* harmony export */ });\n// marker 資料處理與工具\r\nconst colorFactionMap = {\r\n    'rgb(0, 138, 247)': '蒙古',\r\n    'rgb(6, 133, 158)': '臺灣',  // 更新為實際顏色\r\n    'rgb(252, 185, 0)': '滿洲',\r\n    'rgb(174, 67, 236)': '香港',\r\n    'rgb(255, 255, 255)': '反賊聯盟',\r\n    'rgb(70, 190, 127)': '藏國',\r\n    'rgb(116, 160, 246)': '維吾爾',\r\n    'rgb(0, 233, 228)': '哈薩克',  // 更新為實際顏色\r\n    'rgb(253, 30, 25)': '紅軍',\r\n    'rgb(109, 109, 109)': '新中國狂歡'\r\n};\r\nfunction getCityName(marker) {\r\n    let cityDiv = marker.parentElement && marker.parentElement.querySelector('[class*=\"CityName\"], [class*=\"cityName\"]');\r\n    if (cityDiv) return cityDiv.textContent.trim();\r\n    return marker.style.left + ',' + marker.style.top;\r\n}\r\nfunction getMarkerId(marker) {\r\n    return marker.style.left + '_' + marker.style.top;\r\n}\r\nfunction getFactionByColor(color) {\r\n    return colorFactionMap[color] || '未知';\r\n}\r\nfunction getAllUniqueValues(markerData, field) {\r\n    const values = new Set();\r\n    Object.values(markerData).forEach(d => {\r\n        if (Array.isArray(d[field])) {\r\n            d[field].forEach(v => values.add(v));\r\n        } else if (d[field]) {\r\n            values.add(d[field]);\r\n        }\r\n    });\r\n    return Array.from(values).filter(Boolean);\r\n}\r\nfunction getAllRewardCombos(markerData) {\r\n    const combos = new Set();\r\n    Object.values(markerData).forEach(d => {\r\n        if (Array.isArray(d.reward) && d.reward.length) {\r\n            combos.add(d.reward.join(','));\r\n        }\r\n    });\r\n    return Array.from(combos).filter(Boolean);\r\n}\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/markerUtils.js?\n}")},"./js/map/rankingModal.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupRankingModalEvents: () => (/* binding */ setupRankingModalEvents),\n/* harmony export */   updateRanking: () => (/* binding */ updateRanking)\n/* harmony export */ });\n/* harmony import */ var _factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./factionColorMap.js */ \"./js/map/factionColorMap.js\");\n\r\n\r\n// 排行榜模組\r\nasync function updateRanking() {\r\n    if(location.hash !== '#/portalmap') return;\r\n    function waitForMarkers(mapSelector, markerSelector, timeout = 12000) {\r\n        return new Promise((resolve, reject) => {\r\n            const start = Date.now();\r\n            (function check() {\r\n                const mapBox = document.querySelector(mapSelector);\r\n                if (mapBox) {\r\n                    const markers = mapBox.querySelectorAll(markerSelector);\r\n                    if (markers.length > 0) return resolve({mapBox, markers});\r\n                }\r\n                if (Date.now() - start > timeout) return reject('地圖城市載入逾時');\r\n                setTimeout(check, 300);\r\n            })();\r\n        });\r\n    }\r\n    try {\r\n        const {mapBox, markers} = await waitForMarkers('.PortalMap_mapBox__3WtlM', '.PortalMap_marker__rzok1, .PortalMap_markerCapital__6ocPp');\r\n        const colorMap = {};\r\n        markers.forEach(marker => {\r\n            if (!marker || !marker.style) return;\r\n            const color = marker.style.backgroundColor;\r\n            if (!colorMap[color]) colorMap[color] = 0;\r\n            colorMap[color]++;\r\n        });\r\n        const sorted = Object.entries(colorMap).sort((a,b)=>b[1]-a[1]);\r\n        let html = '<div style=\"font-size:2em;font-weight:700;text-align:center;margin-bottom:18px;letter-spacing:2px;color:#fff;\">陣營城市排行榜</div>';\r\n        html += '<div style=\"width:100%;\">';\r\n        html += '<div style=\"display:flex;justify-content:space-between;align-items:center;padding:0 8px 8px 8px;font-size:1.15em;font-weight:600;color:#fff;opacity:0.85;border-bottom:1.5px solid #444;\">';\r\n        html += '<span>陣營</span><span>城市數</span></div>';\r\n        sorted.forEach(([color, count]) => {\r\n            const factionName = (0,_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getFactionByColor)(color);\r\n            html += `<div style=\"display:flex;align-items:center;justify-content:space-between;padding:12px 8px 12px 8px;font-size:1.18em;font-weight:500;\">\r\n                <span style=\"display:flex;align-items:center;gap:12px;\">\r\n                    <span style=\"display:inline-block;width:22px;height:22px;background:${color};border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px #0004;\"></span>\r\n                    <span style=\"color:#fff;\">${factionName}</span>\r\n                </span>\r\n                <span style=\"color:#fff;\">${count}</span>\r\n            </div>`;\r\n        });\r\n        html += '</div>';\r\n        document.getElementById('ranking-content').innerHTML = html;\r\n    } catch(e) {\r\n        document.getElementById('ranking-content').innerHTML = '排行榜載入失敗：' + e;\r\n    }\r\n}\r\n\r\nfunction setupRankingModalEvents() {\r\n    let rankingUpdateTimer = null;\r\n    let lastRankingHash = '';\r\n    document.getElementById('show-portalmap-ranking').onclick = async function() {\r\n        location.hash = '#/portalmap';\r\n        document.getElementById('ranking-modal').style.display = 'flex';\r\n        lastRankingHash = location.hash;\r\n        await updateRanking();\r\n        if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n        rankingUpdateTimer = setInterval(()=>{\r\n            if(location.hash === '#/portalmap') {\r\n                updateRanking();\r\n            }\r\n        }, 2000);\r\n    };\r\n    document.getElementById('close-ranking-modal').onclick = function() {\r\n        document.getElementById('ranking-modal').style.display = 'none';\r\n        if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n    };\r\n    window.addEventListener('hashchange', function() {\r\n        if(document.getElementById('ranking-modal').style.display === 'flex') {\r\n            if(location.hash === '#/portalmap') {\r\n                updateRanking();\r\n                if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n                rankingUpdateTimer = setInterval(()=>{\r\n                    if(location.hash === '#/portalmap') updateRanking();\r\n                }, 2000);\r\n            } else {\r\n                if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n            }\r\n        }\r\n    });\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/map/rankingModal.js?\n}")},"./js/ui/customControls.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupCustomControls: () => (/* binding */ setupCustomControls),\n/* harmony export */   setupRankingPanelDrag: () => (/* reexport safe */ _rankingPanelDrag_js__WEBPACK_IMPORTED_MODULE_4__.setupRankingPanelDrag)\n/* harmony export */ });\n/* harmony import */ var _panelDrag_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./panelDrag.js */ \"./js/ui/panelDrag.js\");\n/* harmony import */ var _exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./exitConfirm.js */ \"./js/ui/exitConfirm.js\");\n/* harmony import */ var _map_factionMapControl_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../map/factionMapControl.js */ \"./js/map/factionMapControl.js\");\n/* harmony import */ var _audio_audioControls_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../audio/audioControls.js */ \"./js/audio/audioControls.js\");\n/* harmony import */ var _rankingPanelDrag_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./rankingPanelDrag.js */ \"./js/ui/rankingPanelDrag.js\");\n/* harmony import */ var _map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ../map/factionColorMap.js */ \"./js/map/factionColorMap.js\");\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfunction getDomOrWarn(id, warnMsg) {\r\n    const el = document.getElementById(id);\r\n    if (!el) {\r\n        console.warn(warnMsg || `找不到 DOM 元素：${id}`);\r\n    }\r\n    return el;\r\n}\r\n\r\n// 獲取當前選中的帳號（用於多實例隔離）\r\nfunction getCurrentSelectedAccount() {\r\n    const accountSelect = document.getElementById('account-select');\r\n    if (accountSelect && accountSelect.selectedIndex >= 0) {\r\n        return {\r\n            accountIdx: accountSelect.selectedIndex,\r\n            account: accountSelect.options[accountSelect.selectedIndex].text\r\n        };\r\n    }\r\n    // fallback: 若沒有 select，則用 radio\r\n    const radio = document.querySelector('input[name=\"account-radio\"]:checked');\r\n    if (radio) {\r\n        const idx = parseInt(radio.value);\r\n        const span = radio.parentElement.querySelector('span');\r\n        return {\r\n            accountIdx: idx,\r\n            account: span ? span.textContent.trim() : ''\r\n        };\r\n    }\r\n    return null;\r\n}\r\n\r\n// 獲取完整的帳號資訊（包含密碼）\r\nasync function getCurrentAccountData() {\r\n    const selected = getCurrentSelectedAccount();\r\n    if (!selected) return null;\r\n    try {\r\n        const accounts = await window.__TAURI__.core.invoke('get_accounts');\r\n        if (accounts && accounts.length > 0) {\r\n            // 僅用帳號名稱（必要時可加密碼）比對\r\n            let acc = accounts.find(a => a.account === selected.account);\r\n            return acc || accounts[0];\r\n        }\r\n    } catch (e) {\r\n        console.error('獲取帳號列表失敗:', e);\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction createFactionFilterDropdown(controlsPanel) {\r\n    if (document.getElementById('rf-faction-filter')) return;\r\n    const container = document.createElement('div');\r\n    container.style.cssText = 'margin-bottom: 12px; position: relative; display: flex; align-items: center;';\r\n    \r\n    const label = document.createElement('label');\r\n    label.textContent = '戰報通知過濾：';\r\n    label.style.cssText = 'margin-right: 8px; flex-shrink: 0;';\r\n    \r\n    // 使用自定義下拉選單替代 select 元素\r\n    const customSelect = document.createElement('div');\r\n    customSelect.id = 'rf-faction-filter';\r\n    customSelect.tabIndex = 0;\r\n    customSelect.style.cssText = `\r\n        padding: 4px 8px;\r\n        border-radius: 6px;\r\n        font-size: 0.95em;\r\n        background: #222;\r\n        color: #fff;\r\n        border: 1px solid #555;\r\n        margin-left: 2px;\r\n        position: relative;\r\n        pointer-events: auto;\r\n        cursor: pointer;\r\n        outline: none;\r\n        min-width: 100px;\r\n        user-select: none;\r\n    `;\r\n    \r\n    const displayText = document.createElement('span');\r\n    displayText.textContent = '全部';\r\n    displayText.style.cssText = 'display: block;';\r\n    customSelect.appendChild(displayText);\r\n    \r\n    const dropdown = document.createElement('div');\r\n    dropdown.style.cssText = `\r\n        position: absolute;\r\n        top: 100%;\r\n        left: 0;\r\n        right: 0;\r\n        background: #222;\r\n        border: 1px solid #555;\r\n        border-top: none;\r\n        border-radius: 0 0 6px 6px;\r\n        display: none;\r\n        z-index: 1000;\r\n        margin-top: -1px;\r\n        box-shadow: 0 4px 8px rgba(0,0,0,0.3);\r\n    `;\r\n    \r\n    const factions = (0,_map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_5__.getAllFactions)().map(f => f.name);\r\n    const options = ['全部', ...factions.filter(f => f !== '新中國狂歡')];\r\n    \r\n    let selectedValue = '全部';\r\n    \r\n    options.forEach(name => {\r\n        const option = document.createElement('div');\r\n        option.textContent = name;\r\n        option.dataset.value = name;\r\n        option.style.cssText = `\r\n            padding: 6px 8px;\r\n            cursor: pointer;\r\n            color: #fff;\r\n            transition: background-color 0.15s;\r\n        `;\r\n        \r\n        option.addEventListener('mouseenter', function() {\r\n            this.style.backgroundColor = '#3a3a3a';\r\n        });\r\n        \r\n        option.addEventListener('mouseleave', function() {\r\n            if (this.dataset.value !== selectedValue) {\r\n                this.style.backgroundColor = '';\r\n            }\r\n        });\r\n        \r\n        option.addEventListener('click', function(e) {\r\n            e.stopPropagation();\r\n            selectedValue = this.dataset.value;\r\n            displayText.textContent = selectedValue;\r\n            dropdown.style.display = 'none';\r\n            customSelect.style.borderRadius = '6px';\r\n            \r\n            // 更新選中狀態\r\n            Array.from(dropdown.children).forEach(opt => {\r\n                opt.style.backgroundColor = opt.dataset.value === selectedValue ? '#3a3a3a' : '';\r\n            });\r\n            \r\n            // 觸發 change 事件\r\n            handleFilterChange(selectedValue);\r\n        });\r\n        \r\n        dropdown.appendChild(option);\r\n    });\r\n    \r\n    customSelect.appendChild(dropdown);\r\n    \r\n    // 點擊顯示/隱藏下拉選單\r\n    customSelect.addEventListener('click', function(e) {\r\n        e.stopPropagation();\r\n        const isVisible = dropdown.style.display === 'block';\r\n        dropdown.style.display = isVisible ? 'none' : 'block';\r\n        customSelect.style.borderRadius = isVisible ? '6px' : '6px 6px 0 0';\r\n    });\r\n    \r\n    // 點擊外部關閉下拉選單\r\n    document.addEventListener('click', function() {\r\n        dropdown.style.display = 'none';\r\n        customSelect.style.borderRadius = '6px';\r\n    });\r\n    \r\n    // 鍵盤支持\r\n    customSelect.addEventListener('keydown', function(e) {\r\n        if (e.key === 'Enter' || e.key === ' ') {\r\n            e.preventDefault();\r\n            const isVisible = dropdown.style.display === 'block';\r\n            dropdown.style.display = isVisible ? 'none' : 'block';\r\n            customSelect.style.borderRadius = isVisible ? '6px' : '6px 6px 0 0';\r\n        } else if (e.key === 'Escape') {\r\n            dropdown.style.display = 'none';\r\n            customSelect.style.borderRadius = '6px';\r\n        }\r\n    });\r\n    \r\n    // 懸停效果\r\n    customSelect.addEventListener('mouseenter', function() {\r\n        if (dropdown.style.display !== 'block') {\r\n            this.style.borderColor = '#777';\r\n            this.style.backgroundColor = '#2a2a2a';\r\n        }\r\n    });\r\n    \r\n    customSelect.addEventListener('mouseleave', function() {\r\n        if (dropdown.style.display !== 'block') {\r\n            this.style.borderColor = '#555';\r\n            this.style.backgroundColor = '#222';\r\n        }\r\n    });\r\n    \r\n    // 保存值獲取函數\r\n    customSelect.getValue = () => selectedValue;\r\n    customSelect.setValue = (value) => {\r\n        if (options.includes(value)) {\r\n            selectedValue = value;\r\n            displayText.textContent = value;\r\n            Array.from(dropdown.children).forEach(opt => {\r\n                opt.style.backgroundColor = opt.dataset.value === selectedValue ? '#3a3a3a' : '';\r\n            });\r\n        }\r\n    };\r\n    \r\n    container.appendChild(label);\r\n    container.appendChild(customSelect);\r\n    controlsPanel.appendChild(container);\r\n\r\n    container.appendChild(label);\r\n    container.appendChild(customSelect);\r\n    controlsPanel.appendChild(container);\r\n\r\n    // 處理值變更\r\n    async function handleFilterChange(value) {\r\n        if (!window.__TAURI__ && window.__TAURI__?.core) {\r\n            try {\r\n                // 獲取當前帳號資訊用於多實例隔離\r\n                const targetAccount = await getCurrentAccountData();\r\n                console.log('[rf-faction-filter] 觸發 save_report_faction_filter:', value, targetAccount);\r\n                const result = await window.__TAURI__.core.invoke('save_report_faction_filter', { value, targetAccount });\r\n                console.log('[rf-faction-filter] save_report_faction_filter 回傳:', result);\r\n            } catch (e) {\r\n                console.error('保存戰報篩選設定失敗:', e);\r\n            }\r\n        } else {\r\n            console.warn('[rf-faction-filter] pywebview API 不存在，未呼叫 save_report_faction_filter');\r\n        }\r\n        if (window.updateFactionFilter) window.updateFactionFilter(value);\r\n    }\r\n\r\n    // 初始化選項，支援 pywebview 及網頁版\r\n    async function syncFactionFilterFromConfig(retry = 0) {\r\n        if (!window.__TAURI__ && window.__TAURI__?.core) {\r\n            try {\r\n                // 獲取當前帳號資訊用於多實例隔離\r\n                const targetAccount = await getCurrentAccountData();\r\n                if (!targetAccount && retry < 2) {\r\n                    // 若帳號還沒切好，延遲再試一次，最多 retry 2 次\r\n                    setTimeout(() => syncFactionFilterFromConfig(retry + 1), 200);\r\n                    return;\r\n                }\r\n                const val = await window.__TAURI__.core.invoke('get_report_faction_filter', { targetAccount });\r\n                // 強制同步值\r\n                if (val && options.includes(val)) {\r\n                    customSelect.setValue(val);\r\n                } else {\r\n                    customSelect.setValue('全部');\r\n                }\r\n                // 除錯用：印出帳號與值\r\n                console.log('[帳號切換] 當前帳號:', targetAccount, '戰報通知過濾:', customSelect.getValue());\r\n                if (window.updateFactionFilter) window.updateFactionFilter(customSelect.getValue());\r\n            } catch (e) {\r\n                console.error('獲取戰報篩選設定失敗:', e);\r\n                customSelect.setValue('全部');\r\n                if (window.updateFactionFilter) window.updateFactionFilter('全部');\r\n            }\r\n        } else {\r\n            // 網頁版：預設為全部\r\n            customSelect.setValue('全部');\r\n            if (window.updateFactionFilter) window.updateFactionFilter('全部');\r\n        }\r\n    }\r\n    // 掛到 window 讓外部可呼叫\r\n    window.syncFactionFilterFromConfig = syncFactionFilterFromConfig;\r\n    window.addEventListener('pywebviewready', syncFactionFilterFromConfig);\r\n    document.addEventListener('DOMContentLoaded', syncFactionFilterFromConfig);\r\n\r\n    // 監聽帳號選擇變更，重新同步戰報篩選設定\r\n    function setupAccountChangeListener() {\r\n        const accountSelect = document.getElementById('account-select');\r\n        if (accountSelect) {\r\n            accountSelect.addEventListener('change', () => {\r\n                // 延遲一點以確保帳號變更完成\r\n                setTimeout(syncFactionFilterFromConfig, 100);\r\n                // 新增：同步 radio 狀態\r\n                const radios = document.querySelectorAll('input[name=\"account-radio\"]');\r\n                if (radios && accountSelect.selectedIndex >= 0) {\r\n                    radios.forEach((r, i) => {\r\n                        const shouldCheck = (i === accountSelect.selectedIndex);\r\n                        const wasChecked = r.checked;\r\n                        r.checked = shouldCheck;\r\n\r\n                        // 當透過下拉選單切換帳號時，主動觸發對應 radio 的 change，\r\n                        // 讓原本在 accountManager.js 綁定的邏輯（更新 window.currentSelectedAccountIdx、\r\n                        // 呼叫 setActiveAccount 等）一併執行，確保後端 active_account_index 同步。\r\n                        if (shouldCheck && !wasChecked) {\r\n                            r.dispatchEvent(new Event('change', { bubbles: true }));\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        } else {\r\n            // 如果帳號選擇框還沒出現，稍後再試\r\n            setTimeout(setupAccountChangeListener, 1000);\r\n        }\r\n    }\r\n    setupAccountChangeListener();\r\n}\r\n\r\n// 保留一些通用樣式以支援對話框功能\r\nfunction addDialogStyles() {\r\n    const styleId = 'rf-dialog-styles';\r\n    if (document.getElementById(styleId)) return;\r\n    \r\n    const style = document.createElement('style');\r\n    style.id = styleId;\r\n    style.textContent = `\r\n        @keyframes spin {\r\n            0% { transform: rotate(0deg); }\r\n            100% { transform: rotate(360deg); }\r\n        }\r\n        \r\n        .rf-download-status {\r\n            position: fixed;\r\n            top: 50%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            background-color: rgba(0, 0, 0, 0.9);\r\n            padding: 15px;\r\n            border-radius: 8px;\r\n            z-index: 10000;\r\n            color: white;\r\n            min-width: 300px;\r\n            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);\r\n            border: 1px solid #555;\r\n        }\r\n        .rf-download-status h3 {\r\n            margin-top: 0;\r\n            padding-bottom: 10px;\r\n            border-bottom: 1px solid #444;\r\n        }\r\n        .rf-download-status-close {\r\n            position: absolute;\r\n            top: 10px;\r\n            right: 10px;\r\n            cursor: pointer;\r\n            font-size: 16px;\r\n        }\r\n        .rf-progress-bar {\r\n            height: 10px;\r\n            background-color: #333;\r\n            border-radius: 5px;\r\n            margin: 10px 0;\r\n            overflow: hidden;\r\n        }\r\n        .rf-progress-bar-fill {\r\n            height: 100%;\r\n            background-color: #4CAF50;\r\n            transition: width 0.3s;\r\n        }\r\n        .rf-download-stats {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            margin-top: 15px;\r\n        }\r\n        .rf-download-stat {\r\n            text-align: center;\r\n            padding: 5px;\r\n            flex-grow: 1;\r\n        }\r\n    `;\r\n    document.head.appendChild(style);\r\n}\r\n\r\n// 切換全屏模式\r\nfunction toggleFullscreen() {\r\n    if (!window.__TAURI__?.core) return;\r\n\r\n    const isCurrentlyFullScreen = document.fullscreenElement ||\r\n        document.webkitFullscreenElement ||\r\n        document.mozFullScreenElement ||\r\n        document.msFullscreenElement;\r\n    const targetMode = isCurrentlyFullScreen ? 'normal' : 'fullscreen';\r\n    if (!window.__TAURI__.core.set_window_mode) {\r\n        window.__TAURI__.core.invoke('set_window_mode', { targetMode });\r\n    }\r\n    window.__TAURI__.core.invoke('toggle_fullscreen');\r\n    console.log('[控制面板] 切換全屏模式，預期狀態:', targetMode);\r\n}\r\n\r\n// 下載狀態已整合到控制面板中，不再需要獨立的對話框\r\n// 此函數保留為兼容性考慮，但不再創建獨立對話框\r\nfunction showDownloadStatus() {\r\n    // 只需切換控制面板的可見性\r\n    const controlsPanel = document.getElementById('rf-controls-panel');\r\n    if (controlsPanel) {\r\n        controlsPanel.style.transform = 'translateX(0)';\r\n    }\r\n}\r\n\r\n// 顯示音量設定\r\nfunction showVolumeSettings() {\r\n    if (!window.__TAURI__?.core) return;\r\n\r\n    // 獲取當前音量設定\r\n    window.__TAURI__.core.invoke('get_config_volume', {  }).then(volume => {\r\n            // 創建對話框\r\n            const dialog = document.createElement('div');\r\n            dialog.className = 'rf-download-status'; // 重用樣式\r\n            \r\n            dialog.innerHTML = `\r\n                <div class=\"rf-download-status-close\" onclick=\"this.parentNode.remove()\">✕</div>\r\n                <h3>音量設定</h3>\r\n                <div style=\"margin-bottom: 15px;\">\r\n                    <label style=\"display: block; margin-bottom: 5px;\">背景音樂音量</label>\r\n                    <input type=\"range\" id=\"bgm-volume\" min=\"0\" max=\"1\" step=\"0.01\" value=\"${volume.bgm}\" style=\"width: 100%;\">\r\n                </div>\r\n                <div style=\"margin-bottom: 15px;\">\r\n                    <label style=\"display: block; margin-bottom: 5px;\">音效音量</label>\r\n                    <input type=\"range\" id=\"se-volume\" min=\"0\" max=\"1\" step=\"0.01\" value=\"${volume.se}\" style=\"width: 100%;\">\r\n                </div>\r\n                <div style=\"margin-bottom: 15px;\">\r\n                    <label style=\"display: flex; align-items: center;\">\r\n                        <input type=\"checkbox\" id=\"se147-muted\" ${volume.se147Muted ? 'checked' : ''}>\r\n                        <span style=\"margin-left: 5px;\">靜音147號音效 (炒股音效)</span>\r\n                    </label>\r\n                </div>\r\n                <div style=\"text-align: center; margin-top: 15px;\">\r\n                    <button id=\"save-volume\" style=\"padding: 5px 15px;\">保存</button>\r\n                    <button onclick=\"this.parentNode.parentNode.remove()\" style=\"padding: 5px 15px; margin-left: 10px;\">取消</button>\r\n                </div>\r\n            `;\r\n            \r\n            document.body.appendChild(dialog);\r\n            \r\n            // 添加保存按鈕事件\r\n            document.getElementById('save-volume').addEventListener('click', function() {\r\n                const newVolume = {\r\n                    bgm: parseFloat(document.getElementById('bgm-volume').value),\r\n                    se: parseFloat(document.getElementById('se-volume').value),\r\n                    se147Muted: document.getElementById('se147-muted').checked\r\n                };\r\n                \r\n                window.__TAURI__.core.invoke('save_config_volume', { newVolume }).then(() => {\r\n                    dialog.remove();\r\n                    \r\n                    // 如果有 AudioManager，立即應用設定\r\n                    if (window.AudioManager) {\r\n                        window.AudioManager.setVolume(newVolume.bgm, newVolume.se);\r\n                        window.AudioManager.setSE147Muted(newVolume.se147Muted);\r\n                    }\r\n                });\r\n            });\r\n        });\r\n}\r\n\r\n// 關於頁面已移除\r\n\r\n// 退出應用\r\nfunction exitApp() {\r\n    // 始終顯示自訂退出確認對話框\r\n    (0,_exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__.loadExitPromptsAndShow)();\r\n}\r\n\r\nfunction setupCustomControls() {\r\n    console.log('setupCustomControls called');\r\n    // 快取常用節點\r\n    const controlsPanel = getDomOrWarn('custom-controls', 'custom-controls 不存在，無法掛載控制面板事件');\r\n    const controlsToggle = getDomOrWarn('custom-controls-toggle', 'custom-controls-toggle 不存在，無法掛載控制面板事件');\r\n    if (!controlsPanel || !controlsToggle) {\r\n        console.error('setupCustomControls aborted: panel or toggle missing');\r\n        return;\r\n    }\r\n\r\n    // 控制面板拖拉與展開收合\r\n    (0,_panelDrag_js__WEBPACK_IMPORTED_MODULE_0__.setupPanelDrag)(controlsPanel, controlsToggle);\r\n    \r\n    // 添加ESC浮動提示 (顯示5秒後淡出)\r\n    if (!document.getElementById('floating-esc-hint')) {\r\n        const floatingEscHint = document.createElement('div');\r\n        floatingEscHint.id = 'floating-esc-hint';\r\n        floatingEscHint.textContent = '按 ESC 打開控制面板';\r\n        floatingEscHint.style.position = 'fixed';\r\n        floatingEscHint.style.bottom = '10px';\r\n        floatingEscHint.style.right = '10px';\r\n        floatingEscHint.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\r\n        floatingEscHint.style.color = 'white';\r\n        floatingEscHint.style.padding = '5px 10px';\r\n        floatingEscHint.style.borderRadius = '4px';\r\n        floatingEscHint.style.fontSize = '12px';\r\n        floatingEscHint.style.zIndex = '9990';\r\n        floatingEscHint.style.opacity = '0.7';\r\n        floatingEscHint.style.transition = 'opacity 1s';\r\n        document.body.appendChild(floatingEscHint);\r\n        \r\n        // 5 秒後淡出提示\r\n        setTimeout(() => {\r\n            floatingEscHint.style.opacity = '0';\r\n            setTimeout(() => floatingEscHint.remove(), 1000);\r\n        }, 5000);\r\n    }\r\n\r\n    // 退出遊戲按鈕（可能在 pywebviewready 後才添加，延遲綁定）\r\n    setTimeout(() => {\r\n        const exitBtn = document.getElementById('exit-app');\r\n        if (exitBtn) {\r\n            exitBtn.onclick = _exitConfirm_js__WEBPACK_IMPORTED_MODULE_1__.loadExitPromptsAndShow;\r\n        }\r\n    }, 100);\r\n\r\n    // 勢力分布圖開關\r\n    const factionMapBtn = document.getElementById('toggle-faction-map');\r\n    const factionMapContainer = document.getElementById('faction-map-canvas-container');\r\n    if (factionMapBtn && factionMapContainer) {\r\n        (0,_map_factionMapControl_js__WEBPACK_IMPORTED_MODULE_2__.setupFactionMapControl)(factionMapBtn, factionMapContainer);\r\n    }\r\n\r\n    // 音量與通知控制\r\n    (0,_audio_audioControls_js__WEBPACK_IMPORTED_MODULE_3__.setupAudioControls)(controlsPanel);\r\n    \r\n    // 戰報通知過濾下拉選單\r\n    createFactionFilterDropdown(controlsPanel);\r\n    \r\n        // 添加下載狀態區域（替代按鈕和右下角浮動提示）\r\n    if (controlsPanel && !document.getElementById('rf-download-status-area')) {\r\n        // 創建下載狀態區域\r\n        const downloadArea = document.createElement('div');\r\n        downloadArea.id = 'rf-download-status-area';\r\n        downloadArea.style.width = '100%';\r\n        downloadArea.style.padding = '10px';\r\n        downloadArea.style.marginBottom = '10px';\r\n        downloadArea.style.background = 'rgba(52, 152, 219, 0.2)';\r\n        downloadArea.style.borderRadius = '6px';\r\n        downloadArea.style.border = '1px solid rgba(52, 152, 219, 0.5)';\r\n        \r\n        // 初始內容 - 簡化版下載狀態顯示 (移除進度條，純數字顯示)\r\n        downloadArea.innerHTML = `\r\n            <div style=\"display:flex;align-items:center;\">\r\n                <div id=\"control-download-spinner\" style=\"margin-right:10px;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;\"></div>\r\n                <div id=\"control-download-status-text\" style=\"font-size:0.95em;flex-grow:1;font-weight:500;\">準備就緒</div>\r\n                <div id=\"control-download-progress-text\" style=\"font-size:0.9em;color:white;margin-left:8px;min-width:40px;text-align:right;\">0%</div>\r\n            </div>\r\n            <div id=\"control-download-details\" style=\"display:flex;justify-content:space-between;margin-top:10px;font-size:0.85em;color:#bbb;\">\r\n                <div style=\"display:flex;gap:10px;\">\r\n                    <span id=\"control-download-queue\" style=\"white-space:nowrap;\">隊列: 0</span>\r\n                    <span id=\"control-download-active\" style=\"white-space:nowrap;\">並行: 0</span>\r\n                </div>\r\n                <div>\r\n                    <span id=\"control-download-completed\" style=\"white-space:nowrap;\">已完成: 0</span>\r\n                </div>\r\n            </div>\r\n        `;        controlsPanel.appendChild(downloadArea);\r\n        \r\n        // 使用變數追蹤上一次的狀態，以便偵測變化\r\n        const lastStatus = {\r\n            queueLength: 0,\r\n            activeDownloads: 0,\r\n            downloadedCount: 0,\r\n            isDownloading: false\r\n        };\r\n        \r\n        // 設置定期更新下載狀態（優化版）\r\n        function updateControlPanelDownloadStatus() {\r\n            if (!window.__TAURI__?.core) return;\r\n            \r\n            // 使用 Promise 以提高可靠性\r\n            // 檢查是否正在卸載頁面，如果是則不執行\r\n            if (window.isUnloading) return;\r\n\r\n            Promise.resolve()\r\n                .then(() => window.__TAURI__.core.invoke('get_resource_download_status', {  }))\r\n                .then(status => {\r\n                    if (window.isUnloading) return;\r\n                    const statusArea = document.getElementById('rf-download-status-area');\r\n                    const statusText = document.getElementById('control-download-status-text');\r\n                    const progressText = document.getElementById('control-download-progress-text');\r\n                    const queueText = document.getElementById('control-download-queue');\r\n                    const activeText = document.getElementById('control-download-active');\r\n                    const completedText = document.getElementById('control-download-completed');\r\n                    const spinner = document.getElementById('control-download-spinner');\r\n                    \r\n                    if (!statusArea || !statusText) return;\r\n                    \r\n                    // 從後端取得資料並確保值合法\r\n                    const queueLength = typeof status.queueLength === 'number' ? status.queueLength : 0;\r\n                    const activeDownloads = typeof status.activeDownloads === 'number' ? status.activeDownloads : 0;\r\n                    const maxWorkers = typeof status.maxWorkers === 'number' ? status.maxWorkers : 0;\r\n                    const downloadedCount = typeof status.downloadedCount === 'number' ? status.downloadedCount : 0;\r\n                    const isDownloading = Boolean(status.isDownloading);\r\n                    \r\n                    // 判斷是否有變化需要更新 UI\r\n                    const hasStatusChanged = \r\n                        queueLength !== lastStatus.queueLength || \r\n                        activeDownloads !== lastStatus.activeDownloads || \r\n                        downloadedCount !== lastStatus.downloadedCount || \r\n                        isDownloading !== lastStatus.isDownloading;\r\n                    \r\n                    // 只有在狀態變化時才更新 UI，減少不必要的 DOM 操作\r\n                    if (hasStatusChanged) {\r\n                        // 更新追蹤狀態\r\n                        Object.assign(lastStatus, {\r\n                            queueLength,\r\n                            activeDownloads,\r\n                            downloadedCount,\r\n                            isDownloading\r\n                        });\r\n                        \r\n                        // 計算進度\r\n                        const total = queueLength + downloadedCount;\r\n                        const progress = total > 0 ? Math.floor((downloadedCount / total) * 100) : 100;\r\n                        \r\n                        // 更新進度文字\r\n                        progressText.textContent = `${progress}%`;\r\n                        \r\n                        // 根據下載狀態更新顯示\r\n                        if (isDownloading && (queueLength > 0 || activeDownloads > 0)) {\r\n                            // 顯示下載中狀態\r\n                            statusText.textContent = `下載資源中`;\r\n                            spinner.style.display = 'block';\r\n                        } else if (downloadedCount > 0) {\r\n                            // 下載已完成\r\n                            statusText.textContent = `已完成`;\r\n                            spinner.style.display = 'none';\r\n                            progressText.textContent = '100%';\r\n                        } else {\r\n                            // 無下載\r\n                            statusText.textContent = `準備就緒`;\r\n                            spinner.style.display = 'none';\r\n                            progressText.textContent = '0%';\r\n                        }\r\n                        \r\n                        // 更新詳細資訊，增加空格並格式化數字\r\n                        if (total > 0) {\r\n                            queueText.textContent = `隊列: ${queueLength}`;\r\n                            activeText.textContent = `並行: ${activeDownloads}`;\r\n                            completedText.textContent = `已完成: ${downloadedCount}`;\r\n                        } else {\r\n                            queueText.textContent = `隊列: 0`;\r\n                            activeText.textContent = `並行: 0`;\r\n                            completedText.textContent = `已完成: 0`;\r\n                        }\r\n                    }\r\n                })\r\n                .catch(err => {\r\n                    console.error(\"獲取下載狀態失敗\", err);\r\n                });\r\n        }\r\n        \r\n        // 立即執行第一次更新\r\n        updateControlPanelDownloadStatus();\r\n        \r\n        // 使用更高頻率的更新間隔，確保動態更新更流暢\r\n        // 在網頁可見性變化時調整更新頻率\r\n        let updateIntervalId = setInterval(updateControlPanelDownloadStatus, 150);\r\n        \r\n        // 監聽頁面卸載事件，清除定時器\r\n        window.addEventListener('beforeunload', () => {\r\n            window.isUnloading = true;\r\n            clearInterval(updateIntervalId);\r\n        });\r\n\r\n        // 當頁面隱藏時減少更新頻率，可見時恢復\r\n        document.addEventListener('visibilitychange', () => {\r\n            if (window.isUnloading) return;\r\n            clearInterval(updateIntervalId);\r\n            updateIntervalId = setInterval(\r\n                updateControlPanelDownloadStatus, \r\n                document.hidden ? 500 : 150\r\n            );\r\n        });\r\n    }\r\n    \r\n    // 添加ESC鍵提示\r\n    if (controlsPanel && !document.getElementById('rf-esc-hint')) {\r\n        const escHint = document.createElement('div');\r\n        escHint.id = 'rf-esc-hint';\r\n        escHint.textContent = '按 ESC 打開/關閉控制面板';\r\n        escHint.style.fontSize = '0.8em';\r\n        escHint.style.color = '#aaa';\r\n        escHint.style.textAlign = 'center';\r\n        escHint.style.marginTop = '10px';\r\n        controlsPanel.appendChild(escHint);\r\n    }\r\n    \r\n    // 添加桌面專屬按鈕容器（在所有其他元素之後）\r\n    if (controlsPanel && !document.getElementById('desktop-buttons-container')) {\r\n        console.log('Creating desktop-buttons-container');\r\n        const desktopBtnsContainer = document.createElement('div');\r\n        desktopBtnsContainer.id = 'desktop-buttons-container';\r\n        controlsPanel.appendChild(desktopBtnsContainer);\r\n    } else {\r\n        console.log('desktop-buttons-container already exists or panel missing');\r\n    }\r\n    \r\n    // 確保對話框樣式已添加\r\n    addDialogStyles();\r\n}\r\n\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/customControls.js?\n}")},"./js/ui/exitConfirm.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   loadExitPromptsAndShow: () => (/* binding */ loadExitPromptsAndShow),\n/* harmony export */   showExitConfirm: () => (/* binding */ showExitConfirm)\n/* harmony export */ });\n// 退出遊戲確認\r\nasync function loadExitPromptsAndShow() {\r\n    let prompts = [\r\n        { message: '確認要離開 逆統戰：烽火 嗎？', confirm: '確定', cancel: '取消' }\r\n    ];\r\n    if (window.__TAURI__?.core) {\r\n        try {\r\n            const yamlStr = await window.__TAURI__.core.invoke('load_yaml', { filename: 'exit_prompts.yaml' });\r\n            if (yamlStr) {\r\n                let loaded = null;\r\n                if (window.YAML && window.YAML.load) {\r\n                    loaded = window.YAML.load(yamlStr);\r\n                } else {\r\n                    try {\r\n                        const mod = await Promise.resolve(/*! import() */).then(__webpack_require__.bind(__webpack_require__, /*! js-yaml */ \"./node_modules/js-yaml/dist/js-yaml.mjs\"));\r\n                        loaded = mod.load(yamlStr);\r\n                    } catch {}\r\n                }\r\n                if (Array.isArray(loaded) && loaded.length > 0) prompts = loaded;\r\n            }\r\n        } catch {}\r\n    }\r\n    const prompt = prompts[Math.floor(Math.random() * prompts.length)];\r\n    showExitConfirm(prompt);\r\n}\r\n\r\nfunction showExitConfirm(prompt) {\r\n    if (document.getElementById('custom-exit-confirm')) return;\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'custom-exit-confirm';\r\n    overlay.style.position = 'fixed';\r\n    overlay.style.left = '0';\r\n    overlay.style.top = '0';\r\n    overlay.style.width = '100vw';\r\n    overlay.style.height = '100vh';\r\n    overlay.style.background = 'rgba(0,0,0,0.32)';\r\n    overlay.style.zIndex = '20000';\r\n    overlay.style.display = 'flex';\r\n    overlay.style.alignItems = 'center';\r\n    overlay.style.justifyContent = 'center';\r\n    overlay.innerHTML = `\r\n      <div style=\"background:rgba(34,34,34,0.98);backdrop-filter:blur(6px);border-radius:14px;box-shadow:0 4px 32px #000a;padding:32px 36px 24px 36px;min-width:260px;max-width:90vw;display:flex;flex-direction:column;align-items:center;\">\r\n        <div style=\"font-size:1.18em;font-weight:bold;margin-bottom:18px;letter-spacing:1px;color:#fff;text-align:center;\">${prompt.message}</div>\r\n        <div style=\"display:flex;gap:18px;\">\r\n          <button id=\"exit-confirm-yes\" style=\"min-width:90px;min-height:38px;font-size:1em;background:#d9534f;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0003;cursor:pointer;transition:background 0.18s;\">${prompt.confirm}</button>\r\n          <button id=\"exit-confirm-no\" style=\"min-width:90px;min-height:38px;font-size:1em;background:#444;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0002;cursor:pointer;transition:background 0.18s;\">${prompt.cancel}</button>\r\n        </div>\r\n      </div>\r\n      <style>\r\n        #exit-confirm-yes:hover { background: #b52b27 !important; }\r\n        #exit-confirm-no:hover { background: #222 !important; }\r\n      </style>\r\n    `;\r\n    document.body.appendChild(overlay);\r\n    document.getElementById('exit-confirm-yes').onclick = async function() {\r\n        // 顯示關閉中的訊息\r\n        const dialogContent = overlay.querySelector('div > div:first-child');\r\n        if (dialogContent) {\r\n            dialogContent.textContent = '正在關閉應用...';\r\n        }\r\n        \r\n        // 禁用按鈕避免重複點擊\r\n        const buttons = overlay.querySelectorAll('button');\r\n        buttons.forEach(btn => {\r\n            btn.disabled = true;\r\n            btn.style.opacity = '0.5';\r\n            btn.style.cursor = 'not-allowed';\r\n        });\r\n        \r\n        // 調用退出API（直接關閉）\r\n        if (window.__TAURI__?.core) {\r\n            try {\r\n                await window.__TAURI__.core.invoke('exit_app');\r\n            } catch(e) {\r\n                console.error('退出失敗:', e);\r\n                window.close();\r\n            }\r\n        } else {\r\n            window.close();\r\n        }\r\n    };\r\n    document.getElementById('exit-confirm-no').onclick = function() {\r\n        document.body.removeChild(overlay);\r\n    };\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/exitConfirm.js?\n}")},"./js/ui/keyboardInit.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   initKeyboardControls: () => (/* binding */ initKeyboardControls)\n/* harmony export */ });\n/**\r\n * 鍵盤初始化腳本\r\n * 確保ESC按鍵能被正確捕獲（F11已移至windowManager.js）\r\n */\r\n\r\n// 等待文檔加載完成\r\ndocument.addEventListener('DOMContentLoaded', function() {\r\n    // 確保腳本只運行一次\r\n    if (window._keyboardInitDone) return;\r\n    window._keyboardInitDone = true;\r\n    \r\n    console.log('初始化鍵盤監聽器');\r\n    \r\n    // 監聽鍵盤事件\r\n    window.addEventListener('keydown', function(event) {\r\n        console.log('按鍵按下:', event.key, event.keyCode);\r\n        \r\n        // ESC 鍵 - 切換控制面板\r\n        if (event.key === 'Escape' || event.keyCode === 27) {\r\n            console.log('觸發ESC切換功能選單');\r\n            const panel = document.getElementById('custom-controls');\r\n            const toggle = document.getElementById('custom-controls-toggle');\r\n            if (panel && toggle) {\r\n                if (panel.style.display === 'none' || !panel.style.display) {\r\n                    panel.style.display = 'block';\r\n                    toggle.style.display = 'none';\r\n                } else {\r\n                    panel.style.display = 'none';\r\n                    toggle.style.display = 'flex';\r\n                }\r\n            }\r\n            event.preventDefault();\r\n        }\r\n        \r\n        // F11 鍵處理已移至 windowManager.js\r\n    }, true);\r\n    \r\n    // 添加全局函數供直接調用\r\n    window.rfToggleMenu = function() {\r\n        const panel = document.getElementById('custom-controls');\r\n        const toggle = document.getElementById('custom-controls-toggle');\r\n        if (panel && toggle) {\r\n            if (panel.style.display === 'none' || !panel.style.display) {\r\n                panel.style.display = 'block';\r\n                toggle.style.display = 'none';\r\n            } else {\r\n                panel.style.display = 'none';\r\n                toggle.style.display = 'flex';\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    };\r\n    \r\n    // 檢查5秒後是否成功載入\r\n    setTimeout(function() {\r\n        console.log('鍵盤監聽器已運行5秒');\r\n    }, 5000);\r\n});\r\n\r\n// 即時執行初始化\r\n(function() {\r\n    if (document.readyState === 'loading') {\r\n        console.log('等待文檔加載完成後初始化鍵盤...');\r\n    } else {\r\n        if (window._keyboardInitDone) return;\r\n        window._keyboardInitDone = true;\r\n        \r\n        console.log('立即初始化鍵盤監聽器');\r\n        \r\n        window.addEventListener('keydown', function(event) {\r\n            console.log('按鍵按下:', event.key, event.keyCode);\r\n            \r\n            if (event.key === 'Escape' || event.keyCode === 27) {\r\n                console.log('觸發ESC切換功能選單');\r\n                const panel = document.getElementById('custom-controls');\r\n                const toggle = document.getElementById('custom-controls-toggle');\r\n                if (panel && toggle) {\r\n                    if (panel.style.display === 'none' || !panel.style.display) {\r\n                        panel.style.display = 'block';\r\n                        toggle.style.display = 'none';\r\n                    } else {\r\n                        panel.style.display = 'none';\r\n                        toggle.style.display = 'flex';\r\n                    }\r\n                }\r\n                event.preventDefault();\r\n            }\r\n        }, true);\r\n        \r\n        window.rfToggleMenu = function() {\r\n            const panel = document.getElementById('custom-controls');\r\n            const toggle = document.getElementById('custom-controls-toggle');\r\n            if (panel && toggle) {\r\n                if (panel.style.display === 'none' || !panel.style.display) {\r\n                    panel.style.display = 'block';\r\n                    toggle.style.display = 'none';\r\n                } else {\r\n                    panel.style.display = 'none';\r\n                    toggle.style.display = 'flex';\r\n                }\r\n                return true;\r\n            }\r\n            return false;\r\n        };\r\n    }\r\n})();\r\n\r\n// 導出函數供其他模塊使用\r\nfunction initKeyboardControls() {\r\n    // 已在上方初始化，此函數保留以兼容舊代碼\r\n    console.log('initKeyboardControls 已通過 DOMContentLoaded 初始化');\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/keyboardInit.js?\n}")},"./js/ui/notificationBox.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   initializeMessageObserver: () => (/* binding */ initializeMessageObserver)\n/* harmony export */ });\n/* harmony import */ var _map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../map/factionColorMap.js */ \"./js/map/factionColorMap.js\");\n// mod/js/notificationBox.js\r\n\r\n\r\nconst HIGHLIGHTER_ID = 'rf-custom-highlighter';\r\nlet fadeOutTimer = null; // Timer for the fade-out effect\r\nlet lastTextContent = null; // Cache the last text to avoid redundant updates\r\nlet isInitialized = false; // Guard against re-initialization\r\n\r\nlet currentFactionFilter = '全部';\r\n\r\n// 獲取當前選中的帳號（用於多實例隔離）\r\nfunction getCurrentSelectedAccount() {\r\n    const accountSelect = document.getElementById('account-select');\r\n    if (!accountSelect || accountSelect.selectedIndex < 0) {\r\n        return null;\r\n    }\r\n    return {\r\n        accountIdx: accountSelect.selectedIndex,\r\n        account: accountSelect.options[accountSelect.selectedIndex].text\r\n    };\r\n}\r\n\r\n// 獲取完整的帳號資訊（包含密碼）\r\nasync function getCurrentAccountData() {\r\n    const selected = getCurrentSelectedAccount();\r\n    if (!selected) return null;\r\n    \r\n    try {\r\n        const accounts = await window.__TAURI__.core.invoke('get_accounts');\r\n        if (accounts && selected.accountIdx < accounts.length) {\r\n            return accounts[selected.accountIdx];\r\n        }\r\n    } catch (e) {\r\n        console.error('獲取帳號列表失敗:', e);\r\n    }\r\n    return null;\r\n}\r\n\r\n/**\r\n * Creates and injects the dedicated highlighter element and a style tag.\r\n * This runs only once and sets up all static styles for performance.\r\n */\r\nfunction setupHighlighter() {\r\n    if (document.getElementById(HIGHLIGHTER_ID)) {\r\n        return;\r\n    }\r\n\r\n    // 1. Create the highlighter element\r\n    const highlighterElement = document.createElement('div');\r\n    highlighterElement.id = HIGHLIGHTER_ID;\r\n    \r\n    // 2. Apply all static styles at creation time\r\n    Object.assign(highlighterElement.style, {\r\n        display: 'inline-block',\r\n        position: 'fixed',\r\n        top: '82px',\r\n        left: '50%',\r\n        zIndex: '10001',\r\n        padding: '4px 10px',\r\n        borderRadius: '8px',\r\n        fontWeight: 'bold',\r\n        textAlign: 'center',\r\n        whiteSpace: 'nowrap',\r\n        pointerEvents: 'none',\r\n        opacity: '0', // Start invisible\r\n        transform: 'translateX(-50%)', // Use pure CSS for centering\r\n        transition: 'opacity 0.4s ease-in-out',\r\n        // --- GPU Acceleration Hint ---\r\n        willChange: 'opacity', \r\n    });\r\n    \r\n    document.body.appendChild(highlighterElement);\r\n\r\n    // 3. Create and inject a style tag to hide the original element\r\n    const style = document.createElement('style');\r\n    style.id = `${HIGHLIGHTER_ID}-style`;\r\n    style.innerHTML = `\r\n        .ShortMessage_messageText__uLw0A {\r\n            display: none !important;\r\n            visibility: hidden !important;\r\n        }\r\n    `;\r\n    document.head.appendChild(style);\r\n}\r\n\r\n/**\r\n * Determines if an RGB color is light or dark based on its luminance.\r\n * @param {string} rgbString - The color in \"rgb(r, g, b)\" format.\r\n * @returns {boolean} - True if the color is considered light, false otherwise.\r\n */\r\nfunction isColorLight(rgbString) {\r\n    if (!rgbString || !rgbString.startsWith('rgb')) {\r\n        return false; \r\n    }\r\n    const rgbValues = rgbString.match(/\\d+/g);\r\n    if (!rgbValues || rgbValues.length < 3) {\r\n        return false;\r\n    }\r\n    const [r, g, b] = rgbValues.map(Number);\r\n    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;\r\n    return yiq >= 186;\r\n}\r\n\r\n/**\r\n * Updates only the dynamic styles of the highlighter element.\r\n * This is called for new messages and window resizing.\r\n * @param {string} text - The message text to display.\r\n */\r\nfunction updateDynamicStyles(text) {\r\n    const highlighterElement = document.getElementById(HIGHLIGHTER_ID);\r\n    if (!highlighterElement) return;\r\n\r\n    const trimmedText = text.trim();\r\n    \r\n    // --- Determine Faction Color ---\r\n    const factions = (0,_map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getAllFactions)();\r\n    let firstFactionFound = null;\r\n    let earliestIndex = -1;\r\n\r\n    for (const faction of factions) {\r\n        const index = trimmedText.indexOf(faction.name);\r\n        if (index !== -1 && (earliestIndex === -1 || index < earliestIndex)) {\r\n            earliestIndex = index;\r\n            firstFactionFound = faction;\r\n        }\r\n    }\r\n\r\n    let backgroundColor, boxShadowColor, textColor;\r\n\r\n    if (firstFactionFound) {\r\n        const rgbColor = (0,_map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getFactionColor)(firstFactionFound.name);\r\n        textColor = isColorLight(rgbColor) ? '#222' : 'white';\r\n        const colorWithAlpha = (alpha) => rgbColor.replace('rgb', 'rgba').replace(')', `, ${alpha})`);\r\n        backgroundColor = colorWithAlpha(0.3);\r\n        boxShadowColor = colorWithAlpha(0.25);\r\n    } else {\r\n        textColor = '#222';\r\n        backgroundColor = 'rgba(255, 255, 0, 0.2)';\r\n        boxShadowColor = 'rgba(255, 255, 0, 0.25)';\r\n    }\r\n\r\n    // --- Dynamic Font Size ---\r\n    const minFontSize = 16;\r\n    const maxFontSize = 24;\r\n    const preferredFontSize = window.innerWidth / 80; \r\n    const dynamicFontSizePx = Math.max(minFontSize, Math.min(preferredFontSize, maxFontSize));\r\n\r\n    // --- Apply only the dynamic styles ---\r\n    highlighterElement.textContent = trimmedText;\r\n    highlighterElement.style.color = textColor;\r\n    highlighterElement.style.backgroundColor = backgroundColor;\r\n    highlighterElement.style.boxShadow = `0 0 12px 4px ${boxShadowColor}`;\r\n    highlighterElement.style.fontSize = `${dynamicFontSizePx}px`;\r\n}\r\n\r\n\r\n/**\r\n * Manages the visibility and content of the highlighter.\r\n * @param {string} text - The message text to display.\r\n */\r\nfunction showHighlighter(text) {\r\n    if (!passesFactionFilter(text)) return;\r\n\r\n    const highlighterElement = document.getElementById(HIGHLIGHTER_ID);\r\n    if (!highlighterElement) return;\r\n\r\n    // Always clear any existing fade-out timer to prevent premature hiding.\r\n    if (fadeOutTimer) {\r\n        clearTimeout(fadeOutTimer);\r\n    }\r\n\r\n    const trimmedText = text.trim();\r\n\r\n    // Update content and fade in if the message is new, or if the box was hidden.\r\n    // This avoids re-rendering the same content if it's already visible.\r\n    if (trimmedText !== lastTextContent || highlighterElement.style.opacity !== '1') {\r\n        lastTextContent = trimmedText;\r\n        updateDynamicStyles(trimmedText);\r\n        highlighterElement.style.opacity = '1';\r\n    }\r\n\r\n    // Schedule a new fade-out for the current message.\r\n    const FADE_OUT_DELAY = 4000;\r\n    fadeOutTimer = setTimeout(() => {\r\n        highlighterElement.style.opacity = '0';\r\n        lastTextContent = null; // Clear cache when faded out\r\n    }, FADE_OUT_DELAY);\r\n}\r\n\r\nwindow.updateFactionFilter = function(val) {\r\n    currentFactionFilter = val;\r\n};\r\n\r\nfunction getFactionFromText(text) {\r\n    const factions = (0,_map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getAllFactions)();\r\n    for (const faction of factions) {\r\n        if (text.includes(faction.name)) return faction.name;\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction passesFactionFilter(text) {\r\n    if (currentFactionFilter === '全部') return true;\r\n    const faction = getFactionFromText(text);\r\n    return faction === currentFactionFilter;\r\n}\r\n\r\nasync function initializeMessageObserver() {\r\n    // Prevent multiple initializations, which would lead to memory leaks\r\n    // by attaching multiple observers and event listeners.\r\n    if (isInitialized) {\r\n        return;\r\n    }\r\n    isInitialized = true;\r\n\r\n    setupHighlighter();\r\n\r\n    const handleMutation = (targetNode) => {\r\n        if (targetNode && targetNode.textContent) {\r\n            const newText = targetNode.textContent.trim();\r\n            if (newText) {\r\n                showHighlighter(newText);\r\n            }\r\n        }\r\n    };\r\n    \r\n    const existingMessage = document.querySelector('.ShortMessage_messageText__uLw0A');\r\n    if (existingMessage) {\r\n        handleMutation(existingMessage);\r\n    }\r\n\r\n    window.addEventListener('resize', () => {\r\n        // Only update styles if the highlighter has content\r\n        if (lastTextContent) {\r\n            updateDynamicStyles(lastTextContent);\r\n        }\r\n    });\r\n\r\n    const observer = new MutationObserver((mutationsList) => {\r\n        for (const mutation of mutationsList) {\r\n            let targetElement = null;\r\n            if (mutation.type === 'childList') {\r\n                mutation.addedNodes.forEach(node => {\r\n                    if (node.nodeType !== Node.ELEMENT_NODE) return;\r\n                    if (node.matches('.ShortMessage_messageText__uLw0A')) {\r\n                        targetElement = node;\r\n                    } else {\r\n                        targetElement = node.querySelector('.ShortMessage_messageText__uLw0A');\r\n                    }\r\n                });\r\n            } else if (mutation.type === 'characterData') {\r\n                targetElement = mutation.target.parentElement?.closest('.ShortMessage_messageText__uLw0A');\r\n            }\r\n\r\n            if (targetElement) {\r\n                handleMutation(targetElement);\r\n                return; \r\n            }\r\n        }\r\n    });\r\n\r\n    observer.observe(document.body, {\r\n        childList: true,\r\n        subtree: true,\r\n        characterData: true,\r\n    });\r\n\r\n    // 初始化過濾條件\r\n    if (!window.__TAURI__ && window.__TAURI__?.core) {\r\n        try {\r\n            // 獲取當前帳號資訊用於多實例隔離\r\n            const targetAccount = await getCurrentAccountData();\r\n            const val = await window.__TAURI__.core.invoke('get_report_faction_filter', { targetAccount });\r\n            currentFactionFilter = val || '全部';\r\n        } catch (e) {\r\n            console.error('獲取戰報篩選設定失敗:', e);\r\n            currentFactionFilter = '全部';\r\n        }\r\n    }\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/notificationBox.js?\n}")},"./js/ui/panelDrag.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupPanelDrag: () => (/* binding */ setupPanelDrag)\n/* harmony export */ });\n// 自訂控制面板與拖拉模組\r\nfunction setupPanelDrag(controlsPanel, controlsToggle) {\r\n    // 保存控制面板當前狀態，防止切換全屏時丟失\r\n    let panelState = {\r\n        isOpen: false,\r\n        position: { x: 0, y: 0 }\r\n    };\r\n    \r\n    // 檢查是否有窗口管理器的面板位置\r\n    let defaultPosition = { x: 20, y: 20 };\r\n    \r\n    // 優先使用窗口管理器的面板位置\r\n    if (window.windowState && window.windowState.panelPosition) {\r\n        defaultPosition = window.windowState.panelPosition;\r\n    }\r\n    \r\n    // 初始化時從 localStorage 載入面板狀態\r\n    try {\r\n        const savedState = localStorage.getItem('rf_panel_state');\r\n        if (savedState) {\r\n            const loadedState = JSON.parse(savedState);\r\n            \r\n            // 應用開關狀態\r\n            if (loadedState.isOpen) {\r\n                controlsPanel.style.display = 'block';\r\n                controlsToggle.style.display = 'none';\r\n                panelState.isOpen = true;\r\n            } else {\r\n                controlsPanel.style.display = 'none';\r\n                controlsToggle.style.display = 'flex';\r\n                panelState.isOpen = false;\r\n            }\r\n            \r\n            // 應用位置，但確保位置有效\r\n            if (loadedState.position && \r\n                loadedState.position.x !== undefined && \r\n                loadedState.position.y !== undefined) {\r\n                \r\n                // 確保位置在可見區域內\r\n                let x = loadedState.position.x;\r\n                let y = loadedState.position.y;\r\n                \r\n                // 限制位置在視窗範圍內\r\n                const maxX = window.innerWidth - 100; \r\n                const maxY = window.innerHeight - 100;\r\n                \r\n                if (x < 0) x = 0;\r\n                if (y < 0) y = 0;\r\n                if (x > maxX) x = maxX;\r\n                if (y > maxY) y = maxY;\r\n                \r\n                // 應用有效位置\r\n                controlsPanel.style.left = x + 'px';\r\n                controlsPanel.style.top = y + 'px';\r\n                controlsToggle.style.left = x + 'px';\r\n                controlsToggle.style.top = y + 'px';\r\n                \r\n                // 更新狀態\r\n                panelState.position = { x, y };\r\n                \r\n                // 更新窗口管理器的面板位置\r\n                if (window.windowState) {\r\n                    window.windowState.panelPosition = { x, y };\r\n                }\r\n            } else {\r\n                // 如果沒有有效位置，使用默認位置\r\n                controlsPanel.style.left = defaultPosition.x + 'px';\r\n                controlsPanel.style.top = defaultPosition.y + 'px';\r\n                controlsToggle.style.left = defaultPosition.x + 'px';\r\n                controlsToggle.style.top = defaultPosition.y + 'px';\r\n                \r\n                panelState.position = defaultPosition;\r\n            }\r\n        } else {\r\n            // 沒有保存的狀態，使用默認值\r\n            controlsPanel.style.left = defaultPosition.x + 'px';\r\n            controlsPanel.style.top = defaultPosition.y + 'px';\r\n            controlsToggle.style.left = defaultPosition.x + 'px';\r\n            controlsToggle.style.top = defaultPosition.y + 'px';\r\n            \r\n            panelState.position = defaultPosition;\r\n        }\r\n    } catch (e) {\r\n        console.error('載入面板狀態失敗:', e);\r\n        \r\n        // 出錯時使用默認位置\r\n        controlsPanel.style.left = defaultPosition.x + 'px';\r\n        controlsPanel.style.top = defaultPosition.y + 'px';\r\n        controlsToggle.style.left = defaultPosition.x + 'px';\r\n        controlsToggle.style.top = defaultPosition.y + 'px';\r\n        \r\n        panelState.position = defaultPosition;\r\n    }\r\n\r\n    // 展開/收合功能選單\r\n    controlsToggle.onclick = function() {\r\n        if(controlsPanel.style.display === 'none') {\r\n            controlsPanel.style.display = 'block';\r\n            controlsToggle.style.display = 'none';\r\n            // 更新狀態並保存\r\n            panelState.isOpen = true;\r\n            localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n        }\r\n    };\r\n    \r\n    // 暴露全局切換函數供 ESC 鍵調用\r\n    window.toggleControlPanel = function() {\r\n        if (controlsPanel.style.display === 'none' || !controlsPanel.style.display) {\r\n            // 展開選單\r\n            controlsPanel.style.display = 'block';\r\n            controlsToggle.style.display = 'none';\r\n            panelState.isOpen = true;\r\n        } else {\r\n            // 收合選單\r\n            controlsPanel.style.display = 'none';\r\n            controlsToggle.style.display = 'flex';\r\n            panelState.isOpen = false;\r\n        }\r\n        localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n    };\r\n    \r\n    // 點擊外部區域關閉面板\r\n    document.addEventListener('mousedown', function(e) {\r\n        if(controlsPanel.style.display !== 'none' && !controlsPanel.contains(e.target) && !controlsToggle.contains(e.target)) {\r\n            // 檢查是否點擊了其他對話框或特殊元素\r\n            const clickedOnDialog = e.target.closest('.dialog') || e.target.closest('#ranking-modal') || e.target.closest('#faction-map-canvas-container');\r\n            if (!clickedOnDialog) {\r\n                // 直接切換面板\r\n                controlsPanel.style.display = 'none';\r\n                controlsToggle.style.display = 'flex';\r\n                panelState.isOpen = false;\r\n                localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n            }\r\n        }\r\n    });\r\n    // 讓功能選單可滑鼠拖拉移動\r\n    (function() {\r\n        const panel = controlsPanel;\r\n        let isDragging = false, startX = 0, startY = 0, origX = 0, origY = 0;\r\n        panel.addEventListener('mousedown', function(e) {\r\n            if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'FORM' || e.target.isContentEditable) return;\r\n            isDragging = true;\r\n            startX = e.clientX;\r\n            startY = e.clientY;\r\n            const rect = panel.getBoundingClientRect();\r\n            origX = rect.left;\r\n            origY = rect.top;\r\n            document.body.style.userSelect = 'none';\r\n        });\r\n        window.addEventListener('mousemove', function(e) {\r\n            if (!isDragging) return;\r\n            let dx = e.clientX - startX;\r\n            let dy = e.clientY - startY;\r\n            panel.style.left = (origX + dx) + 'px';\r\n            panel.style.top = (origY + dy) + 'px';\r\n            panel.style.right = 'auto';\r\n        });\r\n        window.addEventListener('mouseup', function() {\r\n            if (isDragging) {\r\n                // 拖拉結束時修正位置\r\n                const rect = panel.getBoundingClientRect();\r\n                const minX = 0, minY = 0;\r\n                const maxX = window.innerWidth - Math.min(rect.width, 300); // 確保至少部分可見\r\n                const maxY = window.innerHeight - Math.min(rect.height, 100);\r\n                let newLeft = rect.left, newTop = rect.top;\r\n                if (rect.left < minX) newLeft = minX;\r\n                if (rect.top < minY) newTop = minY;\r\n                if (rect.left > maxX) newLeft = maxX;\r\n                if (rect.top > maxY) newTop = maxY;\r\n                panel.style.left = newLeft + 'px';\r\n                panel.style.top = newTop + 'px';\r\n                \r\n                // 更新全局窗口管理器的面板位置\r\n                if (window.windowState) {\r\n                    window.windowState.panelPosition = { x: newLeft, y: newTop };\r\n                }\r\n                \r\n                // 保存面板位置到 localStorage\r\n                try {\r\n                    const savedState = localStorage.getItem('rf_panel_state') || '{}';\r\n                    const panelState = JSON.parse(savedState);\r\n                    panelState.position = { x: newLeft, y: newTop };\r\n                    panelState.timestamp = Date.now(); // 添加時間戳\r\n                    localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n                } catch (e) {\r\n                    console.error('保存面板位置失敗:', e);\r\n                }\r\n            }\r\n            isDragging = false;\r\n            document.body.style.userSelect = '';\r\n        });\r\n        panel.style.position = 'fixed';\r\n        panel.style.top = panel.style.top || '20px';\r\n        panel.style.right = panel.style.right || '20px';\r\n    })();\r\n    // 小按鈕也能拖拉移動，並同步展開選單位置\r\n    (function() {\r\n        const toggleBtn = controlsToggle;\r\n        const panel = controlsPanel;\r\n        let isDragging = false, startX = 0, startY = 0, origX = 0, origY = 0;\r\n        toggleBtn.addEventListener('mousedown', function(e) {\r\n            isDragging = true;\r\n            startX = e.clientX;\r\n            startY = e.clientY;\r\n            const rect = toggleBtn.getBoundingClientRect();\r\n            origX = rect.left;\r\n            origY = rect.top;\r\n            document.body.style.userSelect = 'none';\r\n        });\r\n        window.addEventListener('mousemove', function(e) {\r\n            if (!isDragging) return;\r\n            let dx = e.clientX - startX;\r\n            let dy = e.clientY - startY;\r\n            toggleBtn.style.left = (origX + dx) + 'px';\r\n            toggleBtn.style.top = (origY + dy) + 'px';\r\n            toggleBtn.style.right = 'auto';\r\n            panel.style.left = toggleBtn.style.left;\r\n            panel.style.top = toggleBtn.style.top;\r\n            panel.style.right = 'auto';\r\n        });\r\n        window.addEventListener('mouseup', function() {\r\n            if (isDragging) {\r\n                // 拖拉結束時修正位置\r\n                const rect = toggleBtn.getBoundingClientRect();\r\n                const minX = 0, minY = 0;\r\n                const maxX = window.innerWidth - rect.width;\r\n                const maxY = window.innerHeight - rect.height;\r\n                let newLeft = rect.left, newTop = rect.top;\r\n                if (rect.left < minX) newLeft = minX;\r\n                if (rect.top < minY) newTop = minY;\r\n                if (rect.left > maxX) newLeft = maxX;\r\n                if (rect.top > maxY) newTop = maxY;\r\n                toggleBtn.style.left = newLeft + 'px';\r\n                toggleBtn.style.top = newTop + 'px';\r\n                // 同步 panel 位置\r\n                panel.style.left = newLeft + 'px';\r\n                panel.style.top = newTop + 'px';\r\n                \r\n                // 保存面板位置\r\n                try {\r\n                    const savedState = localStorage.getItem('rf_panel_state') || '{}';\r\n                    const panelState = JSON.parse(savedState);\r\n                    panelState.position = { x: newLeft, y: newTop };\r\n                    localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n                } catch (e) {\r\n                    console.error('保存面板位置失敗:', e);\r\n                }\r\n            }\r\n            isDragging = false;\r\n            document.body.style.userSelect = '';\r\n        });\r\n        toggleBtn.style.position = 'fixed';\r\n        toggleBtn.style.top = toggleBtn.style.top || '20px';\r\n        toggleBtn.style.right = toggleBtn.style.right || '20px';\r\n    })();\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/panelDrag.js?\n}")},"./js/ui/rankingModal.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupRankingModalEvents: () => (/* binding */ setupRankingModalEvents),\n/* harmony export */   updateRanking: () => (/* binding */ updateRanking)\n/* harmony export */ });\n/* harmony import */ var _map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../map/factionColorMap.js */ \"./js/map/factionColorMap.js\");\n\r\n\r\n// 排行榜模組\r\nasync function updateRanking() {\r\n    if(location.hash !== '#/portalmap') return;\r\n    function waitForMarkers(mapSelector, markerSelector, timeout = 12000) {\r\n        return new Promise((resolve, reject) => {\r\n            const start = Date.now();\r\n            (function check() {\r\n                const mapBox = document.querySelector(mapSelector);\r\n                if (mapBox) {\r\n                    const markers = mapBox.querySelectorAll(markerSelector);\r\n                    if (markers.length > 0) return resolve({mapBox, markers});\r\n                }\r\n                if (Date.now() - start > timeout) return reject('地圖城市載入逾時');\r\n                setTimeout(check, 300);\r\n            })();\r\n        });\r\n    }\r\n    try {\r\n        const {mapBox, markers} = await waitForMarkers('.PortalMap_mapBox__3WtlM', '.PortalMap_marker__rzok1, .PortalMap_markerCapital__6ocPp');\r\n        const colorMap = {};\r\n        markers.forEach(marker => {\r\n            if (!marker || !marker.style) return;\r\n            const color = marker.style.backgroundColor;\r\n            if (!colorMap[color]) colorMap[color] = 0;\r\n            colorMap[color]++;\r\n        });\r\n        const sorted = Object.entries(colorMap).sort((a,b)=>b[1]-a[1]);\r\n        let html = '<div style=\"font-size:2em;font-weight:700;text-align:center;margin-bottom:18px;letter-spacing:2px;color:#fff;\">陣營城市排行榜</div>';\r\n        html += '<div style=\"width:100%;\">';\r\n        html += '<div style=\"display:flex;justify-content:space-between;align-items:center;padding:0 8px 8px 8px;font-size:1.15em;font-weight:600;color:#fff;opacity:0.85;border-bottom:1.5px solid #444;\">';\r\n        html += '<span>陣營</span><span>城市數</span></div>';\r\n        sorted.forEach(([color, count]) => {\r\n            const factionName = (0,_map_factionColorMap_js__WEBPACK_IMPORTED_MODULE_0__.getFactionByColor)(color);\r\n            html += `<div style=\"display:flex;align-items:center;justify-content:space-between;padding:12px 8px 12px 8px;font-size:1.18em;font-weight:500;\">\r\n                <span style=\"display:flex;align-items:center;gap:12px;\">\r\n                    <span style=\"display:inline-block;width:22px;height:22px;background:${color};border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px #0004;\"></span>\r\n                    <span style=\"color:#fff;\">${factionName}</span>\r\n                </span>\r\n                <span style=\"color:#fff;\">${count}</span>\r\n            </div>`;\r\n        });\r\n        html += '</div>';\r\n        document.getElementById('ranking-content').innerHTML = html;\r\n    } catch(e) {\r\n        document.getElementById('ranking-content').innerHTML = '排行榜載入失敗：' + e;\r\n    }\r\n}\r\n\r\nfunction setupRankingModalEvents() {\r\n    let rankingUpdateTimer = null;\r\n    let lastRankingHash = '';\r\n    document.getElementById('show-portalmap-ranking').onclick = async function() {\r\n        location.hash = '#/portalmap';\r\n        document.getElementById('ranking-modal').style.display = 'flex';\r\n        lastRankingHash = location.hash;\r\n        await updateRanking();\r\n        if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n        rankingUpdateTimer = setInterval(()=>{\r\n            if(location.hash === '#/portalmap') {\r\n                updateRanking();\r\n            }\r\n        }, 2000);\r\n    };\r\n    document.getElementById('close-ranking-modal').onclick = function() {\r\n        document.getElementById('ranking-modal').style.display = 'none';\r\n        if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n    };\r\n    window.addEventListener('hashchange', function() {\r\n        if(document.getElementById('ranking-modal').style.display === 'flex') {\r\n            if(location.hash === '#/portalmap') {\r\n                updateRanking();\r\n                if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n                rankingUpdateTimer = setInterval(()=>{\r\n                    if(location.hash === '#/portalmap') updateRanking();\r\n                }, 2000);\r\n            } else {\r\n                if(rankingUpdateTimer) clearInterval(rankingUpdateTimer);\r\n            }\r\n        }\r\n    });\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/rankingModal.js?\n}")},"./js/ui/rankingPanelDrag.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupRankingPanelDrag: () => (/* binding */ setupRankingPanelDrag)\n/* harmony export */ });\n// 排行榜浮層可拖拉\r\nfunction setupRankingPanelDrag() {\r\n    (function() {\r\n        const panel = document.getElementById('ranking-panel');\r\n        let isDragging = false, startX = 0, startY = 0, origX = 0, origY = 0;\r\n        panel.addEventListener('mousedown', function(e) {\r\n            if (e.button !== 0 || e.target.id === 'close-ranking-modal') return;\r\n            isDragging = true;\r\n            startX = e.clientX;\r\n            startY = e.clientY;\r\n            const rect = panel.getBoundingClientRect();\r\n            origX = rect.left;\r\n            origY = rect.top;\r\n            panel.style.transition = 'none';\r\n            document.body.style.userSelect = 'none';\r\n        });\r\n        window.addEventListener('mousemove', function(e) {\r\n            if (!isDragging) return;\r\n            let dx = e.clientX - startX;\r\n            let dy = e.clientY - startY;\r\n            panel.style.left = (origX + dx) + 'px';\r\n            panel.style.top = (origY + dy) + 'px';\r\n            panel.style.transform = 'none';\r\n        });\r\n        window.addEventListener('mouseup', function() {\r\n            isDragging = false;\r\n            document.body.style.userSelect = '';\r\n        });\r\n        panel.style.position = 'fixed';\r\n        panel.style.top = panel.style.top || '50%';\r\n        panel.style.left = panel.style.left || '50%';\r\n        panel.style.transform = panel.style.transform || 'translate(-50%,-50%)';\r\n    })();\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/rankingPanelDrag.js?\n}")},"./js/ui/swordsIcon.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getColoredKnifeIcon: () => (/* binding */ getColoredKnifeIcon)\n/* harmony export */ });\n// 雙刀圖示染色與快取工具\r\n// 用於將 base64 PNG 動態染色為指定顏色，並快取 DataURL\r\n\r\nconst knifeBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAE4AAABMCAMAAAD0vHEkAAAAMFBMVEVHcEz///////////////////////////////////////////////////////////9EPuwCAAAAD3RSTlMABxUhLT1PW2yCm7LK4PNZhUO6AAACUklEQVR42qWW25aDIAxFBblfkv//25lOmUVtQkPsedPA1qWwyXEcpmdvjy9jzliaOR4BRGg53Ec+UIDYnlcFHyFIFeqR9LwT8S8D6RWs8ESNjHdxgC+BfV7C18C4a/v19rlJi3hJPUYaXtLdFi3gNekYyXhNtzs0QOQ/kkM9z8F6Dr6nWS0N2yxWyhNWWyczMvOPZqrR0dC9lJGmrmm2I41ULyuaadLTC+7zLEfDeHlgxRH+68pDzcagxOD2HmyKyJOHid8vagfNZKSBoBki89DLA2QfUlPIZZrITXD/RVgVZYvNwJgSkKZL5vbATloXJF5nptlBI1aU47iJEk1pMxSMqOCBliY7SLaXngdaGhUWoCAkIcRENJAOfVgeDL3pY4g/iJB0yQJNm6RUiB6H/jua7Ettdyl1k+ruknS76ngcUVpTtjLl7dvERepQ3pwmy9QTMP3SJIO2X1KRfDw4yRIaUHuWQRU9DIRWqAA7osBbfrE8Bag4f1ZTslDUnGFTb0V9AlnKg/hJqFV7ZsdPAmxGYUwiS5PIw3Q0LzkraGhOdCAIzae6c/drXYq8sq3TACjxTNnWqd85VPOWTk+qS5g/juEB3bgTmcC9L996NvaINnlWL3qO4OcP7W+0Yv72W+AXUzWkY+uA4AaN7wXPFvjFWRcdIPhB451jFhpb2gz8miaH8pBZu+l+R9np6o2qjpKuv/BF95aZ3RbgfnuUmL0R7jeDgTPBfL9u79JO7nYxKpxtDG3yyqGMabyjAkya7v34hi8Mmv79+PYxDpo2tk7aD5KZkmts/PnDAAAAAElFTkSuQmCC';\r\n\r\nconst knifeColorCache = {};\r\n\r\n/**\r\n * 產生染色後的雙刀圖示 DataURL，並快取\r\n * @param {string} color - 目標顏色（如 '#ff0000' 或 'rgb(255,0,0)'）\r\n * @param {function} callback - 回傳 DataURL 的 callback\r\n */\r\nfunction getColoredKnifeIcon(color, callback) {\r\n  if (knifeColorCache[color]) {\r\n    callback(knifeColorCache[color]);\r\n    return;\r\n  }\r\n  const img = new Image();\r\n  img.onload = function() {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = img.width;\r\n    canvas.height = img.height;\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.drawImage(img, 0, 0);\r\n    ctx.globalCompositeOperation = 'source-atop';\r\n    ctx.fillStyle = color;\r\n    ctx.globalAlpha = 0.7; // 染色強度可調\r\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n    ctx.globalAlpha = 1.0;\r\n    ctx.globalCompositeOperation = 'source-over';\r\n    const dataUrl = canvas.toDataURL();\r\n    knifeColorCache[color] = dataUrl;\r\n    callback(dataUrl);\r\n  };\r\n  img.src = 'data:image/png;base64,' + knifeBase64;\r\n}\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/swordsIcon.js?\n}")},"./js/ui/updatePrompt.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   initUpdatePrompt: () => (/* binding */ initUpdatePrompt)\n/* harmony export */ });\n\r\nfunction initUpdatePrompt() {\r\n    // 定義全局回調函數供後端調用\r\n    window.onUpdateFound = function(filename, version, url) {\r\n        console.log('[Update] 發現新版本:', version, filename);\r\n        \r\n        // 避免重複彈窗\r\n        if (document.getElementById('rf-update-modal')) return;\r\n\r\n        // 創建模態框\r\n        const modal = document.createElement('div');\r\n        modal.id = 'rf-update-modal';\r\n        modal.style.cssText = `\r\n            position: fixed;\r\n            top: 0;\r\n            left: 0;\r\n            width: 100%;\r\n            height: 100%;\r\n            background: rgba(0,0,0,0.7);\r\n            z-index: 20000;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            backdrop-filter: blur(4px);\r\n            font-family: \"Microsoft JhengHei\", sans-serif;\r\n        `;\r\n        \r\n        const content = document.createElement('div');\r\n        content.style.cssText = `\r\n            background: #222;\r\n            color: #fff;\r\n            padding: 24px;\r\n            border-radius: 12px;\r\n            width: 400px;\r\n            max-width: 90%;\r\n            box-shadow: 0 4px 20px rgba(0,0,0,0.5);\r\n            border: 1px solid #444;\r\n            text-align: center;\r\n            animation: fadeIn 0.3s ease-out;\r\n        `;\r\n        \r\n        // 添加動畫樣式\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            @keyframes fadeIn {\r\n                from { opacity: 0; transform: scale(0.9); }\r\n                to { opacity: 1; transform: scale(1); }\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n        \r\n        content.innerHTML = `\r\n            <h2 style=\"margin-top:0;color:#4CAF50;font-size:1.5em;\">發現新版本 v${version}</h2>\r\n            <p style=\"margin: 20px 0; color: #ccc; line-height: 1.5;\">\r\n                檢測到新的應用程式版本。<br>\r\n                是否立即下載並安裝？\r\n            </p>\r\n            <div style=\"display:flex;justify-content:center;gap:16px;margin-top:24px;\">\r\n                <button id=\"btn-update-confirm\" style=\"padding:10px 24px;background:#4CAF50;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1em;transition:background 0.2s;\">立即更新</button>\r\n                <button id=\"btn-update-cancel\" style=\"padding:10px 24px;background:#555;color:white;border:none;border-radius:6px;cursor:pointer;font-size:1em;transition:background 0.2s;\">稍後再說</button>\r\n            </div>\r\n        `;\r\n        \r\n        modal.appendChild(content);\r\n        document.body.appendChild(modal);\r\n        \r\n        // 按鈕事件\r\n        const btnCancel = document.getElementById('btn-update-cancel');\r\n        const btnConfirm = document.getElementById('btn-update-confirm');\r\n        \r\n        btnCancel.onmouseover = () => btnCancel.style.background = '#666';\r\n        btnCancel.onmouseout = () => btnCancel.style.background = '#555';\r\n        \r\n        btnConfirm.onmouseover = () => btnConfirm.style.background = '#45a049';\r\n        btnConfirm.onmouseout = () => btnConfirm.style.background = '#4CAF50';\r\n        \r\n        btnCancel.onclick = () => {\r\n            modal.remove();\r\n        };\r\n        \r\n        btnConfirm.onclick = async () => {\r\n            btnConfirm.disabled = true;\r\n            btnConfirm.textContent = '下載中...';\r\n            btnConfirm.style.background = '#666';\r\n            btnConfirm.style.cursor = 'wait';\r\n            btnCancel.style.display = 'none';\r\n            \r\n            const p = content.querySelector('p');\r\n            if (p) p.textContent = '正在下載更新檔，下載完成後將自動重啟安裝...';\r\n            \r\n            if (!window.__TAURI__ && window.__TAURI__?.core) {\r\n                try {\r\n                    await window.__TAURI__.core.invoke('perform_update', { url, filename });\r\n                } catch (e) {\r\n                    console.error('Update failed:', e);\r\n                    p.textContent = '更新失敗: ' + e;\r\n                    p.style.color = '#ff5252';\r\n                    btnConfirm.textContent = '重試';\r\n                    btnConfirm.disabled = false;\r\n                    btnConfirm.style.background = '#4CAF50';\r\n                    btnConfirm.style.cursor = 'pointer';\r\n                    btnCancel.style.display = 'inline-block';\r\n                }\r\n            } else {\r\n                alert('無法調用更新 API');\r\n                modal.remove();\r\n            }\r\n        };\r\n    };\r\n    \r\n    console.log('Update prompt initialized');\r\n}\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/updatePrompt.js?\n}")},"./js/ui/windowManager.js"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   initWindowManager: () => (/* binding */ initWindowManager),\n/* harmony export */   toggleFullscreen: () => (/* binding */ toggleFullscreen)\n/* harmony export */ });\n/**\r\n * 視窗管理模組\r\n * 負責管理全屏切換、視窗大小和視窗狀態\r\n */\r\n\r\n// 視窗狀態 (全局可訪問)\r\nwindow.windowState = {\r\n    isFullScreen: false,\r\n    previousState: null,\r\n    lastToggleTime: 0,\r\n    debug: false,  // 關閉除錯輸出\r\n    // 固定視窗大小\r\n    fixedWidth: 1280,\r\n    fixedHeight: 720,\r\n    // 記錄面板位置，確保一致性\r\n    panelPosition: { x: 20, y: 20 },\r\n    // 已保存的面板狀態\r\n    savedPanelState: null\r\n};\r\n\r\n// 使用本地變量方便模塊內部使用\r\nconst windowState = window.windowState;\r\n\r\n// 記錄 F11 事件處理狀態\r\nlet f11HandlerInitialized = false;\r\n\r\n/**\r\n * 切換全屏顯示\r\n * 使用 Tauri API 調用後端\r\n */\r\nasync function toggleFullscreen() {\r\n    // 防止短時間內重複觸發\r\n    const now = Date.now();\r\n    if (now - windowState.lastToggleTime < 500) {\r\n        console.log('防止重複觸發全屏切換');\r\n        return;\r\n    }\r\n    windowState.lastToggleTime = now;\r\n\r\n    console.log('視窗管理器: 切換全屏顯示');\r\n    \r\n    try {\r\n        // 保存面板狀態（在全屏切換前）\r\n        savePanelState();\r\n        \r\n        // 調用 Tauri 後端切換全屏\r\n        if (window.__TAURI__ && window.__TAURI__.core) {\r\n            console.log('視窗管理器: 調用 Tauri API 切換全屏');\r\n            const newFullscreenState = await window.__TAURI__.core.invoke('toggle_fullscreen');\r\n            windowState.isFullScreen = newFullscreenState;\r\n            console.log('視窗管理器: 全屏狀態已切換為', newFullscreenState);\r\n        } else {\r\n            console.warn('視窗管理器: Tauri API 不可用，使用備用方法');\r\n            // 使用瀏覽器原生方法作為備用\r\n            fallbackToggleFullscreen();\r\n        }\r\n        \r\n        // 延遲恢復面板狀態\r\n        setTimeout(() => {\r\n            restorePanelState();\r\n        }, 300);\r\n    } catch(e) {\r\n        console.error('視窗管理器: 切換全屏失敗', e);\r\n        \r\n        // 在失敗時嘗試原生方法\r\n        try {\r\n            fallbackToggleFullscreen();\r\n            setTimeout(restorePanelState, 300);\r\n        } catch(e2) {\r\n            console.error('視窗管理器: 備用全屏切換也失敗', e2);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * 備用的瀏覽器原生全屏切換方法\r\n */\r\nfunction fallbackToggleFullscreen() {\r\n    try {\r\n        const isFullScreen = document.fullscreenElement || \r\n                           document.webkitFullscreenElement || \r\n                           document.mozFullScreenElement ||\r\n                           document.msFullscreenElement;\r\n        \r\n        if (!isFullScreen) {\r\n            const docElm = document.documentElement;\r\n            if (docElm.requestFullscreen) {\r\n                docElm.requestFullscreen();\r\n            } else if (docElm.webkitRequestFullscreen) {\r\n                docElm.webkitRequestFullscreen();\r\n            } else if (docElm.mozRequestFullScreen) {\r\n                docElm.mozRequestFullScreen();\r\n            } else if (docElm.msRequestFullscreen) {\r\n                docElm.msRequestFullscreen();\r\n            }\r\n        } else {\r\n            if (document.exitFullscreen) {\r\n                document.exitFullscreen();\r\n            } else if (document.webkitExitFullscreen) {\r\n                document.webkitExitFullscreen();\r\n            } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen();\r\n            } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen();\r\n            }\r\n        }\r\n    } catch(e) {\r\n        console.error('備用全屏切換失敗', e);\r\n    }\r\n}\r\n\r\n/**\r\n * 保存面板狀態\r\n */\r\nfunction savePanelState() {\r\n    try {\r\n        const controls = document.getElementById('custom-controls');\r\n        const toggle = document.getElementById('custom-controls-toggle');\r\n        if (!controls || !toggle) return;\r\n        \r\n        const isOpen = controls.style.display !== 'none' && controls.style.display !== '';\r\n        let position = windowState.panelPosition || { x: 20, y: 20 };\r\n        \r\n        // 獲取當前位置\r\n        try {\r\n            const rect = isOpen ? controls.getBoundingClientRect() : toggle.getBoundingClientRect();\r\n            \r\n            // 檢查位置是否有效\r\n            if (rect && rect.left >= 0 && rect.top >= 0) {\r\n                position = { x: rect.left, y: rect.top };\r\n                \r\n                // 更新全局保存的面板位置\r\n                windowState.panelPosition = position;\r\n                \r\n                console.log('視窗管理器: 更新面板位置', position);\r\n            }\r\n        } catch(e) {\r\n            console.error('獲取面板位置失敗', e);\r\n        }\r\n        \r\n        const panelState = {\r\n            isOpen: isOpen,\r\n            position: position,\r\n            timestamp: Date.now()\r\n        };\r\n        \r\n        // 保存到全局狀態和 localStorage\r\n        windowState.savedPanelState = panelState;\r\n        localStorage.setItem('rf_panel_state', JSON.stringify(panelState));\r\n        console.log('視窗管理器: 面板狀態已保存', panelState);\r\n    } catch(e) {\r\n        console.error('保存面板狀態失敗', e);\r\n    }\r\n}\r\n\r\n/**\r\n * 恢復面板狀態\r\n */\r\nfunction restorePanelState() {\r\n    try {\r\n        const controls = document.getElementById('custom-controls');\r\n        const toggle = document.getElementById('custom-controls-toggle');\r\n        if (!controls || !toggle) return;\r\n        \r\n        // 優先使用全局保存的狀態\r\n        let panelState = windowState.savedPanelState;\r\n        \r\n        // 如果全局狀態不可用，則嘗試從 localStorage 獲取\r\n        if (!panelState) {\r\n            const savedState = localStorage.getItem('rf_panel_state');\r\n            if (savedState) {\r\n                try {\r\n                    panelState = JSON.parse(savedState);\r\n                } catch(e) {\r\n                    console.error('解析面板狀態失敗', e);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // 如果有面板狀態\r\n        if (panelState) {\r\n            // 檢查時間戳是否有效（10秒內的保存）\r\n            if (Date.now() - panelState.timestamp > 10000) {\r\n                console.log('視窗管理器: 面板狀態已過期，使用默認位置');\r\n                // 使用默認位置或全局保存的位置\r\n                panelState.position = windowState.panelPosition || { x: 20, y: 20 };\r\n            }\r\n            \r\n            // 檢查位置是否有效\r\n            if (panelState.position && \r\n                panelState.position.x !== undefined && \r\n                panelState.position.y !== undefined) {\r\n                \r\n                // 確保位置在可見區域內\r\n                let x = panelState.position.x;\r\n                let y = panelState.position.y;\r\n                \r\n                // 限制位置在視窗範圍內\r\n                const maxX = window.innerWidth - 100; // 留一些空間以確保至少部分可見\r\n                const maxY = window.innerHeight - 100;\r\n                \r\n                if (x < 0) x = 0;\r\n                if (y < 0) y = 0;\r\n                if (x > maxX) x = maxX;\r\n                if (y > maxY) y = maxY;\r\n                \r\n                // 應用位置\r\n                controls.style.left = x + 'px';\r\n                controls.style.top = y + 'px';\r\n                toggle.style.left = x + 'px';\r\n                toggle.style.top = y + 'px';\r\n                \r\n                // 更新全局保存的面板位置\r\n                windowState.panelPosition = { x, y };\r\n                console.log('視窗管理器: 面板位置已更新', windowState.panelPosition);\r\n            }\r\n            \r\n            // 恢復開/關狀態\r\n            if (panelState.isOpen) {\r\n                controls.style.display = 'block';\r\n                toggle.style.display = 'none';\r\n            } else {\r\n                controls.style.display = 'none';\r\n                toggle.style.display = 'flex';\r\n            }\r\n            \r\n            console.log('視窗管理器: 面板狀態已恢復', panelState);\r\n        } else {\r\n            // 如果沒有有效的面板狀態，使用默認設置\r\n            const defaultPosition = { x: 20, y: 20 };\r\n            \r\n            controls.style.left = defaultPosition.x + 'px';\r\n            controls.style.top = defaultPosition.y + 'px';\r\n            toggle.style.left = defaultPosition.x + 'px';\r\n            toggle.style.top = defaultPosition.y + 'px';\r\n            \r\n            // 更新全局保存的面板位置\r\n            windowState.panelPosition = defaultPosition;\r\n            \r\n            console.log('視窗管理器: 使用默認面板位置', defaultPosition);\r\n        }\r\n    } catch(e) {\r\n        console.error('恢復面板狀態失敗', e);\r\n    }\r\n}\r\n\r\n/**\r\n * 監聽 F11 按鍵\r\n */\r\nfunction setupF11Listener() {\r\n    // 避免重複初始化\r\n    if (f11HandlerInitialized) {\r\n        console.log('視窗管理器: F11 監聽器已存在，不重複初始化');\r\n        return;\r\n    }\r\n    \r\n    // 添加事件監聽器，設置為最高捕獲優先級\r\n    window.addEventListener('keydown', function f11Handler(event) {\r\n        // 僅處理 F11 鍵\r\n        if (event.key === 'F11' || event.keyCode === 122) {\r\n            console.log('視窗管理器: 檢測到 F11 按鍵');\r\n            toggleFullscreen();\r\n            \r\n            // 防止事件冒泡和默認行為\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            event.stopImmediatePropagation();\r\n            return false;\r\n        }\r\n    }, true);  // 使用捕獲階段確保最先處理\r\n\r\n    // 標記為已初始化\r\n    f11HandlerInitialized = true;\r\n    console.log('視窗管理器: F11 監聽器已設置');\r\n}\r\n\r\n/**\r\n * 初始化視窗管理器\r\n */\r\nfunction initWindowManager() {\r\n    console.log('視窗管理器: 初始化');\r\n    \r\n    // 設置 F11 按鍵監聽\r\n    setupF11Listener();\r\n    \r\n    // 監聽全屏變更事件\r\n    document.addEventListener('fullscreenchange', handleFullscreenChange);\r\n    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);\r\n    document.addEventListener('mozfullscreenchange', handleFullscreenChange);\r\n    document.addEventListener('MSFullscreenChange', handleFullscreenChange);\r\n    \r\n    // 建立全局訪問點 - 確保這些方法可以被全局使用\r\n    window.rfToggleFullscreen = toggleFullscreen;\r\n    window.savePanelState = savePanelState;\r\n    window.restorePanelState = restorePanelState;\r\n    \r\n    // 設置標誌，表明窗口管理器已初始化\r\n    window._windowManagerInitialized = true;\r\n    \r\n    console.log('視窗管理器: 初始化完成');\r\n}\r\n\r\n/**\r\n * 處理全屏變更事件\r\n */\r\nfunction handleFullscreenChange() {\r\n    const isFullScreen = document.fullscreenElement || \r\n                       document.webkitFullscreenElement || \r\n                       document.mozFullScreenElement ||\r\n                       document.msFullscreenElement;\r\n                       \r\n    windowState.isFullScreen = !!isFullScreen;\r\n    console.log(`視窗管理器: 全屏狀態變更為 ${windowState.isFullScreen ? '全屏' : '窗口模式'}`);\r\n    \r\n    // 在狀態變更後恢復面板\r\n    setTimeout(restorePanelState, 200);\r\n}\r\n\r\n\n\n//# sourceURL=webpack://reversedfront-mod/./js/ui/windowManager.js?\n}")},"./node_modules/js-yaml/dist/js-yaml.mjs"(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   CORE_SCHEMA: () => (/* binding */ CORE_SCHEMA),\n/* harmony export */   DEFAULT_SCHEMA: () => (/* binding */ DEFAULT_SCHEMA),\n/* harmony export */   FAILSAFE_SCHEMA: () => (/* binding */ FAILSAFE_SCHEMA),\n/* harmony export */   JSON_SCHEMA: () => (/* binding */ JSON_SCHEMA),\n/* harmony export */   Schema: () => (/* binding */ Schema),\n/* harmony export */   Type: () => (/* binding */ Type),\n/* harmony export */   YAMLException: () => (/* binding */ YAMLException),\n/* harmony export */   \"default\": () => (/* binding */ jsYaml),\n/* harmony export */   dump: () => (/* binding */ dump),\n/* harmony export */   load: () => (/* binding */ load),\n/* harmony export */   loadAll: () => (/* binding */ loadAll),\n/* harmony export */   safeDump: () => (/* binding */ safeDump),\n/* harmony export */   safeLoad: () => (/* binding */ safeLoad),\n/* harmony export */   safeLoadAll: () => (/* binding */ safeLoadAll),\n/* harmony export */   types: () => (/* binding */ types)\n/* harmony export */ });\n\n/*! js-yaml 4.1.1 https://github.com/nodeca/js-yaml @license MIT */\nfunction isNothing(subject) {\n  return (typeof subject === 'undefined') || (subject === null);\n}\n\n\nfunction isObject(subject) {\n  return (typeof subject === 'object') && (subject !== null);\n}\n\n\nfunction toArray(sequence) {\n  if (Array.isArray(sequence)) return sequence;\n  else if (isNothing(sequence)) return [];\n\n  return [ sequence ];\n}\n\n\nfunction extend(target, source) {\n  var index, length, key, sourceKeys;\n\n  if (source) {\n    sourceKeys = Object.keys(source);\n\n    for (index = 0, length = sourceKeys.length; index < length; index += 1) {\n      key = sourceKeys[index];\n      target[key] = source[key];\n    }\n  }\n\n  return target;\n}\n\n\nfunction repeat(string, count) {\n  var result = '', cycle;\n\n  for (cycle = 0; cycle < count; cycle += 1) {\n    result += string;\n  }\n\n  return result;\n}\n\n\nfunction isNegativeZero(number) {\n  return (number === 0) && (Number.NEGATIVE_INFINITY === 1 / number);\n}\n\n\nvar isNothing_1      = isNothing;\nvar isObject_1       = isObject;\nvar toArray_1        = toArray;\nvar repeat_1         = repeat;\nvar isNegativeZero_1 = isNegativeZero;\nvar extend_1         = extend;\n\nvar common = {\n\tisNothing: isNothing_1,\n\tisObject: isObject_1,\n\ttoArray: toArray_1,\n\trepeat: repeat_1,\n\tisNegativeZero: isNegativeZero_1,\n\textend: extend_1\n};\n\n// YAML error class. http://stackoverflow.com/questions/8458984\n\n\nfunction formatError(exception, compact) {\n  var where = '', message = exception.reason || '(unknown reason)';\n\n  if (!exception.mark) return message;\n\n  if (exception.mark.name) {\n    where += 'in \"' + exception.mark.name + '\" ';\n  }\n\n  where += '(' + (exception.mark.line + 1) + ':' + (exception.mark.column + 1) + ')';\n\n  if (!compact && exception.mark.snippet) {\n    where += '\\n\\n' + exception.mark.snippet;\n  }\n\n  return message + ' ' + where;\n}\n\n\nfunction YAMLException$1(reason, mark) {\n  // Super constructor\n  Error.call(this);\n\n  this.name = 'YAMLException';\n  this.reason = reason;\n  this.mark = mark;\n  this.message = formatError(this, false);\n\n  // Include stack trace in error object\n  if (Error.captureStackTrace) {\n    // Chrome and NodeJS\n    Error.captureStackTrace(this, this.constructor);\n  } else {\n    // FF, IE 10+ and Safari 6+. Fallback for others\n    this.stack = (new Error()).stack || '';\n  }\n}\n\n\n// Inherit from Error\nYAMLException$1.prototype = Object.create(Error.prototype);\nYAMLException$1.prototype.constructor = YAMLException$1;\n\n\nYAMLException$1.prototype.toString = function toString(compact) {\n  return this.name + ': ' + formatError(this, compact);\n};\n\n\nvar exception = YAMLException$1;\n\n// get snippet for a single line, respecting maxLength\nfunction getLine(buffer, lineStart, lineEnd, position, maxLineLength) {\n  var head = '';\n  var tail = '';\n  var maxHalfLength = Math.floor(maxLineLength / 2) - 1;\n\n  if (position - lineStart > maxHalfLength) {\n    head = ' ... ';\n    lineStart = position - maxHalfLength + head.length;\n  }\n\n  if (lineEnd - position > maxHalfLength) {\n    tail = ' ...';\n    lineEnd = position + maxHalfLength - tail.length;\n  }\n\n  return {\n    str: head + buffer.slice(lineStart, lineEnd).replace(/\\t/g, '→') + tail,\n    pos: position - lineStart + head.length // relative position\n  };\n}\n\n\nfunction padStart(string, max) {\n  return common.repeat(' ', max - string.length) + string;\n}\n\n\nfunction makeSnippet(mark, options) {\n  options = Object.create(options || null);\n\n  if (!mark.buffer) return null;\n\n  if (!options.maxLength) options.maxLength = 79;\n  if (typeof options.indent      !== 'number') options.indent      = 1;\n  if (typeof options.linesBefore !== 'number') options.linesBefore = 3;\n  if (typeof options.linesAfter  !== 'number') options.linesAfter  = 2;\n\n  var re = /\\r?\\n|\\r|\\0/g;\n  var lineStarts = [ 0 ];\n  var lineEnds = [];\n  var match;\n  var foundLineNo = -1;\n\n  while ((match = re.exec(mark.buffer))) {\n    lineEnds.push(match.index);\n    lineStarts.push(match.index + match[0].length);\n\n    if (mark.position <= match.index && foundLineNo < 0) {\n      foundLineNo = lineStarts.length - 2;\n    }\n  }\n\n  if (foundLineNo < 0) foundLineNo = lineStarts.length - 1;\n\n  var result = '', i, line;\n  var lineNoLength = Math.min(mark.line + options.linesAfter, lineEnds.length).toString().length;\n  var maxLineLength = options.maxLength - (options.indent + lineNoLength + 3);\n\n  for (i = 1; i <= options.linesBefore; i++) {\n    if (foundLineNo - i < 0) break;\n    line = getLine(\n      mark.buffer,\n      lineStarts[foundLineNo - i],\n      lineEnds[foundLineNo - i],\n      mark.position - (lineStarts[foundLineNo] - lineStarts[foundLineNo - i]),\n      maxLineLength\n    );\n    result = common.repeat(' ', options.indent) + padStart((mark.line - i + 1).toString(), lineNoLength) +\n      ' | ' + line.str + '\\n' + result;\n  }\n\n  line = getLine(mark.buffer, lineStarts[foundLineNo], lineEnds[foundLineNo], mark.position, maxLineLength);\n  result += common.repeat(' ', options.indent) + padStart((mark.line + 1).toString(), lineNoLength) +\n    ' | ' + line.str + '\\n';\n  result += common.repeat('-', options.indent + lineNoLength + 3 + line.pos) + '^' + '\\n';\n\n  for (i = 1; i <= options.linesAfter; i++) {\n    if (foundLineNo + i >= lineEnds.length) break;\n    line = getLine(\n      mark.buffer,\n      lineStarts[foundLineNo + i],\n      lineEnds[foundLineNo + i],\n      mark.position - (lineStarts[foundLineNo] - lineStarts[foundLineNo + i]),\n      maxLineLength\n    );\n    result += common.repeat(' ', options.indent) + padStart((mark.line + i + 1).toString(), lineNoLength) +\n      ' | ' + line.str + '\\n';\n  }\n\n  return result.replace(/\\n$/, '');\n}\n\n\nvar snippet = makeSnippet;\n\nvar TYPE_CONSTRUCTOR_OPTIONS = [\n  'kind',\n  'multi',\n  'resolve',\n  'construct',\n  'instanceOf',\n  'predicate',\n  'represent',\n  'representName',\n  'defaultStyle',\n  'styleAliases'\n];\n\nvar YAML_NODE_KINDS = [\n  'scalar',\n  'sequence',\n  'mapping'\n];\n\nfunction compileStyleAliases(map) {\n  var result = {};\n\n  if (map !== null) {\n    Object.keys(map).forEach(function (style) {\n      map[style].forEach(function (alias) {\n        result[String(alias)] = style;\n      });\n    });\n  }\n\n  return result;\n}\n\nfunction Type$1(tag, options) {\n  options = options || {};\n\n  Object.keys(options).forEach(function (name) {\n    if (TYPE_CONSTRUCTOR_OPTIONS.indexOf(name) === -1) {\n      throw new exception('Unknown option \"' + name + '\" is met in definition of \"' + tag + '\" YAML type.');\n    }\n  });\n\n  // TODO: Add tag format check.\n  this.options       = options; // keep original options in case user wants to extend this type later\n  this.tag           = tag;\n  this.kind          = options['kind']          || null;\n  this.resolve       = options['resolve']       || function () { return true; };\n  this.construct     = options['construct']     || function (data) { return data; };\n  this.instanceOf    = options['instanceOf']    || null;\n  this.predicate     = options['predicate']     || null;\n  this.represent     = options['represent']     || null;\n  this.representName = options['representName'] || null;\n  this.defaultStyle  = options['defaultStyle']  || null;\n  this.multi         = options['multi']         || false;\n  this.styleAliases  = compileStyleAliases(options['styleAliases'] || null);\n\n  if (YAML_NODE_KINDS.indexOf(this.kind) === -1) {\n    throw new exception('Unknown kind \"' + this.kind + '\" is specified for \"' + tag + '\" YAML type.');\n  }\n}\n\nvar type = Type$1;\n\n/*eslint-disable max-len*/\n\n\n\n\n\nfunction compileList(schema, name) {\n  var result = [];\n\n  schema[name].forEach(function (currentType) {\n    var newIndex = result.length;\n\n    result.forEach(function (previousType, previousIndex) {\n      if (previousType.tag === currentType.tag &&\n          previousType.kind === currentType.kind &&\n          previousType.multi === currentType.multi) {\n\n        newIndex = previousIndex;\n      }\n    });\n\n    result[newIndex] = currentType;\n  });\n\n  return result;\n}\n\n\nfunction compileMap(/* lists... */) {\n  var result = {\n        scalar: {},\n        sequence: {},\n        mapping: {},\n        fallback: {},\n        multi: {\n          scalar: [],\n          sequence: [],\n          mapping: [],\n          fallback: []\n        }\n      }, index, length;\n\n  function collectType(type) {\n    if (type.multi) {\n      result.multi[type.kind].push(type);\n      result.multi['fallback'].push(type);\n    } else {\n      result[type.kind][type.tag] = result['fallback'][type.tag] = type;\n    }\n  }\n\n  for (index = 0, length = arguments.length; index < length; index += 1) {\n    arguments[index].forEach(collectType);\n  }\n  return result;\n}\n\n\nfunction Schema$1(definition) {\n  return this.extend(definition);\n}\n\n\nSchema$1.prototype.extend = function extend(definition) {\n  var implicit = [];\n  var explicit = [];\n\n  if (definition instanceof type) {\n    // Schema.extend(type)\n    explicit.push(definition);\n\n  } else if (Array.isArray(definition)) {\n    // Schema.extend([ type1, type2, ... ])\n    explicit = explicit.concat(definition);\n\n  } else if (definition && (Array.isArray(definition.implicit) || Array.isArray(definition.explicit))) {\n    // Schema.extend({ explicit: [ type1, type2, ... ], implicit: [ type1, type2, ... ] })\n    if (definition.implicit) implicit = implicit.concat(definition.implicit);\n    if (definition.explicit) explicit = explicit.concat(definition.explicit);\n\n  } else {\n    throw new exception('Schema.extend argument should be a Type, [ Type ], ' +\n      'or a schema definition ({ implicit: [...], explicit: [...] })');\n  }\n\n  implicit.forEach(function (type$1) {\n    if (!(type$1 instanceof type)) {\n      throw new exception('Specified list of YAML types (or a single Type object) contains a non-Type object.');\n    }\n\n    if (type$1.loadKind && type$1.loadKind !== 'scalar') {\n      throw new exception('There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.');\n    }\n\n    if (type$1.multi) {\n      throw new exception('There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.');\n    }\n  });\n\n  explicit.forEach(function (type$1) {\n    if (!(type$1 instanceof type)) {\n      throw new exception('Specified list of YAML types (or a single Type object) contains a non-Type object.');\n    }\n  });\n\n  var result = Object.create(Schema$1.prototype);\n\n  result.implicit = (this.implicit || []).concat(implicit);\n  result.explicit = (this.explicit || []).concat(explicit);\n\n  result.compiledImplicit = compileList(result, 'implicit');\n  result.compiledExplicit = compileList(result, 'explicit');\n  result.compiledTypeMap  = compileMap(result.compiledImplicit, result.compiledExplicit);\n\n  return result;\n};\n\n\nvar schema = Schema$1;\n\nvar str = new type('tag:yaml.org,2002:str', {\n  kind: 'scalar',\n  construct: function (data) { return data !== null ? data : ''; }\n});\n\nvar seq = new type('tag:yaml.org,2002:seq', {\n  kind: 'sequence',\n  construct: function (data) { return data !== null ? data : []; }\n});\n\nvar map = new type('tag:yaml.org,2002:map', {\n  kind: 'mapping',\n  construct: function (data) { return data !== null ? data : {}; }\n});\n\nvar failsafe = new schema({\n  explicit: [\n    str,\n    seq,\n    map\n  ]\n});\n\nfunction resolveYamlNull(data) {\n  if (data === null) return true;\n\n  var max = data.length;\n\n  return (max === 1 && data === '~') ||\n         (max === 4 && (data === 'null' || data === 'Null' || data === 'NULL'));\n}\n\nfunction constructYamlNull() {\n  return null;\n}\n\nfunction isNull(object) {\n  return object === null;\n}\n\nvar _null = new type('tag:yaml.org,2002:null', {\n  kind: 'scalar',\n  resolve: resolveYamlNull,\n  construct: constructYamlNull,\n  predicate: isNull,\n  represent: {\n    canonical: function () { return '~';    },\n    lowercase: function () { return 'null'; },\n    uppercase: function () { return 'NULL'; },\n    camelcase: function () { return 'Null'; },\n    empty:     function () { return '';     }\n  },\n  defaultStyle: 'lowercase'\n});\n\nfunction resolveYamlBoolean(data) {\n  if (data === null) return false;\n\n  var max = data.length;\n\n  return (max === 4 && (data === 'true' || data === 'True' || data === 'TRUE')) ||\n         (max === 5 && (data === 'false' || data === 'False' || data === 'FALSE'));\n}\n\nfunction constructYamlBoolean(data) {\n  return data === 'true' ||\n         data === 'True' ||\n         data === 'TRUE';\n}\n\nfunction isBoolean(object) {\n  return Object.prototype.toString.call(object) === '[object Boolean]';\n}\n\nvar bool = new type('tag:yaml.org,2002:bool', {\n  kind: 'scalar',\n  resolve: resolveYamlBoolean,\n  construct: constructYamlBoolean,\n  predicate: isBoolean,\n  represent: {\n    lowercase: function (object) { return object ? 'true' : 'false'; },\n    uppercase: function (object) { return object ? 'TRUE' : 'FALSE'; },\n    camelcase: function (object) { return object ? 'True' : 'False'; }\n  },\n  defaultStyle: 'lowercase'\n});\n\nfunction isHexCode(c) {\n  return ((0x30/* 0 */ <= c) && (c <= 0x39/* 9 */)) ||\n         ((0x41/* A */ <= c) && (c <= 0x46/* F */)) ||\n         ((0x61/* a */ <= c) && (c <= 0x66/* f */));\n}\n\nfunction isOctCode(c) {\n  return ((0x30/* 0 */ <= c) && (c <= 0x37/* 7 */));\n}\n\nfunction isDecCode(c) {\n  return ((0x30/* 0 */ <= c) && (c <= 0x39/* 9 */));\n}\n\nfunction resolveYamlInteger(data) {\n  if (data === null) return false;\n\n  var max = data.length,\n      index = 0,\n      hasDigits = false,\n      ch;\n\n  if (!max) return false;\n\n  ch = data[index];\n\n  // sign\n  if (ch === '-' || ch === '+') {\n    ch = data[++index];\n  }\n\n  if (ch === '0') {\n    // 0\n    if (index + 1 === max) return true;\n    ch = data[++index];\n\n    // base 2, base 8, base 16\n\n    if (ch === 'b') {\n      // base 2\n      index++;\n\n      for (; index < max; index++) {\n        ch = data[index];\n        if (ch === '_') continue;\n        if (ch !== '0' && ch !== '1') return false;\n        hasDigits = true;\n      }\n      return hasDigits && ch !== '_';\n    }\n\n\n    if (ch === 'x') {\n      // base 16\n      index++;\n\n      for (; index < max; index++) {\n        ch = data[index];\n        if (ch === '_') continue;\n        if (!isHexCode(data.charCodeAt(index))) return false;\n        hasDigits = true;\n      }\n      return hasDigits && ch !== '_';\n    }\n\n\n    if (ch === 'o') {\n      // base 8\n      index++;\n\n      for (; index < max; index++) {\n        ch = data[index];\n        if (ch === '_') continue;\n        if (!isOctCode(data.charCodeAt(index))) return false;\n        hasDigits = true;\n      }\n      return hasDigits && ch !== '_';\n    }\n  }\n\n  // base 10 (except 0)\n\n  // value should not start with `_`;\n  if (ch === '_') return false;\n\n  for (; index < max; index++) {\n    ch = data[index];\n    if (ch === '_') continue;\n    if (!isDecCode(data.charCodeAt(index))) {\n      return false;\n    }\n    hasDigits = true;\n  }\n\n  // Should have digits and should not end with `_`\n  if (!hasDigits || ch === '_') return false;\n\n  return true;\n}\n\nfunction constructYamlInteger(data) {\n  var value = data, sign = 1, ch;\n\n  if (value.indexOf('_') !== -1) {\n    value = value.replace(/_/g, '');\n  }\n\n  ch = value[0];\n\n  if (ch === '-' || ch === '+') {\n    if (ch === '-') sign = -1;\n    value = value.slice(1);\n    ch = value[0];\n  }\n\n  if (value === '0') return 0;\n\n  if (ch === '0') {\n    if (value[1] === 'b') return sign * parseInt(value.slice(2), 2);\n    if (value[1] === 'x') return sign * parseInt(value.slice(2), 16);\n    if (value[1] === 'o') return sign * parseInt(value.slice(2), 8);\n  }\n\n  return sign * parseInt(value, 10);\n}\n\nfunction isInteger(object) {\n  return (Object.prototype.toString.call(object)) === '[object Number]' &&\n         (object % 1 === 0 && !common.isNegativeZero(object));\n}\n\nvar int = new type('tag:yaml.org,2002:int', {\n  kind: 'scalar',\n  resolve: resolveYamlInteger,\n  construct: constructYamlInteger,\n  predicate: isInteger,\n  represent: {\n    binary:      function (obj) { return obj >= 0 ? '0b' + obj.toString(2) : '-0b' + obj.toString(2).slice(1); },\n    octal:       function (obj) { return obj >= 0 ? '0o'  + obj.toString(8) : '-0o'  + obj.toString(8).slice(1); },\n    decimal:     function (obj) { return obj.toString(10); },\n    /* eslint-disable max-len */\n    hexadecimal: function (obj) { return obj >= 0 ? '0x' + obj.toString(16).toUpperCase() :  '-0x' + obj.toString(16).toUpperCase().slice(1); }\n  },\n  defaultStyle: 'decimal',\n  styleAliases: {\n    binary:      [ 2,  'bin' ],\n    octal:       [ 8,  'oct' ],\n    decimal:     [ 10, 'dec' ],\n    hexadecimal: [ 16, 'hex' ]\n  }\n});\n\nvar YAML_FLOAT_PATTERN = new RegExp(\n  // 2.5e4, 2.5 and integers\n  '^(?:[-+]?(?:[0-9][0-9_]*)(?:\\\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?' +\n  // .2e4, .2\n  // special case, seems not from spec\n  '|\\\\.[0-9_]+(?:[eE][-+]?[0-9]+)?' +\n  // .inf\n  '|[-+]?\\\\.(?:inf|Inf|INF)' +\n  // .nan\n  '|\\\\.(?:nan|NaN|NAN))$');\n\nfunction resolveYamlFloat(data) {\n  if (data === null) return false;\n\n  if (!YAML_FLOAT_PATTERN.test(data) ||\n      // Quick hack to not allow integers end with `_`\n      // Probably should update regexp & check speed\n      data[data.length - 1] === '_') {\n    return false;\n  }\n\n  return true;\n}\n\nfunction constructYamlFloat(data) {\n  var value, sign;\n\n  value  = data.replace(/_/g, '').toLowerCase();\n  sign   = value[0] === '-' ? -1 : 1;\n\n  if ('+-'.indexOf(value[0]) >= 0) {\n    value = value.slice(1);\n  }\n\n  if (value === '.inf') {\n    return (sign === 1) ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\n\n  } else if (value === '.nan') {\n    return NaN;\n  }\n  return sign * parseFloat(value, 10);\n}\n\n\nvar SCIENTIFIC_WITHOUT_DOT = /^[-+]?[0-9]+e/;\n\nfunction representYamlFloat(object, style) {\n  var res;\n\n  if (isNaN(object)) {\n    switch (style) {\n      case 'lowercase': return '.nan';\n      case 'uppercase': return '.NAN';\n      case 'camelcase': return '.NaN';\n    }\n  } else if (Number.POSITIVE_INFINITY === object) {\n    switch (style) {\n      case 'lowercase': return '.inf';\n      case 'uppercase': return '.INF';\n      case 'camelcase': return '.Inf';\n    }\n  } else if (Number.NEGATIVE_INFINITY === object) {\n    switch (style) {\n      case 'lowercase': return '-.inf';\n      case 'uppercase': return '-.INF';\n      case 'camelcase': return '-.Inf';\n    }\n  } else if (common.isNegativeZero(object)) {\n    return '-0.0';\n  }\n\n  res = object.toString(10);\n\n  // JS stringifier can build scientific format without dots: 5e-100,\n  // while YAML requres dot: 5.e-100. Fix it with simple hack\n\n  return SCIENTIFIC_WITHOUT_DOT.test(res) ? res.replace('e', '.e') : res;\n}\n\nfunction isFloat(object) {\n  return (Object.prototype.toString.call(object) === '[object Number]') &&\n         (object % 1 !== 0 || common.isNegativeZero(object));\n}\n\nvar float = new type('tag:yaml.org,2002:float', {\n  kind: 'scalar',\n  resolve: resolveYamlFloat,\n  construct: constructYamlFloat,\n  predicate: isFloat,\n  represent: representYamlFloat,\n  defaultStyle: 'lowercase'\n});\n\nvar json = failsafe.extend({\n  implicit: [\n    _null,\n    bool,\n    int,\n    float\n  ]\n});\n\nvar core = json;\n\nvar YAML_DATE_REGEXP = new RegExp(\n  '^([0-9][0-9][0-9][0-9])'          + // [1] year\n  '-([0-9][0-9])'                    + // [2] month\n  '-([0-9][0-9])$');                   // [3] day\n\nvar YAML_TIMESTAMP_REGEXP = new RegExp(\n  '^([0-9][0-9][0-9][0-9])'          + // [1] year\n  '-([0-9][0-9]?)'                   + // [2] month\n  '-([0-9][0-9]?)'                   + // [3] day\n  '(?:[Tt]|[ \\\\t]+)'                 + // ...\n  '([0-9][0-9]?)'                    + // [4] hour\n  ':([0-9][0-9])'                    + // [5] minute\n  ':([0-9][0-9])'                    + // [6] second\n  '(?:\\\\.([0-9]*))?'                 + // [7] fraction\n  '(?:[ \\\\t]*(Z|([-+])([0-9][0-9]?)' + // [8] tz [9] tz_sign [10] tz_hour\n  '(?::([0-9][0-9]))?))?$');           // [11] tz_minute\n\nfunction resolveYamlTimestamp(data) {\n  if (data === null) return false;\n  if (YAML_DATE_REGEXP.exec(data) !== null) return true;\n  if (YAML_TIMESTAMP_REGEXP.exec(data) !== null) return true;\n  return false;\n}\n\nfunction constructYamlTimestamp(data) {\n  var match, year, month, day, hour, minute, second, fraction = 0,\n      delta = null, tz_hour, tz_minute, date;\n\n  match = YAML_DATE_REGEXP.exec(data);\n  if (match === null) match = YAML_TIMESTAMP_REGEXP.exec(data);\n\n  if (match === null) throw new Error('Date resolve error');\n\n  // match: [1] year [2] month [3] day\n\n  year = +(match[1]);\n  month = +(match[2]) - 1; // JS month starts with 0\n  day = +(match[3]);\n\n  if (!match[4]) { // no hour\n    return new Date(Date.UTC(year, month, day));\n  }\n\n  // match: [4] hour [5] minute [6] second [7] fraction\n\n  hour = +(match[4]);\n  minute = +(match[5]);\n  second = +(match[6]);\n\n  if (match[7]) {\n    fraction = match[7].slice(0, 3);\n    while (fraction.length < 3) { // milli-seconds\n      fraction += '0';\n    }\n    fraction = +fraction;\n  }\n\n  // match: [8] tz [9] tz_sign [10] tz_hour [11] tz_minute\n\n  if (match[9]) {\n    tz_hour = +(match[10]);\n    tz_minute = +(match[11] || 0);\n    delta = (tz_hour * 60 + tz_minute) * 60000; // delta in mili-seconds\n    if (match[9] === '-') delta = -delta;\n  }\n\n  date = new Date(Date.UTC(year, month, day, hour, minute, second, fraction));\n\n  if (delta) date.setTime(date.getTime() - delta);\n\n  return date;\n}\n\nfunction representYamlTimestamp(object /*, style*/) {\n  return object.toISOString();\n}\n\nvar timestamp = new type('tag:yaml.org,2002:timestamp', {\n  kind: 'scalar',\n  resolve: resolveYamlTimestamp,\n  construct: constructYamlTimestamp,\n  instanceOf: Date,\n  represent: representYamlTimestamp\n});\n\nfunction resolveYamlMerge(data) {\n  return data === '<<' || data === null;\n}\n\nvar merge = new type('tag:yaml.org,2002:merge', {\n  kind: 'scalar',\n  resolve: resolveYamlMerge\n});\n\n/*eslint-disable no-bitwise*/\n\n\n\n\n\n// [ 64, 65, 66 ] -> [ padding, CR, LF ]\nvar BASE64_MAP = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\\n\\r';\n\n\nfunction resolveYamlBinary(data) {\n  if (data === null) return false;\n\n  var code, idx, bitlen = 0, max = data.length, map = BASE64_MAP;\n\n  // Convert one by one.\n  for (idx = 0; idx < max; idx++) {\n    code = map.indexOf(data.charAt(idx));\n\n    // Skip CR/LF\n    if (code > 64) continue;\n\n    // Fail on illegal characters\n    if (code < 0) return false;\n\n    bitlen += 6;\n  }\n\n  // If there are any bits left, source was corrupted\n  return (bitlen % 8) === 0;\n}\n\nfunction constructYamlBinary(data) {\n  var idx, tailbits,\n      input = data.replace(/[\\r\\n=]/g, ''), // remove CR/LF & padding to simplify scan\n      max = input.length,\n      map = BASE64_MAP,\n      bits = 0,\n      result = [];\n\n  // Collect by 6*4 bits (3 bytes)\n\n  for (idx = 0; idx < max; idx++) {\n    if ((idx % 4 === 0) && idx) {\n      result.push((bits >> 16) & 0xFF);\n      result.push((bits >> 8) & 0xFF);\n      result.push(bits & 0xFF);\n    }\n\n    bits = (bits << 6) | map.indexOf(input.charAt(idx));\n  }\n\n  // Dump tail\n\n  tailbits = (max % 4) * 6;\n\n  if (tailbits === 0) {\n    result.push((bits >> 16) & 0xFF);\n    result.push((bits >> 8) & 0xFF);\n    result.push(bits & 0xFF);\n  } else if (tailbits === 18) {\n    result.push((bits >> 10) & 0xFF);\n    result.push((bits >> 2) & 0xFF);\n  } else if (tailbits === 12) {\n    result.push((bits >> 4) & 0xFF);\n  }\n\n  return new Uint8Array(result);\n}\n\nfunction representYamlBinary(object /*, style*/) {\n  var result = '', bits = 0, idx, tail,\n      max = object.length,\n      map = BASE64_MAP;\n\n  // Convert every three bytes to 4 ASCII characters.\n\n  for (idx = 0; idx < max; idx++) {\n    if ((idx % 3 === 0) && idx) {\n      result += map[(bits >> 18) & 0x3F];\n      result += map[(bits >> 12) & 0x3F];\n      result += map[(bits >> 6) & 0x3F];\n      result += map[bits & 0x3F];\n    }\n\n    bits = (bits << 8) + object[idx];\n  }\n\n  // Dump tail\n\n  tail = max % 3;\n\n  if (tail === 0) {\n    result += map[(bits >> 18) & 0x3F];\n    result += map[(bits >> 12) & 0x3F];\n    result += map[(bits >> 6) & 0x3F];\n    result += map[bits & 0x3F];\n  } else if (tail === 2) {\n    result += map[(bits >> 10) & 0x3F];\n    result += map[(bits >> 4) & 0x3F];\n    result += map[(bits << 2) & 0x3F];\n    result += map[64];\n  } else if (tail === 1) {\n    result += map[(bits >> 2) & 0x3F];\n    result += map[(bits << 4) & 0x3F];\n    result += map[64];\n    result += map[64];\n  }\n\n  return result;\n}\n\nfunction isBinary(obj) {\n  return Object.prototype.toString.call(obj) ===  '[object Uint8Array]';\n}\n\nvar binary = new type('tag:yaml.org,2002:binary', {\n  kind: 'scalar',\n  resolve: resolveYamlBinary,\n  construct: constructYamlBinary,\n  predicate: isBinary,\n  represent: representYamlBinary\n});\n\nvar _hasOwnProperty$3 = Object.prototype.hasOwnProperty;\nvar _toString$2       = Object.prototype.toString;\n\nfunction resolveYamlOmap(data) {\n  if (data === null) return true;\n\n  var objectKeys = [], index, length, pair, pairKey, pairHasKey,\n      object = data;\n\n  for (index = 0, length = object.length; index < length; index += 1) {\n    pair = object[index];\n    pairHasKey = false;\n\n    if (_toString$2.call(pair) !== '[object Object]') return false;\n\n    for (pairKey in pair) {\n      if (_hasOwnProperty$3.call(pair, pairKey)) {\n        if (!pairHasKey) pairHasKey = true;\n        else return false;\n      }\n    }\n\n    if (!pairHasKey) return false;\n\n    if (objectKeys.indexOf(pairKey) === -1) objectKeys.push(pairKey);\n    else return false;\n  }\n\n  return true;\n}\n\nfunction constructYamlOmap(data) {\n  return data !== null ? data : [];\n}\n\nvar omap = new type('tag:yaml.org,2002:omap', {\n  kind: 'sequence',\n  resolve: resolveYamlOmap,\n  construct: constructYamlOmap\n});\n\nvar _toString$1 = Object.prototype.toString;\n\nfunction resolveYamlPairs(data) {\n  if (data === null) return true;\n\n  var index, length, pair, keys, result,\n      object = data;\n\n  result = new Array(object.length);\n\n  for (index = 0, length = object.length; index < length; index += 1) {\n    pair = object[index];\n\n    if (_toString$1.call(pair) !== '[object Object]') return false;\n\n    keys = Object.keys(pair);\n\n    if (keys.length !== 1) return false;\n\n    result[index] = [ keys[0], pair[keys[0]] ];\n  }\n\n  return true;\n}\n\nfunction constructYamlPairs(data) {\n  if (data === null) return [];\n\n  var index, length, pair, keys, result,\n      object = data;\n\n  result = new Array(object.length);\n\n  for (index = 0, length = object.length; index < length; index += 1) {\n    pair = object[index];\n\n    keys = Object.keys(pair);\n\n    result[index] = [ keys[0], pair[keys[0]] ];\n  }\n\n  return result;\n}\n\nvar pairs = new type('tag:yaml.org,2002:pairs', {\n  kind: 'sequence',\n  resolve: resolveYamlPairs,\n  construct: constructYamlPairs\n});\n\nvar _hasOwnProperty$2 = Object.prototype.hasOwnProperty;\n\nfunction resolveYamlSet(data) {\n  if (data === null) return true;\n\n  var key, object = data;\n\n  for (key in object) {\n    if (_hasOwnProperty$2.call(object, key)) {\n      if (object[key] !== null) return false;\n    }\n  }\n\n  return true;\n}\n\nfunction constructYamlSet(data) {\n  return data !== null ? data : {};\n}\n\nvar set = new type('tag:yaml.org,2002:set', {\n  kind: 'mapping',\n  resolve: resolveYamlSet,\n  construct: constructYamlSet\n});\n\nvar _default = core.extend({\n  implicit: [\n    timestamp,\n    merge\n  ],\n  explicit: [\n    binary,\n    omap,\n    pairs,\n    set\n  ]\n});\n\n/*eslint-disable max-len,no-use-before-define*/\n\n\n\n\n\n\n\nvar _hasOwnProperty$1 = Object.prototype.hasOwnProperty;\n\n\nvar CONTEXT_FLOW_IN   = 1;\nvar CONTEXT_FLOW_OUT  = 2;\nvar CONTEXT_BLOCK_IN  = 3;\nvar CONTEXT_BLOCK_OUT = 4;\n\n\nvar CHOMPING_CLIP  = 1;\nvar CHOMPING_STRIP = 2;\nvar CHOMPING_KEEP  = 3;\n\n\nvar PATTERN_NON_PRINTABLE         = /[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F-\\x84\\x86-\\x9F\\uFFFE\\uFFFF]|[\\uD800-\\uDBFF](?![\\uDC00-\\uDFFF])|(?:[^\\uD800-\\uDBFF]|^)[\\uDC00-\\uDFFF]/;\nvar PATTERN_NON_ASCII_LINE_BREAKS = /[\\x85\\u2028\\u2029]/;\nvar PATTERN_FLOW_INDICATORS       = /[,\\[\\]\\{\\}]/;\nvar PATTERN_TAG_HANDLE            = /^(?:!|!!|![a-z\\-]+!)$/i;\nvar PATTERN_TAG_URI               = /^(?:!|[^,\\[\\]\\{\\}])(?:%[0-9a-f]{2}|[0-9a-z\\-#;\\/\\?:@&=\\+\\$,_\\.!~\\*'\\(\\)\\[\\]])*$/i;\n\n\nfunction _class(obj) { return Object.prototype.toString.call(obj); }\n\nfunction is_EOL(c) {\n  return (c === 0x0A/* LF */) || (c === 0x0D/* CR */);\n}\n\nfunction is_WHITE_SPACE(c) {\n  return (c === 0x09/* Tab */) || (c === 0x20/* Space */);\n}\n\nfunction is_WS_OR_EOL(c) {\n  return (c === 0x09/* Tab */) ||\n         (c === 0x20/* Space */) ||\n         (c === 0x0A/* LF */) ||\n         (c === 0x0D/* CR */);\n}\n\nfunction is_FLOW_INDICATOR(c) {\n  return c === 0x2C/* , */ ||\n         c === 0x5B/* [ */ ||\n         c === 0x5D/* ] */ ||\n         c === 0x7B/* { */ ||\n         c === 0x7D/* } */;\n}\n\nfunction fromHexCode(c) {\n  var lc;\n\n  if ((0x30/* 0 */ <= c) && (c <= 0x39/* 9 */)) {\n    return c - 0x30;\n  }\n\n  /*eslint-disable no-bitwise*/\n  lc = c | 0x20;\n\n  if ((0x61/* a */ <= lc) && (lc <= 0x66/* f */)) {\n    return lc - 0x61 + 10;\n  }\n\n  return -1;\n}\n\nfunction escapedHexLen(c) {\n  if (c === 0x78/* x */) { return 2; }\n  if (c === 0x75/* u */) { return 4; }\n  if (c === 0x55/* U */) { return 8; }\n  return 0;\n}\n\nfunction fromDecimalCode(c) {\n  if ((0x30/* 0 */ <= c) && (c <= 0x39/* 9 */)) {\n    return c - 0x30;\n  }\n\n  return -1;\n}\n\nfunction simpleEscapeSequence(c) {\n  /* eslint-disable indent */\n  return (c === 0x30/* 0 */) ? '\\x00' :\n        (c === 0x61/* a */) ? '\\x07' :\n        (c === 0x62/* b */) ? '\\x08' :\n        (c === 0x74/* t */) ? '\\x09' :\n        (c === 0x09/* Tab */) ? '\\x09' :\n        (c === 0x6E/* n */) ? '\\x0A' :\n        (c === 0x76/* v */) ? '\\x0B' :\n        (c === 0x66/* f */) ? '\\x0C' :\n        (c === 0x72/* r */) ? '\\x0D' :\n        (c === 0x65/* e */) ? '\\x1B' :\n        (c === 0x20/* Space */) ? ' ' :\n        (c === 0x22/* \" */) ? '\\x22' :\n        (c === 0x2F/* / */) ? '/' :\n        (c === 0x5C/* \\ */) ? '\\x5C' :\n        (c === 0x4E/* N */) ? '\\x85' :\n        (c === 0x5F/* _ */) ? '\\xA0' :\n        (c === 0x4C/* L */) ? '\\u2028' :\n        (c === 0x50/* P */) ? '\\u2029' : '';\n}\n\nfunction charFromCodepoint(c) {\n  if (c <= 0xFFFF) {\n    return String.fromCharCode(c);\n  }\n  // Encode UTF-16 surrogate pair\n  // https://en.wikipedia.org/wiki/UTF-16#Code_points_U.2B010000_to_U.2B10FFFF\n  return String.fromCharCode(\n    ((c - 0x010000) >> 10) + 0xD800,\n    ((c - 0x010000) & 0x03FF) + 0xDC00\n  );\n}\n\n// set a property of a literal object, while protecting against prototype pollution,\n// see https://github.com/nodeca/js-yaml/issues/164 for more details\nfunction setProperty(object, key, value) {\n  // used for this specific key only because Object.defineProperty is slow\n  if (key === '__proto__') {\n    Object.defineProperty(object, key, {\n      configurable: true,\n      enumerable: true,\n      writable: true,\n      value: value\n    });\n  } else {\n    object[key] = value;\n  }\n}\n\nvar simpleEscapeCheck = new Array(256); // integer, for fast access\nvar simpleEscapeMap = new Array(256);\nfor (var i = 0; i < 256; i++) {\n  simpleEscapeCheck[i] = simpleEscapeSequence(i) ? 1 : 0;\n  simpleEscapeMap[i] = simpleEscapeSequence(i);\n}\n\n\nfunction State$1(input, options) {\n  this.input = input;\n\n  this.filename  = options['filename']  || null;\n  this.schema    = options['schema']    || _default;\n  this.onWarning = options['onWarning'] || null;\n  // (Hidden) Remove? makes the loader to expect YAML 1.1 documents\n  // if such documents have no explicit %YAML directive\n  this.legacy    = options['legacy']    || false;\n\n  this.json      = options['json']      || false;\n  this.listener  = options['listener']  || null;\n\n  this.implicitTypes = this.schema.compiledImplicit;\n  this.typeMap       = this.schema.compiledTypeMap;\n\n  this.length     = input.length;\n  this.position   = 0;\n  this.line       = 0;\n  this.lineStart  = 0;\n  this.lineIndent = 0;\n\n  // position of first leading tab in the current line,\n  // used to make sure there are no tabs in the indentation\n  this.firstTabInLine = -1;\n\n  this.documents = [];\n\n  /*\n  this.version;\n  this.checkLineBreaks;\n  this.tagMap;\n  this.anchorMap;\n  this.tag;\n  this.anchor;\n  this.kind;\n  this.result;*/\n\n}\n\n\nfunction generateError(state, message) {\n  var mark = {\n    name:     state.filename,\n    buffer:   state.input.slice(0, -1), // omit trailing \\0\n    position: state.position,\n    line:     state.line,\n    column:   state.position - state.lineStart\n  };\n\n  mark.snippet = snippet(mark);\n\n  return new exception(message, mark);\n}\n\nfunction throwError(state, message) {\n  throw generateError(state, message);\n}\n\nfunction throwWarning(state, message) {\n  if (state.onWarning) {\n    state.onWarning.call(null, generateError(state, message));\n  }\n}\n\n\nvar directiveHandlers = {\n\n  YAML: function handleYamlDirective(state, name, args) {\n\n    var match, major, minor;\n\n    if (state.version !== null) {\n      throwError(state, 'duplication of %YAML directive');\n    }\n\n    if (args.length !== 1) {\n      throwError(state, 'YAML directive accepts exactly one argument');\n    }\n\n    match = /^([0-9]+)\\.([0-9]+)$/.exec(args[0]);\n\n    if (match === null) {\n      throwError(state, 'ill-formed argument of the YAML directive');\n    }\n\n    major = parseInt(match[1], 10);\n    minor = parseInt(match[2], 10);\n\n    if (major !== 1) {\n      throwError(state, 'unacceptable YAML version of the document');\n    }\n\n    state.version = args[0];\n    state.checkLineBreaks = (minor < 2);\n\n    if (minor !== 1 && minor !== 2) {\n      throwWarning(state, 'unsupported YAML version of the document');\n    }\n  },\n\n  TAG: function handleTagDirective(state, name, args) {\n\n    var handle, prefix;\n\n    if (args.length !== 2) {\n      throwError(state, 'TAG directive accepts exactly two arguments');\n    }\n\n    handle = args[0];\n    prefix = args[1];\n\n    if (!PATTERN_TAG_HANDLE.test(handle)) {\n      throwError(state, 'ill-formed tag handle (first argument) of the TAG directive');\n    }\n\n    if (_hasOwnProperty$1.call(state.tagMap, handle)) {\n      throwError(state, 'there is a previously declared suffix for \"' + handle + '\" tag handle');\n    }\n\n    if (!PATTERN_TAG_URI.test(prefix)) {\n      throwError(state, 'ill-formed tag prefix (second argument) of the TAG directive');\n    }\n\n    try {\n      prefix = decodeURIComponent(prefix);\n    } catch (err) {\n      throwError(state, 'tag prefix is malformed: ' + prefix);\n    }\n\n    state.tagMap[handle] = prefix;\n  }\n};\n\n\nfunction captureSegment(state, start, end, checkJson) {\n  var _position, _length, _character, _result;\n\n  if (start < end) {\n    _result = state.input.slice(start, end);\n\n    if (checkJson) {\n      for (_position = 0, _length = _result.length; _position < _length; _position += 1) {\n        _character = _result.charCodeAt(_position);\n        if (!(_character === 0x09 ||\n              (0x20 <= _character && _character <= 0x10FFFF))) {\n          throwError(state, 'expected valid JSON character');\n        }\n      }\n    } else if (PATTERN_NON_PRINTABLE.test(_result)) {\n      throwError(state, 'the stream contains non-printable characters');\n    }\n\n    state.result += _result;\n  }\n}\n\nfunction mergeMappings(state, destination, source, overridableKeys) {\n  var sourceKeys, key, index, quantity;\n\n  if (!common.isObject(source)) {\n    throwError(state, 'cannot merge mappings; the provided source object is unacceptable');\n  }\n\n  sourceKeys = Object.keys(source);\n\n  for (index = 0, quantity = sourceKeys.length; index < quantity; index += 1) {\n    key = sourceKeys[index];\n\n    if (!_hasOwnProperty$1.call(destination, key)) {\n      setProperty(destination, key, source[key]);\n      overridableKeys[key] = true;\n    }\n  }\n}\n\nfunction storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, valueNode,\n  startLine, startLineStart, startPos) {\n\n  var index, quantity;\n\n  // The output is a plain object here, so keys can only be strings.\n  // We need to convert keyNode to a string, but doing so can hang the process\n  // (deeply nested arrays that explode exponentially using aliases).\n  if (Array.isArray(keyNode)) {\n    keyNode = Array.prototype.slice.call(keyNode);\n\n    for (index = 0, quantity = keyNode.length; index < quantity; index += 1) {\n      if (Array.isArray(keyNode[index])) {\n        throwError(state, 'nested arrays are not supported inside keys');\n      }\n\n      if (typeof keyNode === 'object' && _class(keyNode[index]) === '[object Object]') {\n        keyNode[index] = '[object Object]';\n      }\n    }\n  }\n\n  // Avoid code execution in load() via toString property\n  // (still use its own toString for arrays, timestamps,\n  // and whatever user schema extensions happen to have @@toStringTag)\n  if (typeof keyNode === 'object' && _class(keyNode) === '[object Object]') {\n    keyNode = '[object Object]';\n  }\n\n\n  keyNode = String(keyNode);\n\n  if (_result === null) {\n    _result = {};\n  }\n\n  if (keyTag === 'tag:yaml.org,2002:merge') {\n    if (Array.isArray(valueNode)) {\n      for (index = 0, quantity = valueNode.length; index < quantity; index += 1) {\n        mergeMappings(state, _result, valueNode[index], overridableKeys);\n      }\n    } else {\n      mergeMappings(state, _result, valueNode, overridableKeys);\n    }\n  } else {\n    if (!state.json &&\n        !_hasOwnProperty$1.call(overridableKeys, keyNode) &&\n        _hasOwnProperty$1.call(_result, keyNode)) {\n      state.line = startLine || state.line;\n      state.lineStart = startLineStart || state.lineStart;\n      state.position = startPos || state.position;\n      throwError(state, 'duplicated mapping key');\n    }\n\n    setProperty(_result, keyNode, valueNode);\n    delete overridableKeys[keyNode];\n  }\n\n  return _result;\n}\n\nfunction readLineBreak(state) {\n  var ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch === 0x0A/* LF */) {\n    state.position++;\n  } else if (ch === 0x0D/* CR */) {\n    state.position++;\n    if (state.input.charCodeAt(state.position) === 0x0A/* LF */) {\n      state.position++;\n    }\n  } else {\n    throwError(state, 'a line break is expected');\n  }\n\n  state.line += 1;\n  state.lineStart = state.position;\n  state.firstTabInLine = -1;\n}\n\nfunction skipSeparationSpace(state, allowComments, checkIndent) {\n  var lineBreaks = 0,\n      ch = state.input.charCodeAt(state.position);\n\n  while (ch !== 0) {\n    while (is_WHITE_SPACE(ch)) {\n      if (ch === 0x09/* Tab */ && state.firstTabInLine === -1) {\n        state.firstTabInLine = state.position;\n      }\n      ch = state.input.charCodeAt(++state.position);\n    }\n\n    if (allowComments && ch === 0x23/* # */) {\n      do {\n        ch = state.input.charCodeAt(++state.position);\n      } while (ch !== 0x0A/* LF */ && ch !== 0x0D/* CR */ && ch !== 0);\n    }\n\n    if (is_EOL(ch)) {\n      readLineBreak(state);\n\n      ch = state.input.charCodeAt(state.position);\n      lineBreaks++;\n      state.lineIndent = 0;\n\n      while (ch === 0x20/* Space */) {\n        state.lineIndent++;\n        ch = state.input.charCodeAt(++state.position);\n      }\n    } else {\n      break;\n    }\n  }\n\n  if (checkIndent !== -1 && lineBreaks !== 0 && state.lineIndent < checkIndent) {\n    throwWarning(state, 'deficient indentation');\n  }\n\n  return lineBreaks;\n}\n\nfunction testDocumentSeparator(state) {\n  var _position = state.position,\n      ch;\n\n  ch = state.input.charCodeAt(_position);\n\n  // Condition state.position === state.lineStart is tested\n  // in parent on each call, for efficiency. No needs to test here again.\n  if ((ch === 0x2D/* - */ || ch === 0x2E/* . */) &&\n      ch === state.input.charCodeAt(_position + 1) &&\n      ch === state.input.charCodeAt(_position + 2)) {\n\n    _position += 3;\n\n    ch = state.input.charCodeAt(_position);\n\n    if (ch === 0 || is_WS_OR_EOL(ch)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction writeFoldedLines(state, count) {\n  if (count === 1) {\n    state.result += ' ';\n  } else if (count > 1) {\n    state.result += common.repeat('\\n', count - 1);\n  }\n}\n\n\nfunction readPlainScalar(state, nodeIndent, withinFlowCollection) {\n  var preceding,\n      following,\n      captureStart,\n      captureEnd,\n      hasPendingContent,\n      _line,\n      _lineStart,\n      _lineIndent,\n      _kind = state.kind,\n      _result = state.result,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (is_WS_OR_EOL(ch)      ||\n      is_FLOW_INDICATOR(ch) ||\n      ch === 0x23/* # */    ||\n      ch === 0x26/* & */    ||\n      ch === 0x2A/* * */    ||\n      ch === 0x21/* ! */    ||\n      ch === 0x7C/* | */    ||\n      ch === 0x3E/* > */    ||\n      ch === 0x27/* ' */    ||\n      ch === 0x22/* \" */    ||\n      ch === 0x25/* % */    ||\n      ch === 0x40/* @ */    ||\n      ch === 0x60/* ` */) {\n    return false;\n  }\n\n  if (ch === 0x3F/* ? */ || ch === 0x2D/* - */) {\n    following = state.input.charCodeAt(state.position + 1);\n\n    if (is_WS_OR_EOL(following) ||\n        withinFlowCollection && is_FLOW_INDICATOR(following)) {\n      return false;\n    }\n  }\n\n  state.kind = 'scalar';\n  state.result = '';\n  captureStart = captureEnd = state.position;\n  hasPendingContent = false;\n\n  while (ch !== 0) {\n    if (ch === 0x3A/* : */) {\n      following = state.input.charCodeAt(state.position + 1);\n\n      if (is_WS_OR_EOL(following) ||\n          withinFlowCollection && is_FLOW_INDICATOR(following)) {\n        break;\n      }\n\n    } else if (ch === 0x23/* # */) {\n      preceding = state.input.charCodeAt(state.position - 1);\n\n      if (is_WS_OR_EOL(preceding)) {\n        break;\n      }\n\n    } else if ((state.position === state.lineStart && testDocumentSeparator(state)) ||\n               withinFlowCollection && is_FLOW_INDICATOR(ch)) {\n      break;\n\n    } else if (is_EOL(ch)) {\n      _line = state.line;\n      _lineStart = state.lineStart;\n      _lineIndent = state.lineIndent;\n      skipSeparationSpace(state, false, -1);\n\n      if (state.lineIndent >= nodeIndent) {\n        hasPendingContent = true;\n        ch = state.input.charCodeAt(state.position);\n        continue;\n      } else {\n        state.position = captureEnd;\n        state.line = _line;\n        state.lineStart = _lineStart;\n        state.lineIndent = _lineIndent;\n        break;\n      }\n    }\n\n    if (hasPendingContent) {\n      captureSegment(state, captureStart, captureEnd, false);\n      writeFoldedLines(state, state.line - _line);\n      captureStart = captureEnd = state.position;\n      hasPendingContent = false;\n    }\n\n    if (!is_WHITE_SPACE(ch)) {\n      captureEnd = state.position + 1;\n    }\n\n    ch = state.input.charCodeAt(++state.position);\n  }\n\n  captureSegment(state, captureStart, captureEnd, false);\n\n  if (state.result) {\n    return true;\n  }\n\n  state.kind = _kind;\n  state.result = _result;\n  return false;\n}\n\nfunction readSingleQuotedScalar(state, nodeIndent) {\n  var ch,\n      captureStart, captureEnd;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch !== 0x27/* ' */) {\n    return false;\n  }\n\n  state.kind = 'scalar';\n  state.result = '';\n  state.position++;\n  captureStart = captureEnd = state.position;\n\n  while ((ch = state.input.charCodeAt(state.position)) !== 0) {\n    if (ch === 0x27/* ' */) {\n      captureSegment(state, captureStart, state.position, true);\n      ch = state.input.charCodeAt(++state.position);\n\n      if (ch === 0x27/* ' */) {\n        captureStart = state.position;\n        state.position++;\n        captureEnd = state.position;\n      } else {\n        return true;\n      }\n\n    } else if (is_EOL(ch)) {\n      captureSegment(state, captureStart, captureEnd, true);\n      writeFoldedLines(state, skipSeparationSpace(state, false, nodeIndent));\n      captureStart = captureEnd = state.position;\n\n    } else if (state.position === state.lineStart && testDocumentSeparator(state)) {\n      throwError(state, 'unexpected end of the document within a single quoted scalar');\n\n    } else {\n      state.position++;\n      captureEnd = state.position;\n    }\n  }\n\n  throwError(state, 'unexpected end of the stream within a single quoted scalar');\n}\n\nfunction readDoubleQuotedScalar(state, nodeIndent) {\n  var captureStart,\n      captureEnd,\n      hexLength,\n      hexResult,\n      tmp,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch !== 0x22/* \" */) {\n    return false;\n  }\n\n  state.kind = 'scalar';\n  state.result = '';\n  state.position++;\n  captureStart = captureEnd = state.position;\n\n  while ((ch = state.input.charCodeAt(state.position)) !== 0) {\n    if (ch === 0x22/* \" */) {\n      captureSegment(state, captureStart, state.position, true);\n      state.position++;\n      return true;\n\n    } else if (ch === 0x5C/* \\ */) {\n      captureSegment(state, captureStart, state.position, true);\n      ch = state.input.charCodeAt(++state.position);\n\n      if (is_EOL(ch)) {\n        skipSeparationSpace(state, false, nodeIndent);\n\n        // TODO: rework to inline fn with no type cast?\n      } else if (ch < 256 && simpleEscapeCheck[ch]) {\n        state.result += simpleEscapeMap[ch];\n        state.position++;\n\n      } else if ((tmp = escapedHexLen(ch)) > 0) {\n        hexLength = tmp;\n        hexResult = 0;\n\n        for (; hexLength > 0; hexLength--) {\n          ch = state.input.charCodeAt(++state.position);\n\n          if ((tmp = fromHexCode(ch)) >= 0) {\n            hexResult = (hexResult << 4) + tmp;\n\n          } else {\n            throwError(state, 'expected hexadecimal character');\n          }\n        }\n\n        state.result += charFromCodepoint(hexResult);\n\n        state.position++;\n\n      } else {\n        throwError(state, 'unknown escape sequence');\n      }\n\n      captureStart = captureEnd = state.position;\n\n    } else if (is_EOL(ch)) {\n      captureSegment(state, captureStart, captureEnd, true);\n      writeFoldedLines(state, skipSeparationSpace(state, false, nodeIndent));\n      captureStart = captureEnd = state.position;\n\n    } else if (state.position === state.lineStart && testDocumentSeparator(state)) {\n      throwError(state, 'unexpected end of the document within a double quoted scalar');\n\n    } else {\n      state.position++;\n      captureEnd = state.position;\n    }\n  }\n\n  throwError(state, 'unexpected end of the stream within a double quoted scalar');\n}\n\nfunction readFlowCollection(state, nodeIndent) {\n  var readNext = true,\n      _line,\n      _lineStart,\n      _pos,\n      _tag     = state.tag,\n      _result,\n      _anchor  = state.anchor,\n      following,\n      terminator,\n      isPair,\n      isExplicitPair,\n      isMapping,\n      overridableKeys = Object.create(null),\n      keyNode,\n      keyTag,\n      valueNode,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch === 0x5B/* [ */) {\n    terminator = 0x5D;/* ] */\n    isMapping = false;\n    _result = [];\n  } else if (ch === 0x7B/* { */) {\n    terminator = 0x7D;/* } */\n    isMapping = true;\n    _result = {};\n  } else {\n    return false;\n  }\n\n  if (state.anchor !== null) {\n    state.anchorMap[state.anchor] = _result;\n  }\n\n  ch = state.input.charCodeAt(++state.position);\n\n  while (ch !== 0) {\n    skipSeparationSpace(state, true, nodeIndent);\n\n    ch = state.input.charCodeAt(state.position);\n\n    if (ch === terminator) {\n      state.position++;\n      state.tag = _tag;\n      state.anchor = _anchor;\n      state.kind = isMapping ? 'mapping' : 'sequence';\n      state.result = _result;\n      return true;\n    } else if (!readNext) {\n      throwError(state, 'missed comma between flow collection entries');\n    } else if (ch === 0x2C/* , */) {\n      // \"flow collection entries can never be completely empty\", as per YAML 1.2, section 7.4\n      throwError(state, \"expected the node content, but found ','\");\n    }\n\n    keyTag = keyNode = valueNode = null;\n    isPair = isExplicitPair = false;\n\n    if (ch === 0x3F/* ? */) {\n      following = state.input.charCodeAt(state.position + 1);\n\n      if (is_WS_OR_EOL(following)) {\n        isPair = isExplicitPair = true;\n        state.position++;\n        skipSeparationSpace(state, true, nodeIndent);\n      }\n    }\n\n    _line = state.line; // Save the current line.\n    _lineStart = state.lineStart;\n    _pos = state.position;\n    composeNode(state, nodeIndent, CONTEXT_FLOW_IN, false, true);\n    keyTag = state.tag;\n    keyNode = state.result;\n    skipSeparationSpace(state, true, nodeIndent);\n\n    ch = state.input.charCodeAt(state.position);\n\n    if ((isExplicitPair || state.line === _line) && ch === 0x3A/* : */) {\n      isPair = true;\n      ch = state.input.charCodeAt(++state.position);\n      skipSeparationSpace(state, true, nodeIndent);\n      composeNode(state, nodeIndent, CONTEXT_FLOW_IN, false, true);\n      valueNode = state.result;\n    }\n\n    if (isMapping) {\n      storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, valueNode, _line, _lineStart, _pos);\n    } else if (isPair) {\n      _result.push(storeMappingPair(state, null, overridableKeys, keyTag, keyNode, valueNode, _line, _lineStart, _pos));\n    } else {\n      _result.push(keyNode);\n    }\n\n    skipSeparationSpace(state, true, nodeIndent);\n\n    ch = state.input.charCodeAt(state.position);\n\n    if (ch === 0x2C/* , */) {\n      readNext = true;\n      ch = state.input.charCodeAt(++state.position);\n    } else {\n      readNext = false;\n    }\n  }\n\n  throwError(state, 'unexpected end of the stream within a flow collection');\n}\n\nfunction readBlockScalar(state, nodeIndent) {\n  var captureStart,\n      folding,\n      chomping       = CHOMPING_CLIP,\n      didReadContent = false,\n      detectedIndent = false,\n      textIndent     = nodeIndent,\n      emptyLines     = 0,\n      atMoreIndented = false,\n      tmp,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch === 0x7C/* | */) {\n    folding = false;\n  } else if (ch === 0x3E/* > */) {\n    folding = true;\n  } else {\n    return false;\n  }\n\n  state.kind = 'scalar';\n  state.result = '';\n\n  while (ch !== 0) {\n    ch = state.input.charCodeAt(++state.position);\n\n    if (ch === 0x2B/* + */ || ch === 0x2D/* - */) {\n      if (CHOMPING_CLIP === chomping) {\n        chomping = (ch === 0x2B/* + */) ? CHOMPING_KEEP : CHOMPING_STRIP;\n      } else {\n        throwError(state, 'repeat of a chomping mode identifier');\n      }\n\n    } else if ((tmp = fromDecimalCode(ch)) >= 0) {\n      if (tmp === 0) {\n        throwError(state, 'bad explicit indentation width of a block scalar; it cannot be less than one');\n      } else if (!detectedIndent) {\n        textIndent = nodeIndent + tmp - 1;\n        detectedIndent = true;\n      } else {\n        throwError(state, 'repeat of an indentation width identifier');\n      }\n\n    } else {\n      break;\n    }\n  }\n\n  if (is_WHITE_SPACE(ch)) {\n    do { ch = state.input.charCodeAt(++state.position); }\n    while (is_WHITE_SPACE(ch));\n\n    if (ch === 0x23/* # */) {\n      do { ch = state.input.charCodeAt(++state.position); }\n      while (!is_EOL(ch) && (ch !== 0));\n    }\n  }\n\n  while (ch !== 0) {\n    readLineBreak(state);\n    state.lineIndent = 0;\n\n    ch = state.input.charCodeAt(state.position);\n\n    while ((!detectedIndent || state.lineIndent < textIndent) &&\n           (ch === 0x20/* Space */)) {\n      state.lineIndent++;\n      ch = state.input.charCodeAt(++state.position);\n    }\n\n    if (!detectedIndent && state.lineIndent > textIndent) {\n      textIndent = state.lineIndent;\n    }\n\n    if (is_EOL(ch)) {\n      emptyLines++;\n      continue;\n    }\n\n    // End of the scalar.\n    if (state.lineIndent < textIndent) {\n\n      // Perform the chomping.\n      if (chomping === CHOMPING_KEEP) {\n        state.result += common.repeat('\\n', didReadContent ? 1 + emptyLines : emptyLines);\n      } else if (chomping === CHOMPING_CLIP) {\n        if (didReadContent) { // i.e. only if the scalar is not empty.\n          state.result += '\\n';\n        }\n      }\n\n      // Break this `while` cycle and go to the funciton's epilogue.\n      break;\n    }\n\n    // Folded style: use fancy rules to handle line breaks.\n    if (folding) {\n\n      // Lines starting with white space characters (more-indented lines) are not folded.\n      if (is_WHITE_SPACE(ch)) {\n        atMoreIndented = true;\n        // except for the first content line (cf. Example 8.1)\n        state.result += common.repeat('\\n', didReadContent ? 1 + emptyLines : emptyLines);\n\n      // End of more-indented block.\n      } else if (atMoreIndented) {\n        atMoreIndented = false;\n        state.result += common.repeat('\\n', emptyLines + 1);\n\n      // Just one line break - perceive as the same line.\n      } else if (emptyLines === 0) {\n        if (didReadContent) { // i.e. only if we have already read some scalar content.\n          state.result += ' ';\n        }\n\n      // Several line breaks - perceive as different lines.\n      } else {\n        state.result += common.repeat('\\n', emptyLines);\n      }\n\n    // Literal style: just add exact number of line breaks between content lines.\n    } else {\n      // Keep all line breaks except the header line break.\n      state.result += common.repeat('\\n', didReadContent ? 1 + emptyLines : emptyLines);\n    }\n\n    didReadContent = true;\n    detectedIndent = true;\n    emptyLines = 0;\n    captureStart = state.position;\n\n    while (!is_EOL(ch) && (ch !== 0)) {\n      ch = state.input.charCodeAt(++state.position);\n    }\n\n    captureSegment(state, captureStart, state.position, false);\n  }\n\n  return true;\n}\n\nfunction readBlockSequence(state, nodeIndent) {\n  var _line,\n      _tag      = state.tag,\n      _anchor   = state.anchor,\n      _result   = [],\n      following,\n      detected  = false,\n      ch;\n\n  // there is a leading tab before this token, so it can't be a block sequence/mapping;\n  // it can still be flow sequence/mapping or a scalar\n  if (state.firstTabInLine !== -1) return false;\n\n  if (state.anchor !== null) {\n    state.anchorMap[state.anchor] = _result;\n  }\n\n  ch = state.input.charCodeAt(state.position);\n\n  while (ch !== 0) {\n    if (state.firstTabInLine !== -1) {\n      state.position = state.firstTabInLine;\n      throwError(state, 'tab characters must not be used in indentation');\n    }\n\n    if (ch !== 0x2D/* - */) {\n      break;\n    }\n\n    following = state.input.charCodeAt(state.position + 1);\n\n    if (!is_WS_OR_EOL(following)) {\n      break;\n    }\n\n    detected = true;\n    state.position++;\n\n    if (skipSeparationSpace(state, true, -1)) {\n      if (state.lineIndent <= nodeIndent) {\n        _result.push(null);\n        ch = state.input.charCodeAt(state.position);\n        continue;\n      }\n    }\n\n    _line = state.line;\n    composeNode(state, nodeIndent, CONTEXT_BLOCK_IN, false, true);\n    _result.push(state.result);\n    skipSeparationSpace(state, true, -1);\n\n    ch = state.input.charCodeAt(state.position);\n\n    if ((state.line === _line || state.lineIndent > nodeIndent) && (ch !== 0)) {\n      throwError(state, 'bad indentation of a sequence entry');\n    } else if (state.lineIndent < nodeIndent) {\n      break;\n    }\n  }\n\n  if (detected) {\n    state.tag = _tag;\n    state.anchor = _anchor;\n    state.kind = 'sequence';\n    state.result = _result;\n    return true;\n  }\n  return false;\n}\n\nfunction readBlockMapping(state, nodeIndent, flowIndent) {\n  var following,\n      allowCompact,\n      _line,\n      _keyLine,\n      _keyLineStart,\n      _keyPos,\n      _tag          = state.tag,\n      _anchor       = state.anchor,\n      _result       = {},\n      overridableKeys = Object.create(null),\n      keyTag        = null,\n      keyNode       = null,\n      valueNode     = null,\n      atExplicitKey = false,\n      detected      = false,\n      ch;\n\n  // there is a leading tab before this token, so it can't be a block sequence/mapping;\n  // it can still be flow sequence/mapping or a scalar\n  if (state.firstTabInLine !== -1) return false;\n\n  if (state.anchor !== null) {\n    state.anchorMap[state.anchor] = _result;\n  }\n\n  ch = state.input.charCodeAt(state.position);\n\n  while (ch !== 0) {\n    if (!atExplicitKey && state.firstTabInLine !== -1) {\n      state.position = state.firstTabInLine;\n      throwError(state, 'tab characters must not be used in indentation');\n    }\n\n    following = state.input.charCodeAt(state.position + 1);\n    _line = state.line; // Save the current line.\n\n    //\n    // Explicit notation case. There are two separate blocks:\n    // first for the key (denoted by \"?\") and second for the value (denoted by \":\")\n    //\n    if ((ch === 0x3F/* ? */ || ch === 0x3A/* : */) && is_WS_OR_EOL(following)) {\n\n      if (ch === 0x3F/* ? */) {\n        if (atExplicitKey) {\n          storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, null, _keyLine, _keyLineStart, _keyPos);\n          keyTag = keyNode = valueNode = null;\n        }\n\n        detected = true;\n        atExplicitKey = true;\n        allowCompact = true;\n\n      } else if (atExplicitKey) {\n        // i.e. 0x3A/* : */ === character after the explicit key.\n        atExplicitKey = false;\n        allowCompact = true;\n\n      } else {\n        throwError(state, 'incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line');\n      }\n\n      state.position += 1;\n      ch = following;\n\n    //\n    // Implicit notation case. Flow-style node as the key first, then \":\", and the value.\n    //\n    } else {\n      _keyLine = state.line;\n      _keyLineStart = state.lineStart;\n      _keyPos = state.position;\n\n      if (!composeNode(state, flowIndent, CONTEXT_FLOW_OUT, false, true)) {\n        // Neither implicit nor explicit notation.\n        // Reading is done. Go to the epilogue.\n        break;\n      }\n\n      if (state.line === _line) {\n        ch = state.input.charCodeAt(state.position);\n\n        while (is_WHITE_SPACE(ch)) {\n          ch = state.input.charCodeAt(++state.position);\n        }\n\n        if (ch === 0x3A/* : */) {\n          ch = state.input.charCodeAt(++state.position);\n\n          if (!is_WS_OR_EOL(ch)) {\n            throwError(state, 'a whitespace character is expected after the key-value separator within a block mapping');\n          }\n\n          if (atExplicitKey) {\n            storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, null, _keyLine, _keyLineStart, _keyPos);\n            keyTag = keyNode = valueNode = null;\n          }\n\n          detected = true;\n          atExplicitKey = false;\n          allowCompact = false;\n          keyTag = state.tag;\n          keyNode = state.result;\n\n        } else if (detected) {\n          throwError(state, 'can not read an implicit mapping pair; a colon is missed');\n\n        } else {\n          state.tag = _tag;\n          state.anchor = _anchor;\n          return true; // Keep the result of `composeNode`.\n        }\n\n      } else if (detected) {\n        throwError(state, 'can not read a block mapping entry; a multiline key may not be an implicit key');\n\n      } else {\n        state.tag = _tag;\n        state.anchor = _anchor;\n        return true; // Keep the result of `composeNode`.\n      }\n    }\n\n    //\n    // Common reading code for both explicit and implicit notations.\n    //\n    if (state.line === _line || state.lineIndent > nodeIndent) {\n      if (atExplicitKey) {\n        _keyLine = state.line;\n        _keyLineStart = state.lineStart;\n        _keyPos = state.position;\n      }\n\n      if (composeNode(state, nodeIndent, CONTEXT_BLOCK_OUT, true, allowCompact)) {\n        if (atExplicitKey) {\n          keyNode = state.result;\n        } else {\n          valueNode = state.result;\n        }\n      }\n\n      if (!atExplicitKey) {\n        storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, valueNode, _keyLine, _keyLineStart, _keyPos);\n        keyTag = keyNode = valueNode = null;\n      }\n\n      skipSeparationSpace(state, true, -1);\n      ch = state.input.charCodeAt(state.position);\n    }\n\n    if ((state.line === _line || state.lineIndent > nodeIndent) && (ch !== 0)) {\n      throwError(state, 'bad indentation of a mapping entry');\n    } else if (state.lineIndent < nodeIndent) {\n      break;\n    }\n  }\n\n  //\n  // Epilogue.\n  //\n\n  // Special case: last mapping's node contains only the key in explicit notation.\n  if (atExplicitKey) {\n    storeMappingPair(state, _result, overridableKeys, keyTag, keyNode, null, _keyLine, _keyLineStart, _keyPos);\n  }\n\n  // Expose the resulting mapping.\n  if (detected) {\n    state.tag = _tag;\n    state.anchor = _anchor;\n    state.kind = 'mapping';\n    state.result = _result;\n  }\n\n  return detected;\n}\n\nfunction readTagProperty(state) {\n  var _position,\n      isVerbatim = false,\n      isNamed    = false,\n      tagHandle,\n      tagName,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch !== 0x21/* ! */) return false;\n\n  if (state.tag !== null) {\n    throwError(state, 'duplication of a tag property');\n  }\n\n  ch = state.input.charCodeAt(++state.position);\n\n  if (ch === 0x3C/* < */) {\n    isVerbatim = true;\n    ch = state.input.charCodeAt(++state.position);\n\n  } else if (ch === 0x21/* ! */) {\n    isNamed = true;\n    tagHandle = '!!';\n    ch = state.input.charCodeAt(++state.position);\n\n  } else {\n    tagHandle = '!';\n  }\n\n  _position = state.position;\n\n  if (isVerbatim) {\n    do { ch = state.input.charCodeAt(++state.position); }\n    while (ch !== 0 && ch !== 0x3E/* > */);\n\n    if (state.position < state.length) {\n      tagName = state.input.slice(_position, state.position);\n      ch = state.input.charCodeAt(++state.position);\n    } else {\n      throwError(state, 'unexpected end of the stream within a verbatim tag');\n    }\n  } else {\n    while (ch !== 0 && !is_WS_OR_EOL(ch)) {\n\n      if (ch === 0x21/* ! */) {\n        if (!isNamed) {\n          tagHandle = state.input.slice(_position - 1, state.position + 1);\n\n          if (!PATTERN_TAG_HANDLE.test(tagHandle)) {\n            throwError(state, 'named tag handle cannot contain such characters');\n          }\n\n          isNamed = true;\n          _position = state.position + 1;\n        } else {\n          throwError(state, 'tag suffix cannot contain exclamation marks');\n        }\n      }\n\n      ch = state.input.charCodeAt(++state.position);\n    }\n\n    tagName = state.input.slice(_position, state.position);\n\n    if (PATTERN_FLOW_INDICATORS.test(tagName)) {\n      throwError(state, 'tag suffix cannot contain flow indicator characters');\n    }\n  }\n\n  if (tagName && !PATTERN_TAG_URI.test(tagName)) {\n    throwError(state, 'tag name cannot contain such characters: ' + tagName);\n  }\n\n  try {\n    tagName = decodeURIComponent(tagName);\n  } catch (err) {\n    throwError(state, 'tag name is malformed: ' + tagName);\n  }\n\n  if (isVerbatim) {\n    state.tag = tagName;\n\n  } else if (_hasOwnProperty$1.call(state.tagMap, tagHandle)) {\n    state.tag = state.tagMap[tagHandle] + tagName;\n\n  } else if (tagHandle === '!') {\n    state.tag = '!' + tagName;\n\n  } else if (tagHandle === '!!') {\n    state.tag = 'tag:yaml.org,2002:' + tagName;\n\n  } else {\n    throwError(state, 'undeclared tag handle \"' + tagHandle + '\"');\n  }\n\n  return true;\n}\n\nfunction readAnchorProperty(state) {\n  var _position,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch !== 0x26/* & */) return false;\n\n  if (state.anchor !== null) {\n    throwError(state, 'duplication of an anchor property');\n  }\n\n  ch = state.input.charCodeAt(++state.position);\n  _position = state.position;\n\n  while (ch !== 0 && !is_WS_OR_EOL(ch) && !is_FLOW_INDICATOR(ch)) {\n    ch = state.input.charCodeAt(++state.position);\n  }\n\n  if (state.position === _position) {\n    throwError(state, 'name of an anchor node must contain at least one character');\n  }\n\n  state.anchor = state.input.slice(_position, state.position);\n  return true;\n}\n\nfunction readAlias(state) {\n  var _position, alias,\n      ch;\n\n  ch = state.input.charCodeAt(state.position);\n\n  if (ch !== 0x2A/* * */) return false;\n\n  ch = state.input.charCodeAt(++state.position);\n  _position = state.position;\n\n  while (ch !== 0 && !is_WS_OR_EOL(ch) && !is_FLOW_INDICATOR(ch)) {\n    ch = state.input.charCodeAt(++state.position);\n  }\n\n  if (state.position === _position) {\n    throwError(state, 'name of an alias node must contain at least one character');\n  }\n\n  alias = state.input.slice(_position, state.position);\n\n  if (!_hasOwnProperty$1.call(state.anchorMap, alias)) {\n    throwError(state, 'unidentified alias \"' + alias + '\"');\n  }\n\n  state.result = state.anchorMap[alias];\n  skipSeparationSpace(state, true, -1);\n  return true;\n}\n\nfunction composeNode(state, parentIndent, nodeContext, allowToSeek, allowCompact) {\n  var allowBlockStyles,\n      allowBlockScalars,\n      allowBlockCollections,\n      indentStatus = 1, // 1: this>parent, 0: this=parent, -1: this<parent\n      atNewLine  = false,\n      hasContent = false,\n      typeIndex,\n      typeQuantity,\n      typeList,\n      type,\n      flowIndent,\n      blockIndent;\n\n  if (state.listener !== null) {\n    state.listener('open', state);\n  }\n\n  state.tag    = null;\n  state.anchor = null;\n  state.kind   = null;\n  state.result = null;\n\n  allowBlockStyles = allowBlockScalars = allowBlockCollections =\n    CONTEXT_BLOCK_OUT === nodeContext ||\n    CONTEXT_BLOCK_IN  === nodeContext;\n\n  if (allowToSeek) {\n    if (skipSeparationSpace(state, true, -1)) {\n      atNewLine = true;\n\n      if (state.lineIndent > parentIndent) {\n        indentStatus = 1;\n      } else if (state.lineIndent === parentIndent) {\n        indentStatus = 0;\n      } else if (state.lineIndent < parentIndent) {\n        indentStatus = -1;\n      }\n    }\n  }\n\n  if (indentStatus === 1) {\n    while (readTagProperty(state) || readAnchorProperty(state)) {\n      if (skipSeparationSpace(state, true, -1)) {\n        atNewLine = true;\n        allowBlockCollections = allowBlockStyles;\n\n        if (state.lineIndent > parentIndent) {\n          indentStatus = 1;\n        } else if (state.lineIndent === parentIndent) {\n          indentStatus = 0;\n        } else if (state.lineIndent < parentIndent) {\n          indentStatus = -1;\n        }\n      } else {\n        allowBlockCollections = false;\n      }\n    }\n  }\n\n  if (allowBlockCollections) {\n    allowBlockCollections = atNewLine || allowCompact;\n  }\n\n  if (indentStatus === 1 || CONTEXT_BLOCK_OUT === nodeContext) {\n    if (CONTEXT_FLOW_IN === nodeContext || CONTEXT_FLOW_OUT === nodeContext) {\n      flowIndent = parentIndent;\n    } else {\n      flowIndent = parentIndent + 1;\n    }\n\n    blockIndent = state.position - state.lineStart;\n\n    if (indentStatus === 1) {\n      if (allowBlockCollections &&\n          (readBlockSequence(state, blockIndent) ||\n           readBlockMapping(state, blockIndent, flowIndent)) ||\n          readFlowCollection(state, flowIndent)) {\n        hasContent = true;\n      } else {\n        if ((allowBlockScalars && readBlockScalar(state, flowIndent)) ||\n            readSingleQuotedScalar(state, flowIndent) ||\n            readDoubleQuotedScalar(state, flowIndent)) {\n          hasContent = true;\n\n        } else if (readAlias(state)) {\n          hasContent = true;\n\n          if (state.tag !== null || state.anchor !== null) {\n            throwError(state, 'alias node should not have any properties');\n          }\n\n        } else if (readPlainScalar(state, flowIndent, CONTEXT_FLOW_IN === nodeContext)) {\n          hasContent = true;\n\n          if (state.tag === null) {\n            state.tag = '?';\n          }\n        }\n\n        if (state.anchor !== null) {\n          state.anchorMap[state.anchor] = state.result;\n        }\n      }\n    } else if (indentStatus === 0) {\n      // Special case: block sequences are allowed to have same indentation level as the parent.\n      // http://www.yaml.org/spec/1.2/spec.html#id2799784\n      hasContent = allowBlockCollections && readBlockSequence(state, blockIndent);\n    }\n  }\n\n  if (state.tag === null) {\n    if (state.anchor !== null) {\n      state.anchorMap[state.anchor] = state.result;\n    }\n\n  } else if (state.tag === '?') {\n    // Implicit resolving is not allowed for non-scalar types, and '?'\n    // non-specific tag is only automatically assigned to plain scalars.\n    //\n    // We only need to check kind conformity in case user explicitly assigns '?'\n    // tag, for example like this: \"!<?> [0]\"\n    //\n    if (state.result !== null && state.kind !== 'scalar') {\n      throwError(state, 'unacceptable node kind for !<?> tag; it should be \"scalar\", not \"' + state.kind + '\"');\n    }\n\n    for (typeIndex = 0, typeQuantity = state.implicitTypes.length; typeIndex < typeQuantity; typeIndex += 1) {\n      type = state.implicitTypes[typeIndex];\n\n      if (type.resolve(state.result)) { // `state.result` updated in resolver if matched\n        state.result = type.construct(state.result);\n        state.tag = type.tag;\n        if (state.anchor !== null) {\n          state.anchorMap[state.anchor] = state.result;\n        }\n        break;\n      }\n    }\n  } else if (state.tag !== '!') {\n    if (_hasOwnProperty$1.call(state.typeMap[state.kind || 'fallback'], state.tag)) {\n      type = state.typeMap[state.kind || 'fallback'][state.tag];\n    } else {\n      // looking for multi type\n      type = null;\n      typeList = state.typeMap.multi[state.kind || 'fallback'];\n\n      for (typeIndex = 0, typeQuantity = typeList.length; typeIndex < typeQuantity; typeIndex += 1) {\n        if (state.tag.slice(0, typeList[typeIndex].tag.length) === typeList[typeIndex].tag) {\n          type = typeList[typeIndex];\n          break;\n        }\n      }\n    }\n\n    if (!type) {\n      throwError(state, 'unknown tag !<' + state.tag + '>');\n    }\n\n    if (state.result !== null && type.kind !== state.kind) {\n      throwError(state, 'unacceptable node kind for !<' + state.tag + '> tag; it should be \"' + type.kind + '\", not \"' + state.kind + '\"');\n    }\n\n    if (!type.resolve(state.result, state.tag)) { // `state.result` updated in resolver if matched\n      throwError(state, 'cannot resolve a node with !<' + state.tag + '> explicit tag');\n    } else {\n      state.result = type.construct(state.result, state.tag);\n      if (state.anchor !== null) {\n        state.anchorMap[state.anchor] = state.result;\n      }\n    }\n  }\n\n  if (state.listener !== null) {\n    state.listener('close', state);\n  }\n  return state.tag !== null ||  state.anchor !== null || hasContent;\n}\n\nfunction readDocument(state) {\n  var documentStart = state.position,\n      _position,\n      directiveName,\n      directiveArgs,\n      hasDirectives = false,\n      ch;\n\n  state.version = null;\n  state.checkLineBreaks = state.legacy;\n  state.tagMap = Object.create(null);\n  state.anchorMap = Object.create(null);\n\n  while ((ch = state.input.charCodeAt(state.position)) !== 0) {\n    skipSeparationSpace(state, true, -1);\n\n    ch = state.input.charCodeAt(state.position);\n\n    if (state.lineIndent > 0 || ch !== 0x25/* % */) {\n      break;\n    }\n\n    hasDirectives = true;\n    ch = state.input.charCodeAt(++state.position);\n    _position = state.position;\n\n    while (ch !== 0 && !is_WS_OR_EOL(ch)) {\n      ch = state.input.charCodeAt(++state.position);\n    }\n\n    directiveName = state.input.slice(_position, state.position);\n    directiveArgs = [];\n\n    if (directiveName.length < 1) {\n      throwError(state, 'directive name must not be less than one character in length');\n    }\n\n    while (ch !== 0) {\n      while (is_WHITE_SPACE(ch)) {\n        ch = state.input.charCodeAt(++state.position);\n      }\n\n      if (ch === 0x23/* # */) {\n        do { ch = state.input.charCodeAt(++state.position); }\n        while (ch !== 0 && !is_EOL(ch));\n        break;\n      }\n\n      if (is_EOL(ch)) break;\n\n      _position = state.position;\n\n      while (ch !== 0 && !is_WS_OR_EOL(ch)) {\n        ch = state.input.charCodeAt(++state.position);\n      }\n\n      directiveArgs.push(state.input.slice(_position, state.position));\n    }\n\n    if (ch !== 0) readLineBreak(state);\n\n    if (_hasOwnProperty$1.call(directiveHandlers, directiveName)) {\n      directiveHandlers[directiveName](state, directiveName, directiveArgs);\n    } else {\n      throwWarning(state, 'unknown document directive \"' + directiveName + '\"');\n    }\n  }\n\n  skipSeparationSpace(state, true, -1);\n\n  if (state.lineIndent === 0 &&\n      state.input.charCodeAt(state.position)     === 0x2D/* - */ &&\n      state.input.charCodeAt(state.position + 1) === 0x2D/* - */ &&\n      state.input.charCodeAt(state.position + 2) === 0x2D/* - */) {\n    state.position += 3;\n    skipSeparationSpace(state, true, -1);\n\n  } else if (hasDirectives) {\n    throwError(state, 'directives end mark is expected');\n  }\n\n  composeNode(state, state.lineIndent - 1, CONTEXT_BLOCK_OUT, false, true);\n  skipSeparationSpace(state, true, -1);\n\n  if (state.checkLineBreaks &&\n      PATTERN_NON_ASCII_LINE_BREAKS.test(state.input.slice(documentStart, state.position))) {\n    throwWarning(state, 'non-ASCII line breaks are interpreted as content');\n  }\n\n  state.documents.push(state.result);\n\n  if (state.position === state.lineStart && testDocumentSeparator(state)) {\n\n    if (state.input.charCodeAt(state.position) === 0x2E/* . */) {\n      state.position += 3;\n      skipSeparationSpace(state, true, -1);\n    }\n    return;\n  }\n\n  if (state.position < (state.length - 1)) {\n    throwError(state, 'end of the stream or a document separator is expected');\n  } else {\n    return;\n  }\n}\n\n\nfunction loadDocuments(input, options) {\n  input = String(input);\n  options = options || {};\n\n  if (input.length !== 0) {\n\n    // Add tailing `\\n` if not exists\n    if (input.charCodeAt(input.length - 1) !== 0x0A/* LF */ &&\n        input.charCodeAt(input.length - 1) !== 0x0D/* CR */) {\n      input += '\\n';\n    }\n\n    // Strip BOM\n    if (input.charCodeAt(0) === 0xFEFF) {\n      input = input.slice(1);\n    }\n  }\n\n  var state = new State$1(input, options);\n\n  var nullpos = input.indexOf('\\0');\n\n  if (nullpos !== -1) {\n    state.position = nullpos;\n    throwError(state, 'null byte is not allowed in input');\n  }\n\n  // Use 0 as string terminator. That significantly simplifies bounds check.\n  state.input += '\\0';\n\n  while (state.input.charCodeAt(state.position) === 0x20/* Space */) {\n    state.lineIndent += 1;\n    state.position += 1;\n  }\n\n  while (state.position < (state.length - 1)) {\n    readDocument(state);\n  }\n\n  return state.documents;\n}\n\n\nfunction loadAll$1(input, iterator, options) {\n  if (iterator !== null && typeof iterator === 'object' && typeof options === 'undefined') {\n    options = iterator;\n    iterator = null;\n  }\n\n  var documents = loadDocuments(input, options);\n\n  if (typeof iterator !== 'function') {\n    return documents;\n  }\n\n  for (var index = 0, length = documents.length; index < length; index += 1) {\n    iterator(documents[index]);\n  }\n}\n\n\nfunction load$1(input, options) {\n  var documents = loadDocuments(input, options);\n\n  if (documents.length === 0) {\n    /*eslint-disable no-undefined*/\n    return undefined;\n  } else if (documents.length === 1) {\n    return documents[0];\n  }\n  throw new exception('expected a single document in the stream, but found more');\n}\n\n\nvar loadAll_1 = loadAll$1;\nvar load_1    = load$1;\n\nvar loader = {\n\tloadAll: loadAll_1,\n\tload: load_1\n};\n\n/*eslint-disable no-use-before-define*/\n\n\n\n\n\nvar _toString       = Object.prototype.toString;\nvar _hasOwnProperty = Object.prototype.hasOwnProperty;\n\nvar CHAR_BOM                  = 0xFEFF;\nvar CHAR_TAB                  = 0x09; /* Tab */\nvar CHAR_LINE_FEED            = 0x0A; /* LF */\nvar CHAR_CARRIAGE_RETURN      = 0x0D; /* CR */\nvar CHAR_SPACE                = 0x20; /* Space */\nvar CHAR_EXCLAMATION          = 0x21; /* ! */\nvar CHAR_DOUBLE_QUOTE         = 0x22; /* \" */\nvar CHAR_SHARP                = 0x23; /* # */\nvar CHAR_PERCENT              = 0x25; /* % */\nvar CHAR_AMPERSAND            = 0x26; /* & */\nvar CHAR_SINGLE_QUOTE         = 0x27; /* ' */\nvar CHAR_ASTERISK             = 0x2A; /* * */\nvar CHAR_COMMA                = 0x2C; /* , */\nvar CHAR_MINUS                = 0x2D; /* - */\nvar CHAR_COLON                = 0x3A; /* : */\nvar CHAR_EQUALS               = 0x3D; /* = */\nvar CHAR_GREATER_THAN         = 0x3E; /* > */\nvar CHAR_QUESTION             = 0x3F; /* ? */\nvar CHAR_COMMERCIAL_AT        = 0x40; /* @ */\nvar CHAR_LEFT_SQUARE_BRACKET  = 0x5B; /* [ */\nvar CHAR_RIGHT_SQUARE_BRACKET = 0x5D; /* ] */\nvar CHAR_GRAVE_ACCENT         = 0x60; /* ` */\nvar CHAR_LEFT_CURLY_BRACKET   = 0x7B; /* { */\nvar CHAR_VERTICAL_LINE        = 0x7C; /* | */\nvar CHAR_RIGHT_CURLY_BRACKET  = 0x7D; /* } */\n\nvar ESCAPE_SEQUENCES = {};\n\nESCAPE_SEQUENCES[0x00]   = '\\\\0';\nESCAPE_SEQUENCES[0x07]   = '\\\\a';\nESCAPE_SEQUENCES[0x08]   = '\\\\b';\nESCAPE_SEQUENCES[0x09]   = '\\\\t';\nESCAPE_SEQUENCES[0x0A]   = '\\\\n';\nESCAPE_SEQUENCES[0x0B]   = '\\\\v';\nESCAPE_SEQUENCES[0x0C]   = '\\\\f';\nESCAPE_SEQUENCES[0x0D]   = '\\\\r';\nESCAPE_SEQUENCES[0x1B]   = '\\\\e';\nESCAPE_SEQUENCES[0x22]   = '\\\\\"';\nESCAPE_SEQUENCES[0x5C]   = '\\\\\\\\';\nESCAPE_SEQUENCES[0x85]   = '\\\\N';\nESCAPE_SEQUENCES[0xA0]   = '\\\\_';\nESCAPE_SEQUENCES[0x2028] = '\\\\L';\nESCAPE_SEQUENCES[0x2029] = '\\\\P';\n\nvar DEPRECATED_BOOLEANS_SYNTAX = [\n  'y', 'Y', 'yes', 'Yes', 'YES', 'on', 'On', 'ON',\n  'n', 'N', 'no', 'No', 'NO', 'off', 'Off', 'OFF'\n];\n\nvar DEPRECATED_BASE60_SYNTAX = /^[-+]?[0-9_]+(?::[0-9_]+)+(?:\\.[0-9_]*)?$/;\n\nfunction compileStyleMap(schema, map) {\n  var result, keys, index, length, tag, style, type;\n\n  if (map === null) return {};\n\n  result = {};\n  keys = Object.keys(map);\n\n  for (index = 0, length = keys.length; index < length; index += 1) {\n    tag = keys[index];\n    style = String(map[tag]);\n\n    if (tag.slice(0, 2) === '!!') {\n      tag = 'tag:yaml.org,2002:' + tag.slice(2);\n    }\n    type = schema.compiledTypeMap['fallback'][tag];\n\n    if (type && _hasOwnProperty.call(type.styleAliases, style)) {\n      style = type.styleAliases[style];\n    }\n\n    result[tag] = style;\n  }\n\n  return result;\n}\n\nfunction encodeHex(character) {\n  var string, handle, length;\n\n  string = character.toString(16).toUpperCase();\n\n  if (character <= 0xFF) {\n    handle = 'x';\n    length = 2;\n  } else if (character <= 0xFFFF) {\n    handle = 'u';\n    length = 4;\n  } else if (character <= 0xFFFFFFFF) {\n    handle = 'U';\n    length = 8;\n  } else {\n    throw new exception('code point within a string may not be greater than 0xFFFFFFFF');\n  }\n\n  return '\\\\' + handle + common.repeat('0', length - string.length) + string;\n}\n\n\nvar QUOTING_TYPE_SINGLE = 1,\n    QUOTING_TYPE_DOUBLE = 2;\n\nfunction State(options) {\n  this.schema        = options['schema'] || _default;\n  this.indent        = Math.max(1, (options['indent'] || 2));\n  this.noArrayIndent = options['noArrayIndent'] || false;\n  this.skipInvalid   = options['skipInvalid'] || false;\n  this.flowLevel     = (common.isNothing(options['flowLevel']) ? -1 : options['flowLevel']);\n  this.styleMap      = compileStyleMap(this.schema, options['styles'] || null);\n  this.sortKeys      = options['sortKeys'] || false;\n  this.lineWidth     = options['lineWidth'] || 80;\n  this.noRefs        = options['noRefs'] || false;\n  this.noCompatMode  = options['noCompatMode'] || false;\n  this.condenseFlow  = options['condenseFlow'] || false;\n  this.quotingType   = options['quotingType'] === '\"' ? QUOTING_TYPE_DOUBLE : QUOTING_TYPE_SINGLE;\n  this.forceQuotes   = options['forceQuotes'] || false;\n  this.replacer      = typeof options['replacer'] === 'function' ? options['replacer'] : null;\n\n  this.implicitTypes = this.schema.compiledImplicit;\n  this.explicitTypes = this.schema.compiledExplicit;\n\n  this.tag = null;\n  this.result = '';\n\n  this.duplicates = [];\n  this.usedDuplicates = null;\n}\n\n// Indents every line in a string. Empty lines (\\n only) are not indented.\nfunction indentString(string, spaces) {\n  var ind = common.repeat(' ', spaces),\n      position = 0,\n      next = -1,\n      result = '',\n      line,\n      length = string.length;\n\n  while (position < length) {\n    next = string.indexOf('\\n', position);\n    if (next === -1) {\n      line = string.slice(position);\n      position = length;\n    } else {\n      line = string.slice(position, next + 1);\n      position = next + 1;\n    }\n\n    if (line.length && line !== '\\n') result += ind;\n\n    result += line;\n  }\n\n  return result;\n}\n\nfunction generateNextLine(state, level) {\n  return '\\n' + common.repeat(' ', state.indent * level);\n}\n\nfunction testImplicitResolving(state, str) {\n  var index, length, type;\n\n  for (index = 0, length = state.implicitTypes.length; index < length; index += 1) {\n    type = state.implicitTypes[index];\n\n    if (type.resolve(str)) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// [33] s-white ::= s-space | s-tab\nfunction isWhitespace(c) {\n  return c === CHAR_SPACE || c === CHAR_TAB;\n}\n\n// Returns true if the character can be printed without escaping.\n// From YAML 1.2: \"any allowed characters known to be non-printable\n// should also be escaped. [However,] This isn’t mandatory\"\n// Derived from nb-char - \\t - #x85 - #xA0 - #x2028 - #x2029.\nfunction isPrintable(c) {\n  return  (0x00020 <= c && c <= 0x00007E)\n      || ((0x000A1 <= c && c <= 0x00D7FF) && c !== 0x2028 && c !== 0x2029)\n      || ((0x0E000 <= c && c <= 0x00FFFD) && c !== CHAR_BOM)\n      ||  (0x10000 <= c && c <= 0x10FFFF);\n}\n\n// [34] ns-char ::= nb-char - s-white\n// [27] nb-char ::= c-printable - b-char - c-byte-order-mark\n// [26] b-char  ::= b-line-feed | b-carriage-return\n// Including s-white (for some reason, examples doesn't match specs in this aspect)\n// ns-char ::= c-printable - b-line-feed - b-carriage-return - c-byte-order-mark\nfunction isNsCharOrWhitespace(c) {\n  return isPrintable(c)\n    && c !== CHAR_BOM\n    // - b-char\n    && c !== CHAR_CARRIAGE_RETURN\n    && c !== CHAR_LINE_FEED;\n}\n\n// [127]  ns-plain-safe(c) ::= c = flow-out  ⇒ ns-plain-safe-out\n//                             c = flow-in   ⇒ ns-plain-safe-in\n//                             c = block-key ⇒ ns-plain-safe-out\n//                             c = flow-key  ⇒ ns-plain-safe-in\n// [128] ns-plain-safe-out ::= ns-char\n// [129]  ns-plain-safe-in ::= ns-char - c-flow-indicator\n// [130]  ns-plain-char(c) ::=  ( ns-plain-safe(c) - “:” - “#” )\n//                            | ( /* An ns-char preceding */ “#” )\n//                            | ( “:” /* Followed by an ns-plain-safe(c) */ )\nfunction isPlainSafe(c, prev, inblock) {\n  var cIsNsCharOrWhitespace = isNsCharOrWhitespace(c);\n  var cIsNsChar = cIsNsCharOrWhitespace && !isWhitespace(c);\n  return (\n    // ns-plain-safe\n    inblock ? // c = flow-in\n      cIsNsCharOrWhitespace\n      : cIsNsCharOrWhitespace\n        // - c-flow-indicator\n        && c !== CHAR_COMMA\n        && c !== CHAR_LEFT_SQUARE_BRACKET\n        && c !== CHAR_RIGHT_SQUARE_BRACKET\n        && c !== CHAR_LEFT_CURLY_BRACKET\n        && c !== CHAR_RIGHT_CURLY_BRACKET\n  )\n    // ns-plain-char\n    && c !== CHAR_SHARP // false on '#'\n    && !(prev === CHAR_COLON && !cIsNsChar) // false on ': '\n    || (isNsCharOrWhitespace(prev) && !isWhitespace(prev) && c === CHAR_SHARP) // change to true on '[^ ]#'\n    || (prev === CHAR_COLON && cIsNsChar); // change to true on ':[^ ]'\n}\n\n// Simplified test for values allowed as the first character in plain style.\nfunction isPlainSafeFirst(c) {\n  // Uses a subset of ns-char - c-indicator\n  // where ns-char = nb-char - s-white.\n  // No support of ( ( “?” | “:” | “-” ) /* Followed by an ns-plain-safe(c)) */ ) part\n  return isPrintable(c) && c !== CHAR_BOM\n    && !isWhitespace(c) // - s-white\n    // - (c-indicator ::=\n    // “-” | “?” | “:” | “,” | “[” | “]” | “{” | “}”\n    && c !== CHAR_MINUS\n    && c !== CHAR_QUESTION\n    && c !== CHAR_COLON\n    && c !== CHAR_COMMA\n    && c !== CHAR_LEFT_SQUARE_BRACKET\n    && c !== CHAR_RIGHT_SQUARE_BRACKET\n    && c !== CHAR_LEFT_CURLY_BRACKET\n    && c !== CHAR_RIGHT_CURLY_BRACKET\n    // | “#” | “&” | “*” | “!” | “|” | “=” | “>” | “'” | “\"”\n    && c !== CHAR_SHARP\n    && c !== CHAR_AMPERSAND\n    && c !== CHAR_ASTERISK\n    && c !== CHAR_EXCLAMATION\n    && c !== CHAR_VERTICAL_LINE\n    && c !== CHAR_EQUALS\n    && c !== CHAR_GREATER_THAN\n    && c !== CHAR_SINGLE_QUOTE\n    && c !== CHAR_DOUBLE_QUOTE\n    // | “%” | “@” | “`”)\n    && c !== CHAR_PERCENT\n    && c !== CHAR_COMMERCIAL_AT\n    && c !== CHAR_GRAVE_ACCENT;\n}\n\n// Simplified test for values allowed as the last character in plain style.\nfunction isPlainSafeLast(c) {\n  // just not whitespace or colon, it will be checked to be plain character later\n  return !isWhitespace(c) && c !== CHAR_COLON;\n}\n\n// Same as 'string'.codePointAt(pos), but works in older browsers.\nfunction codePointAt(string, pos) {\n  var first = string.charCodeAt(pos), second;\n  if (first >= 0xD800 && first <= 0xDBFF && pos + 1 < string.length) {\n    second = string.charCodeAt(pos + 1);\n    if (second >= 0xDC00 && second <= 0xDFFF) {\n      // https://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae\n      return (first - 0xD800) * 0x400 + second - 0xDC00 + 0x10000;\n    }\n  }\n  return first;\n}\n\n// Determines whether block indentation indicator is required.\nfunction needIndentIndicator(string) {\n  var leadingSpaceRe = /^\\n* /;\n  return leadingSpaceRe.test(string);\n}\n\nvar STYLE_PLAIN   = 1,\n    STYLE_SINGLE  = 2,\n    STYLE_LITERAL = 3,\n    STYLE_FOLDED  = 4,\n    STYLE_DOUBLE  = 5;\n\n// Determines which scalar styles are possible and returns the preferred style.\n// lineWidth = -1 => no limit.\n// Pre-conditions: str.length > 0.\n// Post-conditions:\n//    STYLE_PLAIN or STYLE_SINGLE => no \\n are in the string.\n//    STYLE_LITERAL => no lines are suitable for folding (or lineWidth is -1).\n//    STYLE_FOLDED => a line > lineWidth and can be folded (and lineWidth != -1).\nfunction chooseScalarStyle(string, singleLineOnly, indentPerLevel, lineWidth,\n  testAmbiguousType, quotingType, forceQuotes, inblock) {\n\n  var i;\n  var char = 0;\n  var prevChar = null;\n  var hasLineBreak = false;\n  var hasFoldableLine = false; // only checked if shouldTrackWidth\n  var shouldTrackWidth = lineWidth !== -1;\n  var previousLineBreak = -1; // count the first line correctly\n  var plain = isPlainSafeFirst(codePointAt(string, 0))\n          && isPlainSafeLast(codePointAt(string, string.length - 1));\n\n  if (singleLineOnly || forceQuotes) {\n    // Case: no block styles.\n    // Check for disallowed characters to rule out plain and single.\n    for (i = 0; i < string.length; char >= 0x10000 ? i += 2 : i++) {\n      char = codePointAt(string, i);\n      if (!isPrintable(char)) {\n        return STYLE_DOUBLE;\n      }\n      plain = plain && isPlainSafe(char, prevChar, inblock);\n      prevChar = char;\n    }\n  } else {\n    // Case: block styles permitted.\n    for (i = 0; i < string.length; char >= 0x10000 ? i += 2 : i++) {\n      char = codePointAt(string, i);\n      if (char === CHAR_LINE_FEED) {\n        hasLineBreak = true;\n        // Check if any line can be folded.\n        if (shouldTrackWidth) {\n          hasFoldableLine = hasFoldableLine ||\n            // Foldable line = too long, and not more-indented.\n            (i - previousLineBreak - 1 > lineWidth &&\n             string[previousLineBreak + 1] !== ' ');\n          previousLineBreak = i;\n        }\n      } else if (!isPrintable(char)) {\n        return STYLE_DOUBLE;\n      }\n      plain = plain && isPlainSafe(char, prevChar, inblock);\n      prevChar = char;\n    }\n    // in case the end is missing a \\n\n    hasFoldableLine = hasFoldableLine || (shouldTrackWidth &&\n      (i - previousLineBreak - 1 > lineWidth &&\n       string[previousLineBreak + 1] !== ' '));\n  }\n  // Although every style can represent \\n without escaping, prefer block styles\n  // for multiline, since they're more readable and they don't add empty lines.\n  // Also prefer folding a super-long line.\n  if (!hasLineBreak && !hasFoldableLine) {\n    // Strings interpretable as another type have to be quoted;\n    // e.g. the string 'true' vs. the boolean true.\n    if (plain && !forceQuotes && !testAmbiguousType(string)) {\n      return STYLE_PLAIN;\n    }\n    return quotingType === QUOTING_TYPE_DOUBLE ? STYLE_DOUBLE : STYLE_SINGLE;\n  }\n  // Edge case: block indentation indicator can only have one digit.\n  if (indentPerLevel > 9 && needIndentIndicator(string)) {\n    return STYLE_DOUBLE;\n  }\n  // At this point we know block styles are valid.\n  // Prefer literal style unless we want to fold.\n  if (!forceQuotes) {\n    return hasFoldableLine ? STYLE_FOLDED : STYLE_LITERAL;\n  }\n  return quotingType === QUOTING_TYPE_DOUBLE ? STYLE_DOUBLE : STYLE_SINGLE;\n}\n\n// Note: line breaking/folding is implemented for only the folded style.\n// NB. We drop the last trailing newline (if any) of a returned block scalar\n//  since the dumper adds its own newline. This always works:\n//    • No ending newline => unaffected; already using strip \"-\" chomping.\n//    • Ending newline    => removed then restored.\n//  Importantly, this keeps the \"+\" chomp indicator from gaining an extra line.\nfunction writeScalar(state, string, level, iskey, inblock) {\n  state.dump = (function () {\n    if (string.length === 0) {\n      return state.quotingType === QUOTING_TYPE_DOUBLE ? '\"\"' : \"''\";\n    }\n    if (!state.noCompatMode) {\n      if (DEPRECATED_BOOLEANS_SYNTAX.indexOf(string) !== -1 || DEPRECATED_BASE60_SYNTAX.test(string)) {\n        return state.quotingType === QUOTING_TYPE_DOUBLE ? ('\"' + string + '\"') : (\"'\" + string + \"'\");\n      }\n    }\n\n    var indent = state.indent * Math.max(1, level); // no 0-indent scalars\n    // As indentation gets deeper, let the width decrease monotonically\n    // to the lower bound min(state.lineWidth, 40).\n    // Note that this implies\n    //  state.lineWidth ≤ 40 + state.indent: width is fixed at the lower bound.\n    //  state.lineWidth > 40 + state.indent: width decreases until the lower bound.\n    // This behaves better than a constant minimum width which disallows narrower options,\n    // or an indent threshold which causes the width to suddenly increase.\n    var lineWidth = state.lineWidth === -1\n      ? -1 : Math.max(Math.min(state.lineWidth, 40), state.lineWidth - indent);\n\n    // Without knowing if keys are implicit/explicit, assume implicit for safety.\n    var singleLineOnly = iskey\n      // No block styles in flow mode.\n      || (state.flowLevel > -1 && level >= state.flowLevel);\n    function testAmbiguity(string) {\n      return testImplicitResolving(state, string);\n    }\n\n    switch (chooseScalarStyle(string, singleLineOnly, state.indent, lineWidth,\n      testAmbiguity, state.quotingType, state.forceQuotes && !iskey, inblock)) {\n\n      case STYLE_PLAIN:\n        return string;\n      case STYLE_SINGLE:\n        return \"'\" + string.replace(/'/g, \"''\") + \"'\";\n      case STYLE_LITERAL:\n        return '|' + blockHeader(string, state.indent)\n          + dropEndingNewline(indentString(string, indent));\n      case STYLE_FOLDED:\n        return '>' + blockHeader(string, state.indent)\n          + dropEndingNewline(indentString(foldString(string, lineWidth), indent));\n      case STYLE_DOUBLE:\n        return '\"' + escapeString(string) + '\"';\n      default:\n        throw new exception('impossible error: invalid scalar style');\n    }\n  }());\n}\n\n// Pre-conditions: string is valid for a block scalar, 1 <= indentPerLevel <= 9.\nfunction blockHeader(string, indentPerLevel) {\n  var indentIndicator = needIndentIndicator(string) ? String(indentPerLevel) : '';\n\n  // note the special case: the string '\\n' counts as a \"trailing\" empty line.\n  var clip =          string[string.length - 1] === '\\n';\n  var keep = clip && (string[string.length - 2] === '\\n' || string === '\\n');\n  var chomp = keep ? '+' : (clip ? '' : '-');\n\n  return indentIndicator + chomp + '\\n';\n}\n\n// (See the note for writeScalar.)\nfunction dropEndingNewline(string) {\n  return string[string.length - 1] === '\\n' ? string.slice(0, -1) : string;\n}\n\n// Note: a long line without a suitable break point will exceed the width limit.\n// Pre-conditions: every char in str isPrintable, str.length > 0, width > 0.\nfunction foldString(string, width) {\n  // In folded style, $k$ consecutive newlines output as $k+1$ newlines—\n  // unless they're before or after a more-indented line, or at the very\n  // beginning or end, in which case $k$ maps to $k$.\n  // Therefore, parse each chunk as newline(s) followed by a content line.\n  var lineRe = /(\\n+)([^\\n]*)/g;\n\n  // first line (possibly an empty line)\n  var result = (function () {\n    var nextLF = string.indexOf('\\n');\n    nextLF = nextLF !== -1 ? nextLF : string.length;\n    lineRe.lastIndex = nextLF;\n    return foldLine(string.slice(0, nextLF), width);\n  }());\n  // If we haven't reached the first content line yet, don't add an extra \\n.\n  var prevMoreIndented = string[0] === '\\n' || string[0] === ' ';\n  var moreIndented;\n\n  // rest of the lines\n  var match;\n  while ((match = lineRe.exec(string))) {\n    var prefix = match[1], line = match[2];\n    moreIndented = (line[0] === ' ');\n    result += prefix\n      + (!prevMoreIndented && !moreIndented && line !== ''\n        ? '\\n' : '')\n      + foldLine(line, width);\n    prevMoreIndented = moreIndented;\n  }\n\n  return result;\n}\n\n// Greedy line breaking.\n// Picks the longest line under the limit each time,\n// otherwise settles for the shortest line over the limit.\n// NB. More-indented lines *cannot* be folded, as that would add an extra \\n.\nfunction foldLine(line, width) {\n  if (line === '' || line[0] === ' ') return line;\n\n  // Since a more-indented line adds a \\n, breaks can't be followed by a space.\n  var breakRe = / [^ ]/g; // note: the match index will always be <= length-2.\n  var match;\n  // start is an inclusive index. end, curr, and next are exclusive.\n  var start = 0, end, curr = 0, next = 0;\n  var result = '';\n\n  // Invariants: 0 <= start <= length-1.\n  //   0 <= curr <= next <= max(0, length-2). curr - start <= width.\n  // Inside the loop:\n  //   A match implies length >= 2, so curr and next are <= length-2.\n  while ((match = breakRe.exec(line))) {\n    next = match.index;\n    // maintain invariant: curr - start <= width\n    if (next - start > width) {\n      end = (curr > start) ? curr : next; // derive end <= length-2\n      result += '\\n' + line.slice(start, end);\n      // skip the space that was output as \\n\n      start = end + 1;                    // derive start <= length-1\n    }\n    curr = next;\n  }\n\n  // By the invariants, start <= length-1, so there is something left over.\n  // It is either the whole string or a part starting from non-whitespace.\n  result += '\\n';\n  // Insert a break if the remainder is too long and there is a break available.\n  if (line.length - start > width && curr > start) {\n    result += line.slice(start, curr) + '\\n' + line.slice(curr + 1);\n  } else {\n    result += line.slice(start);\n  }\n\n  return result.slice(1); // drop extra \\n joiner\n}\n\n// Escapes a double-quoted string.\nfunction escapeString(string) {\n  var result = '';\n  var char = 0;\n  var escapeSeq;\n\n  for (var i = 0; i < string.length; char >= 0x10000 ? i += 2 : i++) {\n    char = codePointAt(string, i);\n    escapeSeq = ESCAPE_SEQUENCES[char];\n\n    if (!escapeSeq && isPrintable(char)) {\n      result += string[i];\n      if (char >= 0x10000) result += string[i + 1];\n    } else {\n      result += escapeSeq || encodeHex(char);\n    }\n  }\n\n  return result;\n}\n\nfunction writeFlowSequence(state, level, object) {\n  var _result = '',\n      _tag    = state.tag,\n      index,\n      length,\n      value;\n\n  for (index = 0, length = object.length; index < length; index += 1) {\n    value = object[index];\n\n    if (state.replacer) {\n      value = state.replacer.call(object, String(index), value);\n    }\n\n    // Write only valid elements, put null instead of invalid elements.\n    if (writeNode(state, level, value, false, false) ||\n        (typeof value === 'undefined' &&\n         writeNode(state, level, null, false, false))) {\n\n      if (_result !== '') _result += ',' + (!state.condenseFlow ? ' ' : '');\n      _result += state.dump;\n    }\n  }\n\n  state.tag = _tag;\n  state.dump = '[' + _result + ']';\n}\n\nfunction writeBlockSequence(state, level, object, compact) {\n  var _result = '',\n      _tag    = state.tag,\n      index,\n      length,\n      value;\n\n  for (index = 0, length = object.length; index < length; index += 1) {\n    value = object[index];\n\n    if (state.replacer) {\n      value = state.replacer.call(object, String(index), value);\n    }\n\n    // Write only valid elements, put null instead of invalid elements.\n    if (writeNode(state, level + 1, value, true, true, false, true) ||\n        (typeof value === 'undefined' &&\n         writeNode(state, level + 1, null, true, true, false, true))) {\n\n      if (!compact || _result !== '') {\n        _result += generateNextLine(state, level);\n      }\n\n      if (state.dump && CHAR_LINE_FEED === state.dump.charCodeAt(0)) {\n        _result += '-';\n      } else {\n        _result += '- ';\n      }\n\n      _result += state.dump;\n    }\n  }\n\n  state.tag = _tag;\n  state.dump = _result || '[]'; // Empty sequence if no valid values.\n}\n\nfunction writeFlowMapping(state, level, object) {\n  var _result       = '',\n      _tag          = state.tag,\n      objectKeyList = Object.keys(object),\n      index,\n      length,\n      objectKey,\n      objectValue,\n      pairBuffer;\n\n  for (index = 0, length = objectKeyList.length; index < length; index += 1) {\n\n    pairBuffer = '';\n    if (_result !== '') pairBuffer += ', ';\n\n    if (state.condenseFlow) pairBuffer += '\"';\n\n    objectKey = objectKeyList[index];\n    objectValue = object[objectKey];\n\n    if (state.replacer) {\n      objectValue = state.replacer.call(object, objectKey, objectValue);\n    }\n\n    if (!writeNode(state, level, objectKey, false, false)) {\n      continue; // Skip this pair because of invalid key;\n    }\n\n    if (state.dump.length > 1024) pairBuffer += '? ';\n\n    pairBuffer += state.dump + (state.condenseFlow ? '\"' : '') + ':' + (state.condenseFlow ? '' : ' ');\n\n    if (!writeNode(state, level, objectValue, false, false)) {\n      continue; // Skip this pair because of invalid value.\n    }\n\n    pairBuffer += state.dump;\n\n    // Both key and value are valid.\n    _result += pairBuffer;\n  }\n\n  state.tag = _tag;\n  state.dump = '{' + _result + '}';\n}\n\nfunction writeBlockMapping(state, level, object, compact) {\n  var _result       = '',\n      _tag          = state.tag,\n      objectKeyList = Object.keys(object),\n      index,\n      length,\n      objectKey,\n      objectValue,\n      explicitPair,\n      pairBuffer;\n\n  // Allow sorting keys so that the output file is deterministic\n  if (state.sortKeys === true) {\n    // Default sorting\n    objectKeyList.sort();\n  } else if (typeof state.sortKeys === 'function') {\n    // Custom sort function\n    objectKeyList.sort(state.sortKeys);\n  } else if (state.sortKeys) {\n    // Something is wrong\n    throw new exception('sortKeys must be a boolean or a function');\n  }\n\n  for (index = 0, length = objectKeyList.length; index < length; index += 1) {\n    pairBuffer = '';\n\n    if (!compact || _result !== '') {\n      pairBuffer += generateNextLine(state, level);\n    }\n\n    objectKey = objectKeyList[index];\n    objectValue = object[objectKey];\n\n    if (state.replacer) {\n      objectValue = state.replacer.call(object, objectKey, objectValue);\n    }\n\n    if (!writeNode(state, level + 1, objectKey, true, true, true)) {\n      continue; // Skip this pair because of invalid key.\n    }\n\n    explicitPair = (state.tag !== null && state.tag !== '?') ||\n                   (state.dump && state.dump.length > 1024);\n\n    if (explicitPair) {\n      if (state.dump && CHAR_LINE_FEED === state.dump.charCodeAt(0)) {\n        pairBuffer += '?';\n      } else {\n        pairBuffer += '? ';\n      }\n    }\n\n    pairBuffer += state.dump;\n\n    if (explicitPair) {\n      pairBuffer += generateNextLine(state, level);\n    }\n\n    if (!writeNode(state, level + 1, objectValue, true, explicitPair)) {\n      continue; // Skip this pair because of invalid value.\n    }\n\n    if (state.dump && CHAR_LINE_FEED === state.dump.charCodeAt(0)) {\n      pairBuffer += ':';\n    } else {\n      pairBuffer += ': ';\n    }\n\n    pairBuffer += state.dump;\n\n    // Both key and value are valid.\n    _result += pairBuffer;\n  }\n\n  state.tag = _tag;\n  state.dump = _result || '{}'; // Empty mapping if no valid pairs.\n}\n\nfunction detectType(state, object, explicit) {\n  var _result, typeList, index, length, type, style;\n\n  typeList = explicit ? state.explicitTypes : state.implicitTypes;\n\n  for (index = 0, length = typeList.length; index < length; index += 1) {\n    type = typeList[index];\n\n    if ((type.instanceOf  || type.predicate) &&\n        (!type.instanceOf || ((typeof object === 'object') && (object instanceof type.instanceOf))) &&\n        (!type.predicate  || type.predicate(object))) {\n\n      if (explicit) {\n        if (type.multi && type.representName) {\n          state.tag = type.representName(object);\n        } else {\n          state.tag = type.tag;\n        }\n      } else {\n        state.tag = '?';\n      }\n\n      if (type.represent) {\n        style = state.styleMap[type.tag] || type.defaultStyle;\n\n        if (_toString.call(type.represent) === '[object Function]') {\n          _result = type.represent(object, style);\n        } else if (_hasOwnProperty.call(type.represent, style)) {\n          _result = type.represent[style](object, style);\n        } else {\n          throw new exception('!<' + type.tag + '> tag resolver accepts not \"' + style + '\" style');\n        }\n\n        state.dump = _result;\n      }\n\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// Serializes `object` and writes it to global `result`.\n// Returns true on success, or false on invalid object.\n//\nfunction writeNode(state, level, object, block, compact, iskey, isblockseq) {\n  state.tag = null;\n  state.dump = object;\n\n  if (!detectType(state, object, false)) {\n    detectType(state, object, true);\n  }\n\n  var type = _toString.call(state.dump);\n  var inblock = block;\n  var tagStr;\n\n  if (block) {\n    block = (state.flowLevel < 0 || state.flowLevel > level);\n  }\n\n  var objectOrArray = type === '[object Object]' || type === '[object Array]',\n      duplicateIndex,\n      duplicate;\n\n  if (objectOrArray) {\n    duplicateIndex = state.duplicates.indexOf(object);\n    duplicate = duplicateIndex !== -1;\n  }\n\n  if ((state.tag !== null && state.tag !== '?') || duplicate || (state.indent !== 2 && level > 0)) {\n    compact = false;\n  }\n\n  if (duplicate && state.usedDuplicates[duplicateIndex]) {\n    state.dump = '*ref_' + duplicateIndex;\n  } else {\n    if (objectOrArray && duplicate && !state.usedDuplicates[duplicateIndex]) {\n      state.usedDuplicates[duplicateIndex] = true;\n    }\n    if (type === '[object Object]') {\n      if (block && (Object.keys(state.dump).length !== 0)) {\n        writeBlockMapping(state, level, state.dump, compact);\n        if (duplicate) {\n          state.dump = '&ref_' + duplicateIndex + state.dump;\n        }\n      } else {\n        writeFlowMapping(state, level, state.dump);\n        if (duplicate) {\n          state.dump = '&ref_' + duplicateIndex + ' ' + state.dump;\n        }\n      }\n    } else if (type === '[object Array]') {\n      if (block && (state.dump.length !== 0)) {\n        if (state.noArrayIndent && !isblockseq && level > 0) {\n          writeBlockSequence(state, level - 1, state.dump, compact);\n        } else {\n          writeBlockSequence(state, level, state.dump, compact);\n        }\n        if (duplicate) {\n          state.dump = '&ref_' + duplicateIndex + state.dump;\n        }\n      } else {\n        writeFlowSequence(state, level, state.dump);\n        if (duplicate) {\n          state.dump = '&ref_' + duplicateIndex + ' ' + state.dump;\n        }\n      }\n    } else if (type === '[object String]') {\n      if (state.tag !== '?') {\n        writeScalar(state, state.dump, level, iskey, inblock);\n      }\n    } else if (type === '[object Undefined]') {\n      return false;\n    } else {\n      if (state.skipInvalid) return false;\n      throw new exception('unacceptable kind of an object to dump ' + type);\n    }\n\n    if (state.tag !== null && state.tag !== '?') {\n      // Need to encode all characters except those allowed by the spec:\n      //\n      // [35] ns-dec-digit    ::=  [#x30-#x39] /* 0-9 */\n      // [36] ns-hex-digit    ::=  ns-dec-digit\n      //                         | [#x41-#x46] /* A-F */ | [#x61-#x66] /* a-f */\n      // [37] ns-ascii-letter ::=  [#x41-#x5A] /* A-Z */ | [#x61-#x7A] /* a-z */\n      // [38] ns-word-char    ::=  ns-dec-digit | ns-ascii-letter | “-”\n      // [39] ns-uri-char     ::=  “%” ns-hex-digit ns-hex-digit | ns-word-char | “#”\n      //                         | “;” | “/” | “?” | “:” | “@” | “&” | “=” | “+” | “$” | “,”\n      //                         | “_” | “.” | “!” | “~” | “*” | “'” | “(” | “)” | “[” | “]”\n      //\n      // Also need to encode '!' because it has special meaning (end of tag prefix).\n      //\n      tagStr = encodeURI(\n        state.tag[0] === '!' ? state.tag.slice(1) : state.tag\n      ).replace(/!/g, '%21');\n\n      if (state.tag[0] === '!') {\n        tagStr = '!' + tagStr;\n      } else if (tagStr.slice(0, 18) === 'tag:yaml.org,2002:') {\n        tagStr = '!!' + tagStr.slice(18);\n      } else {\n        tagStr = '!<' + tagStr + '>';\n      }\n\n      state.dump = tagStr + ' ' + state.dump;\n    }\n  }\n\n  return true;\n}\n\nfunction getDuplicateReferences(object, state) {\n  var objects = [],\n      duplicatesIndexes = [],\n      index,\n      length;\n\n  inspectNode(object, objects, duplicatesIndexes);\n\n  for (index = 0, length = duplicatesIndexes.length; index < length; index += 1) {\n    state.duplicates.push(objects[duplicatesIndexes[index]]);\n  }\n  state.usedDuplicates = new Array(length);\n}\n\nfunction inspectNode(object, objects, duplicatesIndexes) {\n  var objectKeyList,\n      index,\n      length;\n\n  if (object !== null && typeof object === 'object') {\n    index = objects.indexOf(object);\n    if (index !== -1) {\n      if (duplicatesIndexes.indexOf(index) === -1) {\n        duplicatesIndexes.push(index);\n      }\n    } else {\n      objects.push(object);\n\n      if (Array.isArray(object)) {\n        for (index = 0, length = object.length; index < length; index += 1) {\n          inspectNode(object[index], objects, duplicatesIndexes);\n        }\n      } else {\n        objectKeyList = Object.keys(object);\n\n        for (index = 0, length = objectKeyList.length; index < length; index += 1) {\n          inspectNode(object[objectKeyList[index]], objects, duplicatesIndexes);\n        }\n      }\n    }\n  }\n}\n\nfunction dump$1(input, options) {\n  options = options || {};\n\n  var state = new State(options);\n\n  if (!state.noRefs) getDuplicateReferences(input, state);\n\n  var value = input;\n\n  if (state.replacer) {\n    value = state.replacer.call({ '': value }, '', value);\n  }\n\n  if (writeNode(state, 0, value, true, true)) return state.dump + '\\n';\n\n  return '';\n}\n\nvar dump_1 = dump$1;\n\nvar dumper = {\n\tdump: dump_1\n};\n\nfunction renamed(from, to) {\n  return function () {\n    throw new Error('Function yaml.' + from + ' is removed in js-yaml 4. ' +\n      'Use yaml.' + to + ' instead, which is now safe by default.');\n  };\n}\n\n\nvar Type                = type;\nvar Schema              = schema;\nvar FAILSAFE_SCHEMA     = failsafe;\nvar JSON_SCHEMA         = json;\nvar CORE_SCHEMA         = core;\nvar DEFAULT_SCHEMA      = _default;\nvar load                = loader.load;\nvar loadAll             = loader.loadAll;\nvar dump                = dumper.dump;\nvar YAMLException       = exception;\n\n// Re-export all types in case user wants to create custom schema\nvar types = {\n  binary:    binary,\n  float:     float,\n  map:       map,\n  null:      _null,\n  pairs:     pairs,\n  set:       set,\n  timestamp: timestamp,\n  bool:      bool,\n  int:       int,\n  merge:     merge,\n  omap:      omap,\n  seq:       seq,\n  str:       str\n};\n\n// Removed functions from JS-YAML 3.0.x\nvar safeLoad            = renamed('safeLoad', 'load');\nvar safeLoadAll         = renamed('safeLoadAll', 'loadAll');\nvar safeDump            = renamed('safeDump', 'dump');\n\nvar jsYaml = {\n\tType: Type,\n\tSchema: Schema,\n\tFAILSAFE_SCHEMA: FAILSAFE_SCHEMA,\n\tJSON_SCHEMA: JSON_SCHEMA,\n\tCORE_SCHEMA: CORE_SCHEMA,\n\tDEFAULT_SCHEMA: DEFAULT_SCHEMA,\n\tload: load,\n\tloadAll: loadAll,\n\tdump: dump,\n\tYAMLException: YAMLException,\n\ttypes: types,\n\tsafeLoad: safeLoad,\n\tsafeLoadAll: safeLoadAll,\n\tsafeDump: safeDump\n};\n\n\n\n\n//# sourceURL=webpack://reversedfront-mod/./node_modules/js-yaml/dist/js-yaml.mjs?\n}")}},__webpack_module_cache__={},inProgress,dataWebpackPrefix;function __webpack_require__(n){var e=__webpack_module_cache__[n];if(void 0!==e)return e.exports;if(void 0===__webpack_modules__[n]){var t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}var r=__webpack_module_cache__[n]={exports:{}};return __webpack_modules__[n](r,r.exports,__webpack_require__),r.exports}__webpack_require__.m=__webpack_modules__,__webpack_require__.d=(n,e)=>{for(var t in e)__webpack_require__.o(e,t)&&!__webpack_require__.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:e[t]})},__webpack_require__.f={},__webpack_require__.e=n=>Promise.all(Object.keys(__webpack_require__.f).reduce((e,t)=>(__webpack_require__.f[t](n,e),e),[])),__webpack_require__.u=n=>n+".main.bundle.js",__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(n){if("object"==typeof window)return window}}(),__webpack_require__.o=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),inProgress={},dataWebpackPrefix="reversedfront-mod:",__webpack_require__.l=(n,e,t,r)=>{if(inProgress[n])inProgress[n].push(e);else{var o,a;if(void 0!==t)for(var i=document.getElementsByTagName("script"),s=0;s<i.length;s++){var l=i[s];if(l.getAttribute("src")==n||l.getAttribute("data-webpack")==dataWebpackPrefix+t){o=l;break}}o||(a=!0,(o=document.createElement("script")).charset="utf-8",__webpack_require__.nc&&o.setAttribute("nonce",__webpack_require__.nc),o.setAttribute("data-webpack",dataWebpackPrefix+t),o.src=n),inProgress[n]=[e];var c=(e,t)=>{o.onerror=o.onload=null,clearTimeout(d);var r=inProgress[n];if(delete inProgress[n],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach(n=>n(t)),e)return e(t)},d=setTimeout(c.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=c.bind(null,o.onerror),o.onload=c.bind(null,o.onload),a&&document.head.appendChild(o)}},__webpack_require__.r=n=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},(()=>{var n;__webpack_require__.g.importScripts&&(n=__webpack_require__.g.location+"");var e=__webpack_require__.g.document;if(!n&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(n=e.currentScript.src),!n)){var t=e.getElementsByTagName("script");if(t.length)for(var r=t.length-1;r>-1&&(!n||!/^http(s?):/.test(n));)n=t[r--].src}if(!n)throw new Error("Automatic publicPath is not supported in this browser");n=n.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),__webpack_require__.p=n})(),(()=>{var n={main:0};__webpack_require__.f.j=(e,t)=>{var r=__webpack_require__.o(n,e)?n[e]:void 0;if(0!==r)if(r)t.push(r[2]);else{var o=new Promise((t,o)=>r=n[e]=[t,o]);t.push(r[2]=o);var a=__webpack_require__.p+__webpack_require__.u(e),i=new Error;__webpack_require__.l(a,t=>{if(__webpack_require__.o(n,e)&&(0!==(r=n[e])&&(n[e]=void 0),r)){var o=t&&("load"===t.type?"missing":t.type),a=t&&t.target&&t.target.src;i.message="Loading chunk "+e+" failed.\n("+o+": "+a+")",i.name="ChunkLoadError",i.type=o,i.request=a,r[1](i)}},"chunk-"+e,e)}};var e=(e,t)=>{var r,o,[a,i,s]=t,l=0;if(a.some(e=>0!==n[e])){for(r in i)__webpack_require__.o(i,r)&&(__webpack_require__.m[r]=i[r]);if(s)s(__webpack_require__)}for(e&&e(t);l<a.length;l++)o=a[l],__webpack_require__.o(n,o)&&n[o]&&n[o][0](),n[o]=0},t=self.webpackChunkreversedfront_mod=self.webpackChunkreversedfront_mod||[];t.forEach(e.bind(null,0)),t.push=e.bind(null,t.push.bind(t))})();var __webpack_exports__=__webpack_require__("./js/index.js")})();